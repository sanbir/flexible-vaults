"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[94995],{343168:(e,o,t)=>{t.d(o,{A:()=>n});class r extends(()=>t(757695))().Store{getInitialState(){return{openTooltip:void 0}}}const n=new r},894995:(e,o,t)=>{t.r(o),t.d(o,{FORMS_SHARE_CALLOUT_KEY:()=>te,changeFormClosedState:()=>pe,changeFormSubmissionPermissions:()=>fe,changeFormSubmissionTemplate:()=>ve,createAndFocusCollectionFormEditorView:()=>ae,createCollectionFormEditorView:()=>se,createDummyFormPage:()=>he,createFormInPrivate:()=>de,createFormQuestion:()=>ue,createFormQuestionAndUpdateOrCreateModule:()=>me,createModuleForNewlyDuplicatedProperty:()=>ce,createResponsesCollectionView:()=>le,incrementAndTrackUserFormsCreated:()=>re,maybeAlertAboutUnsupportedPublicQuestions:()=>be,maybeSyncQuestionNameToPropertyName:()=>ne,remapQuestionToNewProperty:()=>Ie,toggleAnonymousFormSubmissionState:()=>ye,toggleNotionBrandingState:()=>ge});t(16280),t(944114),t(898992),t(354520),t(672577),t(803949),t(581454),t(296540);var r=()=>t(564884),n=()=>t(907258),i=()=>t(401497),a=()=>t(675133),s=()=>t(792057),d=()=>t(807449),l=()=>t(584262),u=()=>t(700500),c=()=>t(31503),m=()=>t(898244),p=()=>t(713998),f=()=>t(110192),v=()=>t(416504),y=()=>t(123423),g=()=>t(626922),I=()=>t(421559),h=()=>t(688728),b=()=>t(235692),_=()=>t(388821),A=()=>t(450648),w=()=>t(179034),S=()=>t(519831),M=()=>t(869558),C=()=>t(37165),T=()=>t(144081),x=()=>t(201980),B=()=>t(69708),P=()=>t(100622),F=()=>t(496603),N=()=>t(183558),Q=()=>t(284371),O=()=>t(896628),E=()=>t(384944),D=()=>t(857783),U=()=>t(185544),k=()=>t(680977),R=()=>t(631123),V=()=>t(478251),z=()=>t(180762),j=()=>t(680288),L=()=>t(644854),G=()=>t(389658),q=()=>t(594794),X=()=>t(300789),Z=()=>t(978846),W=()=>t(33218),H=()=>t(343168),$=()=>t(957763),K=()=>t(598729),Y=()=>t(547149),J=()=>t(465741),ee=t(474848);const oe=(0,B().YK)({responsesViewName:{id:"formEditorActions.responsesViewName",defaultMessage:"Responses"},newFormViewName:{id:"formEditorActions.newFormViewName",defaultMessage:"Form builder"},formDatabaseTitle:{id:"newBlock.databaseInline.formDatabaseTitle",defaultMessage:"New form"}}),te="forms_share_form_tooltip";function re(e,o){const{currentUserSettingsStore:t}=n().default.state;if(!t)return;const i=function(){const{currentUserSettingsStore:e}=n().default.state;if(!e)return;return e.getSettingsStore().getKeyStore("user_forms_created_count").getValue()??0}();void 0!==i&&((0,k().m)({userSettingsStore:t,transaction:o,data:{user_forms_created_count:i+1}}),function(e,o){(0,r().u)({environment:e,event:{eventName:"form_created",eventProperties:{user_total_form_count:o.userFormsCreatedCount}}})}(e,{userFormsCreatedCount:i+1}))}function ne(e){var o;const{questionStore:t,environment:r,collectionStore:n,collectionContextStore:i}=e,s=null===(o=t.getConfig())||void 0===o?void 0:o.propertyId;if(!s)throw new Error("No property ID found for question");Y().createAndCommit({userAction:"formQuestion.changeName",environment:r,canUndo:!0,perform:e=>{if(!t.shouldSyncQuestionNameToPropertyName())return;const o=t.getNameStore().getValue();if(!o)return;const r=(0,A().r4)({textValue:o,getRecordModel:t.getRecordModel,deterministic:!0,userTimeZone:(0,v().P)(),intl:a().A.getIntl()}),d=(0,j().fE)({property:s,collectionContextStore:i,newValue:r})?(0,f().Q)(r):r;(0,R().Y)({collectionStore:n,property:s,name:d,transaction:e})}})}function ie(){const e=(0,i().IS)((()=>({container:{display:"flex",flexDirection:"column"},iconGroup:{display:"flex",flexDirection:"row",justifyContent:"center",color:P().Tj.icon.secondary,alignItems:"center"},dialogTitle:{fontSize:16,fontWeight:Q().Wy.semibold,lineHeight:"22px",marginTop:12,marginBottom:12},dialogDescription:{color:P().Tj.text.secondary,fontSize:14,lineHeight:"20px"}})),[]);return(0,ee.jsxs)("div",{style:e.container,children:[(0,ee.jsxs)("div",{style:e.iconGroup,children:[(0,ee.jsx)(d().I,{icon:I().T,size:36}),(0,ee.jsx)(d().I,{icon:y().arrowStraightRightFillIcon,size:24,style:{marginInlineStart:12,marginInlineEnd:12}}),(0,ee.jsx)(d().I,{icon:g().e,size:36})]}),(0,ee.jsx)("span",{style:e.dialogTitle,children:(0,ee.jsx)(B().sA,{defaultMessage:"Auto-create form questions based on existing properties?",id:"NewFormOnExistingCollectionDialogTitle.message"})}),(0,ee.jsx)("span",{style:e.dialogDescription,children:(0,ee.jsx)(B().sA,{defaultMessage:"Only supported property types will create new questions.",id:"NewFormOnExistingCollectionDialogTitle.description"})})]})}function ae(e){const{environment:o,collectionContextStore:t,collectionStore:r,transaction:n}=e,i=t.collectionViewBlockStore();if(!i)return;const a=r.getSchema(),d=se({environment:o,collectionViewBlockStore:i,collectionId:r.id,schema:a,transaction:n,initializeWithAllDefaultQuestions:!1});if(!d)return;(0,z().t)({environment:o,collectionContextStore:t,collectionViewId:d.newViewId,isFullScreen:t.isFullScreenStore.state,isRootChild:t.isRootChildStore.state,isInPeekRenderer:t.isInPeekRendererStore.state});const l=d.layoutStore,u=Object.keys(a).filter((e=>{const o=a[e];return"title"!==e&&o&&(0,c().Sg)(o)}));u.length>0&&u.length<=J().eb&&s().ui({showCancel:!1,keepFocus:!1,message:(0,ee.jsx)(ie,{}),mode:"wide",items:[{label:(0,ee.jsx)(B().sA,{defaultMessage:"Create {numQuestions, plural, one {1 question} other {{numQuestions} questions}}",id:"formEditorActions.createQuestions.primaryAction",values:{numQuestions:u.length}}),color:"blue",buttonType:"solid",onAccept(){Y().createAndCommit({environment:o,userAction:"formActions.autoCreateFormQuestionsForExistingDatabase",canUndo:!0,perform:e=>{for(const n of u)ce({type:"formQuestion",environment:o,module:void 0,transaction:e,layoutStore:l,collectionStore:r,propertyId:n,position:{type:"area_relative",area:"form_layout_schema",location:"end_moveable"},collectionContextStore:t,shouldLogEvent:!0,autoCreatedFromExistingDatabase:!0,duplicateModuleMapping:new Map,propertyIdMapping:new Map,sessionId:(0,N().Ay)()})}})}},{label:(0,ee.jsx)(B().sA,{defaultMessage:"Start from scratch",id:"formEditorActions.createQuestions.secondary"}),color:"gray",buttonType:"plain",onAccept(){}}]})}function se(e){const{environment:o,collectionViewBlockStore:t,collectionId:r,transaction:n,schema:i,initializeWithAllDefaultQuestions:s}=e;if(!t)return;const d=t.getSpaceId(),{formBlockStore:l,layoutStore:u}=function(e){var o;const{environment:t,spaceId:r,inMemoryRecordCache:n,transaction:i,schema:a,initializeWithAllDefaultQuestions:s}=e,d=Object.keys(a).find((e=>{var o;return"multi_select"===(null===(o=a[e])||void 0===o?void 0:o.type)})),l=Boolean(s&&void 0!==d),u=(0,q().Z1)({environment:t,table:w().ev,spaceId:r}),p=(0,q().Z1)({environment:t,table:C().lo,spaceId:r}),f=l?(0,q().Z1)({environment:t,table:C().lo,spaceId:r}):void 0,v=E().Wv({id:u,environment:t,type:"form",permissions:(0,c().eb)(),inMemoryRecordCache:n,transaction:i}),y=E().eC({environment:t,table:T().zx,value:{space_id:r,parent_table:w().ev,parent_id:v.id,modules:(0,b().oP)(p,f)},inMemoryRecordCache:n,transaction:i});var g,I;O().zA({stores:[v],update:{form_layout_pointer:{id:y.id,spaceId:r,table:T().zx}},transaction:i}),ue({environment:t,questionId:p,spaceId:r,layoutId:y.id,propertyId:m().rn,initialQuestionTitle:(null===(o=a[m().rn])||void 0===o?void 0:o.name)??"",inMemoryRecordCache:n,transaction:i,shouldSyncQuestionNameToPropertyName:!0,shouldLogEvent:!1,logData:{area:"form_layout_schema",layoutStore:y}}),l&&f&&d&&ue({environment:t,questionId:f,spaceId:r,layoutId:y.id,propertyId:d,initialQuestionTitle:(null===(g=a[d])||void 0===g?void 0:g.name)??"",existingFormQuestionConfig:{propertyId:d,name:[[(null===(I=a[d])||void 0===I?void 0:I.name)??""]],propertyTypeSpecificConfig:{multi_select:{maxSelectionCount:1}}},inMemoryRecordCache:n,transaction:i,shouldSyncQuestionNameToPropertyName:!0,shouldLogEvent:!1,logData:{area:"form_layout_schema",layoutStore:y}});return{formBlockStore:v,layoutStore:y}}({environment:o,spaceId:d,inMemoryRecordCache:t.inMemoryRecordCache,transaction:n,schema:i,initializeWithAllDefaultQuestions:s}),p=(0,V().i)({environment:o,collectionViewBlockStore:t,collectionView:{type:"form_editor",parent_id:t.id,parent_table:w().ev,alive:!0,space_id:d,name:a().A.formatMessage(oe.newFormViewName),format:{form_block_pointer:{id:l.id,spaceId:d,table:w().ev},collection_pointer:{id:r,spaceId:d,table:S().Vl}}},transaction:n});return E().zv({store:l,data:{parent_id:p.id,parent_table:M().Gy,alive:!0},transaction:n}),H().A.setState({openTooltip:p.id}),X().HH(o,te),re(o,n),{newViewId:p.id,layoutStore:u,formId:l.id}}function de(e){const{environment:o,navigateToFormBuilder:t,spaceStore:r,spaceViewStore:n}=e;if(!(0,$().E)(o,r))return void(0,K().Q)(o,r);if(!(r&&r.canEdit()&&n))return;const i=r.id,s=o.idCreator.getSpaceIdCreatorSync(i);Y().createAndCommit({environment:o,userAction:"formActions.createAndNavigateToFormInPrivate",canUndo:!0,perform:e=>{var d;const{targetBlockStore:u}=(0,L().initializeTemplate)({environment:o,sourceBlockId:"root",targetBlockPointer:(0,q().zP)({environment:o,table:w().ev,spaceId:i}),sourceBlockSubtree:(0,_().partialRecordMapToRecordMap)(G().mT({isInline:!0,name:(0,x().x9d)(a().A.formatMessage(oe.formDatabaseTitle))})),targetRecordCache:r.inMemoryRecordCache,transaction:e,deepCopyTransclusionContainers:!0,resolveTemplateVariables:!1,spaceIdCreator:s}),c=u.getCollectionStoreIfSingleSource();if(!c)throw new Error("Collection store not found");const m=null==c||null===(d=c.getModel())||void 0===d?void 0:d.getNormalizedSchema(),p=u;if(!m)throw new Error("Schema not found");se({environment:o,transaction:e,collectionViewBlockStore:p,collectionId:c.id,schema:m,initializeWithAllDefaultQuestions:!0}),le({environment:o,transaction:e,collectionViewBlockStore:p,collectionStore:c,schema:m}),U().yM({environment:o,spaceStore:r,spaceViewStore:n,pageStore:u,isPrivate:!0,transaction:e,location:{type:"prepend"}}),t&&D().uK({environment:o,store:u,pageVisitSource:l().y8.CreateFormDeepLink})}})}function le(e){const{environment:o,collectionViewBlockStore:t,collectionStore:r,transaction:n}=e,i=t.getSpaceId(),s=Object.keys(e.schema).find((o=>{var t;return"created_by"===(null===(t=e.schema[o])||void 0===t?void 0:t.type)}));(0,V().i)({environment:o,collectionViewBlockStore:t,collectionView:{type:"table",parent_id:t.id,parent_table:w().ev,alive:!0,name:a().A.formatMessage(oe.responsesViewName),space_id:i,format:{table_properties:[{property:"title",visible:!0},...s?[{property:s,visible:!0}]:[]],table_wrap:!0,collection_pointer:r.pointer}},transaction:n})}function ue(e){const{environment:o,questionId:t,spaceId:n,layoutId:i,propertyId:a,initialQuestionTitle:s,inMemoryRecordCache:d,transaction:l,shouldSyncQuestionNameToPropertyName:u,collectionContextStore:c,shouldLogEvent:m=!0,autofocusTitle:p,existingFormQuestionConfig:f,autoCreatedFromExistingDatabase:v}=e;E().vt({environment:o,table:C().lo,args:{id:t,space_id:n,parentPointer:{id:i,table:T().zx,spaceId:n},config:{...f,propertyId:a,name:[[s]],shouldSyncQuestionNameToPropertyName:u}},inMemoryRecordCache:d,transaction:l}),m&&(0,r().u)({environment:o,event:{eventName:"add_form_question",eventProperties:{...(0,J().YA)({collectionContextStore:c,propertyId:a,questionId:t,area:e.logData.area,parentModuleId:e.logData.parentModuleId,layoutStore:e.logData.layoutStore}),auto_created_from_existing_database:Boolean(v)}}}),p&&p.autofocusedQuestionTextStore.autofocusQuestionTitle({questionId:t})}function ce(e){const{type:o,module:t,environment:r,transaction:n,layoutStore:i,position:a,duplicateModuleMapping:s,shouldLogEvent:d=!0,collectionContextStore:l,sessionId:u}=e;let c;const m=t&&s.get(t.id)||(0,N().Ay)();if("formQuestion"===o){var p;const{collectionStore:o,propertyId:u,autofocusTitle:f,existingFormQuestionConfig:v,autoCreatedFromExistingDatabase:y,propertyIdMapping:g}=e,I=o.getSchema()[u];if(!I)throw new Error(`No schema found for property ${u}`);const b=v?(0,x().q4_)(null==v?void 0:v.name):I.name,_=i.getSpaceId(),A=(0,q().Z1)({environment:r,table:C().lo,spaceId:_});if(!(0,h().uW)(a.area))throw new Error("Module is not allowed in this area");ue({environment:r,questionId:A,spaceId:_,layoutId:i.id,propertyId:u,initialQuestionTitle:b,inMemoryRecordCache:i.inMemoryRecordCache,transaction:n,shouldSyncQuestionNameToPropertyName:!0,shouldLogEvent:d,logData:{area:a.area,parentModuleId:null==t?void 0:t.parentModuleId,layoutStore:i},collectionContextStore:l,autofocusTitle:f,existingFormQuestionConfig:v,autoCreatedFromExistingDatabase:y}),c={type:"formQuestion",id:m,formQuestionId:A,...t?{parentModuleId:s.get(t.parentModuleId??"")??t.parentModuleId,parentConditionalGroupId:t.parentConditionalGroupId,conditionalGroups:null===(p=t.conditionalGroups)||void 0===p?void 0:p.map((e=>({...e,trigger:{...e.trigger,property:g.get(e.trigger.property)??e.trigger.property},children:[]})))}:{}}}else c={type:"placeholder",id:m,parentModuleId:s.get(t.parentModuleId??""),parentConditionalGroupId:t.parentConditionalGroupId};return(0,Z().UQ)({environment:r,transaction:n,layoutStore:i,position:a,module:c,sessionId:u,isPropertyCreation:!1}),{moduleId:m}}function me(e){const{environment:o,transaction:t,layoutStore:r,propertyId:n,initialQuestionTitle:i,moduleId:a,shouldSyncQuestionNameToPropertyName:s,collectionContextStore:d,autofocusTitle:l,area:u,sessionId:c}=e,m=r.getModel();if(!m)throw new Error("Layout model cannot be undefined");const p=r.getSpaceId(),f=(0,q().Z1)({environment:o,table:C().lo,spaceId:p});ue({environment:o,questionId:f,spaceId:p,layoutId:m.id,propertyId:n,initialQuestionTitle:i,inMemoryRecordCache:r.inMemoryRecordCache,transaction:t,shouldSyncQuestionNameToPropertyName:s,collectionContextStore:d,autofocusTitle:l,logData:{area:u,parentModuleId:"form_conditional_modules"===u?e.parentModuleId:void 0,layoutStore:r}});const v={type:"formQuestion",id:a??(0,N().Ay)(),formQuestionId:f,..."form_conditional_modules"===u?{parentModuleId:e.parentModuleId,parentConditionalGroupId:e.parentConditionalGroupId}:{}};return a?(0,W().UQ)({environment:o,transaction:t,layoutStore:r,position:{area:u,moduleId:a},updatedModule:v}):"form_conditional_modules"===u&&(0,Z().UQ)({environment:o,transaction:t,layoutStore:r,position:{type:"absolute",area:"form_conditional_modules",parentConditionalGroupId:e.parentConditionalGroupId,parentModuleId:e.parentModuleId},module:v,sessionId:c,isPropertyCreation:!1}),{updatedModuleId:v.id,formQuestionId:f}}function pe({environment:e,formBlockStore:o,isClosed:t}){o.getIsFormClosed()!==t&&Y().createAndCommit({userAction:"formActions.changeFormClosedState",environment:e,canUndo:!0,perform:e=>{O().zA({stores:[o],update:{form_config:{...o.getFormConfig(),is_form_closed:t}},transaction:e})}})}function fe({environment:e,formBlockStore:o,permissions:t}){o.getFormSubmissionPermissions()!==t&&Y().createAndCommit({userAction:"formActions.changeFormSubmissionPermissions",environment:e,canUndo:!0,perform:e=>{O().zA({stores:[o],update:{form_config:{...o.getFormConfig(),submission_permissions:t}},transaction:e})}})}function ve({environment:e,formBlockStore:o,template:t}){const r=o.getFormSubmissionTemplate();(0,F().n4)(r,t)||Y().createAndCommit({userAction:"formActions.changeFormSubmissionTemplate",environment:e,canUndo:!0,perform:e=>{E().KY({store:o.getFormatStore().getKeyStore("form_config").getKeyStore("form_submission_template"),transaction:e,value:t})}})}function ye({environment:e,formBlockStore:o}){const t=o.getIsFormAnonymousSubmissionEnabled();Y().createAndCommit({userAction:"formActions.changeAnonymousFormSubmissionState",environment:e,canUndo:!0,perform:e=>{O().zA({stores:[o],update:{form_config:{...o.getFormConfig(),anonymous_submissions:!t}},transaction:e})}})}function ge({environment:e,formBlockStore:o}){var t;const r=o.getSiteStore();if(!r)return;const n=(null===(t=r.getHeader())||void 0===t?void 0:t.hideWatermark)??!1;Y().createAndCommit({userAction:"formBlockStore.publicForm.toggleNotionBranding",environment:e,canUndo:!0,perform:e=>{Y().applyOperation({store:r,operation:{pointer:r.pointer,path:["header","hideWatermark"],command:"set",args:!n},transaction:e})}})}function Ie({environment:e,newPropertyId:o,formQuestionStore:t}){Y().createAndCommit({userAction:"formQuestion.remapQuestionToNewProperty",environment:e,canUndo:!0,perform:e=>{Y().applyOperation({store:t,operation:{pointer:t.pointer,path:["config","propertyId"],command:"set",args:o},transaction:e})}})}function he(e){const{environment:o,collectionSchemaPropertyIds:t,temporaryRecordCache:r,spaceId:n,collectionId:i,formMode:a}=e,s={};t.forEach((e=>{s[e]=(0,x().x9d)("")}));const{performResult:d}=Y().createAndCommit({environment:o,userAction:"formActions.createDummyFormPage",perform:e=>{const t=E().Wv({environment:o,type:u().xd.page,inMemoryRecordCache:r,transaction:e,spaceId:n,properties:{...s}});return E().zv({store:t,data:{alive:"viewer"===a,parent_id:i,parent_table:"collection"},transaction:e}),t},canUndo:!1});return d}async function be(e){const{environment:o,formBlockStore:t,collectionSchema:r,onAccept:n}=e;if(!r)return;const i=(0,J().Dx)(t),d=(null==i?void 0:i.getNormalizedFormQuestionStoresForFormLayout({collectionSchema:r}))??[],l=[];if(d.forEach((e=>{const t=e.getPropertyId();if(!t)return;const n=(0,p()._g)({schema:r,property:t}),i=null==n?void 0:n.type;if(!i)return;(0,J().CK)({environment:o,propertyType:i,propertySchema:n,isPublicForm:!0})&&l.push(e)})),0===l.length)return void n();const u=l.map(((e,o)=>{const t=(0,A().r4)({textValue:e.getNameStore().getValue(),getRecordModel:e.getRecordModel,deterministic:!0,userTimeZone:(0,v().P)(),intl:a().A.getIntl()}),r=o===l.length-1;return(0,ee.jsx)("div",{style:{fontSize:14,textAlign:"start",padding:"8px 12px",borderBottom:r?void 0:`1px solid ${P().Tj.border.secondaryTranslucent}`},children:t},e.id)})),{accept:c}=await s().Gh({message:(0,ee.jsx)(B().sA,{id:"formEditorActions.maybeAlertAboutUnsupportedPublicQuestions.message",defaultMessage:"These questions are not supported in public forms and will not be shown to respondents:"}),description:(0,ee.jsx)("div",{style:{borderRadius:6,border:`1px solid ${P().Tj.border.secondaryTranslucent}`,width:"calc(100% + 24px)",marginInlineStart:-12,marginTop:12,maxHeight:210,overflow:"auto"},children:u}),acceptLabel:(0,ee.jsx)(B().sA,{id:"formEditorActions.maybeAlertAboutUnsupportedPublicQuestions.acceptLabel",defaultMessage:"Got it"}),acceptColor:"blue",cancelButtonType:"plain",mode:"wide"});c&&n()}},978846:(e,o,t)=>{t.d(o,{E:()=>y,UQ:()=>g});t(16280),t(18107),t(944114),t(967357);var r=()=>t(31503),n=()=>t(792071),i=()=>t(688728),a=()=>t(500993),s=()=>t(369186),d=()=>t(475140),l=()=>t(120997),u=()=>t(251822),c=()=>t(778781),m=()=>t(534177),p=()=>t(547149),f=()=>t(447934),v=()=>t(479062);function y(e){const{moduleId:o,layoutStore:t,sessionId:n,environment:a,position:s}=e,d=t.getModuleById(o);if(!d)throw new Error(`Cannot move module with id ${o} because a module with that id is not in the layout`);const l=(0,v().TR)({modulesByArea:t.getModules(),moduleId:o,newPosition:s});I({...e,module:d,userAction:"BuilderLayoutModules.moveModuleToPosition",afterUpsertTransaction:()=>{var e;const o=(0,r().Cg)({moduleId:d.id,modulesByArea:t.getModules()}).length;(0,v().Ib)({environment:a,sessionId:n,collectionId:null===(e=t.getCollectionModel())||void 0===e?void 0:e.id,layoutId:t.id,context:(0,i().We)(s.area),action:l,moduleType:d.type,area:s.area,depth:o})}})}function g(e){const{position:o,module:t,layoutStore:n,sessionId:a,environment:s}=e;if(n.getModuleById(t.id))throw new Error(`Cannot add module with id ${t.id} because a module with that id is already in the layout`);I({...e,userAction:"BuilderLayoutModules.addModuleAtPosition",performBeforeApplyUpsertOperations:e=>{const{transaction:r}=e;"page_main"!==o.area&&"page_details"!==o.area||(0,c().gx)(t)&&(0,f().HD)({environment:s,transaction:r,layoutStore:n,property:t.propertyId})},afterUpsertTransaction:()=>{var d;const l=(0,r().Cg)({moduleId:t.id,modulesByArea:n.getModules()}).length;(0,v().zb)({environment:s,module:t,sessionId:a,collectionId:null===(d=n.getCollectionModel())||void 0===d?void 0:d.id,layoutId:n.id,context:(0,i().We)(o.area),isPropertyCreation:e.isPropertyCreation,area:o.area,depth:l})}})}function I(e){const{environment:o,position:t,layoutStore:r,module:u,transaction:c,userAction:f,performBeforeApplyUpsertOperations:v,afterUpsertTransaction:y}=e,g=r.pointer,I=r.getModules(),A=r.getRawModules(),w=A&&(0,d().c7)(A,(e=>e.id===u.id))||(0,s().Lv)(u),S="page_main"===t.area||"page_details"===t.area?function(e){const{layoutPointer:o,modulesByArea:t,rawModulesByArea:r}=e,a=(0,d().EX)(t,(e=>"relationsGroup"===e.type));if("form_conditional_modules"===(null==a?void 0:a.position.area))return;const l=r&&(0,d().LC)(r,(e=>"relationsGroup"===e.type));if(!a)return;if(a&&l)return;const u=a.module;if(!u||"relationsGroup"!==u.type)throw new Error("relations group module location in normalized was incorrect, cannot backfill relations group module");return function(e){var o;const{module:t,modulesByArea:r,layoutPointer:a}=e,l=(0,d().JO)(r,(e=>e.id===t.id));if(!l)throw new Error("cannot upsert module at current position because module does not have a current position");if("form_conditional_modules"===l.area)throw new Error("[Forms Conditional Logic Not Implemented] form_conditional_modules area is not supported for adding and moving modules");const u="views_main_tab_modules"===l.area?null===(o=r.views_main_tab_modules)||void 0===o?void 0:o[l.viewId]:r[l.area];if(!u||0===u.length)throw new Error("cannot upsert module at current position in area because that area is empty");const c={module:(0,s().Lv)(t),pointer:a,..."views_main_tab_modules"===l.area?{area:i().Zm[l.area],viewId:l.viewId}:{area:i().Zm[l.area]}};if(0===l.index)return n().N4X.putModuleAfter({...c,afterId:void 0});const m=u.at(l.index+1);if(!m)return n().N4X.putModuleAfter({...c,afterId:void 0});return n().N4X.putModuleBefore({...c,beforeId:m.id})}({module:u,layoutPointer:o,modulesByArea:t})}({layoutPointer:g,modulesByArea:I,rawModulesByArea:A}):null;S&&p().createAndCommitOrAppend({environment:o,perform:e=>{p().applyOperation({transaction:e,store:r,operation:S})},canUndo:!0,transaction:c,userAction:`${f||"BuilderLayoutModules.upsert"}.preOpBackfill`});const M=[],C=function(e){const{layoutStore:o,module:t,upsertPosition:r}=e,a=o.getModules(),s=(0,d().JO)(a,(e=>t.id===e.id));if(!s)return;if("form_conditional_modules"===s.area)return n().N4X.deleteModuleInArea({pointer:o.pointer,area:s.area,moduleId:t.id});if("views_main_tab_modules"===s.area){const e="absolute"===r.type&&"views_main_tab_modules"===r.area?r.viewId:void 0,i=s.viewId;if(e===i)return;return n().N4X.deleteModuleInArea({pointer:o.pointer,area:s.area,moduleId:t.id,viewId:i})}if("page_main"===s.area||"page_details"===s.area||"form_layout_schema"===s.area||"person_profile_page_main"===s.area||"person_profile_page_details"===s.area||"dashboard_layout_schema"===s.area){if(s.area===r.area)return;return n().N4X.deleteModuleInArea({pointer:o.pointer,area:i().Zm[s.area],moduleId:t.id})}(0,m().HB)(s.area)}({upsertPosition:t,module:u,layoutStore:r});C&&M.push(C);const T=function(e){const{upsertPosition:o,layoutPointer:t,modulesByArea:r,rawModuleToUpsert:s}=e;if("absolute"===o.type)return function(e){const{upsertPosition:o,rawModuleToUpsert:t,layoutPointer:r,modulesByArea:s}=e,u=(0,d().JO)(s,(e=>t.id===e.id)),{area:c}=o;if("form_conditional_modules"===c){const{parentConditionalGroupId:e,parentModuleId:i}=o;if(!(0,l().V)(t,"form_conditional_modules"))throw new Error("Can only add form question or placeholder modules to form_conditional_modules area.");const u=(0,d().Ib)({modulesByArea:s,find:e=>e.id===t.parentModuleId}),c=(0,a().A)(i,s);return n().N4X.upsertChildModule({pointer:r,module:t,previousParentModuleAndArea:u,newParentModule:{area:c.area,module:c.module,conditionalGroupId:e,index:o.index},modulesByArea:s})}const m=o.index;if(m<0)throw new Error(`Cannot upsert module with id ${t.id} to a negative position`);if("views_main_tab_modules"===c){const e=o.viewId;if(!s[c]||!s[c][e])throw new Error("Cannot upsert module into views_main_tab_modules area that does not have views");const a="views_main_tab_modules"===(null==u?void 0:u.area)&&(null==u?void 0:u.viewId)===e?u.index:void 0,d=h({modulesInArea:s[c][e],indexOfModuleToUpsertInArea:a,indexToUpsertTo:m});if(!d)return;return[n().N4X.putModuleBeforeOrAfter({pointer:r,area:i().Zm[c],viewId:e,module:t,direction:d.insertDirection,beforeOrAfterId:d.beforeOrAfterId})]}const p=s[c]??[],f=(null==u?void 0:u.area)===c?u.index:void 0,v=h({modulesInArea:p,indexOfModuleToUpsertInArea:f,indexToUpsertTo:m});if(!v)return;return[n().N4X.putModuleBeforeOrAfter({pointer:r,area:i().Zm[c],module:t,direction:v.insertDirection,beforeOrAfterId:v.beforeOrAfterId})]}({upsertPosition:o,rawModuleToUpsert:s,layoutPointer:t,modulesByArea:r});if("module_relative"===o.type)return[b({upsertPosition:o,rawModuleToUpsert:s,layoutPointer:t,modulesByArea:r})];if("area_relative"===o.type)return[_({upsertPosition:o,rawModuleToUpsert:s,layoutPointer:t,modulesByArea:r})];(0,m().HB)(o)}({module:u,upsertPosition:t,modulesByArea:I,layoutPointer:g,rawModuleToUpsert:w});T&&M.push(...T);const x="placeholder"===u.type&&"form_layout_schema"===t.area?`form_layout_new_question_${u.id}`:void 0;p().createAndCommitOrAppend({environment:o,undoCheckpoint:x,canUndo:!0,perform:e=>{v&&v({transaction:e});for(const o of M)p().applyOperation({transaction:e,store:r,operation:o})},transaction:c,userAction:f||"BuilderLayoutModules.upsert"}),y&&y()}function h(e){const{modulesInArea:o,indexOfModuleToUpsertInArea:t,indexToUpsertTo:r}=e;if(0===r||0===o.length)return{insertDirection:"before",beforeOrAfterId:void 0};const n=o.at(r);return n?void 0===t?{insertDirection:"before",beforeOrAfterId:n.id}:t!==r?t<r?{insertDirection:"after",beforeOrAfterId:n.id}:{insertDirection:"before",beforeOrAfterId:n.id}:void 0:{insertDirection:"after",beforeOrAfterId:void 0}}function b(e){const{upsertPosition:o,rawModuleToUpsert:t,layoutPointer:r,modulesByArea:a}=e,{area:s,direction:l,relativeToModuleId:u}=o,c=i().Zm[s],m=(0,d().JO)(a,(e=>e.id===u));if(!m||m.area!==s)throw new Error(`Cannot find module with id: ${u} to add upsert relative to in ${s}`);if("views_main_tab_modules"===c){const e="views_main_tab_modules"===m.area?m.viewId:void 0;if(!e)throw new Error("Cannot upsert module into views_main_tab_modules area that does not have views");return n().N4X.putModuleBeforeOrAfter({pointer:r,area:"views_main_tab_modules",viewId:e,module:t,direction:"above"===l?"before":"after",beforeOrAfterId:u})}return n().N4X.putModuleBeforeOrAfter({pointer:r,area:c,module:t,direction:"above"===l?"before":"after",beforeOrAfterId:u})}function _(e){const{upsertPosition:o,rawModuleToUpsert:t,layoutPointer:r,modulesByArea:a}=e,{location:s}=o;if("views_main_tab_modules"===o.area){const e=o.viewId,l={pointer:r,area:i().Zm[o.area],viewId:e,module:t};if("start"===s||"end"===s)return n().N4X.putModuleBeforeOrAfter({...l,direction:"start"===s?"before":"after",beforeOrAfterId:void 0});if("end_moveable"===s){var d;const e=A({area:o.area,modulesInArea:(null===(d=a.views_main_tab_modules)||void 0===d?void 0:d[o.viewId])??[]});return n().N4X.putModuleBeforeOrAfter({...l,direction:e.insertDirection,beforeOrAfterId:e.beforeOrAfterId})}(0,m().HB)(s)}const l={pointer:r,area:i().Zm[o.area],module:t};if("start"===s||"end"===s)return n().N4X.putModuleBeforeOrAfter({...l,direction:"start"===s?"before":"after",beforeOrAfterId:void 0});if("end_moveable"===s){const e=a[o.area]??[],t=A({area:o.area,modulesInArea:e});return n().N4X.putModuleBeforeOrAfter({...l,direction:t.insertDirection,beforeOrAfterId:t.beforeOrAfterId})}(0,m().HB)(s)}function A(e){const{area:o,modulesInArea:t}=e,r=(0,u().jS)(o,t),n=r.nonMoveableHeaderModules,i="moveableCenterModules"in r?r.moveableCenterModules:[],a="moveableFooterModules"in r?r.moveableFooterModules:[];if(i.length){const e=i.at(-1);if(!e)throw new Error("cannot find last moveable center module to add below for end moveable");return{insertDirection:"after",beforeOrAfterId:e.id}}if(n.length){const e=n.at(-1);if(!e)throw new Error("cannot find last header module to add below for end moveable");return{insertDirection:"after",beforeOrAfterId:e.id}}if(a.length){const e=a.at(0);if(!e)throw new Error("cannot find first moveable footer module to add above for end moveable");return{insertDirection:"before",beforeOrAfterId:e.id}}return{insertDirection:"after",beforeOrAfterId:void 0}}}}]);