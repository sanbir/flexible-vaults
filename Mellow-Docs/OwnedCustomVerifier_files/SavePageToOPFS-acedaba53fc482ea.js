"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[82094],{402245:(e,n,t)=>{t.r(n),t.d(n,{SavePageToOPFS:()=>y});t(517642),t(658004),t(733853),t(845876),t(432475),t(515024),t(731698),t(898992),t(354520),t(908872);var a=t(296540),r=()=>t(907258),i=()=>t(59226),o=()=>t(395361),s=()=>t(484714),c=()=>t(590526),d=()=>t(452540),u=()=>t(134025),l=()=>t(179034);var g=()=>t(495074),k=()=>t(733539),f=(t(944114),()=>t(135168)),v=()=>t(726637),m=()=>t(585515),p=()=>t(577449),b=()=>t(388821),h=()=>t(870618),C=()=>t(369763);var _=()=>t(865085);function T(e){const n=(0,s().v3)(),t=e.id,T=_().OPFSBootupRegistry.isEnabled,[y,w]=(0,a.useState)(!1),S=(0,i().X)("opfs_save_page_strategy_revision_tracking")&&T,L=(0,i().X)("opfs_save_page_strategy_sync_tracking")&&T,E=(0,i().X)("opfs_save_page_strategy_background")&&T,P=(0,i().X)("opfs_save_page_strategy_navigation")&&T,A=(0,c().uB)(r().default),B={revisionTracking:S,syncTracking:L,backgrounded:E,navigation:P},I=(0,a.useCallback)((e=>{var t;null!==(t=A.state.currentLoadingContainerStore)&&void 0!==t&&t.state.endOfResultsReached&&async function(e,n,t){const a=(0,C().getOPFSPageCacheInstance)(),r=(0,f().f)(e);if(!n.currentUser.id||!r||!a)return;performance.mark("generate-chunk-start");const i=[];let o={stack:[]};const s=new Set;for(;o;){const t=b().RecordMapWithRole.create(),a=await(0,m().T)({page:{spaceId:r.id,id:e.id},limit:30,cursor:o,verticalColumns:!0,baseUrl:v().A.domainBaseUrl,publicDomainName:v().A.publicDomainName,shouldTraverseToggleBlocks:!0,contentBatchSize:30,sessionCombinedIds:s},p().h.fromMonomorphicFunctionUnsafe((async e=>{const a=await h().h7({environment:n,pointer:e,useInMemoryCacheOnly:!0,skipAccessWrites:!0,ignoreAllCaches:!0});return a?(t.setModelAndRole(e,a.model,a.role),s.add((0,d().jV)(e)),a.model):void 0})));if(i.push(t),0===a.cursorValue.stack.length){o=void 0;break}o=a.cursorValue}performance.mark("generate-chunk-end"),performance.measure("generate-chunk","generate-chunk-start","generate-chunk-end"),await a.write(n.currentUser.id,e.id,i)}(e,n).catch((e=>{}))}),[n,A]),D=(0,o().Y)((e=>{window.requestIdleCallback?window.requestIdleCallback((()=>I(e)),{timeout:1e4}):setTimeout((()=>I(e)),2e3)}),1e3),U=(0,a.useCallback)(((...e)=>{for(const n of e){const e=(0,d().W8)({combinedId:n.combinedId});"track_page"===n.type&&e.id===t?w(!0):"untrack_page"===n.type&&e.id===t&&w(!1)}}),[t]);(0,a.useEffect)((()=>{if(!B.revisionTracking&&!B.syncTracking)return void g().A.removeListener(U);g().A.addListener(U);return g().A.getPageBlockTrackerForPage({table:l().ev,id:t})&&w(!0),()=>g().A.removeListener(U)}),[t,U,B.revisionTracking,B.syncTracking]);const F=(0,a.useMemo)((()=>{if(!1!==y)return g().A.getPageBlockTrackerForPage({table:l().ev,id:t})}),[t,y]),M=(0,a.useCallback)((()=>{if(!F)return;performance.mark("revisionChangeDetectionStart");const n=k().default.state,t=n.undoStack[n.undoStack.length-1];if(!t)return;const a=t.transactions.reduce(((e,n)=>{for(const t of n.operations)if(t.pointer.table===l().ev&&e.add(t.pointer.id),(0,u().mP)(t)&&t.additionalUpdatedPointers)for(const n of t.additionalUpdatedPointers)n.table===l().ev&&e.add(n.id);return e}),new Set),r=F.getLiveBlocks().filter((({blockStore:e})=>a.has(e.id)));performance.mark("revisionChangeDetectionEnd");performance.measure("revisionChangeDetection","revisionChangeDetectionStart","revisionChangeDetectionEnd");r.length>0&&D(e)}),[F,e,D]);(0,a.useEffect)((()=>{if(T&&B.revisionTracking&&F)return k().default.addListener(M),()=>k().default.removeListener(M)}),[T,B.revisionTracking,F,M]);const R=(0,a.useCallback)((()=>{D(e)}),[e,D]),O=(0,o().Y)(R,50);(0,a.useEffect)((()=>{if(T&&B.syncTracking&&F)return F.addListener(O),()=>{F.removeListener(O)}}),[T,B.syncTracking,F,O]),(0,a.useEffect)((()=>{if(B.navigation)return()=>{D(e)}}),[B.navigation,e,D]);!function(e,n){const t=(0,o().Y)(e,(null==n?void 0:n.debounceTimeMs)??256),r=(0,a.useCallback)((()=>{document.hidden&&t()}),[t]),i=(0,a.useCallback)((()=>{t()}),[t]);(0,a.useEffect)((()=>(document.addEventListener("visibilitychange",r),window.addEventListener("blur",i),()=>{document.removeEventListener("visibilitychange",r),window.removeEventListener("blur",i),t.cancel()})),[t,r,i])}((0,a.useCallback)((()=>{T&&B.backgrounded&&D(e)}),[T,B.backgrounded,e,D]))}function y({pageStore:e}){return T(e),null}}}]);