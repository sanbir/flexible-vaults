"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[17693],{79976:(e,t,o)=>{o.r(t),o.d(t,{duplicateBlock:()=>S});o(16280),o(898992),o(823215),o(581454),o(737550);var s=()=>o(907258),i=()=>o(929219),r=()=>o(675133),n=()=>o(711339);class a{constructor(e){this.environment=void 0,this.metricName=void 0,this.startMetric=void 0,this.prevLapMetric=void 0,this.extraData=void 0,this.environment=e.environment,this.metricName=e.metricName,this.startMetric=n().default.mark(e.metricName),this.prevLapMetric=n().default.mark(e.metricName),this.extraData=e.extraData??{}}mark(e){n().default.measure(this.prevLapMetric,{environment:this.environment,data:{type:e,...this.extraData},sampleDecision:"default"}),this.prevLapMetric=n().default.mark(this.metricName)}end(){n().default.measure(this.startMetric,{environment:this.environment,data:{type:"total",...this.extraData},sampleDecision:"default"})}}var c=()=>o(792057),l=()=>o(489295),u=()=>o(723085),d=()=>o(700500),p=()=>o(665344),h=()=>o(854150),m=()=>o(763824),g=()=>o(973647),f=()=>o(863168),v=()=>o(37450),k=()=>o(544198),y=()=>o(418375),M=()=>o(360886),_=()=>o(977529),C=()=>o(761986),D=()=>o(731892),w=()=>o(949653),I=()=>o(677733);function S(e){if(e.skipUserFacingMessages)return b(e);const t=D().CU({sourceBlocks:e.stores});try{const o=b({...e,onRedundantDuplicationError:()=>{(0,_().Yv)()}});return{...o,onComplete:o.onComplete.then((e=>("success"===e.status?D().MK(t):D().UO(t),e))).catch((e=>{throw D().UO(t),e}))}}catch(o){throw D().UO(t),o}}function b(e){const{environment:t,stores:o,transaction:n,targetSpaceId:_,executionTarget:D,from:S,options:b,installationImprint:x,templateInstallationMetadata:T,shouldUseSynchronousDuplicationAPI:A,skipUserFacingMessages:B,onRedundantDuplicationError:P}=e,E="local"===(y().A.getState().executionTarget??D)?"local_duplication":A?"server_synchronous_duplication":"server_duplication",U=new a({environment:t,metricName:"duplicate_block_stopwatch",extraData:{duplication_type:E,from:S}});if(0===o.length)throw new Error("Must duplicate at least one block");const j=o[0].getSpaceId();if(!o.every((e=>e.getSpaceId()===j)))throw new Error("All stores must be in the same space");if(o.length>1&&!b.useSharedContext&&!o.every((e=>e.isTypedCollectionViewBlock())))throw new Error("Multiple source blocks only supported for grouped typed DB duplication unless useSharedContext option is true");!function(e){const{environment:t,stores:o}=e;for(const i of o){const e=(0,l().zH)(i).getValue();if(!e)continue;const{sidebarSpaceStore:o}=s().default.getState();let r;o&&e.parent_table===h().yK&&(r=u().h.createChildStore(o,{table:h().yK,id:e.parent_id}));const{collectionId:n,ownedCollectionCount:a,linkedCollectionCount:c}=(0,k().P)(i,{skipPages:!1}),p={from:"copy",type:e.type,teamStore:r,is_toggleable:(0,d().Yt)(e.type,e.format),collection_id:n,owned_collection_count:a,linked_collection_count:c,new_page_id:"page"===e.type?i.id:void 0,creating_block_id:i.id,parent_collection_id:i.getParentCollectionIdUpToTwoLevels(),form_id:i.getFirstFormIdInCollectionViewBlock()};v().tP(e.type)?v().vH(t,{...p,type:e.type,collection_id:n||""}):v().vH(t,{...p,type:e.type})}}({environment:t,stores:o}),U.mark("track_create_blocks"),b.convertExternalObjectInstancesToPlaceholders=j!==_;const F=T&&(0,p().Fe)(T.source)&&T.isListedTemplate;if(1===o.length&&"local_duplication"===E&&!F){const e=(0,w().tryLocalDuplicateWithTransaction)({environment:t,store:o[0],options:b,sourceSpaceId:j,targetSpaceId:_,transaction:n,installationImprint:x,templateInstallationMetadata:T,stopwatch:U,from:S});if(e)return U.mark("try_local_duplication_success"),U.end(),{blockStores:[e],onComplete:Promise.resolve({status:"success"})};U.mark("try_local_duplication_failure")}const N=t.defaultRecordCache.inMemoryRecordCache;if(o.some((e=>e.inMemoryRecordCache!==N)))throw new Error("Can only server duplicate from the environment.defaultRecordCache.inMemoryRecordCache.");i().A.state.online||c().f1(r().A.formatMessage(M().V.offlineError));const R=(0,I().serverDuplicate)({environment:t,sourceBlocks:o.map((e=>({id:e.id,spaceId:e.getSpaceId()}))),targetInMemoryRecordCache:N,transaction:n,targetSpaceId:_,installationImprint:x,templateInstallationMetadata:T,stopwatch:U,shouldUseSynchronousDuplicationAPI:A,options:b,from:S,onRedundantDuplicationError:P});if(U.mark("duplicate_block_immediate_return"),g().Q.isFail(R))throw B||(0,C().x)({environment:t,duplicateError:R.error}),R.error;const{blockStores:V,onComplete:O}=R.value,L=m().yX();return O.then((e=>{if(U.end(),g().Q.isSuccess(e)){for(const e of V)if("ai_block"===e.getType()){f().EF.setState(e.pointer.id);break}L.resolve({status:"success",recordIdMap:e.value.recordIdMap})}else{var o;B||(0,C().x)({environment:t,duplicateError:e.error,blockStores:V}),L.resolve({status:"error",error:e.error,errorMessage:null===(o=(0,C().V2)(e.error))||void 0===o?void 0:o.description})}})),{blockStores:V,onComplete:L.promise}}},418375:(e,t,o)=>{o.d(t,{A:()=>s});const s=o(757695).Store.createValue({executionTarget:null},{name:"DuplicationDebuggingStore"})},731892:(e,t,o)=>{o.d(t,{UO:()=>f,MK:()=>v,CU:()=>g});o(296540);var s=()=>o(128933),i=()=>o(784489),r=()=>o(590526),n=()=>o(388926),a=()=>o(98126),c=()=>o(700500),l=()=>o(69708),u=()=>o(534177),d=o(474848);const p=(0,l().YK)({pageDuplicatingMessage:{id:"duplicateProgressSnackbar.pageDuplicating",defaultMessage:"Page is duplicating"},contentDuplicatingMessage:{id:"duplicateProgressSnackbar.contentDuplicating",defaultMessage:"Content is duplicating"}});function h(e){const{sourceBlocks:t,stage:o}=e,s=(0,r().K8)((()=>!(t.length<1)&&t[0].isType(c().Gz)),[t]);let i;return"initial"===o?i=s?p.pageDuplicatingMessage:p.contentDuplicatingMessage:(0,u().HB)(o),(0,d.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:8},children:[(0,d.jsx)(a().k,{size:"sm",onDarkBackground:!0}),(0,d.jsx)("span",{children:(0,d.jsx)(l().sA,{...i})}),(0,d.jsx)("div",{style:{height:24},children:(0,d.jsx)(n().A,{type:"vertical",colorVariant:"inversePrimary",colorPalette:"gray",size:24})})]})}var m=()=>o(977529);function g(e){const{sourceBlocks:t}=e,o=new(m().DI)({sourceBlocks:t,showInitialMessage:k,onClear:y});return o.start(),o.id}function f(e){const t=(0,m().lq)(e);null==t||t.clear()}function v(e){const t=(0,m().lq)(e);null==t||t.complete()}function k(e){const t=(0,d.jsx)(h,{sourceBlocks:e,stage:"initial"});(0,i().f)({item:{label:t,durationMs:"keep"},onDismiss:()=>{(0,m().Yv)()}})}function y(){s().N2()}},784489:(e,t,o)=>{o.d(t,{f:()=>a});o(296540);var s=()=>o(69708),i=()=>o(203913),r=()=>o(128933),n=o(474848);function a(e){const{item:t,onDismiss:o}=e;r().D6({...t,right:(0,n.jsx)(i().Ag,{onClick:o??r().N2,children:(0,n.jsx)(s().sA,{id:"snackbar.dismiss.title",defaultMessage:"Dismiss"})})})}},935432:(e,t,o)=>{o.d(t,{A:()=>n});var s=()=>o(416845),i=()=>o(357264),r=()=>o(788579);function n(e,t){if((0,s().pA8)(t)){const o=(0,r().$)(t.clientData);if(o)return"messageValues"in t.clientData?e.formatMessage(o,t.clientData.messageValues):e.formatMessage(o)}return e.formatMessage(i().k.generic_error)}},977529:(e,t,o)=>{o.d(t,{DI:()=>c,Yv:()=>a,lq:()=>r});const s=2*o(615234).TD,i=new Map;function r(e){return i.get(e)}function n(){return i.values().next().value}function a(){const e=Array.from(i.values());for(const t of e)t.clear()}class c{constructor(e){this.id=void 0,this.sourceBlocks=void 0,this.currentTimeout=null,this.stage=void 0,this.showInitialMessage=void 0,this.onClear=void 0,this.id=(0,o(498212).Ay)(),this.sourceBlocks=e.sourceBlocks,this.stage="started",this.showInitialMessage=e.showInitialMessage,this.onClear=e.onClear,i.set(this.id,this)}isOldestActive(){return n()===this}start(){this.currentTimeout=setTimeout((()=>{this.stage="initial_message",this.isOldestActive()&&this.showInitialMessage(this.sourceBlocks)}),s)}showSnackbarForCurrentStage(){"started"===this.stage||("initial_message"===this.stage?this.showInitialMessage(this.sourceBlocks):(0,o(534177).HB)(this.stage))}clear(){this.currentTimeout&&(clearTimeout(this.currentTimeout),this.currentTimeout=null),i.delete(this.id),this.onClear(),function(){const e=n();e&&e.showSnackbarForCurrentStage()}()}complete(){this.isOldestActive()&&this.stage,this.clear()}}}}]);