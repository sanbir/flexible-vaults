(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[44425],{140290:(e,t,n)=>{const o=()=>n(194755),r=";",i=">",s="<";function a(e){let t="";e>0&&(t+=r);const n=e.toString();return n.length>1&&(t+=a(n.length)),t+=n,t}function c(e,t){if(!e)throw new Error(`Input is not a valid ELEN-encoded number: ${t}.`)}e.exports={encode:function(e){if("number"!=typeof e)throw new Error(`Value is not of type number: ${e}.`);const{sign:t,exponent:n,mantissa:r}=o().deconstruct(e);let c="";return c+=1===t?s:i,c+=a(1===t?o().MAX_EXPONENT-n:n),c+=a(1===t?o().MAX_MANTISSA-r:r),c},decode:function(e){if("string"!=typeof e)throw new Error(`Value is not of type string: ${e}.`);const{signLength:t,sign:n}=function(e,t){if(c(t<e.length,e),e[t]===i)return{signLength:1,sign:0};if(e[t]===s)return{signLength:1,sign:1};c(!1,e)}(e,0),{exponentLength:a,exponent:d}=function(e,t,n){if(c(n<e.length,e),"0"===e[n])return{exponentLength:1,exponent:0===t?0:o().MAX_EXPONENT};let i,s,a=n,d=0;for(;e[a]===r;)d+=1,a+=1;c(0!==d,e),s=1;for(;d>0;)i=s,s=Number.parseInt(e.substr(a,s)),c(s>0,e),a+=i,d-=1;return{exponentLength:a-n,exponent:0===t?s:o().MAX_EXPONENT-s}}(e,n,t),{mantissaLength:l,mantissa:u}=function(e,t,n){if(c(n<e.length,e),"0"===e[n])return{mantissaLength:1,mantissa:0===t?0:o().MAX_MANTISSA};let i,s,a=n,d=0;for(;e[a]===r;)d+=1,a+=1;c(0!==d,e),s=1;for(;d>0;)i=s,s=Number.parseInt(e.substr(a,s)),c(s>0,e),a+=i,d-=1;return{mantissaLength:a-n,mantissa:0===t?s:o().MAX_MANTISSA-s}}(e,n,t+a);return c(e.length===t+a+l,e),o().construct({sign:n,exponent:d,mantissa:u})}}},194755:e=>{const t=0xfffffffffffff;function n(e){return s(e[7],7)}function o(e){let t=0;return t+=i(127&e[7],4),t+=s(e[6],4),t}function r(e){let t=0;return t+=i(15&e[6],48),t+=i(e[5],40),t+=i(e[4],32),t+=i(e[3],24),t+=i(e[2],16),t+=i(e[1],8),t+=e[0],t}function i(e,t){return e*Math.pow(2,t)}function s(e,t){return Math.floor(e/Math.pow(2,t))}e.exports={MAX_EXPONENT:2047,MAX_MANTISSA:t,construct:function({sign:e,exponent:n,mantissa:o}){if(0!==e&&1!==e)throw new Error(`Invalid value for sign: ${e}.`);if("number"!=typeof n||n<0||2047<n)throw new Error(`Invalid value for exponent: ${n}.`);if("number"!=typeof o||o<0||t<o)throw new Error(`Invalid value for mantissa: ${o}.`);const r=new ArrayBuffer(8),a=new Float64Array(r),c=new Uint8Array(r);return function(e,t){t[7]|=i(e,7)}(e,c),function(e,t){t[7]|=s(e,4),t[6]|=i(15&e,4)}(n,c),function(e,t){t[6]|=255&s(e,48),t[5]|=255&s(e,40),t[4]|=255&s(e,32),t[3]|=255&s(e,24),t[2]|=255&s(e,16),t[1]|=255&s(e,8),t[0]|=255&e}(o,c),a[0]},deconstruct:function(e){if("number"!=typeof e)throw new Error(`Value is not of type number: ${e}.`);const t=new ArrayBuffer(8),i=new Float64Array(t),s=new Uint8Array(t);return i[0]=e,{sign:n(s),exponent:o(s),mantissa:r(s)}}}},352733:(e,t,n)=>{"use strict";n.d(t,{j:()=>i,n:()=>s});var o=()=>n(671593),r=()=>n(416845);function i(e,t,n={}){const i=(0,o().tf)(e,t,n);if(i)throw new(r().yI4)(i.message)}function s(e,t){const n=(0,o().tf)(e,t);if(void 0!==n)throw new(r().yI4)(n.message);return t}},408863:function(e,t,n){"use strict";var o=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n);var r=Object.getOwnPropertyDescriptor(t,n);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,o,r)}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&o(t,e,n);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.jsonCodec=t.Codec=t.MaxEncoding=t.MinEncoding=t.MAX=t.MIN=t.ObjectLegacyEncoding=t.ObjectEncoding=t.ArrayEncoding=t.NumberEncoding=t.StringEncoding=t.BooleanEncoding=t.NullEncoding=void 0;const s=i(n(140290)),a=()=>n(881270);t.NullEncoding={match:e=>null===e,encode:()=>"",decode:()=>null,compare:()=>0},t.BooleanEncoding={match:e=>!0===e||!1===e,encode:e=>JSON.stringify(e),decode:e=>JSON.parse(e),compare:a().compare},t.StringEncoding={match:e=>"string"==typeof e,encode:e=>e,decode:e=>e,compare:a().compare},t.NumberEncoding={match:e=>"number"==typeof e,encode:e=>s.encode(e),decode:e=>s.decode(e),compare:a().compare},t.ArrayEncoding={match:e=>Array.isArray(e),encode:(e,t)=>e.map(((e,n)=>t(e).replace(/\x01/g,"").replace(/\x00/g,"\0")+"\0")).join(""),decode:(e,t)=>{if(""===e)return[];const n=/(\x01(\x01|\x00)|\x00)/g,o=[];let r=0;for(;;){const i=n.exec(e);if(null===i)return o;if(""===i[0][0])continue;const s=i.index,a=t(e.slice(r,s).replace(/\x01\x01/g,"").replace(/\x01\x00/g,"\0"));o.push(a),r=s+1}},compare:(e,t,n)=>{const o=Math.min(e.length,t.length);for(let r=0;r<o;r++){const o=n(e[r],t[r]);if(0!==o)return o}return(0,a().compare)(e.length,t.length)}},t.ObjectEncoding={match:e=>"object"==typeof e&&null!==e&&Object.getPrototypeOf(e)===Object.prototype,encode:(e,n)=>{const o=function(e){const t=[];for(const n of e)for(const e of n)t.push(e);return t}(Object.entries(e).sort((([e],[t])=>(0,a().compare)(e,t))));return t.ArrayEncoding.encode(o,n)},decode:(e,n)=>{const o=function(e,t){const n=[];for(let o=0;o<e.length;o+=t){const r=e.slice(o,o+t);n.push(r)}return n}(t.ArrayEncoding.decode(e,n),2),r={};for(const[t,i]of o)r[t]=i;return r},compare:(e,t,n)=>{const o=Object.entries(e).sort((([e],[t])=>(0,a().compare)(e,t))),r=Object.entries(t).sort((([e],[t])=>(0,a().compare)(e,t))),i=Math.min(o.length,r.length);for(let s=0;s<i;s++){const[e,t]=o[s],[i,c]=r[s],d=(0,a().compare)(e,i);if(0!==d)return d;const l=n(t,c);if(0!==l)return l}return(0,a().compare)(o.length,r.length)}},t.ObjectLegacyEncoding={match:e=>"object"==typeof e&&null!==e&&Object.getPrototypeOf(e)===Object.prototype,encode:(e,n)=>{const o=Object.entries(e).sort((([e],[t])=>(0,a().compare)(e,t)));return t.ArrayEncoding.encode(o,n)},decode:(e,n)=>{const o=t.ArrayEncoding.decode(e,n),r={};for(const[t,i]of o)r[t]=i;return r},compare:t.ObjectEncoding.compare},t.MIN=Symbol("min"),t.MAX=Symbol("max"),t.MinEncoding={match:e=>e===t.MIN,encode:()=>"",decode:()=>t.MIN,compare:()=>0},t.MaxEncoding={match:e=>e===t.MAX,encode:()=>"",decode:()=>t.MAX,compare:()=>0};class c{constructor(e){this.encodings=e,this.encode=e=>{for(const[t,n]of Object.entries(this.encodings))if(n.match(e))return t+n.encode(e,this.encode);throw new Error(`Missing encoding for value: ${e}`)},this.decode=e=>{const t=e[0],n=e.slice(1);for(const[o,r]of Object.entries(this.encodings))if(o===t)return r.decode(n,this.decode);throw new Error(`Missing encoding for value: ${e}`)},this.compare=(e,t)=>{if(e===t)return 0;let n,o;for(const[r,i]of Object.entries(this.encodings))if(!n&&i.match(e)&&(n=[r,i]),!o&&i.match(t)&&(o=[r,i]),n&&o)break;if(!n)throw new Error(`Missing encoding for value: ${e}`);if(!o)throw new Error(`Missing encoding for value: ${t}`);return n[0]!==o[0]?(0,a().compare)(n[0],o[0]):n[1].compare(e,t,this.compare)};for(const t in e)if(1!==t.length)throw new Error(`Encoding prefix is not 1 byte: ${t}`)}}t.Codec=c,t.jsonCodec=new c({"\0":t.MinEncoding,b:t.NullEncoding,c:t.ObjectEncoding,d:t.ArrayEncoding,e:t.NumberEncoding,f:t.StringEncoding,g:t.BooleanEncoding,"ÿ":t.MaxEncoding})},409971:(e,t,n)=>{"use strict";n.r(t),n.d(t,{SqliteCorruptionRecoveryStatusStore:()=>ve,attemptFetchOfflinePages:()=>pe,cacheSidebarImagesDebounced:()=>J,debugAttemptFetch:()=>Qe,loadRemotePageAndImagesBatched:()=>W,useCacheSidebarImages:()=>xe,useFetchImportantPagesAfterSqliteCorruptionRecovery:()=>et,useOfflineTransitionTracking:()=>Ke,usePageSubscriptionManager:()=>Ue,useRefetchOfflinePages:()=>Je,useUpdateAutosyncedPages:()=>je().u});n(16280),n(944114),n(517642),n(658004),n(733853),n(845876),n(432475),n(515024),n(731698),n(898992),n(354520),n(581454);var o=()=>n(726637),r=()=>n(700500),i=()=>n(992437),s=()=>n(785728),a=()=>n(142748),c=()=>n(388821),d=()=>n(179034),l=()=>n(430837),u=()=>n(638681),f=()=>n(852832);const g=u().lazy((()=>u().union([u().tuple([u().instanceOf(y),u().instanceOf(Date),u().instanceOf(y),u().instanceOf(y),u().string()]),u().tuple([u().instanceOf(y),u().instanceOf(Date),u().instanceOf(y),u().isNull(),u().isNull()])])));let p;const h=-2n,m={BEFORE_ALL_OFFSETS:h,atStart:()=>({type:1,timestamp:-1,offset:h}),atTimestamp:e=>({type:1,timestamp:e,offset:h}),encode:function(e){let t;if(e.pointer){const o="number"==typeof e.pointer.encodedTable?e.pointer.encodedTable:(0,n(561190).vi)(e.pointer.encodedTable);t=[new y(e.type,16),new Date(e.timestamp),new y(e.offset,64),new y(o,16),e.pointer.id]}else t=[new y(e.type,16),new Date(e.timestamp),new y(e.offset,64),null,null];return(0,n(747595)._)(w.encode(t))},decode:function(e){try{const t=w.decode(e);(0,n(352733).j)(g,t);const[o,r,i,s,a]=t,c=o.toFloat64(),d=1;if(c!==d)throw new Error(`decoded type from payload[0]: is \`${c}\`, should be \`${d}\``);const l={type:c,timestamp:r.getTime(),offset:i.value};return s&&null!==a&&(l.pointer={encodedTable:s.toFloat64(),id:a}),l}catch(t){const e=(0,n(319625).A)(t);throw e.message=`SyncCursor decode error: ${e.message}`,e}},encodedStartCursor:()=>p??=m.encode(m.atStart()),encodedAtTimestamp:e=>m.encode(m.atTimestamp(e))};function v(e,t){return e<t?-1:e>t?1:0}class b{constructor(e){this.prefix="i",this.match=e=>Boolean(e&&e instanceof y&&e.bits===this.bits),this.compare=(e,t)=>v(e.value,t.value),this.encode=e=>this.encodeBigint(e.value),this.decode=e=>new y(this.decodeBigint(e),this.bits),this.encodeBigint=e=>{this.assertFitsBits(e);const t=e<0n?"-":"",n=e<0n?2n**BigInt(this.bits)+e:e;if(n<0n)throw new Error(`Expected abs value twos compliment >0, instead was: ${n}`);const o=n.toString(16).padStart(this.bits/4,"0");return`${t}${this.prefix}${o}`},this.decodeBigint=e=>{const t="-"===e[0]?e.slice(1+this.prefix.length):e.slice(this.prefix.length),n=BigInt("0x"+t);return BigInt.asIntN(this.bits,n)},this.assertFitsBits=e=>{const t=BigInt.asIntN(this.bits,e);if(t!==e)throw new Error(`IntN bigint out of range for IntN<${this.bits}>: truncated to ${t}, expected ${e}`)},this.bits=e}}class y{constructor(e,t){this.value=void 0,this.bits=t,this.value=BigInt(e)}toFloat64(){if(this.value>BigInt(Number.MAX_SAFE_INTEGER)||this.value<BigInt(Number.MIN_SAFE_INTEGER))throw new Error(`IntN value ${this.value} out of range ${Number.MIN_SAFE_INTEGER}-${Number.MAX_SAFE_INTEGER} for Float64`);return Number(this.value)}toString(){return`IntN<${this.bits}>(${this.value})`}}const _={match:e=>Boolean(e&&e instanceof Date),compare:(e,t)=>v(e,t),encode:e=>e.toISOString(),decode:e=>new Date(e)},w=new(l().Codec)({"\0":l().MinEncoding,'"':l().StringEncoding,"#":l().NumberEncoding,"%":_,2:new b(16),4:new b(32),8:new b(64),"?":l().BooleanEncoding,"[":l().ArrayEncoding,"{":l().ObjectEncoding,"þ":l().NullEncoding,"ÿ":l().MaxEncoding});(0,f().exposeDebugValue)("SyncCursor",m),(0,f().exposeDebugValue)("SyncCursorCodec",w);var S=()=>n(449412),I=()=>n(496603),T=()=>n(763824),C=()=>n(534177),R=()=>n(769864),E=()=>n(206135),M=()=>n(144460),O=()=>n(217558),P=()=>n(530684),A=()=>n(451169),k=()=>n(996720);function q(e,t){const n=t.getModel({table:d().ev,id:e});if((null==n?void 0:n.getType())===r().xd.collectionView)return[];return t.getModelsByTable(d().ev).filter((n=>((t,n)=>{if(t.getType()!==r().xd.collectionView)return!1;const o=(0,a().MR)(t.pointer,n);for(const i of o.slice(1)){if(i.id===e)return!0;if(i.table===d().ev&&i.getType()===r().xd.page)return!1}return!1})(n,t))).map((e=>e.id))}function x(e){const{pageId:t,cellId:n}=e;return[t,n||"NoCellId","EmptyStack"].join("|")}function N(e){const{cursorItem:t,pageId:n,cellId:o}=e,{id:r,table:i,index:s}=t;return[n,o||"NoCellId",r,i,s].join("|")}n(964979);var F=()=>n(825237),$=()=>n(651124),B=()=>n(837420),U=()=>n(201980),L=()=>n(179266),j=()=>n(944620);function D({icon:e,permissionRecord:t,recordMap:n,environment:o}){var r;const i=(0,$().WO)(e);switch(i.type){case"custom_emoji":const s=(null==n?void 0:n.getModel(i.emoji.pointer))??o.defaultRecordCache.inMemoryRecordCache.getRecordModel({pointer:i.emoji.pointer,userId:o.currentUser.id});if(!s)return;const a=null===(r=s.getIconIfAlive())||void 0===r?void 0:r.icon;if(!a)return;return{url:a,permissionRecord:i.emoji.pointer};case"url":return{url:e,permissionRecord:t};case"unicode_emoji":case"notion_icon":case"app_package_asset":return;default:(0,C().HB)(i)}}async function V({urlAndPermissionRecords:e,environment:t,abortSignal:n}){for(const{url:o,permissionRecord:r}of e){const e=await(0,L().L)({url:o,isAuthenticated:!0,permissionRecord:r},t),i=F().MU(e);i&&await new Promise(((e,t)=>{if(n.aborted)return void t(new(j().f));const o=new Image,r=()=>{o.onload=null,o.onerror=null};o.onload=()=>{r(),e()},o.onerror=n=>{r(),n instanceof DOMException&&"AbortError"===n.name||n instanceof j().f?t(new(j().f)):(S().O8(n,{from:"cacheImagesForOffline",type:"error",data:{url:i}}),e())},o.src=i}))}}const K=100;async function W(e){var t;const{request:n,environment:o,abortSignal:i,skipBatching:s}=e,a=performance.now();let c=0;const l=(0,M().L)("download_batch_size");if(l<1)return{imageCount:0,downloadedVersion:void 0,downloadedSyncCursor:void 0,collectionViewBlockIds:[],pageDownloadTime:0,imagesDownloadTime:void 0,batchedSyncCount:0};const u=s?1:l;let f;switch(n.type){case"syncOfflinePages":f=await G.getInstance().syncPage({batchSize:u,request:n,environment:o,abortSignal:i});break;case"syncPageRecordSinceTimestamp":f=await H.getInstance().syncPage({batchSize:u,request:n,environment:o,abortSignal:i});break;default:(0,C().HB)(n)}i.throwIfAborted();const g=performance.now(),p=f.recordMap.getModel({table:d().ev,id:n.page.id});let h;if(p&&"full"===(0,E().U)(o)){const e=function({blockModel:e,environment:t,recordMap:n}){const o=[],i=[e.pointer,...e.getRenderableContentPointers()],s=new Set;if(e.getType()===r().xd.page){const t=e.getFormatValue("page_cover");t&&o.push({url:t,permissionRecord:e.pointer})}for(;i.length;){const e=i.shift();if(!e)continue;if(s.has(e.id))continue;s.add(e.id);const c=(null==n?void 0:n.getModel(e))??t.defaultRecordCache.inMemoryRecordCache.getRecordModel({pointer:e,userId:t.currentUser.id});if(c){if(c.getType()===r().xd.image){const e=c.getFormatValue("display_source");e&&o.push({url:e,permissionRecord:c.pointer})}else if(c.getType()===r().xd.page||c.getType()===r().xd.callout){const e=c.getFormatValue("page_icon");if(e){const r=D({icon:e,permissionRecord:c.pointer,recordMap:n,environment:t});r&&o.push(r)}}else if(c.isCollectionView()){const e=c.getCollectionPointers()??[];for(const r of e){const e=(null==n?void 0:n.getModel(r))??t.defaultRecordCache.inMemoryRecordCache.getRecordModel({pointer:r,userId:t.currentUser.id});if(e){const i=e.getRawIcon();if(i){const e=D({icon:i,permissionRecord:r,recordMap:n,environment:t});e&&o.push(e)}}}}else if((0,r().Db)(c.getType(),c.getFormat())){const e=c.getProperties().title,r=U().air(e,{spaceId:void 0,inlinePageLink:void 0}).filter((e=>e.table===B().e));for(const i of r){const e=(null==n?void 0:n.getModel(i))??t.defaultRecordCache.inMemoryRecordCache.getRecordModel({pointer:i,userId:t.currentUser.id});if(e){var a;const t=null===(a=e.getIconIfAlive())||void 0===a?void 0:a.icon;t&&o.push({url:t,permissionRecord:i})}}}if(!c.isNavigableBlock())if(c.getType()===r().xd.transclusionReference){const e=c.getTransclusionReferenceTargetPointer();if(!e)continue;const o=(null==n?void 0:n.getModel(e))??t.defaultRecordCache.inMemoryRecordCache.getRecordModel({pointer:e,userId:t.currentUser.id});if(!o)continue;i.push(...o.getRenderableContentPointers())}else i.push(...c.getRenderableContentPointers())}}return o}({blockModel:p,environment:o,recordMap:f.recordMap});i.throwIfAborted(),c=e.length,await V({urlAndPermissionRecords:e,environment:o,abortSignal:i}),i.throwIfAborted();h=performance.now()-g}const m=g-a;return{imageCount:c,downloadedVersion:f.serverPageVersionsByPageId[n.page.id],downloadedSyncCursor:null===(t=f.serverPageSyncCursorsByPageId)||void 0===t?void 0:t[n.page.id],collectionViewBlockIds:q(n.page.id,f.recordMap),pageDownloadTime:m,imagesDownloadTime:h,batchedSyncCount:f.batchedSyncCount}}function X(){return(0,M().L)("download_max_requests_per_api_call")}class z{constructor(e){this.queueBySize=new(n(99895).G)((e=>this.createQueue(e))),this.performRequests=e}async enqueue(e,t){if(e<=1){const[e]=await this.performRequests([t]);return e}return this.queueBySize.get(e).enqueue(t)}createQueue(e){return new(n(56322).A)({performRequests:this.performRequests,batchSize:e,maxWorkers:1,requestDelayMs:100})}}class G{constructor(){this.queue=new z((async e=>{const t=await async function(e){var t;const{requestBatch:l,environment:u,abortSignal:f}=e,{trackRequests:g,filterNextRequests:p}=function(){const e=new Set([]),t=new Set([]);return{trackRequests:function(n){for(const{page:o,cellId:r,cursor:i}of n){0===i.stack.length&&e.add(x({pageId:o.id,cellId:r}));for(const e of i.stack)for(const n of e)t.add(N({cursorItem:n,pageId:o.id,cellId:r}))}},filterNextRequests:function(n){const o=[];for(const r of n){const{cellId:n,page:i}=r,s=[];0===r.cursor.stack.length&&(e.has(x({pageId:i.id,cellId:n}))||o.push(r));for(const e of r.cursor.stack){const o=[];for(const r of e){const e=N({cursorItem:r,pageId:i.id,cellId:n});t.has(e)||o.push(r)}o.length>0&&s.push(o)}const a=n?{stack:s,cellId:n}:{stack:s};s.length>0&&o.push({...r,cursor:a})}return o}}}(),h=[],m={};let v=0,b=0;const y=[],_=[],w=n(206267).JW();let E=l.map((({page:e,offlinePageMetadata:t,originType:n,isOrigin:o})=>({page:e,lastDownloadedVersion:null==t?void 0:t.last_downloaded_version,originType:n,isOrigin:o,cursor:{stack:[]},forceFresh:!1})));for(;E.length>0&&b<K;){g(E),y.push(E);const e=new Map;for(const o of E)e.set(o.page.id,o);const t=E.map((e=>({...e,headers:(0,s().WS)({recordId:e.page.id,spaceId:e.page.spaceId,cellId:e.cellId})}))),n=(0,s().E5)(t),l=await T().lX(n.entries(),10,(async([e,t])=>{const n=X();return await T().vA(t,n,(async t=>{const n=t.map((e=>I().cJ(e,["cellId"]))),r=await R().callApi({eventName:"syncOfflinePages",environment:u,data:{requests:n,verticalColumns:o().A.isMobile,dedupeSessionId:w},headers:e,inMemoryRecordCache:A().o,abortSignal:f});return v++,"failed"===r.type?{...r,requestBatch:t}:r}))})),M=[];for(const o of l.flat()){if("failed"===o.type){const e=new(k().y)(o);throw o.offline||S().O8(e,{from:"loadRemotePages",type:"syncOfflinePagesFailed",data:{syncOfflinePagesRequests:o.requestBatch}}),e}const t=c().RecordMapWithRole.create(o.data.recordMap);h.push(t);for(const[e,r]of Object.entries(o.data.serverPageVersionsByPageId))m[e]=r;o.data.offlineModeSettings&&P().h.updateSettings(o.data.offlineModeSettings);for(const r of o.data.nextChunks)for(const t of r.cursors){const{cellId:n}=t,o=e.get(r.page.id);M.push({page:r.page,lastDownloadedVersion:void 0,cursor:t,cellId:n,originType:(null==o?void 0:o.originType)??"none",isOrigin:(null==o?void 0:o.isOrigin)??!1,forceFresh:r.forceFresh})}const n=i().b.fromRecordMapWithRole(t),s=t.getModelsByTable(d().ev).filter((e=>(0,r().Yt)(e.getType(),e.getFormat()))).map((t=>{const o=(0,a().LW)(t.pointer,n),r=(0,a().J_)(o,(t=>e.has(t.id)));if(r)return{model:t,ancestorInRequests:r}})).filter(C().O9);M.push(...s.map((({model:t,ancestorInRequests:n})=>{const o=e.get(n.id);return{page:{id:t.id,spaceId:t.getSpaceId()},cursor:{stack:[]},lastDownloadedVersion:void 0,originType:(null==o?void 0:o.originType)??"none",isOrigin:(null==o?void 0:o.isOrigin)??!1,forceFresh:(null==o?void 0:o.forceFresh)??!1}})));for(const e of o.data.pagesToDelete){const{currentUser:{id:t},defaultRecordCache:{persistedRecordCache:n},sqliteConnection:o}=u;t&&n&&o&&((0,O().L)({connection:o,userId:t,originPageId:e,autosyncTypes:["not_autosynced"]}),n.deleteRecord({table:d().ev,id:e},t))}_.push(o.handleRecordMapForResponsePromise)}E=p(M),b++}b>=K&&S().O8(new Error("Recursively fetched syncOfflinePages too many times."),{from:"loadRemotePages",type:"infiniteFetchPrevented"});return await Promise.all(_),await(null===(t=u.defaultRecordCache.persistedRecordCache)||void 0===t?void 0:t.flushPendingWrites()),{recordMap:c().RecordMapWithRole.merge(h),serverPageVersionsByPageId:m,serverPageSyncCursorsByPageId:void 0,batchedSyncCount:v}}({environment:e[0].environment,requestBatch:e.map((e=>e.request)),abortSignal:(0,n(245725).N)(e.map((e=>e.abortSignal)))});return e.map((()=>t))}))}static getInstance(){return G.instance??=new G}syncPage(e){return this.queue.enqueue(e.batchSize,e)}}G.instance=void 0;class H{constructor(){this.queue=new z((e=>this.performSyncPageRecordSinceTimestampRequests(e)))}static getInstance(){return H.instance??=new H}syncPage(e){return this.queue.enqueue(e.batchSize,e)}async performSyncPageRecordSinceTimestampRequests(e){var t;if(0===e.length)return[];const{environment:n,abortSignal:o}=e[0],r=c().RecordMapWithRole.create(),i=new Map;let a=0,l=0;const u=[];for(const c of e){const{page:e,offlinePageMetadata:t}=c.request;if(i.has(e.id))continue;const n=(null==t?void 0:t.last_downloaded_sync_cursor)??m.encodedStartCursor();i.set(e.id,{page:e,shouldDelete:!1,nextCursor:n,lastCursor:n,done:!1,initialCursor:n,headers:(0,s().WS)({recordId:e.id,spaceId:e.spaceId,cellId:void 0})})}const f=new Set(i.keys()),g=async e=>{const t=(0,s().E5)(e.map((e=>{const t=i.get(e);if(!t)throw new Error("Page state not found");return t})).filter((e=>e.nextCursor)));return await T().lX(t.entries(),10,(async([e,t])=>{const r=X();return await T().vA(t,r,(async t=>{const r=t.map((({page:e,nextCursor:t})=>{if(!t)throw new Error(`Internal sync error: page ${e.id} has no next cursor`);return{page:e,cursor:t}})),i=await R().callApi({eventName:"syncPageRecordSinceTimestamp",environment:n,data:{requests:r},headers:e,inMemoryRecordCache:A().o,abortSignal:o});return a++,"failed"===i.type?{...i,requestBatch:r}:i}))}))};for(;f.size>0&&l<K;){const e=await g(Array.from(f));for(const t of e.flat()){if("failed"===t.type){const e=new(k().m)(t);throw t.offline||S().O8(e,{from:"loadRemotePages",type:"syncPageRecordSinceTimestampFailed",data:{syncPageRecordSinceTimestampRequests:t.requestBatch}}),e}const e=c().RecordMapWithRole.create(t.data.recordMap);r.assign(e);const o=[];for(const[n,r]of Object.entries(t.data.results)){const e=i.get(n);if(!e)throw new Error(`Server returned unexpected page id: ${n}`);e.shouldDelete=e.shouldDelete||r.shouldDelete,e.nextCursor=r.nextCursor,e.lastCursor=r.lastCursor??r.nextCursor??e.lastCursor,e.done=!r.nextCursor||r.shouldDelete,e.done&&f.delete(n),e.shouldDelete&&o.push(n)}for(const t of o){const{currentUser:{id:e},defaultRecordCache:{persistedRecordCache:o},sqliteConnection:r}=n;e&&o&&r&&((0,O().L)({connection:r,userId:e,originPageId:t,autosyncTypes:["not_autosynced"]}),o.deleteRecord({table:d().ev,id:t},e))}u.push(t.handleRecordMapForResponsePromise)}l++}l>=K&&S().O8(new Error("Recursively fetched syncPageRecordSinceTimestamp too many times."),{from:"loadRemotePages",type:"infiniteFetchPrevented",data:{}});const p={},h={};for(const[s,c]of i.entries()){c.lastCursor!==c.initialCursor&&(h[s]=c.lastCursor);const e=r.getModel({table:d().ev,id:s});e&&(p[s]=e.getVersion())}await Promise.all(u),await(null===(t=n.defaultRecordCache.persistedRecordCache)||void 0===t?void 0:t.flushPendingWrites());const v={recordMap:r,serverPageVersionsByPageId:p,serverPageSyncCursorsByPageId:h,batchedSyncCount:a};return e.map((()=>v))}}H.instance=void 0;const J=(0,I().sg)((async function({pageStores:e,environment:t,currentUserId:o,sidebarSpaceStore:r,abortSignal:i}){o&&r&&(i.aborted||await navigator.locks.request(`sidebar_images_${o}_${r.id}`,{ifAvailable:!0},(async s=>{var a;if(!s)return;const c=[],d=null===(a=r.getIcon())||void 0===a?void 0:a.icon;if(d){const e=D({icon:d,permissionRecord:r.pointer,recordMap:void 0,environment:t});e&&c.push(e)}for(const n of e){var l;const e=null===(l=n.getIcon())||void 0===l?void 0:l.icon;if(e){const o=D({icon:e,permissionRecord:n.pointer,recordMap:void 0,environment:t});o&&c.push(o)}const r=n.getTitleValue(),s=U().air(r,{spaceId:void 0,inlinePageLink:void 0}).filter((e=>e.table===B().e));for(const n of s){const e=t.defaultRecordCache.inMemoryRecordCache.getRecordModel({pointer:n,userId:o});if(e){var u;const t=null===(u=e.getIconIfAlive())||void 0===u?void 0:u.icon;t&&c.push({url:t,permissionRecord:n})}}i.throwIfAborted()}await V({urlAndPermissionRecords:c,environment:t,abortSignal:i}),(0,n(564884).u)({environment:t,event:{eventName:"offline_cache_sidebar_images",eventProperties:{number_of_images_fetched:c.length}}})})))}),1e4);var Q=()=>n(755531),Z=()=>n(44551),Y=()=>n(711339),ee=()=>n(745875),te=()=>n(202945),ne=()=>n(95723),oe=()=>n(959462),re=()=>n(22472),ie=()=>n(430476),se=()=>n(68336),ae=()=>n(644852);var ce=()=>n(543159);var de=()=>n(922742),le=()=>n(816047);const ue=5;let fe=!1;function ge(e){fe&&console.log(`[attemptFetchOfflinePages] ${e()}`)}async function pe(e){const{environment:t,abortSignal:n}=e,{sqliteConnection:o,currentUser:{id:r}}=t;if(!o||!r)return;if("page_subscription_update"===e.fetchTriggerType)return void(await navigator.locks.request(`offline_background_task_${t.currentUser.id}`,(async o=>{if(o)return he({environment:t,fetchTriggerType:e.fetchTriggerType,abortSignal:n,pageSubscriptionUpdate:e.pageSubscriptionUpdate})})));const{fetchTriggerType:i}=e;await navigator.locks.request(`toggle_offline_page_${t.currentUser.id}`,(()=>{})),n.aborted||await navigator.locks.request(`offline_background_task_${t.currentUser.id}`,{ifAvailable:!0},(async e=>{if(!e)return void ge((()=>"Skipping default interval refetch because another default interval refetch is already in progress"));ge((()=>`Acquired lock for ${i}.`)),ge((()=>"Checking when we last refetched."));const s=await(0,de().T)({connection:o,userId:r,taskType:"refetch"});if(s&&"force_debug"!==i){const e=Date.now()-s,t=(0,M().L)("refetch_interval_ms");if(e<.95*t)return void ge((()=>`Skipping refetch because we refetched ${e/1e3/60} minutes ago.`))}const a=await(0,de().T)({connection:o,userId:r,taskType:"refetch_collections"}),c=(0,M().L)("refetch_collections_interval_ms"),d=void 0===a||Date.now()-a>c,l=Date.now();await he({environment:t,fetchTriggerType:i,abortSignal:n,shouldRefetchCollections:d}),await(0,le().I)({connection:o,userId:r,taskType:"refetch",lastExecutedAt:l}),d&&await(0,le().I)({connection:o,userId:r,taskType:"refetch_collections",lastExecutedAt:l})}))}async function he(e){const{environment:t,fetchTriggerType:n,abortSignal:o}=e,{sqliteConnection:r,currentUser:{id:i}}=t,s=performance.now();if(!r||!i)return;const a=await async function(e){const{environment:t,fetchTriggerType:n}=e;return"page_subscription_update"===n?async function(e){const{environment:t,pageSubscriptionUpdate:n}=e,{sqliteConnection:o,currentUser:{id:r}}=t,{pageId:i,lastServerUpdateTime:s}=n;if(!o||!r)return[];const a=await(0,te().c)({connection:o,pageId:i,userId:r});if(!a)return[];if(void 0===a.last_downloaded_at||a.last_downloaded_at<s)return[a];return[]}({environment:t,pageSubscriptionUpdate:e.pageSubscriptionUpdate}):"sqlite_corruption_recovery"===n?async function(e){var t;const{currentUser:{id:n},sqliteConnection:o}=e;if(!n)return[];const r=null===(t=(0,Q().S)())||void 0===t?void 0:t.id;if(!o)return[];const i=await(0,ne().W)({connection:o,userId:n,spaceId:void 0,excludeAutosyncedPages:!0});return Array.from(r?[...i].sort(((e,t)=>(e.space_id===r?0:1)-(t.space_id===r?0:1))):i)}(t):"default_interval"===n||"app_boot_or_user_change"===n||"force_debug"===n?async function(e,t){var n;const{currentUser:{id:o},sqliteConnection:r}=e;if(!o)return[];const i=null===(n=(0,Q().S)())||void 0===n?void 0:n.id;if(!i)return[];if(!r)return[];let s=[];if(t){const e=(0,M().L)("num_collections_per_refetch");s=await async function(e){const{connection:t,userId:n,limit:o}=e,r=se().F4`
		WITH offline_page_metadata AS (
			${(0,ce().y)({userId:n})}
		)
		SELECT * FROM offline_page_metadata
		JOIN block ON offline_page_metadata.id = block.id
		WHERE (block.type = 'collection_view_page' OR block.type = 'collection_view')
		AND offline_page_metadata.download_status = 'success'
		ORDER BY last_downloaded_at ASC
		LIMIT ${o}
	`,i=(await(0,ie().G2)({connection:t,statements:[r.asRead()],queryName:"getOfflineCollectionViewBlocksForRefetch"}))[0].data;return ae().m.rowsFromSqlite(i)}({connection:r,userId:o,limit:e})}const a=(0,M().L)("num_pages_per_refetch"),c=(await(0,ne().W)({connection:r,userId:o,spaceId:i,orderBy:"mostStaleFirst"})).filter((e=>"failed"===e.download_status||"to_download"===e.download_status||"downloading"===e.download_status||void 0===e.download_status)).slice(0,a),d=new Map;for(const u of[...s,...c])d.set(u.id,u);const l=Array.from(d.values());return l}(t,e.shouldRefetchCollections):[]}(e);if(o.aborted)return;if(0===a.length)return;ge((()=>`Refetching ${a.length} pages in batches of ${ue}.`)),ge((()=>`Fetching ids: ${a.map((e=>e.id)).join(", ")}`)),ge((()=>"--------------------------------"));const c={imageCount:0,batchedSyncCount:0,queryCollectionCount:0},d=new Set;if(await T().lX(a,ue,(async e=>{var n;const s=e.id,a=null===(n=oe().A.state.offlinePages)||void 0===n||null===(n=n[s])||void 0===n?void 0:n.last_downloaded_version;ge((()=>`Fetching page ${s}. Last downloaded version: ${a}.`));try{const n=await async function(e){const{connection:t,impactedPageId:n,userId:o}=e,r=(await(0,ie().G2)({connection:t,statements:[se().F4`SELECT * FROM offline_action WHERE impacted_page_id = ${n} AND meta_user_id = ${o}`.asRead()],queryName:"getOfflineActionsForImpactedPage"}))[0].data;return ae().q.rowsFromSqlite(r)}({connection:r,impactedPageId:s,userId:i}),l=n.map((e=>({autosyncType:e.autosync_type,originPageId:e.origin_page_id}))).filter((e=>(0,C().O9)(e.autosyncType)&&(0,C().O9)(e.originPageId)));if(!(0,C().EI)(l))return void ge((()=>`Warning: skipping refetch of page ${s} because it has no origin autosync type pairs.`));const u=await(0,re().og)({from:"useRefetchOfflinePages",page:{id:s,spaceId:e.space_id},environment:t,originAutosyncTypePairs:l,visitedBlockIds:{forThisOriginPage:new Set,forThisInterval:d},stats:c,downloadAbortSignal:o});o.throwIfAborted(),ge((()=>`Fetched and saved page ${s}. Last downloaded version: ${a}. Version from server: ${null==u?void 0:u.downloadedVersion}.`))}catch(l){l instanceof j().f||(ge((()=>`Fetch page ${s} failed.${l instanceof Error?` Error: ${l.message}`:""}`)),S().O8(l,{from:"useRefetchOfflinePages",type:"loadRemotePageAndImagesError",data:{pageId:s}}))}})),"force_debug"!==n){var l,u;const o=await(0,ne().W)({connection:r,userId:i});let d=0,f=0,g=0,p=0;for(const e of o)(e.is_autosynced_origin||e.is_explicitly_offlined_origin||e.is_offline_created_origin)&&p++,e.is_explicitly_offlined_origin&&d++,e.is_autosynced_origin&&f++,e.is_offline_created_origin&&g++;const h=(0,ee().JZ)(o.map((e=>e.last_downloaded_at)).filter((e=>void 0!==e))),m=await(null===Z().electronApi||void 0===Z().electronApi||null===(l=Z().electronApi.getSqliteDiskUsage)||void 0===l?void 0:l.call(Z().electronApi));Y().default.measure({metricName:"background_refetch_offline_pages",startTime:s,endTime:performance.now()},{environment:t,data:{fetch_trigger_type:n,fetch_trigger_update_source:"page_subscription_update"===n?null===(u=e.pageSubscriptionUpdate)||void 0===u?void 0:u.updateSource:void 0,fetch_interval_ms:(0,M().L)("refetch_interval_ms"),number_of_offline_pages_fetched:a.length,total_number_of_offline_pages:Object.keys(oe().A.state.offlinePages??{}).length,median_last_updated_at:h,number_of_images_fetched:c.imageCount,total_number_of_explicitly_marked_offline_pages:d,total_number_of_pages_created_offline:g,total_number_of_offline_origin_pages:p,total_number_of_favorites:0,total_number_of_recents:f,number_of_images_fetched_per_page:c.imageCount/a.length,...c.didUseBatchedApi?{number_of_sync_offline_pages:c.batchedSyncCount,number_of_sync_offline_pages_per_page:c.batchedSyncCount/a.length}:{number_of_load_page_chunk_v2_for_offline_per_page:c.batchedSyncCount/a.length},number_of_query_collection_per_page:c.queryCollectionCount/a.length,disk_usage:t.device.isElectron?m:void 0}})}}class me extends(()=>n(757695))().Store{getInitialState(){return{shouldFetchImportantPages:!1}}}const ve=new me;var be=n(296540),ye=()=>n(664594),_e=()=>n(907258),we=()=>n(484714),Se=()=>n(590526),Ie=()=>n(929219),Te=()=>n(391400),Ce=()=>n(99040),Re=()=>n(110154),Ee=()=>n(381195),Me=()=>n(923455),Oe=()=>n(475553);const Pe=5,Ae=5,ke=10,qe=10;function xe(){const e=(0,we().v3)(),t=(0,Oe().y)(),n=(0,Me().Rx)(),o=(0,Se().O$)(_e().AppStoreSidebarSpaceViewStore),r=(0,Se().O$)(_e().AppStoreSidebarSpaceStore),i=(0,ye().T)(),s=(0,Se().K8)((()=>{if(!Te().A.state.initialRenderCompleted)return;if(!(n&&o&&r&&i))return;if(!t)return;if(!Ie().A.state.online)return;const s=[...n.visiblePrivatePagesStores.slice(0,Pe),...n.visibleSharedPagesStores.slice(0,Ae),...(0,Re().f)({environment:e,spaceStore:r}).slice(0,ke),...o.getBookmarkedPages().slice(0,qe)];for(const e of n.visibleTeamsStores)s.push(...(0,Ee().O)({teamStore:e}));return s}),[n,o,i,r,t,e]);(0,be.useEffect)((()=>{const t=new AbortController;return(async()=>{if(void 0!==s){const{cacheSidebarImagesDebounced:n}=await Ce().W.load();await n({pageStores:s,environment:e,currentUserId:i,sidebarSpaceStore:r,abortSignal:t.signal})}})(),()=>{t.abort()}}),[s,i,r,e])}n(430670),n(803949);class Ne{constructor(e,t=(()=>n(852273))().Ay){this.shouldConnect=!1,this.keys=new Set,this.authToken=void 0,this.listener=void 0,this.listeners=new Map,this.groupListener=e=>{var t;return null===(t=this.listener)||void 0===t?void 0:t.call(this,e)},this.environment=e,this.dispatcher=t}connect(e){const{keys:t,authToken:n,listener:o}=e;this.shouldConnect=!0,this.listener=o,this.keys=new Set(t),this.authToken=n,this.reconcile()}getKeys(){return this.keys.values()}setKeys(e){this.keys=new Set(e),this.reconcile()}getListenerFn(){return this.listener}setListenerFn(e){this.listener=e}getListenerReferences(){return this.listeners.values().map((e=>e.reference))}disconnect(){this.shouldConnect=!1,this.reconcile()}reconcile(){if(this.shouldConnect){for(const[e,t]of this.listeners)this.keys.has(e)||(this.dispatcher.removeListener(t.reference,this.environment),this.listeners.delete(e));for(const e of this.keys){const t=this.listeners.get(e);if(t){if(t.authToken===this.authToken)continue;this.dispatcher.removeListener(t.reference,this.environment)}const n=this.dispatcher.addListener(e,this.authToken,this.groupListener,null==t?void 0:t.reference.subscriptionId,this.environment);n?this.listeners.set(e,{reference:n,authToken:this.authToken}):this.listeners.delete(e)}}else this.listeners.size>0&&(this.listeners.values().forEach((e=>{this.dispatcher.removeListener(e.reference,this.environment)})),this.listeners.clear())}}var Fe=()=>n(424127);var $e=()=>n(242422);let Be;function Ue(){const e=(0,we().v3)(),{currentUser:{id:t}}=e,n=(0,Oe().K)(),o=(0,Se().K8)((()=>$e().default.getConfigKey("offline_mode_sync_engine_config","update_sources")),[]),r=(0,C().EI)(o),i=function(){const e=(0,we().v3)().currentUser.id,t=e?se().F4`
			SELECT offline_page.id 
			FROM offline_page 
			WHERE download_status = 'success' 
			AND meta_user_id = ${e} 
		`:void 0,{value:n}=(0,Fe().uW)("useOfflinePageIds",t,{allowError:!0,primaryKey:["id"]});return(0,be.useMemo)((()=>null==n?void 0:n.map((e=>e.id))),[n])}();(0,be.useEffect)((()=>{n&&r&&t&&i&&(Be?Be.environment=e:Be=new Le(e,o,i,t))}),[e,t,n,r,o,i]);const s=Be&&t!==Be.userId;(0,be.useEffect)((()=>{s&&Be&&i&&Be.handleUserChange(t,i)}),[t,s,i]),(0,be.useEffect)((()=>{Be&&i&&Be.handleOfflinePagesChange(i)}),[i])}class Le{constructor(e,t,n,o){this.status="stopped",this.lockAbortController=void 0,this.releaseUserLock=void 0,this.listenerGroup=new Ne(this.environment),this.messageStoreKeys=new Map,this.handleMessageStoreEvent=({key:e,value:t})=>{if("number"!=typeof t)return;const n=this.messageStoreKeys.get(e);if(!n)return;const{pageId:o,updateSource:r}=n,i={pageId:o,lastServerUpdateTime:t,updateSource:r};pe({environment:this.environment,abortSignal:(new AbortController).signal,fetchTriggerType:"page_subscription_update",pageSubscriptionUpdate:i})},this.environment=e,this.updateSources=t,this.offlineIds=n,this.userId=o,this.handleOfflinePagesChange=I().nF(this.handleOfflinePagesChange.bind(this),1e3,{leading:!0}),this.trySubscribing(n)}trySubscribing(e){if(!this.userId)throw new Error("No userId provided for subscribing");var t;this.lockAbortController=new AbortController,this.status="waiting-for-lock",navigator.locks.request((t=this.userId,`page-updates-${t}`),{signal:this.lockAbortController.signal},(()=>(this.status="subscribing",this.refreshListeners(e),new Promise((e=>{this.releaseUserLock=e}))))).catch((e=>{}))}handleUserChange(e,t){var n;if(this.userId=e,"subscribing"===this.status)this.removeAllListeners(),this.status="stopped",null===(n=this.releaseUserLock)||void 0===n||n.call(this),this.releaseUserLock=void 0;else if("waiting-for-lock"===this.status){var o;null===(o=this.lockAbortController)||void 0===o||o.abort(),this.lockAbortController=void 0,this.status="stopped"}this.userId&&this.trySubscribing(t)}handleOfflinePagesChange(e){"subscribing"===this.status&&this.refreshListeners(e)}refreshListeners(e){const{sqliteConnection:t}=this.environment;if(!t||!this.userId)return;const o=e.flatMap((e=>this.updateSources.map((t=>[(0,n(921997).z9)({pageId:e,updateSource:t}),{pageId:e,updateSource:t}]))));this.messageStoreKeys=new Map(o),this.listenerGroup.connect({keys:o.map((([e,t])=>e)),authToken:void 0,listener:this.handleMessageStoreEvent})}removeAllListeners(){this.listenerGroup.disconnect(),this.messageStoreKeys=new Map}}var je=()=>n(940658),De=()=>n(591779),Ve=()=>n(300789);function Ke(){const e=(0,we().v3)(),t=(0,Oe().y)(),n=(0,Se().O$)(Ie().e),o=(0,De().ZC)(n);(0,be.useEffect)((()=>{void 0!==o&&t&&!o&&n&&(0,Ve().HH)(e,"offline_mode_sidebar_callout")}),[e,t,n,o])}var We=()=>n(582676),Xe=()=>n(929480),ze=()=>n(754981);function Ge(){const e=(0,we().Y0)(),t=(0,Oe().K)();return(0,Se().K8)((()=>{if(!Te().A.state.initialRenderCompleted)return!1;if(!Ie().A.state.online)return!1;if(e.isMobileNative){if("wifi"!==Ie().A.state.mobileConnectivityType)return!1}else{const e=navigator.connection;if(e&&(e.saveData||["slow-2g","2g"].includes(e.effectiveType??"")))return!1}return!!t}),[e.isMobileNative,t])}const He=3e5;function Je(){const e=(0,we().v3)(),t=Ge(),n=(0,Se().K8)((()=>{var e;return null===(e=ze().Z.state.globalAbortController)||void 0===e?void 0:e.signal}),[]),o=(0,M().m)("refetch_interval_ms"),r=(0,be.useRef)(!1),i=(0,De().ZC)(e.currentUser.id);Boolean(e.currentUser.id)&&e.currentUser.id!==i&&(r.current=!0),(0,be.useEffect)((()=>{if(r.current&&t){Ye((()=>"Attempt fetch due to app boot or user change"));const t=(0,We().HO)([0,He]),o=window.setTimeout((()=>{pe({fetchTriggerType:"app_boot_or_user_change",environment:e,abortSignal:n}),r.current=!1}),t);return()=>{window.clearTimeout(o)}}}),[n,t,e]),(0,be.useEffect)((()=>{Boolean(e.currentUser.id)&&Boolean(i)&&e.currentUser.id!==i&&((0,Xe().Rq)(),P().h.clearSettings())}),[e.currentUser.id,i]),(0,be.useEffect)((()=>{let r;const i=(0,We().HO)([0,o]),s=window.setTimeout((()=>{t&&(pe({fetchTriggerType:"default_interval",environment:e,abortSignal:n}),r=window.setInterval((()=>{t&&pe({fetchTriggerType:"default_interval",environment:e,abortSignal:n})}),o))}),i);return()=>{window.clearTimeout(s),r&&window.clearInterval(r)}}),[n,t,e,o])}function Qe(e){if(!e)throw new Error("Pass in `__console.environment` as the first param.");pe({fetchTriggerType:"force_debug",environment:e,abortSignal:(new AbortController).signal})}let Ze=!1;function Ye(e){Ze&&console.log(`[useRefetchOfflinePages] ${e()}`)}function et(){const e=(0,we().v3)(),t=(0,Se().K8)((()=>ve.state.shouldFetchImportantPages),[]),n=Ge();(0,be.useEffect)((()=>{t&&n&&(pe({fetchTriggerType:"sqlite_corruption_recovery",environment:e,abortSignal:(new AbortController).signal}),ve.setState({shouldFetchImportantPages:!1}))}),[e,t,n])}(0,f().exposeDebugValue)("debugAttemptFetch",Qe),(0,f().exposeDebugValue)("debugAttemptFetchSinglePage",(async function(e,t){const{sqliteConnection:n,currentUser:{id:o}}=e;if(!n||!o)return;if(!(await(0,te().c)({connection:n,pageId:t,userId:o})))throw new Error(`Page ${t} is not available offline`);Ye((()=>`Debug refetching single page ${t}`));const r={pageId:t,lastServerUpdateTime:1/0,updateSource:"create_snapshot"};await pe({environment:e,fetchTriggerType:"page_subscription_update",abortSignal:(new AbortController).signal,pageSubscriptionUpdate:r})})),(0,f().exposeDebugValue)("toggleOfflineRefetchDebugLogs",(function(){Ze=!Ze,console.log(Ze?"useRefetchOfflinePages debug logs enabled.":"useRefetchOfflinePages debug logs disabled."),fe=!fe,console.log(fe?"attemptFetchOfflinePages debug logs enabled.":"attemptFetchOfflinePages debug logs disabled.")}))},424127:(e,t,n)=>{"use strict";n.d(t,{uW:()=>u});n(16280);var o=n(296540),r=()=>n(726637),i=()=>n(484714),s=()=>n(79926),a=()=>n(763824),c=()=>n(615234),d=()=>n(534177);const l=100;function u(e,t,n,u=!1){const p=function(e){var t,n;const a=(0,i().v3)(),c=null===(t=a.sqliteConnection)||void 0===t||null===(n=t.getObserver)||void 0===n?void 0:n.call(t),d=c?g.get(c):void 0,[u,p]=(0,o.useState)(d),h=(0,s().fJ)(f,{disabled:!e});return(0,o.useEffect)((()=>{if(u||!c||!e)return;const t=g.get(c);if(t)return void p(t);if("resolved"!==h.status||!c)return;const{TabSqliteSubscriptionBackend:n,SqliteSubscriptionManager:o}=h.value,i=new o(new n({observer:c,debounceMs:l,broadcastWritesChannel:new BroadcastChannel("sqlite-writes"),config:r().A}));g.set(c,i),p(i)}),[c,h,u,e]),e?u:void 0}(Boolean(t)),h=function(e,t,n,r,s){const a=(0,i().v3)().currentUser.id,c=t?function(e,t,n,o,r,i){var s,a;if(!n&&null!==(s=o.rowType)&&void 0!==s&&s.singleton)throw new Error(`Must use useSqliteSingleton for singleton row type: ${o.rowType.name}`);const c=t.sql();let l=o.readTables;if(!l){const e=null==r?void 0:r.parseQuery(c);var u;if(e)switch(e.type){case"unknown":l=e.tables;break;case"error":throw e.error;case"crud":if(e.writeTables.length>0)throw new Error(`useSqliteQuery: cannot subscribe to query that writes to tables: ${e.writeTables.join(", ")}`);l=e.readTables;break;default:(0,d().HB)(e)}else l=null===(u=o.rowType)||void 0===u?void 0:u.readTables}const f={_key:`sqlite:KeyCreatorNotLoaded:${e}`,_options:o,singleton:n,sql:c,args:t.args,queryName:e,readTables:l,primaryKey:o.primaryKey??(null===(a=o.rowType)||void 0===a?void 0:a.primaryKey),rowType:o.rowType,userId:i||"guest"};r&&(f._key=r.keyCreator.getKeyUncached(f));return f}(e,t,n,r,s,a):void 0,[l,u]=(0,o.useState)(c);if((null==c?void 0:c._key)!==(null==l?void 0:l._key))return u(c),c;return l}(e,t,u,n,p),v=h?null==p?void 0:p.createQuery(h._key,h):void 0,b=v??m,y=(0,o.useSyncExternalStore)(b.subscribe,b.getSnapshot),_=function(e,t,n){var r;const i=null===(r=(0,s().fJ)(f,{disabled:!e}).value)||void 0===r?void 0:r.OptimisticUpdateComposer;return(0,o.useCallback)(((o,r)=>e&&n&&i&&e?async function(e,t,n,o,r,i){const s=o.rowType;if(!s)throw new Error(`Optimistic updates not supported for queries without a RowType or primaryKey: ${o.key}`);const d=new i(s,n);let l;try{t(d)}finally{l=d.done()}const{queryUpdate:u,rowTypeUpdate:f}=l;if(!u&&!f)return e();let g,p;const h=()=>{var e,t;null===(e=g)||void 0===e||e(),null===(t=p)||void 0===t||t()};f&&(r.dispatchRowTypeUpdate(o.userId,s,{type:"put",update:f}),g=()=>{r.dispatchRowTypeUpdate(o.userId,s,{type:"del",id:f.id})});u&&(o.dispatch({type:"put",update:u}),p=()=>{o.dispatch({type:"del",id:u.id})});const m=(0,a().nQ)(10*c().TD,o.waitForRerun()),v=e();return Promise.all([v,m]).finally(h),await v}(o,r,t,e,n,i):o()),[e,n,i,t])}(v,Boolean(null==h?void 0:h.singleton),p),w=Boolean(t),S=(0,o.useMemo)((()=>({...y,withOptimistic:_,enabled:w})),[y,_,w]);if(S.error&&(null==h||!h._options.allowError))throw S.error;return S}const f=new(s().O2)("SqliteSubscriptions",(async()=>{const[{TabSqliteSubscriptionBackend:e},{SqliteSubscriptionManager:t},{OptimisticUpdateComposer:o}]=await Promise.all([Promise.all([n.e(14208),n.e(93199)]).then(n.bind(n,384233)),Promise.all([n.e(14208),n.e(93199)]).then(n.bind(n,316878)),Promise.all([n.e(14208),n.e(93199)]).then(n.bind(n,415123))]);return{TabSqliteSubscriptionBackend:e,SqliteSubscriptionManager:t,OptimisticUpdateComposer:o}})),g=new WeakMap;function p(){}const h=Object.freeze({loading:!0,seq:-1,value:void 0,valueSeq:void 0,error:void 0,errorSeq:void 0}),m={subscribe:()=>p,getSnapshot:()=>h,dispatch:p}},430837:function(e,t,n){"use strict";var o=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n);var r=Object.getOwnPropertyDescriptor(t,n);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,o,r)}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),r=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||o(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),r(n(408863),t)},448835:(e,t,n)=>{"use strict";n.d(t,{Pz:()=>c,bG:()=>i,lI:()=>s,of:()=>r,ym:()=>a});var o=()=>n(79926);const r=new(o().O2)("offlineSettings",(()=>Promise.all([n.e(38293),n.e(91793),n.e(3551)]).then(n.bind(n,857245)))),i=(0,o()._h)(r,(e=>e.OfflineSettings)),s=(0,o()._h)(r,(e=>e.OfflineSettingsMobile)),a=(0,o()._h)(r,(e=>e.MobileOfflineSettingsSection)),c=(0,o()._h)(r,(e=>e.OfflineModeDebugSettings))},753721:(e,t,n)=>{"use strict";n.d(t,{X:()=>i});var o=()=>n(590526),r=()=>n(391400);function i(){return(0,o().K8)((()=>r().A.state.initialRenderCompleted),[])}},877051:(e,t,n)=>{"use strict";n.d(t,{V:()=>a});var o=n(296540),r=()=>n(907258),i=()=>n(590526),s=()=>n(391400);function a(){const e=(0,o.useRef)(!1),t=(0,i().K8)((()=>r().default.state.renderPhase),[]),n=(0,i().K8)((()=>s().A.state.initialCollectionPendingRenderCount>0),[]);return"rendered"!==t||n||(e.current=!0),!e.current}},881270:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.compare=void 0,t.compare=function(e,t){return e>t?1:e<t?-1:0}},922742:(e,t,n)=>{"use strict";n.d(t,{T:()=>s});var o=()=>n(430476),r=()=>n(68336),i=()=>n(496603);async function s(e){const{connection:t,userId:n,taskType:s}=e,[{data:a}]=await(0,o().G2)({connection:t,statements:[r().F4`SELECT last_executed_at FROM offline_download_metadata WHERE ${r().F4.and([r().F4`meta_user_id = ${n}`,r().F4`task_type = ${s}`])} LIMIT 1`.asRead()],queryName:"getOfflineMetadataLastExecutedAt"});return i().Jt(a,"[0][last_executed_at]")}},923455:(e,t,n)=>{"use strict";n.d(t,{Lp:()=>_,Rx:()=>S,a$:()=>w});var o=n(296540),r=()=>n(907258),i=()=>n(755531),s=()=>n(59226),a=()=>n(484714),c=()=>n(590526),d=()=>n(391400),l=()=>n(269183),u=()=>n(753721),f=()=>n(877051),g=()=>n(644914),p=()=>n(82648),h=()=>n(840247),m=()=>n(479349),v=n(474848);const b=(0,o.createContext)(null);b.displayName="SidebarStateContext";const y=2e4;function _({children:e}){const t=(0,a().v3)(),n=(0,h().r)(t),_=(0,f().V)(),{deferSidebarLoadingWhenCollapsed:w}=(0,l().b8)(t.currentUser.id),S=!(0,c().K8)((()=>(0,g().KB)(t)),[t])&&w&&_,[I,T]=(0,o.useState)(!1);(0,o.useEffect)((()=>{const e=setTimeout((()=>{T(!0)}),y);return()=>{clearTimeout(e)}}),[]);const{currentUserId:C,spaceId:R,isFreshStateReady:E}=(0,c().K8)((()=>{var e,t,o,s;null!==(e=r().default.state.currentUserStore)&&void 0!==e&&e.id&&null!==(t=(0,i().S)())&&void 0!==t&&t.id&&(0,p().yd)("user_and_space_stores_loaded");const a=null===(o=r().default.state.currentUserStore)||void 0===o?void 0:o.id,c=null===(s=(0,i().S)())||void 0===s?void 0:s.id;if(S)return{currentUserId:a,spaceId:c,isFreshStateReady:!1};const l=n.state,u=d().A.state.initialRenderCompleted;return{currentUserId:a,spaceId:c,isFreshStateReady:(0,m().XA)({sidebarState:l,userId:a,spaceId:c,isInitialPageRenderCompleted:u})}}),[n,S]),M=(0,s().X)("enable_greedy_sidebar_initial_render"),O=(0,u().X)(),P=(0,m().cT)({isFreshStateReady:E,userId:C,spaceId:R}),A=(0,c().K8)((()=>{const e=null==P?void 0:P.state;return Boolean(C===(null==e?void 0:e.userId)&&R===(null==e?void 0:e.spaceId))}),[P,C,R]),k=Boolean(A&&(O||M)&&!E&&!I);return(0,v.jsx)(b.Provider,{value:k?P:n,children:e})}function w(){const e=(0,o.useContext)(b),t=(0,a().v3)(),n=(0,h().r)(t);return e??n}function S(){return(0,c().O$)(w())}}}]);