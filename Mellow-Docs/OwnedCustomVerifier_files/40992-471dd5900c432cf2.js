"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[40992],{57685:(e,t,r)=>{r.d(t,{L:()=>o,T:()=>n});r(517642),r(658004),r(733853),r(845876),r(432475),r(515024),r(731698);function n(e){if(!e)return!1;const t=e.getPermissionItems();return!(!t||t.length<=1)}function o(e){const t=new Set;for(const r of e)if("user"===r.type&&r.userId&&(t.add(r.userId),t.size>=2))return!0;return!1}},140022:(e,t,r)=>{r.r(t),r.d(t,{getAnalyticsSearchSourcesFromAssistantFeatureGateStore:()=>ae,trackAIChatTranscriptHistoryChatDeleted:()=>B,trackAIChatTranscriptHistoryItemRestored:()=>W,trackAIChatTranscriptHistoryNewChatCreated:()=>q,trackAcceptAllPill:()=>K,trackAiChatTranscriptHistoryOpenHistoryButtonSelected:()=>V,trackAiDetectedGetSupportPillClick:()=>L,trackAssistantClosed:()=>w,trackAssistantFollowUpShareButtonClick:()=>pe,trackAssistantIntroModalClose:()=>F,trackAssistantIntroModalRead:()=>R,trackAssistantIntroModalTryNow:()=>D,trackAssistantOpened:()=>y,trackAssistantScopeMenuGetAiConnectorsInteraction:()=>ue,trackAssistantShareModalCopyImageFailure:()=>fe,trackAssistantShareModalCopyImageSuccess:()=>me,trackAssistantShareModalDismiss:()=>he,trackAssistantSlackUnfurlAiActionEvent:()=>se,trackAtMentionClick:()=>ee,trackConnectAppsClick:()=>ve,trackConnectorAuthNeededModalOpened:()=>de,trackConnectorInProgressModalOpened:()=>le,trackDiscardAllPill:()=>X,trackFullPageWelcomePromptCardInteraction:()=>ce,trackInferenceEnd:()=>k,trackInferenceStart:()=>b,trackInsertPill:()=>J,trackLeapDismissed:()=>oe,trackLeapLinkClick:()=>ie,trackLeapPreferenceSelect:()=>te,trackLeapPresented:()=>ne,trackLeapSubmit:()=>re,trackLearnMoreAboutAssistantClicked:()=>M,trackLeavingFullPageChat:()=>Z,trackOpeningHelpFromThreeDotMenu:()=>$,trackOpeningSupportFromThreeDotMenu:()=>Q,trackOpeningThreeDotMenu:()=>G,trackQnASilentRetry:()=>P,trackQnaCitationsSeeMoreClick:()=>O,trackQnaCitationsToggle:()=>U,trackQnaFeedbackGiven:()=>N,trackQnaResultClicked:()=>E,trackQnaSessionInitialized:()=>x,trackSavePagePill:()=>Y,trackScopeSearchMenuClose:()=>H,trackScopeSearchMenuOpen:()=>z,trackScopeSearchToggle:()=>j,trackUserClickedAssistantTryAgain:()=>C,trackUserStoppedAssistantOutput:()=>A});r(944114),r(898992),r(354520),r(581454);var n=()=>r(314529),o=()=>r(564884),i=()=>r(755531),a=()=>r(902006),s=()=>r(239666),c=()=>r(955104),l=()=>r(534177),d=()=>r(913839),u=()=>r(272286),p=()=>r(265015),h=()=>r(610083),m=()=>r(631611),f=()=>r(525569),v=()=>r(939622),_=()=>r(604018),g=()=>r(383070),S=()=>r(263542);function y(e,t){const{sessionId:r,startTimestamp:o,transcript:a,hasQuery:s,searchSessionId:l,from:m,isReminder:f,reminderType:_}=t,S=g().zD.isXMLAssistantEnabled(),y=g().zD.isLimitedQnaMode(),w=S?"assistant_open":"qna_open";(0,n().DO_NOT_USE_trackLegacy)(e,w,{qna_session_id:r,has_query:s,search_session_id:l,is_limited_qna_session:y,from:m,is_reminder:f,reminder_type:_}),c().u4({name:w,args:{qna_session_id:r,from:m,duration:Date.now()-o,questions_asked_in_session:a.filter((e=>"human"===e.type)).length??0,is_reminder:f,reminder_type:_,is_limited_qna_session:y}});const I=(0,i().S)(),b=null==I?void 0:I.getMemberCountFromPublicSpaceData(),T=(0,v().z)(e,{spaceId:null==I?void 0:I.id,userId:e.currentUser.id,name:"ai_connectors"})??!1;I&&b&&!f&&g().zD.isAudienceForAiConnectorSprigSurvey({hasAiConnectorFeature:T,isSpaceAdmin:I.canAdmin(),isMultiplayerWorkspace:b>1,qnaConnectionStoreStates:{slackUniversalQnAConnectionStoreState:h().Rh.state,githubAIConnectorStoreState:d().o.state,jiraAIConnectionStoreState:u().yg.state,linearAIConnectorStoreState:p().W.state}})&&c().u4({name:"assistant_open_and_in_ai_connector_sprig_audience",args:{qna_session_id:r,from:m}})}function w(e,t){const{sessionContext:r,from:o}=t,i=null==r?void 0:r.assistantConfigurationStoreState,a=g().zD.isXMLAssistantEnabled(),s=g().zD.isLimitedQnaMode(),l=a?"assistant_close":"qna_close",d=null==i?void 0:i.sessionStartTimestamp;(0,n().DO_NOT_USE_trackLegacy)(e,l,{qna_session_id:null==i?void 0:i.sessionId,qna_session_length:d?Date.now()-d:0,from:o,is_limited_qna_session:s}),c().u4({name:l,args:{qna_session_id:(null==i?void 0:i.sessionId)??"",is_limited_qna_session:s,from:o,duration:d?Date.now()-d:-1,questions_asked_in_session:(null==r?void 0:r.evaluatorFromStoreState.getTranscript().filter((e=>"human"===e.type)).length)??0}})}function I(e){if(!(0,m().Ui)(e))return S().P.state.from;switch(f().default.state.type){case"closed":return;case"assistantCompletionPopup":case"agentCompletionPopup":return f().default.state.from;default:(0,l().HB)(f().default.state)}}function b(e){var t;const{environment:r,configurationState:o,inferenceId:i,source:a,mentionsUsed:c,skillType:l,from:d,actionCardIdForLogging:u}=e,p=ae(),h=o?o.searchScope:s().Wy,m=T(h),f=g().zD.isXMLAssistantEnabled(),v=g().zD.isLimitedQnaMode(),_=(null==o||null===(t=o.temporaryUserInputData)||void 0===t?void 0:t.isRetrying)??!1,S=f?"assistant_inference_start":"qna_inference_start";(0,n().DO_NOT_USE_trackLegacy)(r,S,{qna_session_id:o?o.sessionId:void 0,qna_inference_id:i,is_limited_qna_session:v,is_retry:_,is_suggested_question:"suggested_question"===a,is_reminder_suggested_question:"reminder_suggested_question"===a,is_abandoned_search_suggested_question:"abandoned_search_suggested_question"===a,search_scope_type:h.type,search_scope_id:m,mentions_used:c,skill_type:l,action_card_id:u,from:d,search_sources:p,assistant_opened_from:I(d)})}function T(e){if("everything"!==e.type&&"workspace"!==e.type&&"notion"!==e.type&&"helpdocs"!==e.type&&"ai-knowledge"!==e.type&&"labeler"!==e.type&&"universal-none"!==e.type&&"notion-none"!==e.type&&"web"!==e.type&&"slackbot"!==e.type&&"universal-workspace"!==e.type&&!(0,a().SC)(e.type))return"teamspace"===e.type?e.teamId:"page"===e.type?e.pageId:"collection"===e.type?e.collectionId:"site"===e.type?e.siteId:(0,l().HB)(e.type)}function k(e,t){const{configurationState:r,inferenceId:i,timeTook:a,numCitationsShown:c,numSearchResults:d,numSlackSearchResults:u,numGoogleDriveSearchResults:p,searchedHelpdocs:h,citationsBySource:m,resultsBySource:v,selectedSkill:_,assistantActions:S,from:y,observationsBeforeFirstHumanStep:w,observationsAfterFirstHumanStep:b,forcefullyStoppedByUser:k,actionCardId:C,selectedSkillCategory:A,result:P}=t;if(!r)return;const N=g().zD.isXMLAssistantEnabled(),E=ae(),U=r.searchScope.type,O=T(r?r.searchScope:s().Wy);let x;const F=f().default.state;if("context"in F){const e=F.context;"textSelection"===e.type?x="text":"blockSelection"===e.type?x="block":"cursor"===e.type?x="cursor":(0,l().HB)(e)}N?(0,o().u)({environment:e,event:{eventName:"assistant_inference_end",eventProperties:{session_id:r.sessionId,inference_id:i,time_took:a,num_citations_shown:c,num_search_results:d,num_slack_search_results:u,num_google_drive_search_results:p,searched_helpdocs:h,citations_by_source:m,results_by_source:v,selected_skill:_,action_card_id:C,assistant_actions:(null==S?void 0:S.length)?S:["none"],search_sources:E,search_scope_type:U,observations_before_first_human_step:w,observations_after_first_human_step:b,search_scope_id:O,from:y,assistant_opened_from:I(y),forcefully_stopped_by_user:k,skill_category:A,text_selection_type:x,result:P}}}):(0,n().DO_NOT_USE_trackLegacy)(e,"qna_inference_end",{qna_session_id:r.sessionId,qna_inference_id:i,time_took:a,num_citations_shown:c,num_search_results:d,num_slack_search_results:u,citations_by_source:m,search_sources:E,search_scope_type:U,from:y,assistant_opened_from:I(y)})}function C(e,t){(0,o().u)({environment:e,event:{eventName:"assistant_user_clicked_try_again",eventProperties:{session_id:t.sessionId,assistant_surface_type:t.assistantSurfaceType}}})}function A(e,t){(0,o().u)({environment:e,event:{eventName:"assistant_output_stopped_by_user",eventProperties:{session_id:t.sessionId,assistant_surface_type:t.assistantSurfaceType}}})}function P(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"qna_silent_retry",{qna_session_id:t.sessionId,event:t.event})}function N(e,t,r,n){t&&(0,o().u)({environment:e,event:{eventName:"ai_feedback_given",eventProperties:{feature:"ai_assistant",qna_session_id:t.sessionId,qna_inference_id:r,sentiment:n}}})}function E(e,t){const{configurationState:r,clickedPageId:o,resultType:i,source:a}=t;r&&(0,n().DO_NOT_USE_trackLegacy)(e,"qna_result_clicked",{qna_session_id:r.sessionId,search_session_id:r.searchSessionId,clicked_page_id:o,result_type:i,source:a})}function U(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"qna_citations_toggle",{qna_session_id:t.sessionId,shown:t.shown})}function O(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"qna_citations_see_more_click",{qna_session_id:t.sessionId})}function x(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"qna_session_initialized",{current_initialization_count:t.current_initialization_count})}function F(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"assistant_intro_modal_close",t)}function R(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"assistant_intro_modal_read",t)}function M(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"assistant_learn_more_about_assistant_clicked",t)}function D(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"assistant_intro_modal_continue",t),y(e,{hasQuery:!1,isReminder:!1,transcript:[],searchSessionId:void 0,sessionId:"",startTimestamp:Date.now(),reminderType:void 0,from:"assistant_intro_modal"})}function L(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"ai_get_help_click",{sessionId:t.sessionId})}function W(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"ai_chat_transcript_history.restored",t)}function q(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"ai_chat_transcript_history.new_chat_created",t)}function B(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"ai_chat_transcript_history.chat_deleted",t)}function V(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"ai_chat_transcript_history.open_history_button_selected",t)}function z(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"ai_scoped_search_menu_open",t)}function j(e,t){const{from:r,original_scopes:o,new_scopes:i,config_type:a,ai_session_id:s,ai_inference_id:c}=t,l=o.map((e=>e.type)),d=i.map((e=>e.type));(0,n().DO_NOT_USE_trackLegacy)(e,"ai_scoped_search_toggle",{from:r,original_scope_types:l,new_scope_types:d,config_type:a,ai_session_id:s,ai_inference_id:c})}function H(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"ai_scoped_search_menu_close",t)}function G(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"ai_three_dot_menu.open",t)}function $(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"ai_three_dot_menu.accessing_help",t)}function Q(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"ai_three_dot_menu.opening_support",t)}function J(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"ai_action_pill.insert",t)}function K(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"ai_action_pill.accept_all_edits",t)}function Y(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"ai_action_pill.save_page",t)}function X(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"ai_action_pill.discard_all_edits",t)}function Z(e){(0,n().DO_NOT_USE_trackLegacy)(e,"ai_full_page_exit")}function ee(e){(0,n().DO_NOT_USE_trackLegacy)(e,"ai_at_mention_click")}function te(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"leap_select",t)}function re(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"leap_submit",t)}function ne(e){(0,n().DO_NOT_USE_trackLegacy)(e,"leap_presented")}function oe(e){(0,n().DO_NOT_USE_trackLegacy)(e,"leap_dismissed")}function ie(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"leap_open_link",t)}function ae(){const e=["notion","helpdocs"];return e.push(...(0,_().wd)()),e}function se(e){const{environment:t,action:r,interaction:n}=e;(0,o().u)({environment:t,event:{eventName:"assistant_slack_unfurl_ai_action_event",eventProperties:{interaction:n,action:r}}})}function ce(e){const{environment:t,promptId:r,interaction:n}=e;(0,o().u)({environment:t,event:{eventName:"assistant_full_page_welcome_prompt_card_event",eventProperties:{promptid:r,interaction:n}}})}function le(e){const{environment:t,connector:r,from:n}=e;(0,o().u)({environment:t,event:{eventName:"ai_connector_in_progress_modal_opened",eventProperties:{from:n,connector:r}}})}function de(e){const{environment:t,connector:r,from:n}=e;(0,o().u)({environment:t,event:{eventName:"ai_connector_auth_needed_modal_opened",eventProperties:{from:n,connector:r}}})}function ue(e){const{environment:t,sessionId:r,interaction:n}=e;(0,o().u)({environment:t,event:{eventName:"assistant_scope_menu_get_ai_connectors_interaction",eventProperties:{session_id:r,interaction:n}}})}function pe(e){const{environment:t,sessionId:r,assistantSurfaceType:n}=e;(0,o().u)({environment:t,event:{eventName:"assistant_follow_up_share_action_user_clicked_button",eventProperties:{session_id:r,assistant_surface_type:n}}})}function he(e){const{environment:t,sessionId:r,assistantSurfaceType:n}=e;(0,o().u)({environment:t,event:{eventName:"assistant_follow_up_share_action_user_dismissed_share_modal",eventProperties:{session_id:r,assistant_surface_type:n}}})}function me(e){const{environment:t,sessionId:r,assistantSurfaceType:n}=e;(0,o().u)({environment:t,event:{eventName:"assistant_follow_up_share_action_user_copied_image_success",eventProperties:{session_id:r,assistant_surface_type:n}}})}function fe(e){const{environment:t,sessionId:r,assistantSurfaceType:n}=e;(0,o().u)({environment:t,event:{eventName:"assistant_follow_up_share_action_user_copied_image_failure",eventProperties:{session_id:r,assistant_surface_type:n}}})}function ve(e){const{environment:t,sessionId:r,assistantSurfaceType:n,source:i}=e;(0,o().u)({environment:t,event:{eventName:"assistant_click_connect_apps",eventProperties:{source:i,session_id:r,assistant_surface_type:n}}})}},140992:(e,t,r)=>{r.d(t,{Hp:()=>ht,VG:()=>st,Vn:()=>Je,aP:()=>ze,vy:()=>He,fI:()=>dt,WF:()=>ct,zf:()=>rt,Wq:()=>Ve,Pz:()=>Ke,WE:()=>et,kh:()=>lt,D5:()=>Ge,GS:()=>$e,g6:()=>je,ki:()=>Xe,Mi:()=>Qe,D7:()=>Ye,Cx:()=>pt,zS:()=>ut});r(16280),r(410838),r(517642),r(658004),r(733853),r(845876),r(432475),r(515024),r(731698),r(898992),r(354520),r(672577),r(430670),r(581454),r(737550),r(964979);var n=r(296540),o=()=>r(907258),i=()=>r(135168),a=()=>r(755531),s=()=>r(692031),c=()=>r(212497),l=()=>r(726637),d=()=>r(484714),u=()=>r(590526),p=()=>r(140934),h=()=>r(76549),m=()=>r(770063),f=()=>r(463086),v=()=>r(365646),_=()=>r(592933),g=()=>r(241178),S=()=>r(362750),y=()=>r(878456),w=()=>r(165358),I=()=>r(785728),b=()=>r(134025),T=()=>r(388821),k=()=>r(728272),C=()=>r(179034),A=()=>r(234459),P=()=>r(155792),N=()=>r(439180),E=()=>r(724639),U=()=>r(532659);class O extends Error{constructor(e,t,r){super(e),this.operation=t,this.path=r,this.name="JsonPatchError"}static isJSONPatchError(e){return e instanceof O}}class x extends O{constructor(e){super(`Invalid operation: ${e.op}`,e),this.name="InvalidOperationError"}}class F extends O{constructor(e,t){super(`Invalid path: ${e}`,t,e),this.name="InvalidPathError"}}class R extends O{constructor(e,t){super(`Path not found: ${e} for operation ${null==t?void 0:t.op}`,t,e),this.name="PathNotFoundError"}}class M extends O{constructor(e,t,r,n){super(`Test operation failed at ${e}: expected ${JSON.stringify(r)}, got ${JSON.stringify(t)}`,n,e),this.actual=t,this.expected=r,this.name="TestFailedError"}}class D extends O{constructor(e,t,r){super(`Invalid move operation: cannot move ${e} into its child ${t}`,r,e),this.name="InvalidMoveError"}}class L extends O{constructor(e){super(`Unknown compressed operation type: ${e}`),this.name="InvalidCompressionError"}}class W extends O{constructor(e,t,r){super(`Expected string for ${e} operation 'from' field, got ${t}`,r),this.name="InvalidOperationTypeError"}}r(944114),r(823215);function q(e){return e.replace(/~1/g,"/").replace(/~0/g,"~")}function B(e){return e.replace(/~/g,"~0").replace(/\//g,"~1")}class V{constructor(e=[""]){this.tokens=void 0,this.tokens=e}static parse(e){if(!e.startsWith("/")&&""!==e)throw new F(e);if(""===e)return new V([""]);const t=e.split("/").map(q);return new V(t)}static fromTokens(e){return new V(["",...e])}toString(){return 1===this.tokens.length&&""===this.tokens[0]?"":this.tokens.map(B).join("/")}getTokens(){return this.tokens.slice(1)}append(e){return new V([...this.tokens,e])}prepend(e){return new V(["",e,...this.tokens.slice(1)])}parent(){if(!(this.tokens.length<=1))return new V(this.tokens.slice(0,-1))}lastToken(){return this.tokens.length>1?this.tokens[this.tokens.length-1]:void 0}isPrefixOf(e){return!(this.tokens.length>=e.tokens.length)&&this.tokens.every(((t,r)=>t===e.tokens[r]))}evaluate(e){if(1===this.tokens.length&&""===this.tokens[0])return{parent:void 0,key:"",value:e,exists:!0};let t,r=e,n="";for(let i=1;i<this.tokens.length&&(n=this.tokens[i],i!==this.tokens.length-1);i++){if(null==r)return{parent:void 0,key:n,value:void 0,exists:!1};if("__proto__"===n||"constructor"===n||"prototype"===n)return{parent:void 0,key:n,value:void 0,exists:!1};if(Array.isArray(r)){if("-"===n)return{parent:void 0,key:n,value:void 0,exists:!1};const e=parseInt(n,10);if(isNaN(e)||e<0||!Number.isInteger(e))return{parent:void 0,key:n,value:void 0,exists:!1};if(e>=r.length)return{parent:void 0,key:n,value:void 0,exists:!1};r=r[e]}else{if("object"!=typeof r||null===r)return{parent:void 0,key:n,value:void 0,exists:!1};if(!(n in r))return{parent:void 0,key:n,value:void 0,exists:!1};r=r[n]}}let o=!1;if(null==r)o=!1;else if("__proto__"===n||"constructor"===n||"prototype"===n)o=!1;else if(Array.isArray(r))if("-"===n)o=!1;else{const e=parseInt(n,10);isNaN(e)||e<0||!Number.isInteger(e)||e>=r.length?o=!1:(t=r[e],o=!0)}else if("object"==typeof r&&null!==r){n in r?(t=r[n],o=!0):o=!1}else o=!1;return{parent:r,key:n,value:t,exists:o}}get(e){return this.evaluate(e).value}exists(e){return this.evaluate(e).exists}}var z=()=>r(496603);function j(e){return(0,z().mg)(e)}function H(e,t){const r=V.parse(t.path).evaluate(e);if(""===t.path)return j(t.value);if(!r.parent||null===r.parent||void 0===r.parent)throw new R(t.path,t);const n=r.parent,o=r.key;if(Array.isArray(n))if("-"===o)n.push(j(t.value));else{const e=parseInt(o,10);if(isNaN(e)||e<0||!Number.isInteger(e))throw new R(t.path,t);if(e>n.length)throw new R(t.path,t);n.splice(e,0,j(t.value))}else{if("object"!=typeof n||null===n)throw new R(t.path,t);n[o]=j(t.value)}return e}function G(e,t){const r=V.parse(t.path).evaluate(e);if(""===t.path)throw new R(t.path,t);if(!r.exists)throw new R(t.path,t);if(!r.parent)throw new R(t.path,t);const n=r.parent,o=r.key;if(Array.isArray(n)){const e=parseInt(o,10);if(isNaN(e)||e<0||e>=n.length)throw new R(t.path,t);n.splice(e,1)}else{if("object"!=typeof n||null===n)throw new R(t.path,t);delete n[o]}return e}function $(e,t){switch(t.op){case"add":return H(e,t);case"remove":return G(e,t);case"replace":return function(e,t){const r=V.parse(t.path).evaluate(e);if(""===t.path)return j(t.value);if(!r.exists)throw new R(t.path,t);if(!r.parent)throw new R(t.path,t);const n=r.parent,o=r.key;if(Array.isArray(n)){const e=parseInt(o,10);if(isNaN(e)||e<0||e>=n.length)throw new R(t.path,t);n[e]=j(t.value)}else{if("object"!=typeof n||null===n)throw new R(t.path,t);n[o]=j(t.value)}return e}(e,t);case"move":return function(e,t){const r=V.parse(t.from),n=V.parse(t.path);if(r.isPrefixOf(n))throw new D(t.from,t.path,t);const o=r.evaluate(e);if(!o.exists)throw new R(t.from,t);const i=o.value;return G(e,{op:"remove",path:t.from}),H(e,{op:"add",path:t.path,value:i}),e}(e,t);case"copy":return function(e,t){const r=V.parse(t.from).evaluate(e);if(!r.exists)throw new R(t.from,t);return H(e,{op:"add",path:t.path,value:j(r.value)}),e}(e,t);case"test":return function(e,t){const r=V.parse(t.path).evaluate(e);if(!r.exists)throw new M(t.path,r.value,t.value,t);if(!(0,z().n4)(r.value,t.value))throw new M(t.path,r.value,t.value,t);return e}(e,t);case"append":return function(e,t){const r=V.parse(t.path),n=r.evaluate(e);if(!n.exists)throw new R(t.path,t);if("string"!=typeof n.value)throw new x(t);if(""===t.path)return n.value+t.value;const o=(0,z().mg)(e),i=r.evaluate(o);if(!i.parent||void 0===i.key)throw new x(t);return i.parent[i.key]=n.value+t.value,o}(e,t);case"replaceSuffix":return function(e,t){const r=V.parse(t.path),n=r.evaluate(e);if(!n.exists)throw new R(t.path,t);if(!Array.isArray(n.value))throw new x(t);const o=n.value,i=t.removeCount;if(i<0||!Number.isInteger(i)||i>o.length)throw new x(t);if(""===t.path){const e=[...o];return e.splice(o.length-i,i,...t.value.map((e=>j(e)))),e}const a=(0,z().mg)(e),s=r.evaluate(a);if(!Array.isArray(s.value))throw new x(t);const c=s.value;return c.splice(c.length-i,i,...t.value.map((e=>j(e)))),a}(e,t);default:throw new x(t)}}function Q(e,t,r,n){switch(e){case"add":case"replace":case"test":return{op:e,path:t,value:r};case"append":return{op:"append",path:t,value:r};case"replaceSuffix":if(!Array.isArray(r)||"number"!=typeof n)throw new W(e,`removeCount: ${typeof n}, value: ${typeof r}`);return{op:"replaceSuffix",path:t,value:r,removeCount:n};case"remove":return{op:e,path:t};case"move":case"copy":if("string"!=typeof r)throw new W(e,typeof r);return{op:e,path:t,from:r};default:throw new x({op:"add",path:t,value:void 0})}}const J={apply:function(e,t,r={}){const{mutate:n=!1,ignoreRemoveErrors:o=!1,ignoreReplaceErrors:i=!1}=r;let a=n?e:(0,z().mg)(e);for(const c of t)try{a=$(a,c)}catch(s){if(o&&"remove"===c.op&&s instanceof R)continue;if(i&&"replace"===c.op&&s instanceof R)continue;throw s}return a},applyOperation:$,createOperation:Q,add:(e,t)=>Q("add",e,t),remove:e=>Q("remove",e),replace:(e,t)=>Q("replace",e,t),move:(e,t)=>Q("move",e,t),copy:(e,t)=>Q("copy",e,t),test:(e,t)=>Q("test",e,t),append:(e,t)=>Q("append",e,t),replaceSuffix:(e,t,r)=>Q("replaceSuffix",e,r,t)};const K={a:"add",r:"remove",p:"replace",m:"move",c:"copy",t:"test",x:"append",s:"replaceSuffix"};function Y(e){const{o:t,p:r,v:n,f:o,r:i}=e,a=K[t];if(!a)throw new L(t);if("add"===a)return{op:a,path:r,value:n};if("remove"===a)return{op:a,path:r};if("replace"===a)return{op:a,path:r,value:n};if("move"===a){if(void 0===o)throw new x({op:"move",path:r,from:""});return{op:a,path:r,from:o}}if("copy"===a){if(void 0===o)throw new x({op:"copy",path:r,from:""});return{op:a,path:r,from:o}}if("test"===a)return{op:a,path:r,value:n};if("append"===a){if("string"!=typeof n)throw new x({op:a,path:r,value:""});return{op:a,path:r,value:n}}if("replaceSuffix"===a){if(void 0===i)throw new x({op:a,path:r,removeCount:0,value:[]});if(!Array.isArray(n))throw new x({op:a,path:r,removeCount:0,value:[]});return{op:a,path:r,removeCount:i,value:n}}throw new x({op:"add",path:r,value:void 0})}var X=()=>r(229833),Z=()=>r(534177),ee=()=>r(769864),te=()=>r(384944),re=()=>r(666144),ne=()=>r(383070),oe=()=>r(703748),ie=()=>r(770160),ae=()=>r(69769),se=()=>r(962753),ce=()=>r(492414),le=()=>r(594794),de=()=>r(246766),ue=()=>r(613016),pe=()=>r(616878),he=()=>r(547149),me=()=>r(122058),fe=()=>r(798988),ve=()=>r(865454),_e=()=>r(791256),ge=()=>r(717375),Se=()=>r(755222);class ye extends Error{constructor(e){super(e),this.name="SmootherError"}static isSmootherError(e){return e instanceof ye}}const we={velocity:100,alpha:.99,gamma:1e-5,deadlineOffset:.3,postCompleteSlack:100};class Ie{constructor(e=we){this.buffer=[],this.position=0,this.velocity=void 0,this.lastFrameTime=0,this.startTime=0,this.isFinishedAddingItems=!1,this.currentlyRunningUpdateLoop=void 0,this.alpha=void 0,this.gamma=void 0,this.deadlineOffset=void 0,this.postCompleteSlack=void 0,this.defaultArgs=we,this.handleVisibilityChange=e=>{if(e.state.isVisible&&this.currentlyRunningUpdateLoop){const e=performance.now(),t=this.calculateSmoothedPosition(e);this.position=Math.min(t,this.buffer.length),this.lastFrameTime=e}},this.defaultArgs=e,this.velocity=e.velocity,this.alpha=e.alpha,this.gamma=e.gamma,this.deadlineOffset=e.deadlineOffset,this.postCompleteSlack=e.postCompleteSlack}addItems(e){if(!this.currentlyRunningUpdateLoop)throw new ye("`addItems` was called, but we weren't running the update loop!");const t=performance.now();0===this.startTime&&(this.startTime=t,this.lastFrameTime=t);for(const r of e)this.buffer.push({item:r,timestamp:t})}beginUpdateLoop(e){if(this.currentlyRunningUpdateLoop)throw new ye("`beginUpdateLoop` was called while we were already running the update loop!");this.setupVisibilityHandler(),this.currentlyRunningUpdateLoop=(async()=>{for(;!this.isFinishedAddingItems||this.hasPendingItems();)await new Promise((t=>{requestAnimationFrame((r=>{e(this.getSmoothedItems(r)),t()}))}));this.cleanupVisibilityHandler(),this.currentlyRunningUpdateLoop=void 0})()}setupVisibilityHandler(){Se().A.addListener(this.handleVisibilityChange)}cleanupVisibilityHandler(){Se().A.removeListener(this.handleVisibilityChange)}markIsFinishedAddingItems(){this.isFinishedAddingItems=!0}async finishUpdateLoop(){if(!this.isFinishedAddingItems)throw new ye("`finishUpdateLoop` was called without a corresponding invocation of `markIsFinishedAddingItems`.");this.currentlyRunningUpdateLoop&&await this.currentlyRunningUpdateLoop}reset(){if(this.currentlyRunningUpdateLoop)throw new ye("Cannot reset while the update loop is running!");this.cleanupVisibilityHandler(),this.buffer=[],this.position=0,this.velocity=this.defaultArgs.velocity,this.lastFrameTime=0,this.startTime=0,this.isFinishedAddingItems=!1}async stopAndFinish(){if(!this.isSmoothing())return Promise.resolve();this.markIsFinishedAddingItems(),await this.finishUpdateLoop(),this.reset()}isSmoothing(){return Boolean(this.currentlyRunningUpdateLoop)}getSmoothedItems(e){if(0===this.buffer.length||0===this.startTime)return[];if((e-this.lastFrameTime)/1e3<=0)return[];const t=this.calculateSmoothedPosition(e),r=Math.max(this.position,Math.min(t,this.buffer.length)),n=this.buffer.slice(this.position,r);return this.position=r,this.lastFrameTime=e,n.map((e=>e.item))}calculateSmoothedPosition(e){if(0===this.buffer.length)return 0;const t=(e-this.startTime)/1e3,r=t-(this.lastFrameTime-this.startTime)/1e3;if(r<=0)return this.position;if(this.position>=this.buffer.length)return this.buffer.length;const n=.9*t-this.deadlineOffset;let o=this.position;for(let v=this.position;v<this.buffer.length;v++){(this.buffer[v].timestamp-this.startTime)/1e3<n&&(o=v+1)}const i=this.buffer.length+(this.isFinishedAddingItems?this.postCompleteSlack:0),a=1/r,s=this.isFinishedAddingItems?.01*this.gamma:this.gamma,c=.01,l=e=>{const t=(e-this.position)*a;return 2*s*a*(t-this.velocity)-1/(e-o)+1/(i-e)};let d=o,u=Math.max(i,d+.001),p=l(d),h=l(u);if(!(p<=c&&h>=-.01)){const e=Math.max(1,this.velocity*r),t=Math.min(Math.max(this.position+e,d),u),n=(t-this.position)/r;return this.velocity=this.alpha*this.velocity+(1-this.alpha)*n,t}for(;p<-.01;){const e=(d+u)/2,t=l(e);t<=0?(d=e,p=t):(u=e,h=t)}const m=d,f=(m-this.position)/r;return this.velocity=this.alpha*this.velocity+(1-this.alpha)*f,Math.round(m)}hasPendingItems(){return this.position<this.buffer.length}getDebugInfo(){return{bufferLength:this.buffer.length,position:this.position,velocity:this.velocity,progress:this.buffer.length>0?this.position/this.buffer.length:0}}}const be=["text","thinking","registered_tool_use"];function Te(e){if("agent-inference"===e.type){if("string"==typeof e.value)return e.value;if(Array.isArray(e.value)){const t=e.value[e.value.length-1];if(t&&be.includes(t.type))return t.content}}return""}function ke(e,t){return e.length>t.length&&e.startsWith(t)?e.slice(t.length):""}function Ce(e,t){if("agent-inference"!==e.type)return e;const r={...e};if("string"==typeof r.value)r.value=t;else if(Array.isArray(r.value)){const e=[...r.value],n=e[e.length-1];n&&be.includes(n.type)&&(e[e.length-1]={...n,content:t}),r.value=e}return r}var Ae=()=>r(256001),Pe=()=>r(57685),Ne=()=>r(166442),Ee=()=>r(564884),Ue=()=>r(101078),Oe=()=>r(484127),xe=()=>r(282834),Fe=()=>r(201980),Re=()=>r(955104),Me=()=>r(99895),De=()=>r(944584),Le=()=>r(354785),We=()=>r(140022);function qe(e){var t;const{environment:r,threadId:n,traceId:o,config:i,suggestedPrompt:a,isFollowUp:s,transcript:c}=e,l=(0,_e().o)(c),d=c.findLast((e=>"user"===e.type)),u=function(e){if(!e)return;const t=new(Me().G)((()=>0));for(const n of e){const e=(0,Fe().uPN)(n);for(const r of e)(0,Fe().qsB)(r)?t.set("date",t.get("date")+1):(0,Fe().rie)(r)?t.set("user",t.get("user")+1):(0,Fe().jIt)(r)&&t.set("page",t.get("page")+1)}const r={};for(const[n,o]of t.entries())r[n]=o;return r||void 0}(null==d?void 0:d.value);var p;if("markdown-chat"===(null==i?void 0:i.type))(0,Ee().u)({environment:r,event:{eventName:"markdown_chat_start_turn",eventProperties:{thread_id:n,trace_id:o,is_follow_up:s,model:i.model,suggested_prompt:a,mentions_used:u,opened_from:null==l||null===(p=l.value)||void 0===p?void 0:p.surface}}});else if("researcher"===(null==i?void 0:i.type)){var h;Le().Bg({threadId:n,traceId:o,environment:r,isFollowUp:s,searchSources:(0,We().getAnalyticsSearchSourcesFromAssistantFeatureGateStore)(),searchScopeType:(null===(h=i.searchScope)||void 0===h?void 0:h.type)??"everything"})}else if("search"===(null==i?void 0:i.type))(0,Ee().u)({environment:r,event:{eventName:"deep_find_start_turn",eventProperties:{thread_id:n,trace_id:o,is_follow_up:s,from:null==l?void 0:l.value.surface,suggested_prompt:a,search_session_id:null==i?void 0:i.searchSessionId,search_sources:(0,We().getAnalyticsSearchSourcesFromAssistantFeatureGateStore)(),search_scope_type:i.scopeForNextSearch.type}}});else if("workflow"===(null==i?void 0:i.type)){var m;De().trackAgentStartTurn({environment:r,from:(null==l||null===(m=l.value)||void 0===m?void 0:m.surface)??"unknown",searchSources:(0,We().getAnalyticsSearchSourcesFromAssistantFeatureGateStore)(),actionCardId:void 0,isCustomAgent:Boolean(null==i?void 0:i.isCustomAgent),isDatabaseAgent:null==i?void 0:i.isDatabaseAgent,suggestedPrompt:e.suggestedPrompt,isRetry:e.isRetry,allowEditsEnabled:!i.useReadOnlyMode,threadId:n,config:i,workflowId:i.workflowId,hasMailTrigger:i.hasMailTrigger,mailTriggerTypes:i.mailTriggerTypes,inputModality:e.inputModality})}(0,Ee().u)({environment:e.environment,event:{eventName:"inference_transcript_start_turn",eventProperties:{thread_id:e.threadId,trace_id:e.traceId,config:e.config,suggested_prompt:e.suggestedPrompt,opened_from:null==l||null===(t=l.value)||void 0===t?void 0:t.surface}}})}var Be=()=>r(688483);function Ve(e){const{clientStore:t,environment:r}=e,n=r.RouterStore.state.route,o="chat"===n.name?n.threadId:void 0;o&&t.getOrCreateClientAIChatThreadStore(o).resetState(),t.setState({...t.state,userSelectedConfig:void 0,isAIChatTranscriptSidePanelVisible:!1})}function ze(e){const{environment:t,userStore:r,spaceStore:n,transcript:o,workflowId:i,transaction:a,threadId:s,inMemoryRecordCache:c,threadType:l}=e,d=te().vt({environment:t,table:A().To,args:{id:s??(0,le().Z1)({environment:t,table:A().To,spaceId:n.id}),parentPointer:n.pointer,space_id:n.id,messages:[],data:{workflow_id:i},createdByPointer:r.pointer,alive:!0,type:l},transaction:a,inMemoryRecordCache:c??n.inMemoryRecordCache});return o&&Je({environment:t,spaceStore:n,threadStore:d,userStore:r,addSteps:o,transaction:a}),d}function je(e){var t;const{threadStore:r,transaction:n}=e;Ge({threadStore:r,transaction:n,sharedWithSpace:!Boolean(null===(t=r.getData())||void 0===t?void 0:t.shared_with_space)})}function He(e){var t;const{chatTranscriptInfo:r,environment:n,clientStore:o}=e,i=(0,ue().a)();"assistant"!==r.configType&&i&&((0,Pe().T)(r.store)?function(e){const{chatTranscriptInfo:t,clientStore:r,environment:n}=e,o=t.store,i=n.currentUser.id,a=o.getPermissionItems().find((e=>"user_permission"===e.type&&e.user_id===i));if(!a)return;(0,he().createAndCommit)({userAction:"assistantChatHistoryItem.leaveInferenceChatTranscript",environment:n,canUndo:!0,perform:e=>{(0,Be().xZ)({environment:n,threadStore:o,transaction:e,permissionItem:{...a,role:"none"}})}}),r.removeClientAIChatThreadStore(t.id),(0,oe().clearChatLastOpenedState)()}({chatTranscriptInfo:r,clientStore:o,environment:n}):(null===(t=o.getOrCreateClientAIChatThreadStore(r.id).state.abortController)||void 0===t||t.abort(),(0,he().createAndCommit)({userAction:"assistantChatHistoryItem.deleteInferenceChatTranscript",environment:n,canUndo:!0,perform:e=>{te().zv({store:r.store,data:{alive:!1,current_inference_id:null,current_inference_lease_expiration:null},transaction:e})}}),o.removeClientAIChatThreadStore(r.id),(0,oe().clearChatLastOpenedState)()))}function Ge({threadStore:e,transaction:t,sharedWithSpace:r}){te().zv({store:e.getDataStore(),data:{shared_with_space:r},transaction:t})}function $e(e){var t;const{threadStore:r,transaction:n,clientStore:o}=e,i=o.getOrCreateClientAIChatThreadStore(r.id);i.setState({...i.state,wasForceStoppedByUser:!0}),null===(t=i.state.abortController)||void 0===t||t.abort(),te().zv({store:r,data:{current_inference_id:null,current_inference_lease_expiration:null},transaction:n})}function Qe(e){const{threadStore:t,transaction:r,updatedById:n,updatedByTable:o}=e;te().zv({store:t,data:{updated_time:Date.now(),updated_by_id:n,updated_by_table:o},transaction:r})}function Je(e){const{environment:t,spaceStore:r,threadStore:n,userStore:o,addSteps:i,transaction:a,inMemoryRecordCache:s,filterStreamingSteps:c}=e,l=(c?i.filter((e=>"agent-tool-result"!==e.type||"streaming"!==e.state)):i).map((e=>te().vt({environment:t,table:P().mS,args:{id:e.id.toString(),parentPointer:n.pointer,space_id:r.getSpaceId(),step:e,createdByPointer:o.pointer},transaction:a,inMemoryRecordCache:s??r.inMemoryRecordCache})));return(0,he().applyOperation)({operation:{args:{ids:i.map((e=>e.id))},command:"listAfterMulti",path:["messages"],pointer:n.pointer},store:n,transaction:a}),l}function Ke(e){const{threadStore:t,stepId:r,transaction:n}=e,o=t.getMessages(),i=o.findIndex((e=>e===r)),a=o.slice(i+1);for(const s of a)(0,he().applyOperation)({operation:{args:{id:s},command:"listRemove",path:["messages"],pointer:t.pointer},store:t,transaction:n});pe().f.removeStatusesForMessageIds(a)}function Ye(e){const{threadStore:t,step:r,transaction:n,newValue:o}=e,i=t.getStepStoreById(r.id);i&&te().zv({store:i,data:{value:o},transaction:n})}function Xe(e){const{threadStore:t,stepId:r,transaction:n,newValue:o}=e,i=t.getStepStoreById(r);i&&te().zv({store:i,data:{value:o,isEdited:!0},transaction:n})}const Ze=["config","user-specified-context","context","agent-records-updated"];async function et(e){var t,r;const{clientStore:n,environment:s,threadStore:c,createThreadArgs:l,waitBeforeSending:d,analyticsArgs:u,forceRegenerateTitle:m,confirmToolStepIds:g,rejectToolStepIds:S,stepIdsToInclude:b,sendPatchResponse:T,initialAgentActions:P,isRetry:N}=e,E=(0,i().f)(c)??(0,a().S)(),x=null==E?void 0:E.id;if(!x)throw new Error("No space id");let F=(null==c?void 0:c.getTranscript())??(null==l?void 0:l.transcript)??[];if(0===F.length)throw new Error("No transcript");const R=function(e,t,r){const n=e.findLast((e=>"agent-turn-full-record-map"===e.type));if(null==n||!n.recordVersions)return;const o=new(k().d);for(const{pointer:i,version:a}of n.recordVersions)if(i.table===C().ev){const e=h().Bv.createChildStore(r,i);if((e.getVersion()??0)<=a)continue;const t=(0,h().Nq)(e);(null!=t&&t.isPageBlock()||null!=t&&t.isCollectionView())&&o.add(t.pointer)}return o.size()>0?{id:mt(t,r.id),type:"agent-records-updated",pointers:Array.from(o)}:void 0}(F,s,E);R&&(F=[...F,R]);const M=null===(t=F.findLast((e=>"config"===e.type)))||void 0===t?void 0:t.value.type,D=b?F.filter((e=>b.includes(e.id)||Ze.includes(e.type))):F,L=Boolean(b),W=(null==c?void 0:c.id)??(null==l?void 0:l.id);if(!W)throw new Error("No thread id");const{model:q}=n.state,{cachedInferences:B,annotationInferences:V}=(0,_e().Hg)(n,W),z=new AbortController,j={};for(const o of B){if(!o.value.expected)throw new Error("No expected output for cached inference");if((0,y().Mt)(o.value.expected))throw new Error("Merged response not supported");j[o.key]=o.value.expected}const H={};for(const o of V)o.value.input.annotation&&(H[o.key]=o.value.input.annotation);const G=n.getOrCreateClientAIChatThreadStore(W),$=G.getOrCreateDraftTraceId();G.setState({...G.state,inferences:[],temporarySteps:(null==l?void 0:l.transcript)??(T?[]:G.state.temporarySteps),abortController:z,traceId:$,draftTraceId:void 0,loading:!0,currentUserInitiatedRunningInference:!0,wasForceStoppedByUser:!1}),G.state.stopInferencePromise&&(await G.state.stopInferencePromise,G.setState({...G.state,stopInferencePromise:void 0}));const Q=Boolean(null==c||null===(r=c.getData())||void 0===r?void 0:r.title),J={traceId:$,spaceId:x,transcript:D,threadId:W,threadParentPointer:null==l?void 0:l.parentPointer,threadWorkflowId:null==l?void 0:l.workflowId,createThread:void 0===c,debugOverrides:{...n.state.debugOverrides,cachedInferences:j,annotationInferences:H,model:q,emitInferences:n.state.showDebug},generateTitle:!Q||Boolean(m),saveAllThreadOperations:!0,analyticsArgs:u,confirmToolStepIds:g,rejectToolStepIds:S,createdSource:null==l?void 0:l.createdSource,threadType:M,isPartialTranscript:L,asPatchResponse:Boolean(T),initialAgentActions:null!=P&&P.length?[...P]:void 0,isUserInAnySalesAssistedSpace:(0,se().h0)(s),isSpaceSalesAssisted:(0,se().lM)(s,x)};n.state.showDebug&&G.setState({...G.state,requestInfo:{request:{...J,transcript:F},response:void 0,memories:[]}});try{d&&await d,await async function(e){const{environment:t,abortController:r,clientStore:n,request:i,fullTranscript:a,isRetry:s}=e,{spaceId:c,threadId:l,traceId:d,analyticsArgs:u,createdSource:m}=i;if(!l)throw new Error("Expected a threadId");const g=n.getOrCreateClientAIChatThreadStore(l),S=(0,I().WS)({spaceId:c}),y=await ee().callStreamApi({eventName:"runInferenceTranscript",environment:t,data:i,abortSignal:r.signal,headers:S});if("failed"===y.type){var b;if("AbortedError"===(null===(b=y.body)||void 0===b?void 0:b.name))throw new DOMException("Aborted","AbortError");throw y.error}if(!U().hS.is(y.data))throw new Error("Expected stream response and got non-stream response.");let T=[];const k=tt({environment:t,threadId:l,transcript:a,traceId:d,analyticsArgs:u,createdSource:m,isRetry:s});let P=!0,N=!1;k.beginInferenceTranscriptTurn(),k.markStreamStartIfUnmarked();const E=async function*(e){const{responseStream:t,environment:r,threadStore:n,threadId:o,spaceId:i}=e;let a=!1,s=!0,c=[],l={s:c},d=!1;for await(const p of t){try{"error"===p.type&&(a=!0),"queue-handoff"===p.type&&(s=!1),(0,_().yD)(p)?d||(c=it({environment:r,threadId:o,value:p,patchState:l,spaceId:i})):c=ot({environment:r,threadStore:n,value:p,currentSteps:c}),l={s:c}}catch(u){if(!O.isJSONPatchError(u))throw u;d=!0}yield{temporarySteps:c,isError:a,inferenceComplete:s}}}({responseStream:y.data,environment:t,threadId:l,threadStore:g,spaceId:c});function x(e){const r=g.state.temporarySteps.filter((e=>"user-turn"===Ae().jt[e.type]||"agent-integration"===e.type)),o=new Set(e.map((e=>e.id))),s=[...r.filter((e=>!o.has(e.id))),...e];g.setState({...g.state,temporarySteps:s}),function(e){const{environment:t,request:r,threadStore:n,updatedSteps:o,isDebugEnabled:i,fullTranscript:a,spaceId:s}=e,c=[...a,...o],l=o[o.length-1];l&&function(e){var t;const{environment:r,step:n,transcript:o,spaceId:i}=e;if("agent-tool-result"!==n.type||!(0,v().gY)(n,"create-database")||null===(t=n.result)||void 0===t||!t.shouldNavigate||!n.result.collectionViewBlockId||(0,_e().d$)({transcript:o}))return!1;const a={id:n.result.collectionViewBlockId,spaceId:i,table:C().ev},s=(0,ve().getAgentPreviewWrapper)(r),c=new(h().Bv)(r,a,{inMemoryRecordCache:s.getInMemoryRecordCacheIfIsPreviewingRecord(a,r.currentUser.id)});if(!c.isNavigableBlock())return!1;const l=(0,ce().Ef)({environment:r,updates:{store:c}});if(!l)return!1;(0,de().navigate)({environment:r,url:l,redirect:!1})}({environment:t,step:l,transcript:c,spaceId:s});if(i){const e={transcript:o};n.setState({...n.state,requestInfo:{...n.state.requestInfo,request:{...r,transcript:a},response:e,memories:[]}})}}({environment:t,request:i,isDebugEnabled:n.state.showDebug,updatedSteps:T,threadStore:g,fullTranscript:a,spaceId:c})}try{for await(const e of async function*(e,t,r,n){let o=[],i=!1;const a=new Ie(n);try{for await(const n of e)try{const{temporarySteps:e,isError:s}=n;if(i||s||!(e.length>0)){yield n,o=e;continue}const c=e[e.length-1],l=Te(c),d=o.length>0?Te(o[o.length-1]):"",u=l.length>0;let p=!1;if(u){r.markFirstTokenIfUnmarked();const n=ke(l,d);if(n.length>0){a.isSmoothing()||a.beginUpdateLoop((e=>{for(const{temporarySteps:r}of e)t(r)}));for(let t=0;t<n.length;t++){const r=Ce(c,d+n.slice(0,t+1)),o=[...e];o[o.length-1]=r,a.addItems([{temporarySteps:o}])}p=!0,o=e}}if(p)continue;await a.stopAndFinish(),yield n,o=e}catch(s){if(!ye.isSmootherError(s))throw s;w().log({level:"error",from:"inferenceTranscriptActions",type:"SmootherError",team:"ai-ux",error:(0,X().convertErrorToLog)(s)}),i=!0}}catch(s){throw await a.stopAndFinish(),s}finally{r.markStreamFinishedIfUnmarked(),await a.stopAndFinish()}}(E,x,k))if(T=e.temporarySteps,N=e.isError,P=e.inferenceComplete,T.length>0){x(T);const e=T.length>0?T[T.length-1]:null;e&&nt({analyticsController:k,value:e})}}catch(F){throw P=!1,F}finally{k.markCompletionIfUnmarked();const e=g.state.wasForceStoppedByUser??!1;P?k.endInferenceTranscriptTurn({isError:N,stepsFromTurn:T,wasUserStopped:e}):function(e){const{environment:t,clientStore:r,traceId:n,analyticsArgs:i,createdSource:a,threadId:s,isRetry:c}=e,{sidebarSpaceStore:l}=o().default.state;if(!l)return;const d=f().E.createChildStore(l,{id:s,spaceId:l.getSpaceId(),table:A().To});if(!d)return;const u=r.getOrCreateClientAIChatThreadStore(d.id),h=new(p().ComputedStore)((()=>void 0===d.getCurrentInferenceId()&&!u.state.loading),{debugName:`inferenceCompleteMonitor:${d.id}`}),m=()=>{if(h.state){const{steps:o}=(0,_e().A3)({clientStore:r,threadStore:d}),s=(0,_().Pn)(o),l=tt({environment:t,threadId:d.id,transcript:o,traceId:n,analyticsArgs:i,createdSource:a,isRetry:c}),p=e.wasUserStopped||!0===u.state.wasForceStoppedByUser,f=e.wasError||s.some((e=>"error"===e.type||"agent-debug-error"===e.type||"agent-tool-result"===e.type&&"applied:error"===(0,v().Gu)(e)));l.endInferenceTranscriptTurn({isError:f,stepsFromTurn:s,wasUserStopped:p}),u.setState({...u.state,wasForceStoppedByUser:!1}),h.removeListener(m)}};h.addListener(m),h.state&&m();setTimeout((()=>{h.removeListener(m)}),6e5)}({environment:t,clientStore:n,threadId:l,traceId:d,analyticsArgs:u,createdSource:m,wasUserStopped:e,wasError:N,isRetry:s}),g.setState({...g.state,wasForceStoppedByUser:!1})}}({environment:s,abortController:z,clientStore:n,request:J,fullTranscript:F,isRetry:N})}catch(K){rt(z,K)?await async function(e){const{environment:t,clientStore:r,threadId:n}=e,{currentUserStore:i,sidebarSpaceStore:a}=o().default.state;if(!i||!a)throw new Error("No current user root store");const s=r.getOrCreateClientAIChatThreadStore(n),c=f().E.createChildStore(a,{id:n,spaceId:a.getSpaceId(),table:A().To});if(!c)return;const{serverCommitResult:l}=(0,he().createAndCommit)({userAction:"inferenceTranscriptActions.handleAbort",environment:t,canUndo:!0,perform:e=>{Je({environment:t,spaceStore:a,userStore:i,threadStore:c,addSteps:s.state.temporarySteps,transaction:e,filterStreamingSteps:!0})}});return l}({environment:s,clientStore:n,threadId:W}):!function(e){return e instanceof Error&&"TypeError"===e.name&&"network error"===e.message}(K)?O.isJSONPatchError(K)||w().log({level:"error",from:"runFromStep",type:"runInferenceTranscriptApiError",error:(0,X().convertErrorToLog)(K),data:{miscDataToConvertToString:{spaceId:x,threadId:W}}}):w().log({level:"error",from:"runFromStep",type:"longRunningInferenceTranscriptApiConnectionDrop",data:{miscDataToConvertToString:{spaceId:x,threadId:W}}})}G.setState({...G.state,abortController:void 0,loading:!1,currentUserInitiatedRunningInference:!1,temporarySteps:[]})}function tt(e){const{environment:t,threadId:r,transcript:n,traceId:i,analyticsArgs:a,createdSource:s,isRetry:c}=e,d=(0,_e().jT)(n),u=d&&"search"===d.type?d.searchSessionId:void 0,p=performance.now();let h,m,f,v,_=n.filter((e=>"user"===e.type)).length>1,g=n.filter((e=>"user"===e.type)).length>1,S=!1,y=!1;const w=n.filter((e=>"user"===e.type)).length>1;let I=!1;return{deepFindResultsOnClient:e=>{_||((0,me().hp)({environment:t,assistantSessionId:void 0,searchSessionId:u,traceId:i,threadId:r,showResults:e.showResults,timeSinceTurnStartMs:performance.now()-p,createdSource:s}),_=!0)},deepFindBeginAiAnswer:()=>{g||((0,me().S9)({environment:t,assistantSessionId:void 0,searchSessionId:u,threadId:r,timeSinceTurnStartMs:performance.now()-p,createdSource:s}),g=!0)},beginInferenceTranscriptTurn:()=>{S||(qe({environment:t,threadId:r,traceId:i,config:d,suggestedPrompt:null==a?void 0:a.suggestedPrompt,isFollowUp:w,transcript:n,isRetry:c,inputModality:"typed"}),S=!0)},markStreamStartIfUnmarked:()=>{void 0===h&&(h=performance.now())},markFirstTokenIfUnmarked:()=>{void 0===m&&(m=performance.now())},markStreamFinishedIfUnmarked:()=>{void 0===f&&(f=performance.now())},markCompletionIfUnmarked:()=>{void 0===v&&(v=performance.now())},endInferenceTranscriptTurn:({isError:e,stepsFromTurn:a,wasUserStopped:s})=>{var u,_;if(y)return;const g=h?h-p:void 0,S=m?m-p:void 0,b=v&&f?v-f:void 0,T=v?v-p:void 0,k=(0,_e().o)(n);if("agent_new_user_onboarding"===(null==k||null===(u=k.value)||void 0===u?void 0:u.checklistId)&&"manage-projects"===(null==k||null===(_=k.value)||void 0===_?void 0:_.checklistStepId)){var A;const e=(null===(A=o().AppStoreMainEditorCurrentBlockStore.state)||void 0===A?void 0:A.id)??void 0;e&&fe().o.setPageIdForManageProjectsStep(e)}!function(e){var t;const{config:r,threadId:n,traceId:o,environment:i,isError:a,isFollowUp:s,transcript:c,stepsFromTurn:d,clientTimingMetrics:u,wasUserStopped:p}=e,h=(0,_e().o)(c),m=(0,Ue().E4)({stepsFromTurn:d,isError:a});var f;if("markdown-chat"===(null==r?void 0:r.type))(0,Ee().u)({environment:i,event:{eventName:"markdown_chat_end_turn",eventProperties:{thread_id:n,trace_id:o,is_error:a,is_follow_up:s,opened_from:null==h||null===(f=h.value)||void 0===f?void 0:f.surface}}});else if("researcher"===(null==r?void 0:r.type)&&c){var v;const{citationInfo:e,reportContent:t}=(0,Oe().VJ)(d),{resultsBySource:c,numSearchResults:l}=(0,Oe().W6)(e),{citationsBySource:u,numCitationsShown:p}=(0,Oe().ye)(t,e),h=Le().Yh(d),m=Le().ay(d);Le().g$({threadId:n,traceId:o,environment:i,isFollowUp:s,isError:a,numSearchResults:l,numCitationsShown:p,resultsBySource:c,citationsBySource:u,stepsGenerated:h,planningRounds:m,searchSources:(0,We().getAnalyticsSearchSourcesFromAssistantFeatureGateStore)(),searchScopeType:(null===(v=r.searchScope)||void 0===v?void 0:v.type)??"everything"}),Re().u4({name:"finished_og_research_mode",args:{ai_session_id:n,thread_id:n}})}else if("search"===(null==r?void 0:r.type)){var _;const{maybeSearchStep:e,maybeSearchChatStep:t,numCitations:r,citationsBySource:a,resultsBySource:c}=(0,Ue().AV)(d);(0,Ee().u)({environment:i,event:{eventName:"deep_find_end_turn",eventProperties:{thread_id:n,trace_id:o,is_follow_up:s,from:null==h?void 0:h.value.surface,search_results:c?z().cz(Object.values(c)):void 0,results_by_source:c,citations_shown:r,citations_by_source:a,search_scope_type:(null==e||null===(_=e.scope)||void 0===_?void 0:_.type)??"",search_sources:(0,We().getAnalyticsSearchSourcesFromAssistantFeatureGateStore)(),did_search:(null==t?void 0:t.didSearch)??void 0,has_search_step:void 0!==e,forcefully_stopped_by_user:p,result:m}}})}else if("workflow"===(null==r?void 0:r.type)){var g,S,y,w;const t=(0,We().getAnalyticsSearchSourcesFromAssistantFeatureGateStore)(),o=De().calculateMetricsFromTranscript(d),a=(0,Ue().DW)(d,l().A),s=c.filter((e=>"user"===e.type)).length;let f=0,v=!1,_=!1;for(const r of d)"agent-inference"===r.type&&(void 0!==r.cachedTokensRead&&r.cachedTokensRead>0&&(f+=r.cachedTokensRead),e.seenSpeculativeSearchResultsUsed&&(_=!0),r.speculativeSearchTriggered&&(v=!0)),"agent-tool-result"===r.type&&r.fromSpeculativeSearch&&(_=!0);let I=0,b=0;const T=c.findLast((e=>"user"===e.type));if(T){const e=(0,Fe().k4p)(T.value);e&&(I=e.length,b=(0,xe().I8)(e))}let k=!1,A=!1;const P=c.findLast((e=>"user-specified-context"===e.type));if(null!=P&&P.value){const{textSelection:e,blockSelection:t,pointers:r}=P.value;null!=e&&e.value&&(k=!0),((null==t?void 0:t.value)??[]).length>0&&(k=!0),(r??[]).some((e=>e.table===C().ev))&&(A=!0)}const N=c.findLast((e=>"agent-prebuilt-prompt"===e.type)),E=(null==N?void 0:N.promptType)??("rich_text_menu"===(null==h||null===(g=h.value)||void 0===g?void 0:g.surface)?"ask_ai":void 0);De().trackAgentEndTurn({environment:i,from:(null==h||null===(S=h.value)||void 0===S?void 0:S.surface)??"unknown",checklistId:null==h||null===(y=h.value)||void 0===y?void 0:y.checklistId,checklistStepId:null==h||null===(w=h.value)||void 0===w?void 0:w.checklistStepId,numUserStepsInTranscript:s,searchSources:t,...o,...a,clientTimeToStartStream:null==u?void 0:u.clientTimeToStartStream,clientTimeToFirstToken:null==u?void 0:u.clientTimeToFirstToken,clientTimeToFlushUiUpdates:null==u?void 0:u.clientTimeToFlushUiUpdates,clientTotalTurnDuration:null==u?void 0:u.clientTotalTurnDuration,isCustomAgent:Boolean(null==r?void 0:r.isCustomAgent),isDatabaseAgent:null==r?void 0:r.isDatabaseAgent,cachedTokensRead:f,numUserPromptCharacters:I,numUserPromptWords:b,forcefullyStoppedByUser:p,result:m,isRetry:e.isRetry,allowEditsEnabled:!r.useReadOnlyMode,followupVariation:r.agentFollowupVariation?r.agentFollowupVariation.join("_"):"default",hasAnySelectionContext:k,hasAnyPageContext:A,promptKey:E,threadId:n,speculativeSearchTriggered:v,speculativeSearchResultsUsed:_}),0===o.numToolRun&&(0,Ee().u)({environment:e.environment,event:{eventName:"agent_end_turn_no_tool_results",eventProperties:{ai_session_id:n,ai_inference_id:De().getInferenceIdFromThreadId(n),steps_after_last_user_step:De().getStepSummaries(c)}}})}(0,Ee().u)({environment:e.environment,event:{eventName:"inference_transcript_end_turn",eventProperties:{thread_id:e.threadId,trace_id:e.traceId,is_error:e.isError,opened_from:null==h||null===(t=h.value)||void 0===t?void 0:t.surface,config:r,forcefully_stopped_by_user:p,result:m}}})}({environment:t,config:d,threadId:r,traceId:i,isError:e,isFollowUp:w,transcript:n,stepsFromTurn:a,wasUserStopped:s,clientTimingMetrics:{clientTimeToStartStream:g,clientTimeToFirstToken:S,clientTimeToFlushUiUpdates:b,clientTotalTurnDuration:T},isRetry:c,seenSpeculativeSearchResultsUsed:I}),y=!0},markSpeculativeSearchResultsUsed:()=>{I=!0}}}function rt(e,t){return t instanceof Error&&"AbortError"===t.name&&e.signal.aborted}function nt(e){const{analyticsController:t,value:r}=e;switch(r.type){case"agent-inference":t.markFirstTokenIfUnmarked();break;case"agent-tool-result":r.fromSpeculativeSearch&&t.markSpeculativeSearchResultsUsed();break;case"search":"resultsPartial"===r.status&&t.deepFindResultsOnClient({showResults:r.showResults});break;case"search-chat":t.deepFindBeginAiAnswer()}}function ot(e){const{threadStore:t,value:r,environment:n,currentSteps:o}=e,i=n.currentUser.id;let a=o;if("queue-handoff"===r.type||"reenqueue-with-delay"===r.type);else if("record-map"===r.type)re()._O({environment:n,userId:i,inMemoryRecordCache:n.defaultRecordCache.inMemoryRecordCache,recordMap:T().RecordMapWithRole.create(r.recordMap),debugSource:"runInferenceTranscript",force:!0});else if("inference"===r.type){const e={type:"inference",key:(0,E().$A)(r.value.input),index:r.index,value:r.value},n=z().Ul([...t.state.inferences,e],(e=>e.index));t.setState({...t.state,inferences:n})}else"agent-search-extracted-results"===r.type?t.setAgentSearchResultsForTool(r):"patch"!==r.type&&"patch-start"!==r.type&&(a=(0,y().RM)(a,r));return a}function it(e){const{environment:t,threadId:r,value:n,patchState:o,spaceId:i}=e;if("patch-start"===n.type){let e=o.s;for(const t of n.data.s)e=(0,y().RM)(e,t);return e}"patch"!==n.type&&(0,Z().HB)(n);return function(e){const{environment:t,threadId:r,patches:n,patchState:o,spaceId:i}=e;try{return J.apply(o,n,{mutate:!1}).s}catch(a){throw O.isJSONPatchError(a)&&w().log({level:"error",from:"inferenceTranscriptActions",type:"JsonPatchError",team:"ai-ux",error:(0,X().convertErrorToLog)(a),data:{miscDataToConvertToString:{spaceId:i,userId:t.currentUser.id,threadId:r,message:a.name,operationPath:a.path,operationDetails:a.operation?{op:a.operation.op,path:a.operation.path}:void 0}}}),a}}({patches:n.v.map(Y),patchState:o,environment:t,threadId:r,spaceId:i})}function at(e){const t=new Map;let r=1;return e.replace(/\[\^([^\]]+)\]/g,((e,n)=>{if(n.startsWith("user://"))return"";let o=t.get(n);return void 0===o&&(o=r++,t.set(n,o)),`[[${o}]](${n})`}))}async function st(e){const{environment:t,step:r,textContent:n}=e;let o;if("markdown-chat"===r.type||"fast-researcher-chat"===r.type)o=r.value;else if("search-chat"===r.type){const e=(0,_e().Jz)(r.value);o=(0,g().Gw)({text:e,baseUrl:l().A.domainBaseUrl})}else{if("agent-inference"!==r.type)throw new Error("Unsupported step type");if(n)o=at(n);else{o=at((0,S().lH)(r.value).flatMap((e=>"text"===e.type?[e.content]:[])).join(""))}}const[i,a]=await Promise.all([(0,s().r)(),(0,c().jd)()]);await a({environment:t,stringValue:o,copiedMessage:i.copiedQnAMessageToClipboard})}function ct(e){const{environment:t,threadStore:r,stepId:n,analyticsArgs:o,isRetry:i}=e,{serverCommitResult:a}=(0,he().createAndCommit)({userAction:"AIChatTranscript.RunFromStepButton.handleClick",environment:t,canUndo:!0,perform:e=>{Ke({threadStore:r,stepId:n,transaction:e})}});et({environment:t,threadStore:r,clientStore:Ne().defaultClientAIChatStore,analyticsArgs:o,sendPatchResponse:!0,stepIdsToInclude:[n],waitBeforeSending:a,isRetry:i})}function lt(e){const{threadStore:t,config:r,environment:n}=e;if(!t)return;const{sidebarSpaceStore:i,sidebarSpaceViewStore:a}=o().default.state;if(!i||!a)return;const s=t.getTranscript(),c=t.getMessageStores(),l=s.findIndex(_e().sQ),d=s[l],u=c[l];if(l<0||!u||!d||"config"!==d.type)return;if(d.value.type!==r.type)return;const p={...d,value:r};(0,he().createAndCommit)({userAction:"AIChatTranscript.setConfigInThread",environment:n,canUndo:!0,perform:e=>{te().KY({store:u.getStepStore(),value:p,transaction:e})}})}function dt(){return(0,ge().xm)({isResearchModeWebSearchEnabled:ne().zD.isResearchModeWebSearchEnabled(),showSetupGenerator:ne().zD.showSetupGenerator()}).find((e=>"researcher"===e.type))??{type:"researcher"}}function ut(e){const{clientStore:t,initialPerform:r,threadStore:i}=e,a=(0,d().v3)(),s=(0,ie().useThreadStoreFromCurrentRoute)(),c=i??s,l=(0,u().K8)((()=>Boolean(void 0!==(null==c?void 0:c.getCurrentInferenceId())||(null==c?void 0:c.id)&&t.getOrCreateClientAIChatThreadStore(c.id).state.loading)),[c,t]),p=(0,u().K8)((()=>null!=c&&c.id?t.getOrCreateClientAIChatThreadStore(c.id):void 0),[c,t]),[h,m]=(0,n.useState)(null),f=(0,u().K8)((()=>(null==p?void 0:p.state.pendingStop)??!1),[p]),v=(0,u().K8)((()=>(null==c?void 0:c.getMessages().length)??!1),[c]);(0,n.useEffect)((()=>{if(h&&f&&c&&v){m(null);const{serverCommitResult:e}=(0,he().createAndCommit)({userAction:h.userAction,environment:a,canUndo:!1,perform:e=>{null==r||r(e),$e({threadStore:c,transaction:e,clientStore:t})}}),n=t.getOrCreateClientAIChatThreadStore(c.id);n.setState({...n.state,stopInferencePromise:e,pendingStop:!1})}}),[h,f,v,c,t,a,r]);const _=(0,n.useCallback)((async e=>{const{userAction:n}=e,{sidebarSpaceStore:i}=o().default.state;if(c&&i&&l)if(v){const{serverCommitResult:e}=(0,he().createAndCommit)({userAction:n,environment:a,canUndo:!1,perform:e=>{null==r||r(e),$e({threadStore:c,transaction:e,clientStore:t})}}),o=t.getOrCreateClientAIChatThreadStore(c.id);o.setState({...o.state,stopInferencePromise:e}),await e}else{const e=t.getOrCreateClientAIChatThreadStore(c.id);e.setState({...e.state,loading:!1,currentUserInitiatedRunningInference:!1,pendingStop:!0}),m({userAction:n})}}),[t,a,c,l,r,v]);return _}function pt(e){const t=(0,ie().useThreadStoreFromCurrentRoute)(),r=(null==e?void 0:e.providedThreadStore)??t;return(0,u().K8)((()=>Boolean((null==r?void 0:r.id)&&Ne().defaultClientAIChatStore.getOrCreateClientAIChatThreadStore(r.id).state.loading||void 0!==(null==r?void 0:r.getCurrentInferenceId()))),[r])}function ht(e){const{environment:t,operation:r,transaction:n,recordCache:o}=e;if((0,N().ph)(r))(0,ae().I)({environment:t,operation:r,transaction:n,inMemoryRecordCache:o});else if(r.pointer.table===C().ev)if("set"===r.command&&0===r.path.length){const e=te().Wv({environment:t,id:r.pointer.id,type:r.args.type,properties:r.args.properties,format:r.args.format,permissions:r.args.permissions,createdById:r.args.created_by_id,createdTime:r.args.created_time,createdByTable:r.args.created_by_table,inMemoryRecordCache:o??t.defaultRecordCache.inMemoryRecordCache,spaceId:r.args.space_id,transaction:n});(0,he().applyOperation)({store:e,operation:b().op.update({pointer:e.pointer,path:[],args:{parent_table:r.args.parent_table,parent_id:r.args.parent_id,alive:!0}}),transaction:n})}else(0,ae().I)({environment:t,operation:r,transaction:n,inMemoryRecordCache:o});else if((0,b().$Y)(r)||(0,b().mP)(r)){const e=new(m().pm)({environment:t,pointer:r.pointer,path:r.path,recordStoreOptions:{inMemoryRecordCache:o}});(0,he().applyOperation)({store:e,operation:r,transaction:n})}else(0,Z().HB)(r)}function mt(e,t){return(0,le().Z1)({environment:e,table:P().mS,spaceId:t})}},256001:(e,t,r)=>{r.d(t,{Lq:()=>p,R0:()=>l,hY:()=>c,jt:()=>s});r(18107),r(944114),r(967357),r(898992),r(354520),r(803949),r(581454),r(737550);var n=()=>r(365646),o=()=>r(878456),i=()=>r(496603),a=()=>r(534177);const s={config:"user-turn",context:"user-turn",attachment:"user-turn","user-specified-context":"user-turn",user:"user-turn","user-injected":"user-turn","agent-message":"user-turn","agent-prebuilt-prompt":"user-turn","agent-inference":"agent-turn","agent-tool-result":"agent-turn",error:"agent-turn","agent-debug-error":"agent-turn","eval-result":"agent-turn","agent-integration":"agent-turn","agent-trigger":"agent-turn","agent-route-trigger":"agent-turn","agent-transcript-summary":"agent-turn","premium-feature-unavailable":"agent-turn","agent-search-query-generation":"agent-turn"};function c(e){return"user-turn"===e.type}function l(e){const{isRunningInference:t,showDebug:r=!1}=e,o=r?[...e.transcript]:function(e){return e.sort(((e,t)=>{const r=(0,a().Xk)(h,e.type),n=(0,a().Xk)(h,t.type);return r&&!n?-1:!r&&n?1:0}))}([...e.transcript]),c=[];let l,d,u,p;const m=[];let f,v=0;for(const n of o){const e=s[n.type];e&&("user-turn"===e?_(n):g(n))}function _(e){switch(y(),l||(l={type:"user-turn"},r&&(p=void 0)),e.type){case"config":!function(e){var t;null!==(t=l)&&void 0!==t&&t.userInitiatedStep&&S();l||(l={type:"user-turn"});l.configStep=e}(e);break;case"user":case"user-injected":case"agent-message":case"agent-prebuilt-prompt":!function(e){var t;null!==(t=l)&&void 0!==t&&t.userInitiatedStep&&S();l||(l={type:"user-turn"});l.userInitiatedStep=e}(e);break;case"user-specified-context":!function(e){var t,r;null!==(t=l)&&void 0!==t&&t.userInitiatedStep&&S();l||(l={type:"user-turn"});const n=null===(r=m.at(-1))||void 0===r?void 0:r.value,o=e.value;m.length>0&&(0,i().n4)(null==n?void 0:n.pointers,null==o?void 0:o.pointers)&&(0,i().n4)(null==n?void 0:n.blockSelection,null==o?void 0:o.blockSelection)&&(0,i().n4)(null==n?void 0:n.textSelection,null==o?void 0:o.textSelection)||(m.push(e),l.userSpecifiedContextStep=e)}(e);break;case"attachment":!function(e){var t;null!==(t=l)&&void 0!==t&&t.userInitiatedStep&&S();l||(l={type:"user-turn"});l.attachmentsStep=[...l.attachmentsStep??[],e]}(e);break;case"context":!function(e){r?(p=e,u||(u=e.id)):u||(u=e.id,l||(l={type:"user-turn"}),l.contextStep=e)}(e)}}function g(e){S(),d?(d.steps.push(e),d.lastStepId=e.id,"agent-inference"===e.type&&(d.hasAgentInferenceStep=!0)):d={type:"agent-turn",steps:[e],hasAgentInferenceStep:"agent-inference"===e.type,lastStepId:e.id}}function S(){l&&(r&&p&&(l.contextStep=p),c.push(l),l=void 0)}function y(){var e;if(!d)return;const t=function(e){const t=[];if(e.forEach(((e,r)=>{"agent-tool-result"===e.type&&(0,n().gY)(e,"update-todos")&&t.push(r)})),0===t.length)return e;const r=e.map((e=>"agent-inference"!==e.type?e:function(e){const t=function(e){if(!Array.isArray(e))return e;let t=!1;const r=e.filter((e=>"tool_use"!==e.type||"update-todos"!==e.name||(t=!0,!1)));return t?r:e}(e.value);if(t===e.value)return e;return{...e,value:t}}(e))),o=t[0],i=t.at(-1)??o,a=e[i],s=[];return r.forEach(((e,t)=>{"agent-tool-result"===e.type&&(0,n().gY)(e,"update-todos")?t===o&&s.push(a):s.push(e)})),s}(d.steps),r=t.some((e=>"agent-inference"===e.type)),o=null===(e=t.at(-1))||void 0===e?void 0:e.id,i=t.length>0,a={...d,steps:t,hasAgentInferenceStep:r,lastStepId:o,feedbackComponentIndex:i?v:-1,previousStepId:f};c.push(a),i&&(v++,f=o),d=void 0}S(),y();const w=c.at(-1);return t&&"agent-turn"!==(null==w?void 0:w.type)&&c.push({type:"agent-turn",steps:[],feedbackComponentIndex:v,previousStepId:f,hasAgentInferenceStep:!1,lastStepId:void 0}),c}function d(e){const t=(0,o().ie)(e),{value:r}=t;if(void 0===r)return"";if("string"==typeof r)return r;return r.filter((e=>"text"===e.type&&(e.type,!0))).map((e=>e.content)).join("")}function u(e){const{result:t}=e;if(t&&"object"==typeof t&&"message"in t&&"string"==typeof t.message)return t.message}function p(e){const{turn:t,lastStepOnly:r=!1}=e;if("agent-turn"!==t.type)return"";if(r){for(let e=t.steps.length-1;e>=0;e-=1){const r=t.steps[e];if("agent-inference"!==r.type){if("agent-tool-result"===r.type){const e=u(r);if(e)return e}}else{const e=d(r);if(e)return e}}return""}const n=[];for(const o of t.steps)if("agent-inference"!==o.type){if("agent-tool-result"===o.type){const e=u(o);e&&n.push(e)}}else{const e=d(o);e&&n.push(e)}return n.join("\n\n")}const h=["config","context"]},263542:(e,t,r)=>{r.d(t,{P:()=>o});class n extends(()=>r(757695))().Store{getInitialState(){return{open:!1,currentView:"chat",from:void 0,isAssistantInputEmpty:!0}}}const o=new n;(0,r(852832).exposeDebugValue)("AssistantMenuStore",o)},354785:(e,t,r)=>{r.d(t,{Bg:()=>a,MU:()=>f,Rk:()=>l,Yh:()=>o,ay:()=>i,g$:()=>s,hK:()=>d,nM:()=>u,q0:()=>h,tK:()=>m,uH:()=>c,zJ:()=>p});r(898992),r(354520);var n=()=>r(564884);function o(e){return e.filter((e=>"researcher-agent"===e.type)).length}function i(e){return e.filter((e=>"researcher-next-steps"===e.type)).length}function a(e){const{environment:t,threadId:r,traceId:o,isFollowUp:i,searchSources:a,searchScopeType:s}=e;(0,n().u)({environment:t,event:{eventName:"research_mode_start_turn",eventProperties:{thread_id:r,trace_id:o,is_follow_up:i,search_sources:a,search_scope_type:s}}})}function s(e){const{environment:t,threadId:r,traceId:o,isFollowUp:i,isError:a,numSearchResults:s,numCitationsShown:c,resultsBySource:l,citationsBySource:d,stepsGenerated:u,planningRounds:p,searchSources:h,searchScopeType:m}=e;(0,n().u)({environment:t,event:{eventName:"research_mode_end_turn",eventProperties:{thread_id:r,trace_id:o,is_follow_up:i,is_error:a,num_search_results:s,num_citations_shown:c,results_by_source:l,citations_by_source:d,steps_generated:u,planning_rounds:p,search_sources:h,search_scope_type:m}}})}function c(e){(0,n().u)({environment:e.environment,event:{eventName:"research_mode_start",eventProperties:{query_length:e.queryLength,query_words:e.queryWords,search_session_id:e.searchSessionId,qna_session_id:e.qnaSessionId,research_mode_thread_id:e.researchModeThreadId,source:e.source,source_event_id:e.sourceEventId,suggested_query:e.suggestedQuery,attachment_count:e.attachmentCount??0}}})}function l(e){(0,n().u)({environment:e.environment,event:{eventName:"research_mode_step_expanded",eventProperties:{research_mode_thread_id:e.researchModeThreadId}}})}function d(e){(0,n().u)({environment:e.environment,event:{eventName:"research_mode_step_collapsed",eventProperties:{research_mode_thread_id:e.researchModeThreadId}}})}function u(e){(0,n().u)({environment:e.environment,event:{eventName:"research_mode_report_first_char_rendered",eventProperties:{research_mode_thread_id:e.researchModeThreadId}}})}function p(e){(0,n().u)({environment:e.environment,event:{eventName:"research_mode_report_last_char_rendered",eventProperties:{research_mode_thread_id:e.researchModeThreadId}}})}function h(e){(0,n().u)({environment:e.environment,event:{eventName:"research_mode_report_copied",eventProperties:{research_mode_thread_id:e.researchModeThreadId}}})}function m(e){(0,n().u)({environment:e.environment,event:{eventName:"research_mode_report_saved_to_page",eventProperties:{research_mode_thread_id:e.researchModeThreadId}}})}function f(e){(0,n().u)({environment:e.environment,event:{eventName:"research_mode_report_visited",eventProperties:{research_mode_thread_id:e.researchModeThreadId,source:e.source}}})}},616878:(e,t,r)=>{r.d(t,{f:()=>o});r(517642),r(658004),r(733853),r(845876),r(432475),r(515024),r(731698),r(898992),r(354520);class n extends(()=>r(757695))().Store{getInitialState(){return{statuses:[],previousStepIdToIndex:{},threadId:void 0}}updateStatus({threadId:e,index:t,status:r,previousStepId:n}){this.state.threadId!==e&&this.reset();const o=[...this.state.statuses];o[t]=r;const i={...this.state.previousStepIdToIndex};n&&(i[n]=t),this.setState({threadId:e,statuses:o,previousStepIdToIndex:i})}removeStatusesForMessageIds(e){const t=new Set;for(const r of e){const e=this.state.previousStepIdToIndex[r];e&&t.add(e)}if(t.size>0){const e=[...this.state.statuses];for(const r of t)delete e[r];this.setState({...this.state,statuses:e.filter(Boolean)})}}}const o=new n},631611:(e,t,r)=>{r.d(t,{Ui:()=>d,hP:()=>U,jw:()=>O,wy:()=>N});r(16280);var n,o=r(296540),i=r(474848);const a={fullPage:!0,mobileNative:!0,mobileWeb:!0,commandSearch:!0,mobileNativeTab:!0,searchPane:!0,mobileSearch:!1,writer:!1,corner:!1,mobileWriter:!1,workflowEditor:!1,inferenceTranscriptChatView:!1},s={fullPage:!0,mobileNative:!0,mobileWeb:!0,mobileNativeTab:!0,commandSearch:!1,searchPane:!1,mobileSearch:!1,writer:!1,corner:!1,mobileWriter:!1,workflowEditor:!1,inferenceTranscriptChatView:!1},c={mobileNative:!0,mobileWeb:!0,mobileSearch:!0,mobileWriter:!0,mobileNativeTab:!0,fullPage:!1,writer:!1,corner:!1,searchPane:!1,commandSearch:!1,workflowEditor:!1,inferenceTranscriptChatView:!1},l={writer:!0,mobileWriter:!0,mobileWeb:!1,mobileNative:!1,mobileSearch:!1,fullPage:!1,corner:!1,searchPane:!1,commandSearch:!1,workflowEditor:!1,mobileNativeTab:!1,inferenceTranscriptChatView:!1};function d(e){return l[e]}const u={corner:!0,searchPane:!0,fullPage:!1,mobileNative:!1,mobileWeb:!1,mobileSearch:!1,commandSearch:!1,writer:!1,mobileWriter:!1,workflowEditor:!1,mobileNativeTab:!1,inferenceTranscriptChatView:!1},p={corner:!0,searchPane:!0,fullPage:!0,mobileNative:!0,mobileWeb:!0,mobileSearch:!0,commandSearch:!0,mobileNativeTab:!0,writer:!1,mobileWriter:!1,workflowEditor:!1,inferenceTranscriptChatView:!1},h={corner:!0,searchPane:!0,fullPage:!0,mobileNative:!0,mobileNativeTab:!0,commandSearch:!0,mobileWeb:!1,mobileSearch:!1,writer:!1,mobileWriter:!1,workflowEditor:!1,inferenceTranscriptChatView:!0},m={corner:!0,searchPane:!0,fullPage:!0,commandSearch:!0,writer:!0,mobileWriter:!0,workflowEditor:!0,mobileNative:!1,mobileWeb:!1,mobileSearch:!1,mobileNativeTab:!1,inferenceTranscriptChatView:!1},f={corner:!0,searchPane:!0,commandSearch:!0,mobileNative:!0,mobileSearch:!0,mobileWeb:!0,writer:!1,fullPage:!1,mobileWriter:!1,workflowEditor:!1,mobileNativeTab:!1,inferenceTranscriptChatView:!1},v={corner:!0,writer:!0,mobileWriter:!0,fullPage:!1,searchPane:!1,commandSearch:!1,mobileNative:!1,mobileWeb:!1,mobileSearch:!1,workflowEditor:!1,mobileNativeTab:!1,inferenceTranscriptChatView:!1},_={corner:!0,fullPage:!0,searchPane:!0,mobileNative:!0,mobileNativeTab:!0,commandSearch:!0,mobileWeb:!0,mobileSearch:!0,writer:!1,mobileWriter:!1,workflowEditor:!1,inferenceTranscriptChatView:!1},g={corner:!0,fullPage:!0,searchPane:!1,mobileNative:!1,commandSearch:!1,mobileWeb:!1,mobileSearch:!1,writer:!1,mobileWriter:!1,workflowEditor:!1,mobileNativeTab:!1,inferenceTranscriptChatView:!1},S={corner:!0,fullPage:!0,commandSearch:!1,searchPane:!1,mobileNative:!1,mobileWeb:!1,mobileSearch:!1,writer:!1,mobileWriter:!1,workflowEditor:!1,mobileNativeTab:!1,inferenceTranscriptChatView:!1},y={fullPage:!0,writer:!0,corner:!0,commandSearch:!1,searchPane:!1,mobileNative:!1,mobileWeb:!1,mobileSearch:!1,mobileWriter:!1,workflowEditor:!1,mobileNativeTab:!1,inferenceTranscriptChatView:!1},w={corner:!0,fullPage:!1,writer:!1,commandSearch:!1,searchPane:!1,mobileNative:!1,mobileWeb:!1,mobileSearch:!1,mobileWriter:!1,workflowEditor:!1,mobileNativeTab:!1,inferenceTranscriptChatView:!1},I={fullPage:!0,writer:!1,corner:!1,commandSearch:!1,searchPane:!1,mobileNative:!1,mobileWeb:!1,mobileSearch:!1,mobileWriter:!1,workflowEditor:!1,mobileNativeTab:!1,inferenceTranscriptChatView:!1},b={writer:!0,fullPage:!1,corner:!1,commandSearch:!1,searchPane:!1,mobileNative:!1,mobileWeb:!1,mobileSearch:!1,mobileWriter:!1,workflowEditor:!1,mobileNativeTab:!1,inferenceTranscriptChatView:!1},T={corner:!0,fullPage:!1,searchPane:!1,mobileNative:!1,commandSearch:!1,mobileWeb:!1,mobileSearch:!1,writer:!1,mobileWriter:!1,workflowEditor:!1,mobileNativeTab:!1,inferenceTranscriptChatView:!1},k={corner:!0,fullPage:!0,searchPane:!1,mobileNative:!1,commandSearch:!1,mobileWeb:!1,mobileSearch:!1,writer:!1,mobileWriter:!1,workflowEditor:!1,mobileNativeTab:!1,inferenceTranscriptChatView:!1},C={fullPage:!0,corner:!1,searchPane:!1,mobileNative:!1,commandSearch:!1,mobileWeb:!1,mobileSearch:!1,writer:!1,mobileWriter:!1,workflowEditor:!1,mobileNativeTab:!1,inferenceTranscriptChatView:!1},A={fullPage:!0,corner:!1,searchPane:!1,mobileNative:!1,commandSearch:!1,mobileWeb:!1,mobileSearch:!1,writer:!1,mobileWriter:!1,workflowEditor:!1,mobileNativeTab:!1,inferenceTranscriptChatView:!1},P={commandSearch:!1,searchPane:!1,fullPage:!0,writer:!0,corner:!0,mobileNative:!0,mobileWeb:!0,mobileSearch:!0,mobileWriter:!0,workflowEditor:!0,mobileNativeTab:!0,inferenceTranscriptChatView:!0};class N{constructor(e){this.type=e}get renderAsFullPage(){return a[this.type]}get renderChatHistoryAsFullPage(){return s[this.type]}get isCommandSearchOrSearchPane(){return this.isType("commandSearch")||this.isType("searchPane")}get isQuickSearchMode(){return this.isType("commandSearch")}get isMobile(){return c[this.type]}get isWriter(){return l[this.type]}isType(...e){return e.includes(this.type)}get shouldShowExpandToFullPageChat(){return u[this.type]}get isValidSurfaceForAttachmentUploads(){return h[this.type]}get shouldShowChatHistory(){return p[this.type]}get canUseCurrentPageContext(){return m[this.type]}get showCloseButton(){return f[this.type]}get surfaceSupportsContextWithSelection(){return v[this.type]}get surfaceSupportsParameterization(){return _[this.type]}get surfaceSupportsTutorialAction(){return g[this.type]}get surfaceSupportsShareAnswerAction(){return S[this.type]}get canShowNewChonkifiedInput(){return y[this.type]}canShowSessionStarterInContext(e){return N[e.from].isWriter===this.isWriter}get canUseUpdatedSkillDisplayFormat(){return T[this.type]}get canUseGetAiConnectorScopeMenuFooter(){return k[this.type]}get canShowNewFullPageWelcomeState(){return I[this.type]}get canShowNewWriterDesign(){return b[this.type]}get canShowNewCornerChatWelcomeState(){return w[this.type]}get supportsStartingNewChatAsInferenceTranscript(){return C[this.type]}get supportsChatHistoryWithInferenceTranscripts(){return A[this.type]}get shouldOpenAssistantMenuOnRestoreChatSession(){return P[this.type]}}n=N,N.fullPage=new n("fullPage"),N.corner=new n("corner"),N.searchPane=new n("searchPane"),N.commandSearch=new n("commandSearch"),N.mobileNative=new n("mobileNative"),N.mobileNativeTab=new n("mobileNativeTab"),N.writer=new n("writer"),N.mobileWeb=new n("mobileWeb"),N.mobileSearch=new n("mobileSearch"),N.mobileWriter=new n("mobileWriter"),N.workflowEditor=new n("workflowEditor"),N.inferenceTranscriptChatView=new n("inferenceTranscriptChatView");const E=o.createContext(void 0);function U(e){return(0,i.jsx)(E.Provider,{value:e.surface,children:e.children})}function O(){const e=o.useContext(E);return e||N.corner}E.displayName="AssistantSurfaceContext"},688483:(e,t,r)=>{r.d(t,{K7:()=>u,Rh:()=>p,xZ:()=>d});r(944114),r(898992),r(672577),r(581454),r(737550);var n=()=>r(273900),o=()=>r(798880),i=()=>r(496603),a=()=>r(384944),s=()=>r(547149);function c(e){const{environment:t,threadStore:r,transaction:n}=e,i=Date.now();t.currentUser.id&&a().zv({store:r,data:{updated_time:i,updated_by_id:t.currentUser.id,updated_by_table:o().oo},transaction:n})}function l(e){const{environment:t,threadStore:r,transaction:o,permissionItems:a}=e,l=r.getPermissionItems(),d=0===l.length?function(e){const{environment:t,permissionItems:r}=e,n=t.currentUser.id;if(!n)return r;const o=r.some((e=>"user_permission"===e.type&&e.user_id===n));if(o)return r;return[{type:"user_permission",role:"editor",user_id:n},...r]}({environment:t,permissionItems:a}):a,u=function(e){const{oldItems:t,newItems:r}=e,o=[];for(const a of r){const e=t.find((e=>(0,n().nK)(e,a)));e&&(0,i().n4)(e,a)||o.push(a)}return o}({oldItems:l,newItems:d});0!==u.length&&(!function(e){const{threadStore:t,transaction:r,updates:n}=e,o=t.getPermissionsStore();for(const i of n)s().applyOperation({store:o,operation:{pointer:o.pointer,command:"setPermissionItem",path:o.path,args:i},transaction:r})}({threadStore:r,transaction:o,updates:u}),c({environment:t,threadStore:r,transaction:o}))}function d(e){const{environment:t,threadStore:r,transaction:n,permissionItem:o}=e,i=r.getPermissionsStore();s().applyOperation({store:i,transaction:n,operation:{pointer:i.pointer,path:i.path,command:"setPermissionItem",args:o}}),c({environment:t,threadStore:r,transaction:n})}function u(e){const{environment:t,threadStore:r,transaction:n,userIds:o,role:i}=e;l({environment:t,threadStore:r,transaction:n,permissionItems:o.map((e=>({type:"user_permission",role:i,user_id:e})))})}function p(e){const{environment:t,threadStore:r,transaction:n,currentOwnerId:o,newOwnerId:i}=e;l({environment:t,threadStore:r,transaction:n,permissionItems:[{type:"user_permission",role:"none",user_id:o},{type:"user_permission",role:"editor",user_id:i},{type:"user_permission",role:"read_and_write",user_id:o}]})}},717375:(e,t,r)=>{r.d(t,{xm:()=>s});r(898992),r(354520),r(581454);var n=()=>r(68169),o=()=>r(534177),i=()=>r(844317);function a(e){const{configs:t,isResearchModeWebSearchEnabled:r,showSetupGenerator:n}=e;return t.map((e=>function(e){const{config:t,isResearchModeWebSearchEnabled:r,showSetupGenerator:n}=e;if("researcher"===t.type)return{...t,useWebSearch:r};if("setup-generator"===t.type){if(!n)return}else if("workflow"===t.type)return(0,i().getWorkflowAgentConfig)();return t}({config:e,isResearchModeWebSearchEnabled:r,showSetupGenerator:n}))).filter(o().O9)}function s(e){const{isResearchModeWebSearchEnabled:t,showSetupGenerator:r}=e;return a({configs:n().hx,isResearchModeWebSearchEnabled:t,showSetupGenerator:r})}},798988:(e,t,r)=>{r.d(t,{o:()=>o});class n extends(()=>r(757695))().Store{getInitialState(){return{pageIdForManageProjectsStep:void 0}}getPageIdForManageProjectsStep(){return this.state.pageIdForManageProjectsStep}setPageIdForManageProjectsStep(e){this.setState({...this.state,pageIdForManageProjectsStep:e})}}const o=new n}}]);