"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[64556],{461912:(e,t,n)=>{n.d(t,{A:()=>r});class o extends(()=>n(757695))().Store{getInitialState(){return{open:!1}}}const r=new o},964556:(e,t,n)=>{n.r(t),n.d(t,{activateFromLinkCreation:()=>Fe,activateFromRedirect:()=>He,close:()=>De,getExternalBots:()=>Me,getFirstPartyAccountAccessToken:()=>Ge,initializeExternalIntegrationStore:()=>Pe,openPlaceholderMenu:()=>Qe,refreshExternalIntegrationStore:()=>Te,setUnfurlingOptionType:()=>qe,startUnfurlRequest:()=>We,startUnfurlRequestForCollection:()=>$e,startUnfurlRequestForExternalObjectInstancePage:()=>Le,transformExternalObjectInstanceBlockIntoMention:()=>nt,transformExternalObjectInstanceMentionIntoBlock:()=>ot,updateExternalObjectInstance:()=>rt});n(16280),n(944114),n(898992),n(354520),n(672577),n(430670),n(803949),n(581454);var o=()=>n(230711),r=()=>n(907258),i=()=>n(135168),a=()=>n(212497),c=()=>n(242422),l=()=>n(726637),s=()=>n(221844),d=()=>n(908006),u=()=>n(365917),p=()=>n(675133),m=()=>n(711339),f=()=>n(792057),g=()=>n(128933),v=()=>n(770063),b=()=>n(295633),I=()=>n(732810),S=()=>n(569797),_=()=>n(598790),x=()=>n(906536),h=()=>n(86159),y=()=>n(700500),k=()=>n(443239),C=()=>n(898244),A=()=>n(304740),O=()=>n(617871),w=()=>n(165358),B=()=>n(513416),j=()=>n(792071),E=()=>n(388821),U=()=>n(179034),R=()=>n(824862),P=()=>n(519831),V=()=>n(869558),M=()=>n(402904),T=()=>n(329251),F=()=>n(332393),D=()=>n(322769),N=()=>n(462853),z=()=>n(201980),q=()=>n(506391),H=()=>n(220719),W=()=>n(496603),L=()=>n(534177),$=()=>n(939768),J=()=>n(720665),G=()=>n(559926),K=()=>n(769864),X=()=>n(510683),Y=()=>n(722101),Z=()=>n(383594),Q=()=>n(44729),ee=()=>n(384944),te=()=>n(666144),ne=()=>n(144440),oe=()=>n(339798),re=()=>n(97270),ie=()=>n(120672),ae=()=>n(299917);var ce=()=>n(47373),le=()=>n(493208),se=()=>n(594794),de=()=>n(299545),ue=()=>n(684840),pe=()=>n(475882),me=()=>n(859004),fe=()=>n(673477),ge=()=>n(129522),ve=()=>n(440024),be=()=>n(518489),Ie=()=>n(747674),Se=()=>n(613016),_e=()=>n(957763),xe=()=>n(939622),he=()=>n(295304),ye=()=>n(547149),ke=()=>n(620791),Ce=()=>n(448421),Ae=()=>n(461912),Oe=()=>n(924539);const we=!1;const Be=[O().MN];function je(e,t){var n;const o=Boolean(e&&Be.includes(e.id));return{hasServerDeterminedOptionTypes:o,canUnfurlAsCollection:Boolean(!o&&(null==t||null===(n=t.additional_types)||void 0===n?void 0:n.collection)),canUnfurlAsImport:Boolean(e&&Ee(e,t))}}function Ee(e,t){switch(e.id){case O().MN:return!0;case O().Hd:return t&&"google_docs"===t.name;case O().mn:return t&&"Report"===t.name;default:return!1}}const Ue=(0,n(69708).YK)({browse:{id:"externalBlock.mediaPicker.browseTab.title",defaultMessage:"Browse {appName}"},somethingWentWrong:{defaultMessage:"Something went wrong.",id:"externalActions.dialogError.openFilePicker.errorMessage"},copyDebuggingInformation:{id:"externalActions.dialogItem.openFilePicker.copyDebugData",defaultMessage:"Copy debugging information"},copiedDebuggingInfo:{id:"externalActions.dialogError.copiedDebuggingInfo",defaultMessage:"Copied to clipboard."},userReAuth:{id:"externalActions.dialogError.userReAuth",defaultMessage:"Authentication Expired. Please Re-Authenticate to continue."}});let Re=!1;async function Pe(e){const{environment:t,spaceId:n,force:o}=e;await r().default.waitUntilRendered();const i=u().A.state,a=t.currentUser.id;if(!i.loaded&&!i.loading||i.loaded&&n!==i.spaceId||i.loaded&&a!==i.userId||o){const e=!Re;e&&(Re=!0,m().default.DO_NOT_USE_measureFromPageOriginLegacy("external_integration_store.page_origin_to_loading",{environment:t})),u().A.setState({...u().A.state,loading:!0});const[o,r]=await Promise.all([Ve({environment:t,spaceId:n}),Me({environment:t,spaceId:n})]);if("success"!==o.type||"success"!==r.type)throw new Error("Request failed.");const i=E().RecordMapWithRole.create(o.data.recordMap),a=E().RecordMapWithRole.create(r.data.recordMap);u().A.setState({loaded:!0,loading:!1,spaceId:n,userId:t.currentUser.id,integrations:W().Ul(W().oE(o.data.integrationIds.map((e=>i.getValue({table:F().Li,id:e})))),(({created_at:e})=>e)),externalAuthentications:W().Ul(W().oE(r.data.externalAuthenticationIds.map((e=>a.getValue({table:M().As,id:e})))),(({created_at:e})=>e)),bots:W().My(W().oE(r.data.botIds.map((e=>a.getValue({table:R().GP,id:e})))),(({last_edited_at:e,created_at:t})=>e||t),"desc"),completeSlackAuthentications:W().Ul(W().oE(r.data.completeSlackAuthenticationIds.map((e=>a.getValue({table:M().As,id:e})))),(({created_at:e})=>e)),externalEntities:W().Ul(W().oE(r.data.externalEntityIds.map((e=>a.getModel({table:T().$,id:e})))),(({created_at:e})=>e))}),e&&(Re=!0,m().default.DO_NOT_USE_measureFromPageOriginLegacy("external_integration_store.page_origin_to_ready",{environment:t}))}}async function Ve(e){const{environment:t,spaceId:n}=e,o=m().default.DO_NOT_USE_markLegacy("external_integration_store.get_external_integrations"),r=await K().callCellCompatibleApi({eventName:"getExternalIntegrations",environment:t,data:{spaceId:n},cellNavigation:{spaceId:n}});return"success"===r.type&&m().default.DO_NOT_USE_measureLegacy(o,{environment:t}),r}async function Me(e){const{environment:t,spaceId:n}=e;if(!t.currentUser.isLoggedIn())return{type:"success",status:200,headers:{},data:{botIds:[],externalAuthenticationIds:[],recordMap:{},completeSlackAuthenticationIds:[],externalEntityIds:[]}};const o=m().default.DO_NOT_USE_markLegacy("external_integration_store.get_user_space_external_bots"),r=await K().callCellCompatibleApi({eventName:"getUserSpaceExternalBots",environment:t,data:{spaceId:n},cellNavigation:{spaceId:n}});return"success"===r.type&&m().default.DO_NOT_USE_measureLegacy(o,{environment:t}),r}async function Te(e){const{environment:t}=e,{sidebarSpaceStore:n}=r().default.state;n&&await Pe({environment:t,spaceId:n.id,force:!0})}function Fe(e){var t;const{environment:n,blockStore:r,textStore:i,url:a,textValueBeforePaste:c,urlSelection:l}=e,m=h().get();if(!r||re().A.state.open||fe().Ay.state.open||Ae().A.state.open||!m)return!1;const f=r.getSpaceStore(),g=(0,A().US)(a),v=(0,$().qg)(g);if(!v.host)return!1;const x=n.currentUser.id;if(null==f||!f.isDefined()||!x)return!1;const y=f.id,k=u().A.integrations.state.filter((e=>e.id!==O().ob)),C=(0,q().$B)({url:g,integrations:k,currentSpaceId:y});if("partial"===C.type)return function(e){const{environment:t,parsedUrl:n,urlDomain:o,integrationId:r}=e;G().FO(t,{integrationId:r,urlDomain:o}),w().log({level:"debug",from:"activateFromLinkCreation",type:"linkPreviewUrlMiss",data:{miscDataToConvertToString:{integrationId:r,urlDomain:o,path:n.path}}})}({...C,integrationId:C.integration.id,environment:n}),!1;if("failure"===C.type)return!1;const{integration:B,pattern:j}=C;if(!(0,o().dp)(f,x).isWorkspaceOwner()&&!(0,D().nH)({spaceBotSettings:f.getBotSettingsStore().getValue(),integrationId:B.id}))return!1;const E=(0,ke().jw)(B.id),R=ze({blockStore:r,integration:B,pattern:j,textValueBeforePaste:c}),M=h().getRect(m);if(!M)return!1;const T=r.getRecordStoreUIParent();if(!T||!(0,de().iU)(T))return!1;const F=new(s().A)({name:"unfurlingActions.activateFromLinkCreation",isTemporaryData:!0});n.defaultRecordCache.inMemoryRecordCache.addCacheOverride(F);const N=T.clone(F),z=r.clone(F),H=i.table===U().ev&&i===(null===(t=(0,_().T)(i))||void 0===t?void 0:t.getBlockTitleStore())?z.getBlockTitleStore():i.clone(F),L=(0,se().JH)({environment:n,table:U().ev,spaceId:y}),J=new(b().B)(n,L),K=J.clone(F),X=W().y1(q().MV).map((()=>new(b().B)(n,{table:U().ev,id:(0,se().Z1)({environment:n,table:U().ev,spaceId:y}),spaceId:y}))),Y=X.map((e=>e.clone(F))),Z=new(I().m)(n,(0,se().JH)({environment:n,table:P().Vl,spaceId:y})),Q=Z.clone(F);let ee;ee=j.defaultViews?j.defaultViews.map((e=>new(S().p)(n,(0,se().JH)({environment:n,table:V().Gy,spaceId:y})))):[new(S().p)(n,(0,se().JH)({environment:n,table:V().Gy,spaceId:y}))];const te=ee.map((e=>e.clone(F))),ne=W().y1(q().MV).map((()=>new(I().m)(n,(0,se().JH)({environment:n,table:P().Vl,spaceId:y})))),oe=ne.map((e=>e.clone(F))),ie=W().y1(q().MV).map((()=>new(S().p)(n,(0,se().JH)({environment:n,table:V().Gy,spaceId:y})))),ae=ie.map((e=>e.clone(F)));let ce;return Ae().A.setState({open:!0,url:g,textValueBeforePaste:c,textValueAfterPaste:i.getValue(),urlSelection:l,renderRect:M,integration:B,pattern:j,currentOption:{type:"link"},allOptionTypes:R,temporaryRecordCache:F,stores:{blockStore:r,blockParentStore:T,textStore:i,externalObjectInstanceBlockStore:J,subExternalObjectInstanceBlockStores:X,externalCollectionStore:Z,externalCollectionViewStores:ee,subExternalCollectionStores:ne,subExternalCollectionViewStores:ie},temporaryStores:{blockParentStore:N,blockStore:z,textStore:H,externalObjectInstanceBlockStore:K,subExternalObjectInstanceBlockStores:Y,externalCollectionStore:Q,externalCollectionViewStores:te,subExternalCollectionStores:oe,subExternalCollectionViewStores:ae},unfurlResponse:void 0}),E.length>0&&We({environment:n,url:a,botIds:E.map((({id:e})=>e)),integrationId:B.id,externalObjectInstanceBlockStore:J}),G().Ki(n,{integrationId:B.id,entity:j.name,domain:v.host,from:"link_paste"}),ce="import"===R[0]?"link":R[0],d().default.afterNextFlush((()=>{const e="drive"!==ce;ye().createAndCommit({userAction:"unfurlingActions.activateFromLinkCreation",environment:n,canUndo:!e,perform:t=>{qe({environment:n,type:ce,useTemporaryRecordCache:e,transaction:t,intl:p().A.getIntl()})}})})),!0}function De(e){const{environment:t,setType:n,transaction:o}=e,{currentUserSettingsStore:i}=r().default.state,a=(0,ie().y)(t),c=Ae().A.state;if(!c.open)return;t.defaultRecordCache.inMemoryRecordCache.removeCacheOverride(c.temporaryRecordCache);const l=(0,ke().jw)(c.integration.id).length>0;if(qe({environment:t,type:n||c.currentOption.type,useTemporaryRecordCache:!1,transaction:o,intl:p().A.getIntl()}),function(e){const t=Ae().A.state;if(!t.open)return;const{unfurlResponse:n}=t,{type:o}=t.currentOption,{host:r}=(0,$().qg)((0,A().US)(t.url));r&&G().lR(e,{integrationId:t.integration.id,type:o,entity:t.pattern.name,domain:r,from:"unfurl_menu",...n&&{status:null!=n&&n.root.error?"failure":"success"},collection_id:"collection"===o?t.stores.externalCollectionStore.pointer.id:void 0,collection_view_block_id:"collection"===o&&t.stores.blockStore.isCollectionView()?t.stores.blockStore.id:void 0})}(t),"preview"===c.currentOption.type)(0,Ie().t)({environment:t,stores:[c.currentOption.externalObjectInstanceBlockStore]});else if("drive"===c.currentOption.type){var s,d,u,m,f;const e=$().qg(c.url,{slashesDenoteHost:!0});let n=e.href;if(null!==(s=e.hostname)&&void 0!==s&&s.includes("docs.google.com")&&(null!==(d=e.pathname)&&void 0!==d&&d.includes("presentation")||null!==(u=e.pathname)&&void 0!==u&&u.includes("document")||null!==(m=e.pathname)&&void 0!==m&&m.includes("spreadsheets"))&&null!==(f=e.pathname)&&void 0!==f&&f.includes("/edit")){const t=e.pathname.replace("/edit","/preview");n=$().Gm({url:`https://${e.hostname}${t}`,query:{...e.query},hash:e.hash||void 0})}else n=(0,A().US)(n);ne().Fy(t,{embeddedUrl:{originUrl:n},isDataURL:!1,store:c.stores.blockStore,pageWidth:a,preferredType:"drive"})}if(c.integration&&!l){(null==i?void 0:i.hasDismissedIntegrationPopup({integrationId:c.integration.id}))||Ce().A.setState({open:!0,integration:c.integration,externalObjectInstanceBlockId:c.stores.externalObjectInstanceBlockStore.id,unfurlUrl:c.url})}Ne({environment:t,integrationId:c.integration.id,blockStore:c.stores.externalObjectInstanceBlockStore,unfurlResponse:c.unfurlResponse}),Ae().A.setState({open:!1})}async function Ne({environment:e,integrationId:t,blockStore:n,unfurlResponse:o}){var r;o&&t===O().Hd&&428===(null===(r=o.root.error)||void 0===r?void 0:r.status_code)&&await(0,pe().R)({environment:e,store:n,url:o.root.uri||""})}function ze(e){const{integration:t,pattern:n,blockStore:o,textValueBeforePaste:r}=e,i=o&&o.getType()===y().xd.text&&0===(0,z().q4_)(r).trim().length,{hasServerDeterminedOptionTypes:a,canUnfurlAsCollection:l,canUnfurlAsImport:s}=je(t,n);if(t){if(i){const e=c().default.getConfigKey("link_paste_order",(null==t?void 0:t.id)||"defaultOrder");return e?(l&&(e.order.includes("collection")||e.order.splice(e.order.length-1,0,"collection")),s&&(e.order.includes("import")||e.order.push("import")),W().oE(e.order)):W().oE(["preview","mention","link",(a||l)&&"collection",s&&"import"])}return W().oE(["mention","preview","link",(a||l)&&"collection",s&&"import"])}return i?W().oE(["preview","mention","link",(a||l)&&"collection",s&&"import"]):W().oE(["mention","preview","link",(a||l)&&"collection",s&&"import"])}function qe(e){const{environment:t,type:n,transaction:o,useTemporaryRecordCache:i}=e,a=Ae().A.state;if(!a.open)return;const c=a.integration.id,l=t.currentUser.id,{sidebarSpaceStore:s}=r().default.state;if(!l||null==s||!s.isDefined())return;const u=s.id,p=i?a.temporaryStores:a.stores;if(i){a.temporaryRecordCache.clearCache();for(const e in a.temporaryStores){const n=a.temporaryStores[e],o=Array.isArray(n)?n:[n];for(const e of o){const n={userId:l,pointer:e.pointer},o=t.defaultRecordCache.inMemoryRecordCache.getRecord(n);o?te().PC({environment:t,inMemoryRecordCache:a.temporaryRecordCache,pointer:e.pointer,model:j().Bj6.fromValue(e.pointer.table,o.value),role:o.role,updatePaths:[[]],userId:l,force:!0,debugSource:"setUnfurlingOptionType"}):te().oX({environment:t,inMemoryRecordCache:a.temporaryRecordCache,persistedRecordCache:void 0,pointer:e.pointer,userId:l})}}}const m=(0,A().US)(a.url),{host:f}=(0,$().qg)(m);if(f){if("preview"===n||"mention"===n){const e={original_url:m,domain:f};let n;const{unfurlResponse:r}=a;if(r){const i=(0,L().MU)(W().oE(r.relations.map(((e,n)=>{if(e.external_schema)return;const r=p.subExternalObjectInstanceBlockStores[n];return r?((0,H().MX)(!r.isDefined(),"Sub external object instance store should not have a value before creation"),ee().Wv({environment:t,id:r.id,type:y().xd.externalObjectInstance,spaceId:u,format:e,inMemoryRecordCache:r.inMemoryRecordCache,transaction:o}),ee().zv({store:r,data:{parent_table:U().ev,parent_id:p.externalObjectInstanceBlockStore.id,alive:!0},transaction:o}),[e.uri,r.id]):void 0})))),{external_object_id:a,uri:c,bot_id:l}=r.root;var g;if(a&&c&&l)n={...e,...{...r.root,external_schema:void 0},related_external_object_uris_to_instance_ids:i,external_object_id:a,uri:c,bot_id:l};else n={...e,attributes:r.root.attributes,error:r.root.error,auth_refresh_in_progress:439===(null===(g=r.root.error)||void 0===g?void 0:g.status_code)||null}}else n=e;(0,ce()._J)()||(0,H().MX)(!p.externalObjectInstanceBlockStore.isDefined(),"Preview/mention menu external object instance store should not have a value before creation"),ee().Wv({environment:t,id:p.externalObjectInstanceBlockStore.id,type:y().xd.externalObjectInstance,format:n,inMemoryRecordCache:p.externalObjectInstanceBlockStore.inMemoryRecordCache,transaction:o})}else if("collection"===n){const{unfurlResponse:e}=a;let n=p.externalCollectionStore.pointer;const r=p.externalCollectionViewStores.map(((e,t)=>{var n,o,r;return{id:e.id,version:0,space_id:u,type:(null===(n=a.pattern.defaultViews)||void 0===n?void 0:n[t].type)||"table",format:null===(o=a.pattern.defaultViews)||void 0===o?void 0:o[t].format,query2:null===(r=a.pattern.defaultViews)||void 0===r?void 0:r[t].query2,parent_table:U().ev,parent_id:p.externalObjectInstanceBlockStore.id,alive:!0}}));let i;const l=(0,N().l)(c);if(!l||(0,xe().z)(t,{spaceId:null==s?void 0:s.id,userId:t.currentUser.id,name:l}))if(e){const{external_object_id:t,uri:r,bot_id:a}=e.root;if(t&&r&&a)if("collectionId"in e&&e.collectionId){i={id:e.collectionId,version:0,space_id:u,parent_table:U().ev,parent_id:p.externalObjectInstanceBlockStore.id,alive:!0,schema:{}},n={id:e.collectionId,table:P().Vl,spaceId:u}}else{const t={};e.relations.forEach(((e,n)=>{const r=p.subExternalCollectionStores[n],i=e,a={id:r.id,version:0,space_id:u,parent_table:P().Vl,parent_id:p.externalCollectionStore.id,alive:!0,format:i,schema:{}};t[e.uri]=r.id,ee().zv({store:r,data:a,transaction:o})}));i={id:p.externalCollectionStore.id,version:0,space_id:u,parent_table:U().ev,parent_id:p.externalObjectInstanceBlockStore.id,alive:!0,format:{original_url:m,domain:f,...e.root,related_external_object_uris_to_instance_ids:{...t}},schema:{}}}else{i={id:p.externalCollectionStore.id,version:0,space_id:u,parent_table:U().ev,parent_id:p.externalObjectInstanceBlockStore.id,alive:!0,format:{original_url:m,domain:f,error:e.root.error},schema:{}}}}else{i={id:p.externalCollectionStore.id,version:0,space_id:u,parent_table:U().ev,parent_id:p.externalObjectInstanceBlockStore.id,alive:!0,format:{original_url:m,domain:f},schema:{}}}else{i={id:p.externalCollectionStore.id,version:0,space_id:u,parent_table:U().ev,parent_id:p.externalObjectInstanceBlockStore.id,alive:!0,format:{is_placeholder:!0,integration_id:c},schema:{}}}(0,H().MX)(!p.externalObjectInstanceBlockStore.isDefined(),"Collection menu external object instance store should not have a value before creation");const g=ee().Wv({environment:t,id:p.externalObjectInstanceBlockStore.id,type:y().xd.collectionView,format:{collection_pointer:n,collection_pointers:[n]},spaceId:u,inMemoryRecordCache:p.externalObjectInstanceBlockStore.inMemoryRecordCache,transaction:o});ee().zv({store:g,data:{collection_id:n.id,parent_table:U().ev,parent_id:p.blockParentStore.id,alive:!0,view_ids:p.externalCollectionViewStores.map((e=>e.id))},transaction:o});const v=Ze();p.externalCollectionViewStores.forEach(((t,n)=>{e&&"collectionId"in e&&e.collectionId&&r[n].format&&(r[n].format={collection_pointer:{id:e.collectionId,table:P().Vl}}),v&&e&&"table"===r[n].type&&(r[n].format={...r[n].format,table_properties:tt(e.root.external_schema)}),ee().zv({store:t,data:r[n],transaction:o})})),ee().zv({store:p.externalCollectionStore,data:i,transaction:o});const b=a.integration;d().default.afterNextFlush((()=>{const e=ge().K.findCollectionViewBlockFromId(p.externalObjectInstanceBlockStore.id);if(e&&"collectionContextStore"in e){const t=e.collectionContextStore.settingsStore;oe().R8({collectionSettingsStore:t,item:{type:"shareSyncedView",integrationName:b.name,integrationIcon:b.info.icon}})}}))}if("preview"===n){he().R9({environment:t,store:p.textStore,value:a.textValueBeforePaste,transaction:o});const e=b().B.createChildStore(p.blockParentStore,p.externalObjectInstanceBlockStore.pointer);if(Y().WH({parentStore:p.blockParentStore,insertStore:e,afterStore:p.blockStore,transaction:o}),0===(0,z().q4_)(a.textValueBeforePaste).trim().length){const e=b().B.createChildStore(p.blockParentStore,a.stores.blockStore.pointer);Y().TF({parentStore:p.blockParentStore,childToRemoveStore:e,transaction:o})}const r=b().B.createChildStore(a.stores.blockParentStore,a.stores.externalObjectInstanceBlockStore.pointer);(0,ve().I)({environment:t}),Ae().A.setState({...a,currentOption:{type:n,externalObjectInstanceBlockStore:r}})}else if("mention"===n){const e=(0,z().bMp)(p.externalObjectInstanceBlockStore.id),n=(0,z().wmz)(e),r=(0,z().xym)(a.textValueBeforePaste,[n],a.urlSelection.startIndex),i={startIndex:a.urlSelection.startIndex+1,endIndex:a.urlSelection.startIndex+1};he().R9({environment:t,store:p.textStore,value:r,transaction:o}),ee().zv({store:p.externalObjectInstanceBlockStore,data:{parent_id:p.textStore.id,parent_table:U().ev,alive:!0},transaction:o}),(0,be().h)({environment:t,store:a.stores.blockStore}),(0,x().t)({store:a.stores.textStore,selection:i}),Ae().A.setState({...a,currentOption:{type:"mention",mentionTokenSelection:i}})}else if("link"===n)Ae().A.setState({...a,currentOption:{type:"link"}}),(0,be().h)({environment:t,store:a.stores.blockStore}),(0,x().t)({store:a.stores.textStore,selection:{startIndex:a.urlSelection.endIndex,endIndex:a.urlSelection.endIndex}});else if("drive"===n)Ae().A.setState({...a,currentOption:{type:"drive"}}),(0,be().h)({environment:t,store:a.stores.blockStore}),(0,x().t)({store:a.stores.textStore,selection:{startIndex:a.urlSelection.endIndex,endIndex:a.urlSelection.endIndex}});else if("collection"===n){he().R9({environment:t,store:p.textStore,value:a.textValueBeforePaste,transaction:o});const e=b().B.createChildStore(p.blockParentStore,p.externalObjectInstanceBlockStore.pointer);if(Y().WH({parentStore:p.blockParentStore,insertStore:e,afterStore:p.blockStore,transaction:o}),0===(0,z().q4_)(a.textValueBeforePaste).trim().length){const e=b().B.createChildStore(p.blockParentStore,a.stores.blockStore.pointer);Y().TF({parentStore:p.blockParentStore,childToRemoveStore:e,transaction:o})}(0,ve().I)({environment:t}),Ae().A.setState({...a,currentOption:{type:n}})}else(0,L().HB)(n)}}async function He(e){const{environment:t,notionState:n}=e,{externalObjectInstanceBlockId:o,spaceId:r}=n;if(o){const e=new(b().B)(t,{table:U().ev,id:o,spaceId:r});let n;if(await Promise.all([e.load(),u().A.waitUntil((()=>u().A.state.loaded))]),e.isExternalObjectInstanceBlockStore()||e.isExternalObjectInstancePageBlockStore())n=e.getFormat();else if(e.isCollectionView()){var i;n=null===(i=e.getCollectionStoreIfSingleSource())||void 0===i?void 0:i.getFormat()}if(!n)throw new Error("External object instance has no value.");const a=n.original_url||n.uri;if(!a)throw new Error("External object instance has no original_url.");const c=(0,q().$B)({url:a,integrations:u().A.integrations.state,currentSpaceId:r});if("success"!==c.type)throw new Error("Could not find integration.");const{integration:l}=c,s=(0,ke().jw)(l.id);if(0===s.length)throw new Error("Could not find bot.");if(e.isExternalObjectInstanceBlockStore()||e.isExternalObjectInstancePageBlockStore())await We({environment:t,url:a,botIds:s.map((({id:e})=>e)),integrationId:l.id,externalObjectInstanceBlockStore:e});else{if(!e.isCollectionView())throw new Error(`BlockStore is neither an ExternalObject nor a ExternalCollection. It has type: ${e.getType()}`);{const n=e.getCollectionStoreIfSingleSource();if(!n)throw new Error("Could not find collection store.");await $e({environment:t,url:a,botIds:s.map((({id:e})=>e)),externalCollectionViewBlockStore:e,externalCollectionStore:n,integrationId:l.id})}}}}async function We(e){const{environment:t,url:n,botIds:o,integrationId:r,externalObjectInstanceBlockStore:i}=e;Oe().A.add(n);const a=await K().callApi({eventName:"unfurlUrl",environment:t,data:{url:n,botIds:o,integrationId:r,spaceId:(0,Se().a)()}});Oe().A.delete(n);const c=Ae().A.state,l="success"===a.type?a.data:{root:{error:{status_code:a.status}},relations:[]};if(c.open&&c.stores.externalObjectInstanceBlockStore===i){Ae().A.setState({...c,unfurlResponse:l});const e=function(e,t,n){if(Be.includes(e)&&"collection"===n)return t.root.hasOwnProperty("external_schema")?"collection":"preview";if("import"===n)return"link";return n}(r,l,c.currentOption.type);ye().createAndCommit({userAction:"unfurlingActions.startUnfurlRequest",environment:t,canUndo:!1,perform:n=>{qe({environment:t,type:e,useTemporaryRecordCache:!0,transaction:n,intl:p().A.getIntl()})}})}else{if(i.isExternalObjectInstanceBlockStore())!function(e){const{environment:t,unfurlResponse:n,url:o,externalObjectInstanceBlockStore:r}=e,i=r.pointer.spaceId,a=t.currentUser.id;if(!a)return;const c=(0,A().US)(o),{host:l}=(0,$().qg)(c);if(!l)return;if("collectionId"in n)return;const s=r.getFormat().related_external_object_uris_to_instance_ids,d=(0,L().MU)(Object.entries(s||{}).map((([e,t])=>[e,b().B.createChildStore(r,{id:t,table:U().ev,spaceId:r.getSpaceId()})])));ye().createAndCommit({userAction:"unfurlingActions.createExternalObjectInstanceFromInitialUnfurl",environment:t,canUndo:!0,perform:e=>{const a=(0,L().MU)(W().oE(n.relations.map((n=>{if(n.external_schema)return;let o=d[n.uri];return o?(ee().zv({store:o,data:{type:y().xd.externalObjectInstance,parent_table:U().ev,parent_id:r.id,alive:!0},transaction:e}),ee().zv({store:o.getFormatStore(),data:n,transaction:e})):(o=ee().Wv({environment:t,type:y().xd.externalObjectInstance,spaceId:i,format:n,inMemoryRecordCache:r.inMemoryRecordCache,transaction:e}),ee().zv({store:o,data:{parent_table:U().ev,parent_id:r.id,alive:!0},transaction:e})),[n.uri,o.id]})))),c=r.getFormatStore().getValue();let l,s;c&&(l=c.block_width,s=c.block_height),ee().zv({store:r.getFormatStore(),data:{...{...n.root,block_width:l,block_height:s,external_schema:void 0,integration_id:null,original_url:o,is_placeholder:null,error:n.root.error??null},related_external_object_uris_to_instance_ids:a},transaction:e})}})}({environment:t,unfurlResponse:l,url:n,externalObjectInstanceBlockStore:i}),function(e){const{environment:t,url:n,spaceId:o,status:r}=e,i=(0,le().g8)(n,o),a=(0,A().US)(n),c=(0,$().qg)(a);i&&c.host&&G().lR(t,{integrationId:i.integration.id,type:"preview",entity:i.pattern.name,domain:c.host,from:"link_preview_placeholder",...r&&{status:r}})}({environment:t,url:n,spaceId:i.getSpaceId(),...l&&{status:l.root.error?"failure":"success"}});else{if(!i.isCollectionView()){if(i.isExternalObjectInstancePageBlockStore())return;throw new Error(`BlockStore is neither an ExternalObject nor a ExternalCollection. It has type: ${i.getType()}`)}{const e=i.getCollectionStoreIfSingleSource();if(!e)throw new Error("Could not find collection store.");ye().createAndCommit({userAction:"unfurlingActions.startUnfurlRequest",environment:t,canUndo:!0,perform:o=>{Je({environment:t,unfurlResponse:l,url:n,externalCollectionStore:e,externalCollectionViewBlockStore:i,transaction:o,integrationId:r})}})}}Ne({environment:t,integrationId:r,blockStore:i,unfurlResponse:l})}}async function Le(e){const{environment:t,url:n,botIds:o,userDefinedExternalCollectionStore:r,relatedPageId:i}=e,a=r.getFormat();if(!a.uri||void 0!==a.external_object_id)return;Oe().A.add(n);const c=await K().callApi({eventName:"unfurlUrl",environment:t,data:{url:n,botIds:o,spaceId:r.getSpaceId(),targetCollectionId:r.id,relatedPageId:i}});if("failed"===c.type)return void f().Qg(c);Oe().A.delete(n);const l=c.data;return"pageId"in l&&l.pageId?new(b().B)(t,{table:U().ev,id:l.pageId,spaceId:r.getSpaceId()}):function(e){const{environment:t,unfurlResponse:n,url:o,rootUserDefinedExternalCollectionStore:r}=e,i=r.pointer.spaceId,a=t.currentUser.id;if(!a)return;const c=(0,A().US)(o),{host:l}=(0,$().qg)(c);if(!l)return;if(!n.root.external_object_id)return;const s=n.root;return ye().createAndCommit({userAction:"unfurlingActions.createExternalObjectInstancePageFromInitialUnfurl",environment:t,canUndo:!0,perform:e=>{const n=ee().Wv({environment:t,type:y().xd.externalObjectInstancePage,spaceId:i,format:s,inMemoryRecordCache:r.inMemoryRecordCache,transaction:e});return Q().X$({parentStore:r,childStore:n,transaction:e}),new(b().B)(t,n.pointer)}}).performResult}({environment:t,unfurlResponse:l,url:n,rootUserDefinedExternalCollectionStore:r})}async function $e(e){const{environment:t,url:n,botIds:o,externalCollectionStore:r,externalCollectionViewBlockStore:i,integrationId:a}=e;Oe().A.add(n);const c=await K().callApi({eventName:"unfurlUrl",environment:t,data:{url:n,botIds:o,spaceId:(0,Se().a)()}});Oe().A.delete(n);const l="success"===c.type?c.data:{root:{error:{status_code:c.status}},relations:[]};ye().createAndCommit({userAction:"unfurlingActions.startUnfurlRequestForCollection",environment:t,canUndo:!0,perform:e=>{Je({environment:t,unfurlResponse:l,url:n,externalCollectionStore:r,externalCollectionViewBlockStore:i,transaction:e,integrationId:a})}})}function Je(e){const{environment:t,unfurlResponse:n,url:o,externalCollectionStore:r,externalCollectionViewBlockStore:i,transaction:a,integrationId:c}=e,l=(0,A().US)(o),{host:s}=(0,$().qg)(l);if(!s)return;const{external_object_id:d,uri:u,bot_id:p}=n.root;if(!d||!u||!p)return;const m=r.getSpaceId(),f=(0,N().l)(c);if(!f||(0,xe().z)(t,{spaceId:m,userId:t.currentUser.id,name:f})){const e=W().y1(q().MV).map((()=>new(I().m)(t,(0,se().JH)({environment:t,table:P().Vl,spaceId:m})))),o={};n.relations.forEach(((t,n)=>{const i=e[n],c=t,l={id:i.id,version:0,space_id:m,parent_table:P().Vl,parent_id:r.id,alive:!0,format:c,schema:{}};o[t.uri]=i.id,ee().zv({store:i,data:l,transaction:a})}));const c={id:r.id,version:0,space_id:m,parent_table:U().ev,parent_id:i.id,alive:!0,format:{original_url:l,domain:s,...n.root,property_visibility:(g=n.root.external_schema,g&&Object.keys(g).flatMap((e=>(0,C().cC)(e)?[]:{property:`${k().U}${e}`,visibility:"hide_if_empty"}))),related_external_object_uris_to_instance_ids:{...o},is_placeholder:void 0,integration_id:void 0},schema:{}};ee().zv({store:r,data:c,transaction:a})}else{const e={id:r.id,version:0,space_id:m,parent_table:U().ev,parent_id:i.id,alive:!0,format:{is_placeholder:!0,integration_id:c},schema:{}};ee().zv({store:r,data:e,transaction:a})}var g;if(Ze()&&n){const e=i.getCollectionViewIds();null==e||e.forEach((e=>{const t=S().p.createChildStore(i,{table:V().Gy,id:e,spaceId:i.getSpaceId()});if("table"===t.getType()){const e={...t.getFormat(),table_properties:tt(n.root.external_schema)};ee().zv({store:t,data:{format:e},transaction:a})}}))}}async function Ge(e){const{environment:t,externalAuthenticationValue:n}=e;let o=await K().callApi({eventName:"getExternalIntegrationAccessToken",environment:t,data:{botId:n.id,integrationId:n.integration_id,spaceId:n.space_id}});if("failed"===o.type){const e=u().A.integrations.state.find((e=>e.id===n.integration_id));if(!e)return;g().D6({label:p().A.formatMessage(Ue.userReAuth)}),await X().Jq({environment:t,integration:e,spaceId:n.space_id,from:"integration_file_picker"});const r=u().A.bots.state.filter((e=>e.integration_id===n.integration_id))[0];if(!r)return;o=await K().callApi({eventName:"getExternalIntegrationAccessToken",environment:t,data:{botId:r.id,integrationId:r.integration_id,spaceId:r.space_id}})}return o}function Ke(e){const{integrationType:t,integration:n}=e;return"box"===t||"drive"===t?{type:t,title:p().A.formatMessage(Ue.browse,{appName:n.name}),accounts:u().A.externalAuthentications.state.filter((({integration_id:e})=>e===n.id)),onSelect:Xe(e)}:void 0}function Xe(e){const{integration:t,environment:n,externalObjectTokenStore:o,externalObjectInstanceBlockStore:i}=e;return async e=>{let c=e?e.id:void 0;if(!e){const{sidebarSpaceStore:e}=r().default.state,o=u().A.integrations.state.find((({id:e})=>e===t.id));if(o&&e){const r=u().A.bots.state;await X().Jq({environment:n,integration:o,spaceId:e.id,from:"integration_file_picker"});const i=function(e,t){const n=u().A.bots.state;var o;if(e.length!==n.length)return null===(o=n.filter((e=>e.integration_id===t))[0])||void 0===o?void 0:o.id}(r,t.id);i&&(c=i)}}const l=u().A.externalAuthentications.state.find((e=>e.id===c));if(l){const e=await async function(e,t,n,o,r){if(!u().A.state.loaded)return;r.setState({error:!1,loading:!0});const i=await Ge({environment:e,externalAuthenticationValue:o});if(r.setState({error:!i||"success"!==i.type,loading:!1}),i&&"failed"!==i.type)return i.data;f().ui({message:p().A.formatMessage(Ue.somethingWentWrong),showCancel:!0,keepFocus:!0,items:[{label:p().A.formatMessage(Ue.copyDebuggingInformation),color:void 0,onAccept:async()=>{const t={statusCode:null==i?void 0:i.status,integrationId:n.id,botId:o.id};(await(0,a().jd)())({environment:e,stringValue:JSON.stringify(t,null,2),copiedMessage:Ue.copiedDebuggingInfo})}}]})}(n,0,t,l,o);e&&(Z().I(),await function(e){const{integration:t,tokenDetails:n,environment:o,externalObjectInstanceBlockStore:r,botId:i}=e;if(t.id===O().d0)return async function(e,t){const{access_token:n}=e;try{await(0,ae().Ay)("https://cdn01.boxcdn.net/polyfills/core-js/2.5.3/core.min.js",{resourceType:ae().vt.Javascript});const e=[{url:"https://cdn01.boxcdn.net/platform/elements/15.0.0/en-US/picker.js",resourcetype:ae().vt.Javascript},{url:"https://cdn01.boxcdn.net/platform/elements/15.0.0/en-US/picker.css",resourcetype:ae().vt.Stylesheet}];await Promise.all(e.map((({url:e,resourcetype:t})=>(0,ae().Ay)(e,{resourceType:t}))))}catch(a){return void t(!0,"")}const o=document.createElement("div");o.setAttribute("id","box-app-container"),document.body.appendChild(o);const r=new Box.FilePicker;r.show("0",n,{size:"small",container:"#box-app-container",maxSelectable:1,logoUrl:"box"});const i=()=>{r.hide(),o.remove()};r.addListener("choose",(function(e){var n;const o=null==e||null===(n=e[0])||void 0===n?void 0:n.id;o&&t(!1,`https://app.box.com/file/${o}`),i()})),r.addListener("cancel",i)}(n,Ye({environment:o,externalObjectInstanceBlockStore:r,botId:i}));if(t.id===O().Hd)return(0,ue().openGoogleDriveFilePicker)({environment:o,accessToken:n.access_token,callback:Ye({environment:o,externalObjectInstanceBlockStore:r,botId:i}),integration:t,from:"link_preview_placeholder"});!function(...e){we&&console.warn("multiTextSelectionHelpers:",...e)}(`no matching integration found for external file picker with integration ID ${t.id}}`)}({integration:t,environment:n,externalObjectInstanceBlockStore:i,externalObjectTokenStore:o,botId:l.id,tokenDetails:e}))}}}function Ye(e){const{environment:t,externalObjectInstanceBlockStore:n,botId:o}=e;return(e,r)=>{if(e)return f().ui({message:p().A.formatMessage(Ue.somethingWentWrong),showCancel:!0,keepFocus:!0,items:[{label:p().A.formatMessage(Ue.copyDebuggingInformation),color:void 0,onAccept:async()=>{const n={err:e,botId:o};(await(0,a().jd)())({environment:t,stringValue:JSON.stringify(n,null,2),copiedMessage:Ue.copiedDebuggingInfo})}}]});et({environment:t,externalObjectInstanceBlockStore:n,url:r,botId:o})}}function Ze(){return c().default.checkGate({gateName:"is_visibility_enabled_for_db_sync"})}function Qe(e){const{environment:t,originRect:n,externalObjectInstanceBlockStore:o,integration:r}=e,i=[{type:"embed",onChange:n=>{et({environment:t,url:n.originUrl,externalObjectInstanceBlockStore:o,placeholderIntegrationId:e.placeholderIntegrationId}),Z().I()}}];if(r&&!l().A.isMobile){const n=function(e){const{integration:t}=e;return t.id===O().d0?Ke({integrationType:"box",...e}):t.id===O().Hd?Ke({integrationType:"drive",...e}):void 0}({integration:r,environment:t,externalObjectInstanceBlockStore:o,externalObjectTokenStore:e.externalObjectTokenStore});n&&i.push(n)}Z().W(t,{originGap:0,originRect:n,title:"Embed Link Preview",currentTab:"embed",tabs:i})}function et(e){const{environment:t,url:n,externalObjectInstanceBlockStore:o,placeholderIntegrationId:r,botId:i}=e,a=(0,q().$B)({url:n,integrations:u().A.integrations.state,currentSpaceId:o.getSpaceId()});if("success"===a.type){const{integration:e,pattern:r}=a,c=i?[i]:u().A.bots.state.filter((t=>t.integration_id===e.id)).map((({id:e})=>e));if(c.length>0){const i=o.getParentId(),a=(0,A().US)(n),{host:l}=(0,$().qg)(a);l&&i&&(ye().createAndCommit({userAction:"unfurlingActions.startUnfurlFromPlaceholder",environment:t,canUndo:!0,perform:e=>{ee().zv({store:o,data:{type:y().xd.externalObjectInstance},transaction:e}),ee().zv({store:o.getFormatStore(),data:{original_url:n,domain:l},transaction:e})}}),G().Ki(t,{integrationId:e.id,entity:r.name,domain:l,from:"placeholder"}));!ze({blockStore:o,integration:e,pattern:r,textValueBeforePaste:void 0}).includes("import")||e.id!==O().mn&&e.id!==O().Iy?We({environment:t,url:n,botIds:c,integrationId:e.id,externalObjectInstanceBlockStore:o}):me().M2({url:n,environment:t,from:"external_object_instance_block",integration:e,blockStore:o})}else ye().createAndCommit({userAction:"unfurlingActions.startUnfurlFromPlaceholder",environment:t,canUndo:!0,perform:e=>{ee().zv({store:o.getFormatStore(),data:{integration_id:null,original_url:n,is_placeholder:null},transaction:e})}})}else if("partial"===a.type){const{integration:e}=a;ye().createAndCommit({userAction:"unfurlingActions.startUnfurlFromPlaceholder",environment:t,canUndo:!0,perform:t=>{ee().zv({store:o.getFormatStore(),data:{is_placeholder:null,integration_id:e.id,original_url:n,error:{status_code:B().xB.UNPROCESSABLE_ENTITY}},transaction:t})}})}else"failure"===a.type?ye().createAndCommit({userAction:"unfurlingActions.startUnfurlFromPlaceholder",environment:t,canUndo:!0,perform:e=>{ee().zv({store:o.getFormatStore(),data:{is_placeholder:null,original_url:n,integration_id:r,error:{status_code:B().xB.UNPROCESSABLE_ENTITY}},transaction:e})}}):(0,L().HB)(a)}function tt(e){return e&&Object.entries(e).flatMap((([e,t])=>(0,C().cC)(e)?[]:"hidden"===(null==t?void 0:t.visibility)?{property:`${k().U}${e}`,visible:!1}:{property:`${k().U}${e}`,visible:!0}))}function nt(e){const{environment:t,block:n,transaction:o}=e;if(!n.isDefined()||!(0,_e().E)(t,(0,i().f)(n))||!n.isType(y().xd.externalObjectInstance))return;const r=(0,se().Z1)({environment:t,table:U().ev,spaceId:n.getSpaceId()}),a=ee().Wv({environment:t,id:r,type:y().xd.externalObjectInstance,spaceId:n.getSpaceId(),format:n.getFormat(),inMemoryRecordCache:n.inMemoryRecordCache,transaction:o});ee().zv({store:a,data:{parent_id:n.id,parent_table:n.table,alive:!0},transaction:o});const c=n.getFormatStore().getKeyStore("related_external_object_uris_to_instance_ids").getValue();if(c)for(const i of Object.values(c)){const e={table:U().ev,id:i,spaceId:n.getSpaceId()};ye().applyOperation({store:(0,v().v3)(n,e),operation:{pointer:e,path:[],command:"update",args:{parent_table:U().ev,parent_id:r}},transaction:o})}const l=[(0,z().wmz)((0,z().bMp)(r))];ee().zv({store:n,data:{type:y().xd.text},transaction:o}),he().R9({environment:t,store:n.getBlockTitleStore(),value:l,transaction:o});const s=n.getFormat();ee().zv({store:n.getFormatStore(),data:(0,J().LG)(s,(()=>null)),transaction:o})}function ot(e){var t;const{block:n,transaction:o,token:r,parentStore:i}=e,{tokenIndex:a}=r;if(!n.isDefined())return;const c=null===(t=i.getParentBlockStore())||void 0===t?void 0:t.getContentStore();if(!c)return;he().eF({block:i,editorMode:"default",transaction:o,tokenIndex:a})&&Y().WH({parentStore:c,insertStore:n,afterStore:i,transaction:o})}function rt(e){const{environment:t,spaceId:n,from:o,store:r,bypassCache:i}=e;let a=e.botIds;const c=(0,le().gV)(r),l=(null==c?void 0:c.original_url)||(null==c?void 0:c.uri);if(!l)return;const s=(0,le().g8)(l,n),d=(0,le().au)(l,n);if(!s||0===d.length)return;const u=r.getCollectionStoreIfSingleSource(),{integration:p,pattern:m}=s;p.id===O().Hd&&!a&&null!=c&&c.bot_id&&(a=[c.bot_id]),r.isCollectionView()&&u?K().callCellCompatibleApi({eventName:"refetchExternalObjectInstanceBlocks",environment:t,data:{recordPointers:[{...u.pointer,spaceId:n}],bypassCache:i},cellNavigation:{spaceId:n}}):r.isExternalObjectInstancePageBlockStore()?O().tU.includes(p.id)?We({environment:t,url:l,botIds:a||d.map((({id:e})=>e)),integrationId:p.id,externalObjectInstanceBlockStore:r}):K().callCellCompatibleApi({eventName:"refetchExternalObjectInstanceBlocks",environment:t,data:{recordPointers:[{...r.pointer,spaceId:n}],bypassCache:i},cellNavigation:{spaceId:n}}):r.isExternalObjectInstanceBlockStore()&&We({environment:t,url:l,botIds:a||d.map((({id:e})=>e)),integrationId:p.id,externalObjectInstanceBlockStore:r}),G().zu(t,{integrationId:p.id,entity:m.name,from:o})}}}]);