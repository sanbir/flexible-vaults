"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[93828],{582676:(e,t,n)=>{n.d(t,{HO:()=>a,Nx:()=>i,mT:()=>s});n(898992),n(908872);var o=()=>n(496603);function a([e,t]){return Math.floor(function([e,t]){return Math.random()*(t-e)+e}([e,t]))}function i(e){if(!e)return Math.random;let t=function(e){let t=0;for(let n=0;n<e.length;n++){t=(t<<5)-t+e.charCodeAt(n),t|=0}return t}(e);return()=>{t|=0,t=t+1831565813|0;let e=Math.imul(t^t>>>15,1|t);return e=e+Math.imul(e^e>>>7,61|e)^e,((e^e>>>14)>>>0)/4294967296}}function s(e,t){const n=i(t);return(0,o().Ul)(e,n)}},816047:(e,t,n)=>{n.d(t,{I:()=>i});var o=()=>n(430476),a=()=>n(68336);async function i(e){const{connection:t,userId:n,taskType:i,lastExecutedAt:s}=e;await(0,o().G2)({connection:t,statements:[a().F4`INSERT OR REPLACE INTO offline_download_metadata (meta_user_id, task_type, last_executed_at) VALUES (${n}, ${i}, ${s})`.asWrite()],queryName:"updateOfflineMetadataLastExecutedAt"})}},940658:(e,t,n)=>{n.d(t,{debugAutosync:()=>H,u:()=>q});n(16280),n(517642),n(658004),n(733853),n(845876),n(432475),n(515024),n(731698),n(898992),n(354520),n(581454);var o=n(296540),a=()=>n(300474),i=()=>n(907258),s=()=>n(755531),r=()=>n(484714),c=()=>n(590526),d=()=>n(79926),u=()=>n(929219),l=()=>n(391400),f=()=>n(711339),_=()=>n(852832),g=()=>n(165358),p=()=>n(591779),y=()=>n(582676),m=()=>n(496603),w=()=>n(745875),A=()=>n(763824),v=()=>n(615234),E=()=>n(635462),I=()=>n(825972),b=()=>n(810312),h=()=>n(475553),S=()=>n(144460),T=()=>n(448835),R=()=>n(22472),C=()=>n(430476),O=()=>n(68336),F=()=>n(644852),k=()=>n(543159);var D=()=>n(922742);function M(e){const{userId:t}=e;return O().F4`DELETE FROM offline_page
	WHERE meta_user_id = ${t}
	AND NOT EXISTS (
		SELECT 1
		FROM offline_action
		WHERE offline_action.impacted_page_id = offline_page.id
		AND offline_action.meta_user_id = ${t}
	)`.asWrite()}var N=()=>n(816047);const P=v().Xb;class L extends Error{constructor(e){super(e),this.name="OfflineAutosyncAbortedError"}}async function x(e){var t;const{environment:{currentUser:{id:n},sqliteConnection:o},desiredPages:a}=e;if(!n||!o)return{pagesToAdd:[],pagesToRemove:[]};const i=null===(t=(0,s().S)())||void 0===t?void 0:t.id;if(!i)return{pagesToAdd:[],pagesToRemove:[]};const r=(await async function(e){const{connection:t,userId:n,spaceId:o}=e,a=O().F4`
		WITH offline_page_metadata AS (
			${(0,k().y)({userId:n})}
		)
		SELECT offline_page_metadata.* FROM offline_page_metadata
		WHERE space_id = ${o}
		AND is_autosynced_origin = 1
		ORDER BY last_downloaded_at ASC
	`,i=(await(0,C().G2)({connection:t,statements:[a.asRead()],queryName:"getOfflineAutosyncedOrigins"}))[0].data;return F().m.rowsFromSqlite(i)}({connection:o,userId:n,spaceId:i})).map((e=>({id:e.id,spaceId:e.space_id})));return function(e){const{desiredPages:t,existingAutosyncedPages:n}=e,o=new Set(t.map((e=>e.id))),a=new Set(n.map((e=>e.id)));return{pagesToAdd:(0,m().sb)(t.filter((e=>!a.has(e.id))).filter((e=>!(0,E().s)(e.id)))),pagesToRemove:n.filter((e=>!o.has(e.id)))}}({desiredPages:a,existingAutosyncedPages:r})}async function W(e){const{environment:t,abortSignal:n,autosyncIntervalMs:o,forStats:a}=e,{currentUser:{id:s},sqliteConnection:r}=t;if(!r||!s)return;const c=performance.now(),d=(0,S().L)("autosynced_pages_limit"),u=(0,S().L)("autosynced_favorite_pages_limit"),l=function({limit:e}){var t;return null===(t=I().wI.state)||void 0===t?void 0:t.slice(0,e).map((e=>({id:e.pageId,spaceId:e.store.getSpaceId()})))}({limit:d}),_=(null==l||l.map((e=>e.id)),function({limit:e}){const t=i().default.state.sidebarSpaceViewStore,n=null==t?void 0:t.getBookmarkedPageIds(),o=null==t?void 0:t.getSpaceId();if(n&&o)return null==n?void 0:n.slice(0,e).map((e=>({id:e,spaceId:o})))}({limit:u}));null==_||_.map((e=>e.id));void 0!==l&&void 0!==_&&(await navigator.locks.request(`toggle_offline_page_${t.currentUser.id}`,(()=>{})),await navigator.locks.request(`offline_background_task_${t.currentUser.id}`,{ifAvailable:!0},(async e=>{if(!e)return;const i=await(0,D().T)({connection:r,userId:s,taskType:"autosync"});if(i){if(Date.now()-i<.95*o)return}const d=Date.now(),{pagesToAdd:u,pagesToRemove:p}=await x({environment:t,desiredPages:[...l,..._]});if(0===u.length&&0===p.length)return;n.throwIfAborted();const y=new Set;await(0,A().lX)(u,5,(async e=>{await(0,R().og)({from:"addAutosyncedPage",originAutosyncTypePairs:[{originPageId:e.id,autosyncType:"frecent"}],page:e,environment:t,visitedBlockIds:{forThisOriginPage:new Set,forThisInterval:y},stats:{imageCount:0,batchedSyncCount:0,queryCollectionCount:0},downloadAbortSignal:n}),n.throwIfAborted()})),await(0,N().I)({connection:r,userId:s,taskType:"autosync",lastExecutedAt:d}),n.throwIfAborted();let m=!1;for(const o of p){const e=await(0,R().zB)({from:"removeAutosyncedPage",pageId:o.id,environment:t});null!=e&&e.hasForeignKeyError&&(m=!0),n.throwIfAborted()}if(m){const e=(0,w().Yo)(s,(0,S().L)("reinitialize_on_error_percentage")),t=await(0,D().T)({connection:r,userId:s,taskType:"reinitialize"})??0;e&&Date.now()-t>v().nD&&(g().log({from:"useUpdateAutosyncedPages",type:"reinitialize_on_error",level:"info"}),await async function(e){const{connection:t,userId:n}=e;await(0,C().G2)({connection:t,statements:[O().F4`CREATE TEMP TABLE explicitly_toggled_origins AS
				SELECT DISTINCT
					oa.origin_page_id,
					oa.meta_user_id,
					op.space_id
				FROM offline_action oa
				JOIN offline_page op ON oa.impacted_page_id = op.id AND oa.meta_user_id = op.meta_user_id
				WHERE oa.origin_page_id = oa.impacted_page_id
				  AND oa.autosync_type = 'not_autosynced'
				  AND oa.meta_user_id = ${n}`.asWrite(),O().F4`DELETE FROM offline_action WHERE meta_user_id = ${n}`.asWrite(),O().F4`DELETE FROM offline_page WHERE meta_user_id = ${n}`.asWrite(),O().F4`INSERT INTO offline_page (id, meta_user_id, download_status, space_id)
				SELECT origin_page_id, meta_user_id, 'to_download', space_id
				FROM explicitly_toggled_origins`.asWrite(),O().F4`INSERT INTO offline_action (meta_user_id, origin_page_id, from_page_id, impacted_page_id, autosync_type)
				SELECT meta_user_id, origin_page_id, origin_page_id, origin_page_id, 'not_autosynced'
				FROM explicitly_toggled_origins`.asWrite(),O().F4`DROP TABLE explicitly_toggled_origins`.asWrite()],queryName:"reinitializeOfflineData"})}({connection:r,userId:s}),await(0,N().I)({connection:r,userId:s,taskType:"reinitialize",lastExecutedAt:Date.now()}))}f().default.measure({metricName:"update_autosynced_pages",startTime:c,endTime:performance.now()},{environment:t,data:{number_of_pages_added:u.length,number_of_pages_removed:p.length,is_offline_caching_allowed:a.isOfflineCachingAllowed,is_feature_availability_loaded:a.isFeatureAvailabilityLoaded,does_subscription_allow_autosync:a.doesSubscriptionAllowAutosync,autosync_setting:a.autosyncSetting,autosync_reason:a.autosyncReason,autosync_interval_ms:o}})})))}async function $(e,t){const{currentUser:{id:n},sqliteConnection:o}=e;n&&o&&(await async function(e){const{connection:t,userId:n,spaceId:o}=e;await(0,C().G2)({connection:t,statements:[O().F4`DELETE FROM offline_action WHERE ${O().F4.and([O().F4`meta_user_id = ${n}`,O().F4`autosync_type = ${"frecent"}`,O().F4`EXISTS (
					SELECT 1 FROM offline_page
					WHERE offline_page.id = offline_action.origin_page_id
					AND offline_page.space_id = ${o}
					AND offline_page.meta_user_id = ${n}
				)`])}`.asWrite(),M({userId:n})],queryName:"removeAllOfflineAutosyncedOrigins"})}({connection:o,userId:n,spaceId:t}),await(0,N().I)({connection:o,userId:n,taskType:"autosync",lastExecutedAt:0}))}function q(){const e=(0,r().v3)(),t=(0,a().r)(),n=(0,h().K)(),i=(0,b().Vz)(),s=void 0!==i,f=s&&"available"===i.type,{value:_}=(0,d().fJ)(T().of),g=(0,c().K8)((()=>function(e,t,n){if(!e)return;if(!n)return;const{getAutosyncSetting:o,setAutosyncSetting:a}=n,i=o(e);if(void 0===i&&t)return a(e,"on"),"on";return i}(t,f,_)),[t,f,_]),m=(0,p().ZC)(g)??"off",w=(0,c().K8)((()=>l().A.state.initialRenderCompleted&&u().A.state.online&&n&&f),[n,f]),A=(0,S().m)("autosync_interval_ms"),v=(0,o.useRef)(void 0),E=(0,o.useCallback)((()=>(v.current||(v.current=new AbortController),v.current)),[]),I=(0,o.useCallback)((e=>{E().abort(new L(e)),v.current=void 0}),[E]);(0,o.useEffect)((()=>{if(!_)return;const{setAutosyncSetting:o}=_;const a=function(){if("on"===g&&void 0!==t&&s&&!f&&u().A.state.online)return I("Autosync aborted because space was not paid"),$(e,t).catch((e=>{if(!(e instanceof L))throw e})),void o(t,"off");if(w){if("on"===m&&"off"===g)return I("Autosync aborted because it was turned off"),void(void 0!==t&&$(e,t).catch((e=>{if(!(e instanceof L))throw e})));if("on"===g){const t=E().signal;let o;if("off"===m)W({environment:e,abortSignal:t,autosyncIntervalMs:A,forStats:{isOfflineCachingAllowed:n,isFeatureAvailabilityLoaded:s,doesSubscriptionAllowAutosync:f,autosyncSetting:g,autosyncReason:"toggle_setting"}}).catch((e=>{if(!(e instanceof L))throw e}));else{const a=(0,y().HO)([0,P]);o=window.setTimeout((()=>{t.aborted||W({environment:e,abortSignal:t,autosyncIntervalMs:A,forStats:{isOfflineCachingAllowed:n,isFeatureAvailabilityLoaded:s,doesSubscriptionAllowAutosync:f,autosyncSetting:g,autosyncReason:"startup"}}).catch((e=>{if(!(e instanceof L))throw e}))}),a)}const a=.05*A,i=A+Math.random()*a*2-a;return{timeoutId:o,interval:setInterval((()=>{t.aborted||W({environment:e,abortSignal:t,autosyncIntervalMs:i,forStats:{isOfflineCachingAllowed:n,isFeatureAvailabilityLoaded:s,doesSubscriptionAllowAutosync:f,autosyncSetting:g,autosyncReason:"interval"}}).catch((e=>{if(!(e instanceof L))throw e}))}),i)}}}}();return()=>{null!=a&&a.timeoutId&&clearTimeout(a.timeoutId),null!=a&&a.interval&&clearInterval(a.interval)}}),[I,E,e,w,f,g,m,A,s,t,n,_])}async function H(e){if(!e)throw new Error("Pass in `__console.environment` as the first param.");await W({environment:e,abortSignal:(new AbortController).signal,autosyncIntervalMs:0,forStats:{isOfflineCachingAllowed:!0,isFeatureAvailabilityLoaded:!0,doesSubscriptionAllowAutosync:!0,autosyncSetting:"on",autosyncReason:"debug"}})}(0,_().exposeDebugValue)("debugAutosync",H),(0,_().exposeDebugValue)("debugAddAutosyncedPage",(async function(e,t){if(!e)throw new Error("Pass in `__console.environment` as the first param.");if(!t)throw new Error("Pass in a page ID as the second param.");const o=new(n(295633).B)(e,{id:t,table:n(179034).ev});await o.load();const a=o.getSpaceId(),{currentUser:{id:i},sqliteConnection:s}=e;if(!s)throw new Error("Missing SQLite");if(!i)throw new Error("Missing userId");await navigator.locks.request(`offline_background_task_${i}`,(async n=>{if(!n)throw new Error("Failed to acquire lock for offline background task");await(0,R().og)({from:"addAutosyncedPage",originAutosyncTypePairs:[{originPageId:t,autosyncType:"frecent"}],page:{id:t,spaceId:a},environment:e,visitedBlockIds:{forThisOriginPage:new Set,forThisInterval:new Set},stats:{imageCount:0,batchedSyncCount:0,queryCollectionCount:0},downloadAbortSignal:(new AbortController).signal})}))})),(0,_().exposeDebugValue)("debugClearAutosyncedData",(async function(e,t){var n;if(!e)throw new Error("Pass in `__console.environment` as the first param.");const o=t??(null===(n=(0,s().S)())||void 0===n?void 0:n.id);if(!o)throw new Error("No space ID found, pass one in as the second param.");await $(e,o)}))}}]);