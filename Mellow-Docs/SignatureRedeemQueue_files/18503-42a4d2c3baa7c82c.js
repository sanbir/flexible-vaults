"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[18503],{118503:(e,t,n)=>{n.d(t,{m:()=>Xe});n(16280),n(944114),n(898992),n(354520),n(672577),n(581454),n(908872),n(814603),n(147566),n(198721);var r=n(296540),s=()=>n(242422),a=()=>n(484714),o=()=>n(590526),i=()=>n(401497),l=()=>n(699143),d=()=>n(250910),c=()=>n(420802),p=()=>n(695115),u=()=>n(31511),g=()=>n(98126),m=()=>n(546926),x=()=>n(631524),h=()=>n(26697),f=()=>n(890492),y=()=>n(81068),v=()=>n(663639),j=()=>n(736847),b=()=>n(68169),T=()=>n(218602),C=()=>n(878456),k=()=>n(187174),S=()=>n(973238),I=()=>n(827312),w=()=>n(465505),M=()=>n(514608),A=()=>n(703778),O=()=>n(863330),N=()=>n(870054),R=()=>n(995847),z=()=>n(724639),$=()=>n(69708),B=()=>n(100622),L=()=>n(532659),D=()=>n(496603),P=()=>n(534177),F=()=>n(769864),K=()=>n(547149),E=()=>n(571376),W=()=>n(562936),_=()=>n(140992),q=()=>n(459129),V=()=>n(865454),J=()=>n(791256),U=(n(517642),n(658004),n(733853),n(845876),n(432475),n(515024),n(731698),()=>n(30537));function G(e){switch(e){case"update-page-v2":return"update-page";case"create-agent-v2":return"create-agent";case"update-agent-v2":return"update-agent";default:return e}}function H(e,t){if(!e.expect||0===e.expect.length)return;const n={};for(const r of t)if("agent-inference"===r.type)for(const e of r.value)if("object"==typeof e&&"tool_use"===e.type&&e.name){const t=G(e.name);n[t]=(n[t]||0)+1}return function(e,t){const n={};for(const[o,i]of Object.entries(t)){const e=G(o);n[e]=(n[e]||0)+(i??0)}let r=0,s=0;const a=[];for(const o of e.expect){const e=n[G(o.toolType)]||0,t=o.minTimes??0,i=o.maxTimes;r++;let l=!1;if(l=0===i?0===e:!(void 0!==i&&t>i)&&e>=t&&(void 0===i||e<=i),l)s++;else{let n;n=0===i?"never":void 0!==i?`${t}-${i} times`:`at least ${t} times`,a.push(`Expected ${o.toolType} ${n}, got ${e}${o.description?` (${o.description})`:""}`)}}return{score:s/r,maxScore:1,totalExpectations:r,metExpectations:s,violations:a,toolCounts:n}}(e,n)}var X=()=>n(800204),Y=()=>n(236262),Q=n(474848);function Z(e){const t=(0,$().tz)(),{expectations:n,onChange:s,transcript:a,toolNames:o}=e,[l,c]=(0,r.useState)(new Map),[u,m]=(0,r.useState)(new Set),h=a?a.filter((e=>e.type.includes("inference"))).map(((e,t)=>({index:t,id:e.id}))):[],f=(0,r.useMemo)((()=>Array.from(new Set([...o??[],...X().yu]))),[o]),y=(0,i().IS)((()=>({container:{padding:12,marginTop:16,border:`1px solid ${B().Tj.border.secondaryTranslucent}`,borderRadius:8,backgroundColor:B().Tj.background.primary},section:{marginBottom:16},sectionTitle:{fontSize:14,fontWeight:600,marginBottom:12,color:B().Tj.text.primary},topbar:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:8,marginBottom:12},expectationItem:{display:"flex",flexDirection:"column",gap:4,marginBottom:8,padding:6,backgroundColor:B().Tj.background.primary,border:`1px solid ${B().Tj.border.secondaryTranslucent}`,borderRadius:4},expectationItemHeader:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:4},formRow:{display:"flex",alignItems:"center",gap:6,flexWrap:"wrap"},formField:{display:"flex",alignItems:"center",gap:3,minWidth:"fit-content"},formLabel:{fontSize:13,color:B().Tj.darkTextColor,fontWeight:500,minWidth:30,flexShrink:0},select:{padding:"4px 8px",borderRadius:3,border:`1px solid ${B().Tj.border.secondaryTranslucent}`,backgroundColor:B().Tj.background.primary,color:B().Tj.text.primary,fontSize:13,minWidth:80},numberInput:{padding:"4px 8px",borderRadius:3,border:`1px solid ${B().Tj.border.secondaryTranslucent}`,backgroundColor:B().Tj.background.primary,color:B().Tj.text.primary,fontSize:13,width:50},textInput:{padding:"4px 8px",borderRadius:3,border:`1px solid ${B().Tj.border.secondaryTranslucent}`,backgroundColor:B().Tj.background.primary,color:B().Tj.text.primary,fontSize:13,width:"100%",minWidth:120},descriptionRow:{display:"flex",alignItems:"center",gap:3,width:"100%"},testButton:{display:"flex",alignItems:"center",gap:4},addButton:{display:"flex",alignItems:"center",gap:4},emptyState:{fontSize:12,color:B().Tj.darkTextColor,fontStyle:"italic",padding:8},testResultsPopup:{padding:12,width:400,minWidth:400,maxWidth:"none",maxHeight:300,overflowY:"auto"},testResultItem:{marginBottom:16,fontSize:13,color:B().Tj.darkTextColor,whiteSpace:"pre-wrap"},testResultTitle:{fontWeight:600,marginBottom:8,fontSize:14},failedTestButton:{backgroundColor:"#ffebee",color:"#d32f2f",padding:"4px 8px",borderRadius:4},successTestButton:{backgroundColor:"#e8f5e9",color:"#2e7d32",padding:"4px 8px",borderRadius:4}})),[]),v=r.useMemo((()=>[...n.expect||[]]),[n.expect]),j=(0,r.useCallback)((()=>{const e={...n,expect:[...v,{toolType:"search",minTimes:0,maxTimes:void 0,description:""}]};s(e)}),[n,s,v]),b=(0,r.useCallback)((e=>{const t=[...v];t.splice(e,1);const r={...n,expect:t.length>0?t:void 0};s(r)}),[n,s,v]),T=(0,r.useCallback)(((e,t,r)=>{const a=[...v];a[e]={...a[e],[t]:r};const o={...n,expect:a};s(o)}),[n,s,v]),C=(0,r.useCallback)((e=>{if(!a||!n.expect||0===n.expect.length||e<0||e>=n.expect.length)return;const t=n.expect[e];let r=a;t.stepId&&(r=a.filter((e=>e.id===t.stepId))),m((t=>new Set(t).add(e))),c((t=>{const n=new Map(t);return n.delete(e),n}));try{const n=H({expect:[t]},r);n&&c((t=>new Map(t).set(e,n)))}catch(s){}finally{m((t=>{const n=new Set(t);return n.delete(e),n}))}}),[n,a]);return(0,Q.jsxs)("div",{style:y.container,children:[(0,Q.jsx)("div",{style:y.sectionTitle,children:"Expected Tools Editor"}),(0,Q.jsx)("div",{style:y.topbar,children:(0,Q.jsx)(x().p,{onClick:j,style:y.addButton,children:"Add Expected"})}),(0,Q.jsx)(W().b,{label:"Visual editor",defaultOpen:!0,children:(0,Q.jsx)("div",{style:y.section,children:v&&v.length>0?v.map(((e,n)=>(0,Q.jsxs)("div",{style:y.expectationItem,children:[(0,Q.jsxs)("div",{style:y.expectationItemHeader,children:[(0,Q.jsxs)("div",{style:y.formField,children:[(0,Q.jsx)("div",{style:y.formLabel,children:"Tool:"}),(0,Q.jsx)("select",{style:y.select,value:e.toolType,onChange:e=>{const t=e.target.value;T(n,"toolType",t)},children:[...f].sort().map((e=>(0,Q.jsx)("option",{value:e,children:e},e)))})]}),(0,Q.jsxs)("div",{style:{display:"flex",gap:4,alignItems:"center"},children:[a?(0,Q.jsxs)(Q.Fragment,{children:[(0,Q.jsx)(x().p,{onClick:()=>C(n),style:y.testButton,disabled:u.has(n),children:u.has(n)?(0,Q.jsx)(g().k,{}):"Test"}),l.has(n)?(0,Q.jsx)(d().A,{renderOrigin:e=>(0,Q.jsx)(x().p,{...e,style:1===l.get(n).score?y.successTestButton:y.failedTestButton,children:1===l.get(n).score?"✅":"❌"}),popupType:U().n.Popup,placementToOrigin:"bottom",render:()=>{const e=l.get(n);return(0,Q.jsxs)("div",{style:y.testResultsPopup,children:[(0,Q.jsx)("div",{style:y.testResultTitle,children:"Test Results"}),(0,Q.jsxs)("div",{style:y.testResultItem,children:[(0,Q.jsx)("strong",{children:"Score: "}),`${e.score.toFixed(2)} (${e.metExpectations}/${e.totalExpectations} expectations met)`]}),e.violations.length>0?(0,Q.jsxs)("div",{style:y.testResultItem,children:[(0,Q.jsx)("strong",{children:"Violations:"}),"\n",e.violations.map((e=>`• ${e}\n`)).join("")]}):void 0,(0,Q.jsxs)("div",{style:y.testResultItem,children:[(0,Q.jsx)("strong",{children:"Tool Counts:"}),"\n",Object.entries(e.toolCounts).length>0?Object.entries(e.toolCounts).map((([e,t])=>`${e}: ${t}`)).join(", "):"none"]})]})}}):void 0]}):void 0,(0,Q.jsx)(p().A,{icon:Y().trashIcon,onClick:()=>b(n),ariaLabel:t.formatMessage({id:"aiInferenceTranscript.agentToolExpectationsEditor.removeExpectation",defaultMessage:"Remove tool expectation"})})]})]}),(0,Q.jsxs)("div",{style:y.formRow,children:[(0,Q.jsxs)("div",{style:y.formField,children:[(0,Q.jsx)("div",{style:y.formLabel,children:"Min:"}),(0,Q.jsx)("input",{type:"number",style:y.numberInput,value:e.minTimes??"",placeholder:"0",onChange:e=>T(n,"minTimes",e.target.value?parseInt(e.target.value):void 0)})]}),(0,Q.jsxs)("div",{style:y.formField,children:[(0,Q.jsx)("div",{style:y.formLabel,children:"Max:"}),(0,Q.jsx)("input",{type:"number",style:y.numberInput,value:e.maxTimes??"",placeholder:"∞",onChange:e=>T(n,"maxTimes",e.target.value?parseInt(e.target.value):void 0)})]})]}),(0,Q.jsxs)("div",{style:y.descriptionRow,children:[(0,Q.jsx)("div",{style:y.formLabel,children:"Desc:"}),(0,Q.jsx)("input",{type:"text",style:y.textInput,value:e.description??"",placeholder:"Description (optional)",onChange:e=>T(n,"description",e.target.value)})]}),h&&h.length>0?(0,Q.jsx)("div",{style:y.formRow,children:(0,Q.jsxs)("div",{style:y.formField,children:[(0,Q.jsx)("div",{style:y.formLabel,children:"stepId:"}),(0,Q.jsxs)("select",{style:y.select,value:e.stepId??"all",onChange:e=>{const t=e.target.value,r=h.find((e=>e.id===t));T(n,"stepId",null==r?void 0:r.id)},children:[(0,Q.jsx)("option",{value:"all",children:"all"},-1),h.map((e=>(0,Q.jsx)("option",{value:e.id,children:`${e.index}: ...${e.id.slice(-8)}`},e.index)))]})]})}):void 0]},n))):(0,Q.jsx)("div",{style:y.emptyState,children:"No tool expectations defined. Click 'Add Expectation' to add one."})})}),(0,Q.jsx)(W().b,{label:"JSON editor",defaultOpen:!1,children:(0,Q.jsx)(E().X,{language:"json",value:JSON.stringify({...n,expect:v.length>0?v:void 0},null,2)})})]})}n(430670);var ee=()=>n(692031),te=()=>n(212497),ne=()=>n(383036),re=()=>n(792485),se=()=>n(627503),ae=()=>n(636714),oe=()=>n(12956),ie=()=>n(267271);const le=(0,$().YK)({copy:{id:"aiInferenceTranscript.debug.copy",defaultMessage:"Copy"},copyTooltip:{id:"aiInferenceTranscript.debug.copyTooltip",defaultMessage:"Copy..."},input:{id:"aiInferenceTranscript.debug.copyInput",defaultMessage:"Input"},output:{id:"aiInferenceTranscript.debug.copyOutput",defaultMessage:"Output"},metadata:{id:"aiInferenceTranscript.debug.copyMetadata",defaultMessage:"Metadata"},tool:{id:"aiInferenceTranscript.debug.copyTool",defaultMessage:"Tool input"}});function de(e){const{inference:t}=e,n=(0,a().v3)(),s=(0,$().tz)(),o="transcript"in t.input&&Array.isArray(t.input.transcript)?t.input.transcript:void 0,i=(0,r.useMemo)((()=>D().oE(null==o?void 0:o.flatMap((e=>{if("agent-inference"===e.type&&Array.isArray(e.value))return e.value.filter((e=>"tool_use"===e.type)).map((e=>({tool:e.name,input:e.content})))})))),[o]),l=async e=>{const[t,r]=await Promise.all([(0,ee().r)(),(0,te().jd)()]);r({environment:n,stringValue:e,copiedMessage:t.copiedToClipboard})},c=[(0,ie().gy)({key:"copy",render:e=>(0,Q.jsx)(j().A,{...e}),actions:D().oE([(0,ie().Ls)({key:"input",displayName:le.input,analyticsName:le.input.defaultMessage,action:()=>l(JSON.stringify(t.input,null,2)),validators:[],closeParentMenu:!0,render:e=>(0,Q.jsx)(y().A,{...e,title:s.formatMessage(le.input)})}),(0,ie().Ls)({key:"output",displayName:le.output,analyticsName:le.output.defaultMessage,action:()=>l(JSON.stringify(t.expected,null,2)),validators:[],closeParentMenu:!0,render:e=>(0,Q.jsx)(y().A,{...e,title:s.formatMessage(le.output)})}),(0,ie().Ls)({key:"metadata",displayName:le.metadata,analyticsName:le.metadata.defaultMessage,action:()=>l(JSON.stringify(t.metadata,null,2)),validators:[],closeParentMenu:!0,render:e=>(0,Q.jsx)(y().A,{...e,title:s.formatMessage(le.metadata)})}),i.length>0&&(0,oe().u)({key:"tools",displayName:le.tool,analyticsName:"tools",validators:[],initialFocus:void 0,subActions:()=>[(0,ie().gy)({key:"tools",render:e=>(0,Q.jsx)(j().A,{...e}),actions:i.map((e=>({key:e.tool,displayName:e.tool,searchName:e.tool,shortcuts:void 0,analyticsName:e.tool,action:()=>l(e.input),validators:[],closeParentMenu:!0,render:t=>(0,Q.jsx)(y().A,{...t,title:e.tool})})))})]})])})],u=(0,re().S)();return(0,Q.jsx)(d().A,{popupType:d().z.Popup,placementToOrigin:"bottom",alignmentToOrigin:"start",renderOrigin:e=>(0,Q.jsx)(h().m,{renderTooltip:()=>(0,Q.jsx)("div",{children:s.formatMessage(le.copyTooltip)}),placement:"top",render:t=>(0,Q.jsx)(p().A,{...(0,ne().A)(e,t),icon:se().a,ariaLabel:s.formatMessage(le.copy)})}),render:e=>(0,Q.jsx)(f().A,{menuType:m().gu.Popup,minWidth:220,children:(0,Q.jsx)(ae().A,{context:{blocks:[],environment:n,publicEditMode:void 0,pageContext:u},sections:c,initialFocus:void 0})})})}var ce=()=>n(807449),pe=()=>n(493552),ue=()=>n(29037),ge=()=>n(589407),me=()=>n(671593),xe=()=>n(101927),he=()=>n(820559),fe=()=>n(9140);const ye={recentSearchToolResultsToKeep:-1,summarizeTokenThreshold:void 0};function ve(e){return(0,me().Qq)(fe().LI,e)}const je=(0,$().YK)({debugOptions:{id:"aiInferenceTranscript.debugOverrides.title",defaultMessage:"Debug options"},showAssistantDebugBar:{id:"aiInferenceTranscript.debugOverrides.showAssistantDebugBar",defaultMessage:"Show assistant debug bar"},showErrors:{id:"aiInferenceTranscript.debugOverrides.showErrors",defaultMessage:"Show errors"},showFullAgentSteps:{id:"aiInferenceTranscript.debugOverrides.showFullAgentSteps",defaultMessage:"Emit full agent steps"},skipFunctionTests:{id:"aiInferenceTranscript.debugOverrides.skipFunctionTests",defaultMessage:"Skip function tests"},promptCache:{id:"aiInferenceTranscript.debugOverrides.promptCache",defaultMessage:"Prompt cache"},none:{id:"aiInferenceTranscript.debugOverrides.none",defaultMessage:"None"},redis:{id:"aiInferenceTranscript.debugOverrides.redis",defaultMessage:"Redis"},s3:{id:"aiInferenceTranscript.debugOverrides.s3",defaultMessage:"S3"},embeddingModelOverride:{id:"aiInferenceTranscript.debugOverrides.embeddingModelOverride",defaultMessage:"Embedding model override"},contextManagementConfiguration:{id:"aiInferenceTranscript.debugOverrides.contextManagementConfiguration",defaultMessage:"Context management configuration"},default:{id:"aiInferenceTranscript.debugOverrides.default",defaultMessage:"Default"},bgeM3:{id:"aiInferenceTranscript.debugOverrides.bgeM3",defaultMessage:"BGE-M3"},e5:{id:"aiInferenceTranscript.debugOverrides.e5",defaultMessage:"E5"},bge1024:{id:"aiInferenceTranscript.debugOverrides.bge1024",defaultMessage:"BGE-1024"},bge4096:{id:"aiInferenceTranscript.debugOverrides.bge4096",defaultMessage:"BGE-4096"}});function be(e){const{clientStore:t}=e,n=(0,a().v3)(),s=(0,$().tz)(),l=(0,i().IS)((()=>({iconButton:{width:20,height:20,fill:B().Tj.icon.primary}})),[]),c=(0,o().K8)((()=>t.state.debugOverrides),[t]),[g,x]=(0,r.useState)(c.contextManagementConfiguration??ye),[v,b]=(0,r.useState)(!1),T=(0,o().K8)((()=>{var e;return(null===(e=he().A.state)||void 0===e?void 0:e.showDebugBar)??!1}),[]),C=(0,r.useCallback)((()=>{(0,xe().c6)(!T)}),[T]),k=(0,r.useCallback)((()=>{t.setState({...t.state,debugOverrides:{...t.state.debugOverrides,emitDebugErrors:!t.state.debugOverrides.emitDebugErrors}})}),[t]),S=(0,r.useCallback)((()=>{t.setState({...t.state,debugOverrides:{...t.state.debugOverrides,emitFullAgentSteps:!t.state.debugOverrides.emitFullAgentSteps}})}),[t]),I=(0,r.useCallback)((()=>{t.setState({...t.state,debugOverrides:{...t.state.debugOverrides,fastWorkflowBuilds:!t.state.debugOverrides.fastWorkflowBuilds}})}),[t]),w=(0,r.useCallback)((e=>{t.setState({...t.state,debugOverrides:{...t.state.debugOverrides,usePromptCache:"none"===e?void 0:e}})}),[t]),M=(0,r.useCallback)((e=>{t.setState({...t.state,debugOverrides:{...t.state.debugOverrides,embeddingModelOverride:"default"===e?void 0:e}})}),[t]),A=(0,r.useCallback)((e=>{if(""===e)return;const t=Number(e);return Number.isFinite(t)?t:void 0}),[]),O=(0,r.useCallback)(((e,n)=>{const r=A(n),s=ve({...g,[e]:r});s&&(x(s),t.setState({...t.state,debugOverrides:{...t.state.debugOverrides,contextManagementConfiguration:s}}))}),[t,g,A]),N=c.usePromptCache||"none",R=c.embeddingModelOverride||"default",z=[(0,ie().gy)({key:"debug",render:e=>(0,Q.jsx)(j().A,{...e}),actions:[(0,ie().Ls)({key:"showAssistantDebugBar",displayName:je.showAssistantDebugBar,analyticsName:je.showAssistantDebugBar.defaultMessage,action:()=>C(),validators:[],closeParentMenu:!1,render:e=>(0,Q.jsx)(y().A,{...e,title:s.formatMessage(je.showAssistantDebugBar),right:T&&(0,Q.jsx)(ce().I,{icon:ue().checkmarkIcon,size:"xxs"})})}),(0,ie().Ls)({key:"emitDebugErrors",displayName:je.showErrors,analyticsName:je.showErrors.defaultMessage,action:()=>k(),validators:[],closeParentMenu:!1,render:e=>(0,Q.jsx)(y().A,{...e,title:s.formatMessage(je.showErrors),right:c.emitDebugErrors&&(0,Q.jsx)(ce().I,{icon:ue().checkmarkIcon,size:"xxs"})})}),(0,ie().Ls)({key:"emitFullAgentSteps",displayName:je.showFullAgentSteps,analyticsName:je.showFullAgentSteps.defaultMessage,action:()=>S(),validators:[],closeParentMenu:!1,render:e=>(0,Q.jsx)(y().A,{...e,title:s.formatMessage(je.showFullAgentSteps),right:c.emitFullAgentSteps&&(0,Q.jsx)(ce().I,{icon:ue().checkmarkIcon,size:"xxs"})})}),(0,ie().Ls)({key:"fastWorkflowBuilds",displayName:je.skipFunctionTests,analyticsName:je.skipFunctionTests.defaultMessage,action:()=>I(),validators:[],closeParentMenu:!1,render:e=>(0,Q.jsx)(y().A,{...e,title:s.formatMessage(je.skipFunctionTests),right:c.fastWorkflowBuilds&&(0,Q.jsx)(ce().I,{icon:ue().checkmarkIcon,size:"xxs"})})}),(0,oe().u)({key:"promptCache",displayName:je.promptCache,analyticsName:"promptCache",validators:[],initialFocus:void 0,right:(0,Q.jsx)(pe().D,{colorVariant:"tertiary",children:"none"===N?(0,Q.jsx)($().sA,{...je.none}):"redis"===N?(0,Q.jsx)($().sA,{...je.redis}):(0,Q.jsx)($().sA,{...je.s3})}),subActions:()=>[(0,ie().gy)({key:"cache",render:e=>(0,Q.jsx)(j().A,{...e}),actions:[(0,ie().Ls)({key:"none",displayName:je.none,analyticsName:je.none.defaultMessage,action:()=>w("none"),validators:[],closeParentMenu:!1,render:e=>(0,Q.jsx)(y().A,{...e,title:s.formatMessage(je.none),right:"none"===N&&(0,Q.jsx)(ce().I,{icon:ue().checkmarkIcon,size:"xxs"})})}),(0,ie().Ls)({key:"redis",displayName:je.redis,analyticsName:je.redis.defaultMessage,action:()=>w("redis"),validators:[],closeParentMenu:!1,render:e=>(0,Q.jsx)(y().A,{...e,title:s.formatMessage(je.redis),right:"redis"===N&&(0,Q.jsx)(ce().I,{icon:ue().checkmarkIcon,size:"xxs"})})}),(0,ie().Ls)({key:"s3",displayName:je.s3,analyticsName:je.s3.defaultMessage,action:()=>w("s3"),validators:[],closeParentMenu:!1,render:e=>(0,Q.jsx)(y().A,{...e,title:s.formatMessage(je.s3),right:"s3"===N&&(0,Q.jsx)(ce().I,{icon:ue().checkmarkIcon,size:"xxs"})})})]})]}),(0,oe().u)({key:"embeddingModelOverride",displayName:je.embeddingModelOverride,analyticsName:"embeddingModelOverride",validators:[],initialFocus:void 0,right:(0,Q.jsx)(pe().D,{colorVariant:"tertiary",children:"default"===R?(0,Q.jsx)($().sA,{...je.default}):"bge-m3"===R?(0,Q.jsx)($().sA,{...je.bgeM3}):"bge-1024"===R?(0,Q.jsx)($().sA,{...je.bge1024}):"bge-4096"===R?(0,Q.jsx)($().sA,{...je.bge4096}):(0,Q.jsx)($().sA,{...je.e5})}),subActions:()=>[(0,ie().gy)({key:"embeddingModels",render:e=>(0,Q.jsx)(j().A,{...e}),actions:[(0,ie().Ls)({key:"default",displayName:je.default,analyticsName:je.default.defaultMessage,action:()=>M("default"),validators:[],closeParentMenu:!1,render:e=>(0,Q.jsx)(y().A,{...e,title:s.formatMessage(je.default),right:"default"===R&&(0,Q.jsx)(ce().I,{icon:ue().checkmarkIcon,size:"xxs"})})}),(0,ie().Ls)({key:"bge-m3",displayName:je.bgeM3,analyticsName:je.bgeM3.defaultMessage,action:()=>M("bge-m3"),validators:[],closeParentMenu:!1,render:e=>(0,Q.jsx)(y().A,{...e,title:s.formatMessage(je.bgeM3),right:"bge-m3"===R&&(0,Q.jsx)(ce().I,{icon:ue().checkmarkIcon,size:"xxs"})})}),(0,ie().Ls)({key:"bge-1024",displayName:je.bge1024,analyticsName:je.bge1024.defaultMessage,action:()=>M("bge-1024"),validators:[],closeParentMenu:!1,render:e=>(0,Q.jsx)(y().A,{...e,title:s.formatMessage(je.bge1024),right:"bge-1024"===R&&(0,Q.jsx)(ce().I,{icon:ue().checkmarkIcon,size:"xxs"})})}),(0,ie().Ls)({key:"bge-4096",displayName:je.bge4096,analyticsName:je.bge4096.defaultMessage,action:()=>M("bge-4096"),validators:[],closeParentMenu:!1,render:e=>(0,Q.jsx)(y().A,{...e,title:s.formatMessage(je.bge4096),right:"bge-4096"===R&&(0,Q.jsx)(ce().I,{icon:ue().checkmarkIcon,size:"xxs"})})}),(0,ie().Ls)({key:"e5",displayName:je.e5,analyticsName:je.e5.defaultMessage,action:()=>M("e5"),validators:[],closeParentMenu:!1,render:e=>(0,Q.jsx)(y().A,{...e,title:s.formatMessage(je.e5),right:"e5"===R&&(0,Q.jsx)(ce().I,{icon:ue().checkmarkIcon,size:"xxs"})})})]})]}),(0,ie().Ls)({key:"contextManagementConfiguration",displayName:je.contextManagementConfiguration,analyticsName:"contextManagementConfiguration",action:()=>{x(c.contextManagementConfiguration??ye),b((e=>!e))},validators:[],closeParentMenu:!1,render:e=>(0,Q.jsx)(y().A,{...e,title:s.formatMessage(je.contextManagementConfiguration),right:v?(0,Q.jsx)(ce().I,{icon:ue().checkmarkIcon,size:"xxs"}):void 0})})]})],L=(0,re().S)();return(0,Q.jsx)(d().A,{popupType:d().z.Popup,placementToOrigin:"bottom",alignmentToOrigin:"start",renderOrigin:e=>(0,Q.jsx)(h().m,{renderTooltip:()=>(0,Q.jsx)("div",{children:"Debug options"}),placement:"top",render:t=>(0,Q.jsx)(p().A,{...(0,ne().A)(e,t),icon:ge().ellipsisIcon,iconStyle:l.iconButton,ariaLabel:s.formatMessage(je.debugOptions)})}),render:e=>(0,Q.jsx)(f().A,{menuType:m().gu.Popup,children:(0,Q.jsxs)("div",{style:{display:"flex",flexDirection:"row",alignItems:"stretch",gap:12,padding:"8px 12px"},children:[(0,Q.jsx)("div",{style:{minWidth:220},children:(0,Q.jsx)(ae().A,{context:{blocks:[],environment:n,publicEditMode:void 0,pageContext:L},sections:z,initialFocus:void 0})}),v?(0,Q.jsx)("div",{style:{minWidth:280,flex:1},role:"presentation",onMouseDown:e=>e.stopPropagation(),onClick:e=>e.stopPropagation(),children:(0,Q.jsxs)("div",{style:{display:"flex",flexDirection:"column",gap:8},children:[(0,Q.jsxs)("label",{style:{display:"flex",flexDirection:"column",gap:4},children:[(0,Q.jsx)(pe().D,{styleKey:"captionMedium",colorVariant:"secondary",children:"recentSearchToolResultsToKeep"}),(0,Q.jsx)(u().A,{type:"number",value:void 0===g.recentSearchToolResultsToKeep?"":String(g.recentSearchToolResultsToKeep),onChange:e=>O("recentSearchToolResultsToKeep",e.target.value),placeholder:"-1 (no truncation)"})]}),(0,Q.jsxs)("label",{style:{display:"flex",flexDirection:"column",gap:4},children:[(0,Q.jsx)(pe().D,{styleKey:"captionMedium",colorVariant:"secondary",children:"summarizeTokenThreshold"}),(0,Q.jsx)(u().A,{type:"number",step:"0.01",min:"0",value:void 0===g.summarizeTokenThreshold?"":String(g.summarizeTokenThreshold),onChange:e=>O("summarizeTokenThreshold",e.target.value),placeholder:"0.0 - 1.0"})]}),(0,Q.jsx)(pe().D,{colorVariant:"tertiary",styleKey:"captionRegular",children:"Leave fields empty to use defaults. Threshold controls when progressive compression kicks in."})]})}):null]})})})}n(803949);var Te=n(440961),Ce=()=>n(717137);function ke(e){const{collapseAll:t,collapseAgentMessages:n,uncollapseAll:r,allMessagesCollapsed:s,agentMessagesCollapsed:a,hasCollapsedMessages:o}=e,i=e=>({padding:"4px 8px",border:"1px solid #ddd",backgroundColor:e?"#f5f5f5":"white",color:e?"#999":"#666",borderRadius:4,fontSize:11,cursor:e?"not-allowed":"pointer",userSelect:"none",opacity:e?.6:1});return(0,Q.jsxs)(Q.Fragment,{children:[(0,Q.jsx)("button",{style:i(s),onClick:s?void 0:t,type:"button",title:s?"All messages are already collapsed":"Collapse all messages",disabled:s,children:"Collapse all"}),(0,Q.jsx)("button",{style:i(a),onClick:a?void 0:n,type:"button",title:a?"All agent messages are already collapsed":"Collapse only agent and tool messages",disabled:a,children:"Collapse agent messages"}),(0,Q.jsx)("button",{style:i(!o),onClick:o?r:void 0,type:"button",title:o?"Expand all messages":"No messages are collapsed",disabled:!o,children:"Uncollapse all"})]})}n(737550);function Se(e){const{messages:t}=e,[n,s]=(0,r.useState)((()=>{const e=new Set;return t.forEach(((t,n)=>{if("user"!==t.type.toLowerCase()&&e.add(n),"content"in t&&Array.isArray(t.content)){t.content.some((e=>"tool_result"===e.type||"tool_use"===e.type))&&e.add(n)}})),e})),a=(0,r.useCallback)((e=>{s((t=>{const n=new Set(t);return n.has(e)?n.delete(e):n.add(e),n}))}),[]),o=(0,r.useCallback)((()=>{const e=new Set;t.forEach(((t,n)=>{e.add(n)})),s(e)}),[t]),l=(0,r.useCallback)((()=>{const e=new Set;t.forEach(((t,n)=>{const r=t.type.toLowerCase();if("assistant"!==r&&"system"!==r||e.add(n),"content"in t&&Array.isArray(t.content)){t.content.some((e=>"tool_result"===e.type||"tool_use"===e.type))&&e.add(n)}})),s(e)}),[t]),d=(0,r.useCallback)((()=>{s(new Set)}),[]),c=n.size>0,p=(0,r.useMemo)((()=>t.some(((e,t)=>!n.has(t)))),[t,n]),u=(0,r.useMemo)((()=>{let e=!1,r=!1;return t.forEach(((t,s)=>{const a=t.type.toLowerCase(),o="assistant"===a||"system"===a,i="content"in t&&Array.isArray(t.content)&&t.content.some((e=>"tool_result"===e.type||"tool_use"===e.type)),l=o||i,d=n.has(s);l&&!d&&(e=!0),!l&&d&&(r=!0)})),e||r}),[t,n]),{onCollapseStateChange:g}=e;r.useEffect((()=>{g&&g({collapseAll:o,collapseAgentMessages:l,uncollapseAll:d,allMessagesCollapsed:!p,agentMessagesCollapsed:!u,hasCollapsedMessages:c})}),[g,o,l,d,p,u,c]);const m=(0,i().IS)((()=>({chatContainer:{display:"flex",flexDirection:"column",gap:12,height:"100%",overflow:"visible",padding:12},messageContainer:{display:"flex",flexDirection:"column",gap:4},messageHeader:{display:"flex",alignItems:"center",gap:8,fontSize:12,fontWeight:600,cursor:"pointer",padding:"4px 0",borderRadius:4},messageHeaderClickable:{background:"none",border:"none",padding:0,margin:0,display:"flex",alignItems:"center",gap:8,cursor:"pointer",width:"100%",textAlign:"start"},messageRole:{padding:"2px 6px",borderRadius:4,fontSize:10,fontWeight:600,textTransform:"uppercase",cursor:"pointer",userSelect:"none"},systemRole:{backgroundColor:B().Tj.border.secondaryTranslucent,color:B().Tj.text.secondary},userRole:{backgroundColor:"#2563eb",color:"white"},assistantRole:{backgroundColor:"#16a34a",color:"white"},toolResultRole:{backgroundColor:"#ea580c",color:"white"},toolUseRole:{backgroundColor:"#eab308",color:"white"},unknownRole:{backgroundColor:B().Tj.text.secondary,color:B().Tj.background.primary},toolName:{fontWeight:"bold",marginInlineStart:8,color:B().Tj.text.primary},messageContent:{fontSize:13,lineHeight:1.4,color:B().Tj.text.primary,whiteSpace:"pre-wrap",backgroundColor:B().Tj.background.primary,border:`1px solid ${B().Tj.border.secondaryTranslucent}`,borderRadius:4,padding:8,overflow:"scroll"},cacheIndicator:{fontSize:10,color:B().Tj.text.secondary,fontStyle:"italic"},collapsedIndicator:{fontSize:10,color:B().Tj.text.secondary,fontStyle:"italic",marginInlineStart:8,background:"none",border:"none",padding:0,cursor:"pointer"},multiContentItem:{display:"flex",flexDirection:"column",gap:4,marginBottom:8},contentType:{fontSize:10,color:B().Tj.text.secondary,fontFamily:"monospace"}})),[]),x=(e,t=!1,n)=>{if(t&&n)switch(n){case"tool_result":return{...m.messageRole,...m.toolResultRole};case"tool_use":return{...m.messageRole,...m.toolUseRole};default:return{...m.messageRole,...m.unknownRole}}switch(e.toLowerCase()){case"system":return{...m.messageRole,...m.systemRole};case"user":return{...m.messageRole,...m.userRole};case"assistant":return{...m.messageRole,...m.assistantRole};default:return{...m.messageRole,...m.unknownRole}}},h=e=>{try{if("tool_use"===e.type)return JSON.stringify(JSON.parse(e.content),null,2)}catch(t){}return"content"in e?e.content:JSON.stringify(e,null,2)};return t&&0!==t.length?(0,Q.jsxs)("div",{style:m.chatContainer,children:[t.map(((e,t)=>{var s,o,i;const l=n.has(t),d=function(e){const{type:t}=e;if(t&&"toolName"in e&&e.toolName)return{type:t,name:e.toolName};if(t&&"name"in e&&e.name)return{type:t,name:e.name};if(t&&"content"in e&&Array.isArray(e.content)){const n=e.content.filter((e=>"tool_result"===e.type||"tool_use"===e.type)).map((e=>({type:e.type,name:"name"in e&&e.name||"toolName"in e&&e.toolName||void 0})));if(n.length>0)return{type:t,toolItems:n}}return{type:t}}(e);return(0,Q.jsxs)("div",{style:m.messageContainer,children:[(0,Q.jsx)("button",{style:m.messageHeaderClickable,onClick:()=>a(t),type:"button",children:(0,Q.jsxs)("div",{style:m.messageHeader,children:[null!==(s=d.toolItems)&&void 0!==s&&s.length?void 0:(0,Q.jsx)("span",{style:{...x(d.type),border:"none"},children:d.type}),!d.name||null!==(o=d.toolItems)&&void 0!==o&&o.length?void 0:(0,Q.jsx)("span",{style:m.toolName,children:d.name}),null===(i=d.toolItems)||void 0===i?void 0:i.map(((e,t)=>(0,Q.jsxs)(r.Fragment,{children:[(0,Q.jsx)("span",{style:{...x("",!0,e.type),border:"none",marginInlineStart:t>0?8:0},children:"tool_result"===e.type?"Tool result":"Tool use"}),e.name?(0,Q.jsx)("span",{style:m.toolName,children:e.name}):void 0]},t))),e.do_cache?(0,Q.jsx)("span",{style:m.cacheIndicator,children:"• cached"}):void 0,l?(0,Q.jsx)("span",{style:m.collapsedIndicator,children:"Collapsed"}):void 0]})}),l?void 0:(c=e.content,"string"==typeof c?(0,Q.jsx)("div",{style:m.messageContent,children:c}):Array.isArray(c)?(0,Q.jsx)("div",{style:m.messageContent,children:c.map(((e,t)=>(0,Q.jsxs)("div",{style:m.multiContentItem,children:[(0,Q.jsxs)("div",{style:m.contentType,children:["Type: ",e.type,"name"in e?`: ${e.name}`:"","toolName"in e?`: ${e.toolName}`:""]}),(0,Q.jsx)("div",{children:h(e)})]},t)))}):(0,Q.jsx)("div",{style:m.messageContent,children:"Invalid content format"}))]},t);var c})),(0,Q.jsx)("div",{style:{height:24},children:" "})]}):(0,Q.jsx)("div",{style:m.chatContainer,children:(0,Q.jsx)("div",{style:{color:"#666",fontStyle:"italic"},children:"No messages to display - currently not supported for live transcripts, you may need to load from a log"})})}function Ie(e){var t,n,s,a,o;const{inference:l,trigger:d}=e,[c,p]=(0,r.useState)(!1),u=(0,r.useRef)(null),[g,m]=(0,r.useState)(void 0),x=(0,r.useCallback)((()=>p(!0)),[]),h=(0,r.useCallback)((()=>p(!1)),[]);(0,r.useEffect)((()=>{if(!c)return;const e=e=>{"Escape"===e.key&&h()};return document.addEventListener("keydown",e),u.current&&u.current.focus(),()=>{document.removeEventListener("keydown",e)}}),[c,h]);const f=(0,i().IS)((()=>({backdrop:{position:"fixed",top:0,insetInlineStart:0,insetInlineEnd:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.5)",zIndex:999,display:"flex",alignItems:"center",justifyContent:"center",padding:20},dialogContainer:{width:"95vw",maxWidth:1400,height:"90vh",backgroundColor:B().Tj.background.primary,border:`1px solid ${B().Tj.border.secondaryTranslucent}`,borderRadius:8,boxShadow:"0 4px 12px rgba(0, 0, 0, 0.15)",display:"flex",flexDirection:"column",overflow:"hidden",position:"relative"},header:{padding:"16px 20px",borderBottom:`1px solid ${B().Tj.border.secondaryTranslucent}`,fontSize:16,fontWeight:600,color:B().Tj.text.primary,display:"flex",alignItems:"center",justifyContent:"space-between"},headerTitle:{flex:"0 0 auto"},headerControls:{display:"flex",gap:8,alignItems:"center"},content:{display:"flex",height:"100%",overflow:"hidden"},leftPanel:{flex:"0 0 60%",display:"flex",flexDirection:"column",borderInlineEnd:`1px solid ${B().Tj.border.secondaryTranslucent}`,minWidth:0},rightPanel:{flex:"0 0 40%",display:"flex",flexDirection:"column",overflow:"auto",padding:"16px 20px",gap:16,minWidth:0},transcriptContainer:{flex:1,overflow:"auto",padding:"16px 20px",minHeight:0},section:{display:"flex",flexDirection:"column",gap:8},sectionTitle:{fontSize:14,fontWeight:600,color:B().Tj.text.primary,borderBottom:`1px solid ${B().Tj.border.secondaryTranslucent}`,paddingBottom:4},toggle:{border:"none",padding:0,margin:0},metadataGrid:{display:"grid",gridTemplateColumns:"1fr 2fr",gap:"8px 16px",fontSize:12,fontFamily:"monospace"},metadataKey:{color:B().Tj.text.secondary,fontWeight:600},metadataValue:{color:B().Tj.text.primary,wordBreak:"break-all"},braintrustLink:{color:B().Tj.text.primary,textDecoration:"underline",cursor:"pointer",wordBreak:"break-all"},toolsList:{display:"flex",flexDirection:"column",gap:2}})),[]),y=(0,r.useMemo)((()=>l.metadata||{}),[l.metadata]),v=(0,r.useMemo)((()=>{if(y.renderedPrompt&&Array.isArray(y.renderedPrompt)){const t=[...y.renderedPrompt];return l.expected&&t.push({type:"assistant",content:(e=l.expected,"string"==typeof e||Array.isArray(e)?e:JSON.stringify(e,null,2)),name:"Output"}),t}var e;return null}),[y,l.expected]),j=(0,r.useMemo)((()=>y.tools||[]),[y]),b=(0,r.useMemo)((()=>y.compressedUrls?Array.isArray(y.compressedUrls)?y.compressedUrls:Object.entries(y.compressedUrls).map((([e,t])=>({compressedForm:t,expandedUrl:e}))):[]),[y]),C=(0,r.useCallback)((e=>`https://www.braintrust.dev/app/Notion/p/${(0,T().W)({environmentName:"production",suffix:"workflow"})}/logs?r=${e}`),[]),k=(0,r.useCallback)((e=>{const t=C(e);window.open(t,"_blank")}),[C]),S=(0,r.useMemo)((()=>{const e="transcript"in l.input&&Array.isArray(l.input.transcript)?l.input.transcript:void 0,t=new Map;return null==e||e.forEach((e=>{"agent-tool-result"===e.type&&e.toolName&&t.set(e.toolName,(t.get(e.toolName)||0)+1)})),t}),[l.input]),I=c?(0,Q.jsx)("div",{style:f.backdrop,onClick:e=>{e.target===e.currentTarget&&h()},role:"presentation",children:(0,Q.jsx)(Ce().A,{debugName:"InferenceMetadataDialog",capture:!0,allowEsc:!0,allowSearch:!1,children:(0,Q.jsxs)("div",{ref:u,style:f.dialogContainer,role:"dialog","aria-label":"Inference Details",tabIndex:-1,children:[(0,Q.jsxs)("div",{style:f.header,children:[(0,Q.jsx)("div",{style:f.headerTitle,children:"Inference Details"}),(0,Q.jsx)("div",{style:f.headerControls,children:g?(0,Q.jsx)(ke,{collapseAll:g.collapseAll,collapseAgentMessages:g.collapseAgentMessages,uncollapseAll:g.uncollapseAll,allMessagesCollapsed:g.allMessagesCollapsed,agentMessagesCollapsed:g.agentMessagesCollapsed,hasCollapsedMessages:g.hasCollapsedMessages}):void 0})]}),(0,Q.jsxs)("div",{style:f.content,children:[(0,Q.jsx)("div",{style:f.leftPanel,children:(0,Q.jsx)("div",{style:f.transcriptContainer,children:(0,Q.jsx)(Se,{messages:v??[],onCollapseStateChange:m})})}),(0,Q.jsxs)("div",{style:f.rightPanel,children:[(0,Q.jsxs)("div",{style:f.section,children:[(0,Q.jsx)("div",{style:f.sectionTitle,children:"Basic Information"}),(0,Q.jsxs)("div",{style:f.metadataGrid,children:[(0,Q.jsx)("div",{style:f.metadataKey,children:"ID:"}),(0,Q.jsx)("div",{style:f.metadataValue,children:l.id||"N/A"}),(0,Q.jsx)("div",{style:f.metadataKey,children:"Input Type:"}),(0,Q.jsx)("div",{style:f.metadataValue,children:(null===(t=l.input)||void 0===t?void 0:t.type)||"N/A"}),null!=y&&y.aiSessionId?(0,Q.jsxs)(Q.Fragment,{children:[(0,Q.jsx)("div",{style:f.metadataKey,children:"AI Session ID:"}),(0,Q.jsx)("div",{style:f.metadataValue,children:String(y.aiSessionId)})]}):void 0,null!=y&&y.aiTraceId?(0,Q.jsxs)(Q.Fragment,{children:[(0,Q.jsx)("div",{style:f.metadataKey,children:"AI Trace ID:"}),(0,Q.jsx)("button",{style:{...f.braintrustLink,background:"none",border:"none",padding:0,textAlign:"start",font:"inherit"},onClick:()=>k(String(y.aiTraceId)),title:"Click to open in Braintrust",type:"button",children:String(y.aiTraceId)})]}):void 0,null!=y&&y.modelInfo?(0,Q.jsxs)(Q.Fragment,{children:[(0,Q.jsx)("div",{style:f.metadataKey,children:"Model:"}),(0,Q.jsx)("div",{style:f.metadataValue,children:(null===(n=y.modelInfo)||void 0===n?void 0:n.notionName)||(null===(s=y.modelInfo)||void 0===s?void 0:s.vendorName)||"N/A"})]}):void 0,null!=y&&null!==(a=y.completionMetrics)&&void 0!==a&&a.tokens?(0,Q.jsxs)(Q.Fragment,{children:[(0,Q.jsx)("div",{style:f.metadataKey,children:"Input Tokens:"}),(0,Q.jsx)("div",{style:f.metadataValue,children:String(y.completionMetrics.tokens.inputTokens)||"N/A"}),(0,Q.jsx)("div",{style:f.metadataKey,children:"Output Tokens:"}),(0,Q.jsx)("div",{style:f.metadataValue,children:String(y.completionMetrics.tokens.outputTokens)||"N/A"})]}):void 0,null!=y&&null!==(o=y.completionMetrics)&&void 0!==o&&o.finishReason?(0,Q.jsxs)(Q.Fragment,{children:[(0,Q.jsx)("div",{style:f.metadataKey,children:"Finish Reason:"}),(0,Q.jsx)("div",{style:f.metadataValue,children:(e=>{const t=String(y.completionMetrics.finishReason),n=null==y||null===(e=y.completionMetrics)||void 0===e?void 0:e.toolName;return"tool_use"===t&&n?`${t}: ${n}`:t})()})]}):void 0]})]}),b.length>0?(0,Q.jsxs)("div",{style:f.section,children:[(0,Q.jsx)("div",{style:f.sectionTitle,children:"Compressed URLs"}),(0,Q.jsx)("div",{style:f.metadataGrid,children:b.map((({compressedForm:e,expandedUrl:t})=>(0,Q.jsxs)(r.Fragment,{children:[(0,Q.jsx)("div",{style:f.metadataKey,children:`${e}:`}),(0,Q.jsx)("div",{style:f.metadataValue,children:t})]},e)))})]}):void 0,j&&j.length>0?(0,Q.jsxs)("div",{style:f.section,children:[(0,Q.jsx)("div",{style:f.sectionTitle,children:"Tools"}),(0,Q.jsx)("div",{style:f.toolsList,children:j.map(((e,t)=>{const n=(null==e?void 0:e.name)||`Tool ${t+1}`,r=S.get(n)||0;return(0,Q.jsx)(W().b,{label:n,right:r>0?(0,Q.jsx)("span",{style:{fontSize:10,fontWeight:"bold",color:"#666"},children:1===r?"(ran)":`(ran x${r})`}):void 0,style:f.toggle,defaultOpen:!1,children:(0,Q.jsx)(E().X,{language:"json",value:JSON.stringify(e,null,2)})},t)}))})]}):void 0,(0,Q.jsxs)("div",{style:f.section,children:[(0,Q.jsx)("div",{style:f.sectionTitle,children:"Raw Values"}),(0,Q.jsx)(W().b,{label:"Input",style:f.toggle,defaultOpen:!1,children:(0,Q.jsx)(E().X,{language:"json",value:JSON.stringify(l.input,null,2)})}),l.expected?(0,Q.jsx)(W().b,{label:"Output",style:f.toggle,defaultOpen:!1,children:(0,Q.jsx)(E().X,{language:"json",value:JSON.stringify(l.expected,null,2)})}):void 0,y&&Object.keys(y).length>0?(0,Q.jsx)(W().b,{label:"Raw Metadata",style:f.toggle,defaultOpen:!1,children:(0,Q.jsx)(E().X,{language:"json",value:JSON.stringify(y,null,2)})}):void 0]})]})]})]})})}):null;return(0,Q.jsxs)(Q.Fragment,{children:[(0,Q.jsx)("button",{onClick:x,style:{cursor:"pointer",background:"none",border:"none",padding:0,margin:0,flexGrow:1,textAlign:"start",display:"flex"},type:"button","aria-label":"Open inference metadata dialog",children:d}),I?(0,Te.createPortal)(I,document.body):void 0]})}n(823215);var we=()=>n(933922),Me=()=>n(755125);function Ae(e){const[t,n]=(0,r.useState)(!1),s=(0,a().v3)(),{onFocus:o,onBlur:i,...l}=e,d=e=>{(0,Me().clear)({environment:s}),n(!0),null==o||o(e)},c=e=>{n(!1),null==i||i(e)};return(0,Q.jsx)(we().A,{capture:t,render:e=>(0,Q.jsx)(u().A,{...l,...e,onFocus:d,onBlur:c})})}function Oe(e){const t=(0,$().tz)(),{request:n,memories:s,clientStore:o,onChange:l}=e,c=(0,a().v3)(),[u,m]=(0,r.useState)(!1),[h,f]=(0,r.useState)(0),y=(0,i().IS)((()=>({topbar:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:8},status:{marginInlineEnd:2},formContainer:{display:"flex",flexDirection:"column",gap:12,padding:"12px 0"},formRow:{display:"flex",flexDirection:"column",gap:4},formLabel:{fontSize:12,color:B().Tj.darkTextColor,fontWeight:500},popupContent:{padding:16,minWidth:300},buttonRow:{display:"flex",gap:8},container:{padding:12,marginTop:16,border:`1px solid ${B().Tj.border.secondaryTranslucent}`,borderRadius:8,backgroundColor:B().Tj.background.primary},sectionTitle:{fontSize:14,fontWeight:600,marginBottom:12,color:B().Tj.text.primary},testResultsPopup:{padding:12,width:400,minWidth:400,maxWidth:"none",maxHeight:300,overflowY:"auto"},testResultItem:{marginBottom:16,fontSize:13,color:B().Tj.darkTextColor,whiteSpace:"pre-wrap"},testResultTitle:{fontWeight:600,marginBottom:8,fontSize:14},failedTestButton:{backgroundColor:"#ffebee",color:"#d32f2f",padding:"4px 8px",borderRadius:4},successTestButton:{backgroundColor:"#e8f5e9",color:"#2e7d32",padding:"4px 8px",borderRadius:4},memorySelector:{display:"flex",gap:8,marginBottom:12,alignItems:"center"},memorySelect:{padding:"4px 8px",borderRadius:4,border:`1px solid ${B().Tj.border.secondaryTranslucent}`,backgroundColor:B().Tj.background.primary,color:B().Tj.text.primary},addMemoryButton:{display:"flex",alignItems:"center",gap:4}})),[]),[v,j]=(0,r.useState)(""),b=("inferenceTranscript"===n.type?[...n.request.transcript,...n.response.transcript].filter((e=>e.type.includes("inference"))):[]).map(((e,t)=>({index:t,id:e.id}))),T=(0,r.useCallback)(((e,t)=>{const n=[...s];n[h]={...n[h],[e]:t},l(n)}),[s,h,l]),C=(0,r.useCallback)((()=>{const e=s.filter(((e,t)=>t!==h));l(e),f(Math.min(h,e.length-1))}),[s,h,l]),k=(0,r.useCallback)((()=>{l([...s,{testTitle:"",inputSummary:"",promptFeedback:"",testInstructions:"",originalOutputPassesTest:!1,originalOutputTestResults:[],originalOutput:"",feedback:"",correctedOutputs:[],verified:!1,isOptional:!1}]),f(s.length)}),[s,l]),S=(0,r.useCallback)((async()=>{v.trim()&&(m(!0),await(0,q().Wd)({environment:c,request:n,memory:{...s[h],feedback:v},clientStore:o,onChange:e=>{const t=[...s];t[h]=e,l(t)}}),j(""),m(!1))}),[c,n,s,h,o,l,v]),I=(0,r.useCallback)((async()=>{m(!0),await(0,q().VZ)({environment:c,request:n,memory:s[h],clientStore:o,onChange:e=>{const t=[...s];t[h]=e,l(t)}}),m(!1)}),[c,n,s,h,o,l]),w=s[h];return(0,Q.jsxs)("div",{style:y.container,children:[(0,Q.jsx)("div",{style:y.sectionTitle,children:"Memory Editor"}),(0,Q.jsxs)("div",{style:y.memorySelector,children:[(0,Q.jsx)("select",{style:y.memorySelect,value:h,onChange:e=>f(Number(e.target.value)),children:s.map(((e,t)=>{return(0,Q.jsxs)("option",{value:t,children:["Memory ",t+1,": ",(n=e.testTitle||"Untitled",n.length>24?`${n.slice(0,24)}...`:n)]},t);var n}))}),(0,Q.jsx)(x().p,{onClick:k,style:y.addMemoryButton,children:"Add Memory"})]}),w?(0,Q.jsxs)(Q.Fragment,{children:[(0,Q.jsxs)("div",{style:y.topbar,children:[(0,Q.jsx)("div",{style:y.status,children:u?(0,Q.jsx)(g().k,{}):w.originalOutputTestResults&&w.originalOutputTestResults.length>0?(0,Q.jsx)(d().A,{renderOrigin:e=>(0,Q.jsxs)(x().p,{...e,style:w.originalOutputTestResults.every((e=>1===e.score))?y.successTestButton:y.failedTestButton,children:[w.originalOutputTestResults.every((e=>1===e.score))?"✅ Test score: ":"❌ Test score: ",(w.originalOutputTestResults.reduce(((e,t)=>e+t.score),0)/w.originalOutputTestResults.length).toFixed(2)]}),popupType:U().n.Popup,placementToOrigin:"bottom",render:()=>(0,Q.jsx)("div",{style:y.testResultsPopup,children:w.originalOutputTestResults.map(((e,t)=>(0,Q.jsxs)("div",{style:y.testResultItem,children:[(0,Q.jsxs)("div",{style:y.testResultTitle,children:["Test Result ",t+1," - Score: ",e.score]}),e.reasoning]},t)))})}):null}),(0,Q.jsxs)("div",{style:y.buttonRow,children:[(0,Q.jsx)(d().A,{renderOrigin:e=>(0,Q.jsx)(x().p,{...e,children:"Auto-generate"}),popupType:U().n.Popup,placementToOrigin:"bottom",render:e=>(0,Q.jsxs)("div",{style:y.popupContent,children:[(0,Q.jsxs)("div",{style:y.formRow,children:[(0,Q.jsx)("div",{style:y.formLabel,children:"Feedback"}),(0,Q.jsx)(Ae,{value:v,placeholder:"Enter feedback to generate memory",onChange:e=>j(e.target.value),textarea:!0,autosize:!0})]}),(0,Q.jsx)(x().p,{onClick:()=>{S(),e.close()},disabled:!v.trim(),children:"Generate"})]})}),(0,Q.jsx)(x().p,{onClick:I,children:"Test"}),(0,Q.jsx)(p().A,{icon:Y().trashIcon,onClick:C,ariaLabel:t.formatMessage({id:"aiInferenceTranscript.memoryEditor.deleteMemory",defaultMessage:"Delete memory"})})]})]}),(0,Q.jsx)(W().b,{label:"Visual editor",defaultOpen:!0,children:(0,Q.jsxs)("div",{style:y.formContainer,children:[(0,Q.jsxs)("div",{style:y.formRow,children:[(0,Q.jsx)("div",{style:y.formLabel,children:"Test Title"}),(0,Q.jsx)(Ae,{value:w.testTitle,placeholder:"Enter test title",onChange:e=>T("testTitle",e.target.value)})]}),(0,Q.jsxs)("div",{style:y.formRow,children:[(0,Q.jsx)("div",{style:y.formLabel,children:"Input Summary"}),(0,Q.jsx)(Ae,{value:w.inputSummary,placeholder:"Enter input summary",onChange:e=>T("inputSummary",e.target.value),textarea:!0,autosize:!0})]}),(0,Q.jsxs)("div",{style:y.formRow,children:[(0,Q.jsx)("div",{style:y.formLabel,children:"Prompt Feedback"}),(0,Q.jsx)(Ae,{value:w.promptFeedback,placeholder:"Enter prompt feedback",onChange:e=>T("promptFeedback",e.target.value),textarea:!0,autosize:!0})]}),(0,Q.jsxs)("div",{style:y.formRow,children:[(0,Q.jsx)("div",{style:y.formLabel,children:"Test Instructions"}),(0,Q.jsx)(Ae,{value:w.testInstructions,placeholder:"Enter test instructions",onChange:e=>T("testInstructions",e.target.value),textarea:!0,autosize:!0})]}),(0,Q.jsx)("div",{style:y.formRow,children:(0,Q.jsxs)("label",{style:{display:"flex",alignItems:"center",gap:8},children:[(0,Q.jsx)("input",{type:"checkbox",checked:w.originalOutputPassesTest,onChange:e=>T("originalOutputPassesTest",e.target.checked)}),(0,Q.jsx)("span",{style:y.formLabel,children:"Original Output Passes Test"})]})}),(0,Q.jsx)("div",{style:y.formRow,children:(0,Q.jsxs)("label",{style:{display:"flex",alignItems:"center",gap:8},children:[(0,Q.jsx)("input",{type:"checkbox",checked:w.isOptional,onChange:e=>T("isOptional",e.target.checked)}),(0,Q.jsx)("span",{style:y.formLabel,children:"Optional Memory"})]})}),b&&b.length>0?(0,Q.jsxs)("div",{style:y.formRow,children:[(0,Q.jsx)("div",{style:y.formLabel,children:"stepId:"}),(0,Q.jsxs)("select",{style:{display:"flex",alignItems:"center",gap:8},value:w.stepId??"all",onChange:e=>{const t=e.target.value,n=b.find((e=>e.id===t));T("stepId",null==n?void 0:n.id)},children:[(0,Q.jsx)("option",{value:"all",children:"all"},-1),b.map((e=>(0,Q.jsx)("option",{value:e.id,children:`${e.index}: ...${e.id.slice(-8)}`},e.index)))]})]}):void 0]})}),(0,Q.jsx)(W().b,{label:"JSON editor",defaultOpen:!1,children:(0,Q.jsx)(E().X,{language:"json",value:JSON.stringify(w,null,2)})})]}):void 0]})}var Ne=()=>n(718827),Re=()=>n(274023),ze=()=>n(284371),$e=()=>n(910554);function Be(e){const t=e.model,n=(0,a().v3)(),r=(0,i().IS)((()=>({badge:{fontSize:12,fontWeight:500,padding:"1px 6px",backgroundColor:B().Tj.cardHoveredBackground,color:B().Tj.text.tertiary,borderRadius:4,...ze().RC}})),[]),s=(0,o().K8)((()=>$e().A.getData(n,{})||[]),[n]),l=e.model?Le(e.model)||e.model:"Default model";return(0,Q.jsx)(d().A,{popupType:d().z.Popup,placementToOrigin:"bottom",alignmentToOrigin:"start",renderOrigin:t=>(0,Q.jsx)(h().m,{renderTooltip:()=>(0,Q.jsx)("div",{children:"Select a model"}),placement:"bottom",alignment:"center",render:n=>"button"===e.format?(0,Q.jsx)(x().p,{...(0,ne().A)(t,n),children:l}):(0,Q.jsx)(Ne().Ay,{...(0,ne().A)(t,n),ignoreLocalHoverState:!0,children:(0,Q.jsx)("div",{style:r.badge,children:l})})}),render:n=>(0,Q.jsx)(f().A,{menuType:m().gu.Popup,children:(0,Q.jsx)(v().A,{type:v().O.Vertical,initialFocus:0,sections:[{key:"models",render:e=>(0,Q.jsx)(j().A,{...e,title:"Models",shouldShowBottomDivider:!0}),items:s.map((r=>({key:r,action:()=>{e.setModel(r),n.close()},render:e=>(0,Q.jsx)(y().A,{...e,title:Le(r)||r,isChecked:r===t})})))}]})})})}function Le(e){if("default"===e)return"Default model";try{const t=(0,Re().PK)(e);return t.displayNameWithProvider??t.displayName}catch{return}}var De=()=>n(406094),Pe=()=>n(449445),Fe=()=>n(763884),Ke=()=>n(854705),Ee=()=>n(419357);function We(e){const{items:t,selectedItem:n,onSelect:s,renderItem:a,placeholder:o,isFiltered:l}=e,c=(0,i().IS)((()=>({buttonWrapper:{display:"flex",alignItems:"center",gap:4},chevronWrapper:{display:"flex",alignItems:"center",marginInlineStart:4}})),[]),[p,u]=(0,r.useState)(""),g=(0,r.useCallback)((e=>{u(e.target.value)}),[]),h=t.filter((e=>l(e,p)));return(0,Q.jsx)(d().A,{popupType:d().z.Popup,placementToOrigin:"bottom",alignmentToOrigin:"start",renderOrigin:e=>(0,Q.jsx)(x().p,{...e,children:(0,Q.jsxs)("div",{style:c.buttonWrapper,children:[n?a(n):o||"",(0,Q.jsx)("span",{style:c.chevronWrapper,children:(0,Q.jsx)(ce().I,{icon:Ke().arrowChevronSingleDownFillSmallIcon,size:"xxs",colorVariant:"tertiary"})})]})}),render:e=>(0,Q.jsxs)(f().A,{menuType:m().gu.Popup,children:[(0,Q.jsx)(Ee().Ay,{value:p,onChange:g,autoFocus:!0}),(0,Q.jsx)(v().A,{type:v().O.Vertical,initialFocus:0,sections:[{key:"items",render:e=>(0,Q.jsx)(j().A,{...e}),items:h.map(((t,r)=>({key:r,action:()=>{s(t),e.close()},render:e=>(0,Q.jsx)(y().A,{...e,title:a(t),isChecked:t===n})})))}]})]})})}function _e(e){const{project:t,dataset:n,onChange:s}=e,o=(0,a().v3)(),[i,l]=(0,r.useState)([]),d=(0,r.useCallback)((async()=>{if(!t)return;const e=await F().callApi({eventName:"getBraintrustDatasetsForProject",environment:o,data:{project:t}});if("failed"===e.type)throw e.error;const n=e.data.datasets.map((e=>e.name)).sort(((e,t)=>e.localeCompare(t)));l(n)}),[o,t]);return(0,k().Yb)((async()=>{await d()}),[d]),(0,Q.jsx)(We,{items:i,selectedItem:n,onSelect:s,renderItem:e=>e,isFiltered:(e,t)=>e.toLowerCase().includes(t.toLowerCase()),placeholder:"Select dataset"})}function qe(e){const{project:t,setProject:n}=e,[s,o]=(0,r.useState)([]),i=(0,a().v3)();(0,k().Yb)((async()=>{const e=await F().callApi({eventName:"getBraintrustProjects",environment:i,data:{}});if("failed"===e.type)throw e.error;o(e.data.projects.map((({id:e,name:t})=>({id:e,name:t}))))}),[i]);const l=s.slice().sort(((e,t)=>e.name.localeCompare(t.name)));return(0,Q.jsx)(We,{items:l,selectedItem:t,onSelect:n,renderItem:e=>e.name,isFiltered:(e,t)=>e.name.toLowerCase().includes(t.toLowerCase()),placeholder:"Select project"})}function Ve(e){const{scopeKey:t,inference:n,defaultState:r}=e,s=(0,$().tz)();return(0,Q.jsx)(d().A,{popupType:d().z.Popup,placementToOrigin:"bottom",alignmentToOrigin:"start",renderOrigin:e=>(0,Q.jsx)(h().m,{renderTooltip:()=>"Save to dataset",placement:"top",render:t=>(0,Q.jsx)("div",{...(0,ne().A)(t,e),children:(0,Q.jsx)(p().A,{icon:Pe().arrowLineDownSmallIcon,ariaLabel:s.formatMessage({defaultMessage:"Retry",id:"aiInferenceTranscript.debug.retry"})})})}),render:e=>(0,Q.jsx)(Je,{scopeKey:t,inference:n,buttonPopupParent:e,defaultState:r})})}function Je(e){const{scopeKey:t,inference:n,buttonPopupParent:s,defaultState:o}=e,l=(0,a().v3)(),d=(0,i().IS)((()=>({menuContent:{display:"flex",flexDirection:"column",gap:8,padding:8},label:{fontSize:12,color:B().Tj.text.primary}})),[]),c=(0,r.useMemo)((()=>function(e){const{environment:t,scopeKey:n,defaultState:r}=e,s=Ge(n),a=Fe().K.get({userId:t.currentUser.id,key:s});if(!a&&r)return r;return a||{project:void 0,dataset:void 0,tags:[]}}({environment:l,scopeKey:t,defaultState:o})),[l,o,t]),[p,u]=(0,r.useState)(c),g=(0,r.useCallback)((e=>{u(e),function(e){const{environment:t,scopeKey:n,state:r}=e,s=Ge(n);Fe().K.set({userId:t.currentUser.id,key:s,value:r})}({environment:l,scopeKey:t,state:e})}),[l,t]),x=(0,r.useCallback)((e=>{g({...p,project:e,dataset:void 0})}),[g,p]),h=(0,r.useCallback)((e=>{g({...p,dataset:e})}),[g,p]),y=(0,r.useCallback)((e=>{g({...p,tags:e})}),[g,p]),v=(0,r.useCallback)((()=>{const{project:e,dataset:t,tags:r}=p;e&&t&&(0,q().wm)({environment:l,inference:{...n,tags:r},project:e.name,dataset:t})}),[l,n,p]);return(0,Q.jsx)(f().A,{menuType:m().gu.Popup,...s,children:(0,Q.jsxs)("div",{style:d.menuContent,children:[(0,Q.jsx)("div",{style:d.label,children:"Project"}),(0,Q.jsx)(qe,{project:p.project,setProject:x}),p.project?(0,Q.jsxs)(Q.Fragment,{children:[(0,Q.jsx)("div",{style:d.label,children:"Dataset"}),(0,Q.jsx)(_e,{project:p.project.name,dataset:p.dataset,onChange:h})]}):void 0,p.project&&p.dataset?(0,Q.jsxs)(Q.Fragment,{children:[(0,Q.jsx)("div",{style:d.label,children:"Tags"}),(0,Q.jsx)(Ue,{tags:p.tags,onChange:y}),(0,Q.jsx)(De().A,{size:"lg",onClick:v,children:"Save"})]}):void 0]})})}function Ue(e){const{tags:t,onChange:n}=e,s=(0,i().IS)((()=>({container:{display:"flex",flexDirection:"column",gap:4},tagsContainer:{display:"flex",flexWrap:"wrap",gap:8},checkbox:{pointerEvents:"none"}})),[]),a=(0,r.useCallback)((e=>{const r=t.includes(e)?t.filter((t=>t!==e)):[...t,e];n(r)}),[n,t]);return(0,Q.jsx)("div",{style:s.container,children:(0,Q.jsx)("div",{style:s.tagsContainer,children:b().d7.map((e=>(0,Q.jsxs)(x().p,{onClick:()=>a(e),style:{display:"flex",alignItems:"center",gap:4},children:[(0,Q.jsx)(c().S,{checked:t.includes(e),size:14,style:s.checkbox}),(0,Q.jsx)("span",{children:e})]},e)))})})}function Ge(e){return`ai-inference-transcript-save-to-dataset-${e}`}function He(e){const{step:t,compressionThreshold:n}=e,{inputTokens:r,outputTokens:s,cachedTokensRead:a,cachedTokensCreated:o}=t,l=(0,i().IS)((()=>({container:{display:"flex",flexDirection:"column",gap:4,fontSize:12,fontFamily:"monospace"},progressContainer:{display:"flex",alignItems:"center",gap:8},progressBar:{flexGrow:1,minWidth:100},label:{color:B().Tj.text.secondary,minWidth:120},metrics:{display:"flex",gap:12,marginTop:2,fontSize:11,color:B().Tj.text.tertiary},metric:{display:"flex",alignItems:"center",gap:4},colorBox:{width:8,height:8,borderRadius:2}})),[]),d=a??0,c=o??0,p=Math.max(0,(r??0)-d),u=d+p+c+(s??0),g=t.maxInputTokens??t.maxContextTokens??272e3,m=(0,i().IS)((()=>({progressContainer:{width:"100%",height:6,backgroundColor:B().Tj.border.secondary,borderRadius:3,overflow:"visible",display:"flex",position:"relative"},segment:{height:"100%",transition:"width 0.3s ease"},thresholdLine:{position:"absolute",top:-2,width:1,height:10,backgroundColor:B().Tj.text.secondary,zIndex:1,pointerEvents:"none"}})),[]);if(0===u)return null;const x=Math.min(u/g*100,100),f=e=>void 0===e||0===e?"0":e.toLocaleString(),y=[`Total input tokens: ${f(r)}`,d>0?`  • Cached read: ${f(d)}`:null,p>0?`  • Uncached read: ${f(p)}`:null,`Output tokens: ${f(s)}`,o?`Cached tokens created: ${f(o)}`:null,void 0!==n?`Compression threshold: ${f(Math.round(n*g))} (${Math.round(100*n)}%)`:null,`Total: ${f(u)} / ${f(g)} (${Math.round(x)}%)`].filter(Boolean).join("\n"),v=p/g*100,j=d/g*100,b=(s??0)/g*100,T=(o??0)/g*100,C=void 0!==n?100*n:void 0;return(0,Q.jsxs)("div",{style:l.container,children:[(0,Q.jsxs)("div",{style:l.progressContainer,children:[(0,Q.jsx)("span",{style:l.label,children:"Token Usage:"}),(0,Q.jsx)("div",{style:l.progressBar,children:(0,Q.jsx)(h().m,{renderTooltip:()=>(0,Q.jsx)("div",{style:{whiteSpace:"pre-line"},children:y}),placement:"top",render:e=>(0,Q.jsxs)("div",{...e,style:m.progressContainer,children:[p>0?(0,Q.jsx)("div",{style:{...m.segment,width:`${Math.max(.5,v)}%`,backgroundColor:"#3498db"},title:`Uncached read tokens: ${f(p)}`}):void 0,d>0?(0,Q.jsx)("div",{style:{...m.segment,width:`${Math.max(.5,j)}%`,backgroundColor:"#9b59b6"},title:`Cached read tokens: ${f(d)}`}):void 0,void 0!==s&&s>0?(0,Q.jsx)("div",{style:{...m.segment,width:`${Math.max(.5,b)}%`,backgroundColor:"#e67e22"},title:`Output tokens: ${f(s)}`}):void 0,void 0!==o&&o>0?(0,Q.jsx)("div",{style:{...m.segment,width:`${Math.max(.5,T)}%`,backgroundColor:"#1abc9c"},title:`Cached tokens created: ${f(o)}`}):void 0,void 0!==C?(0,Q.jsx)("div",{style:{...m.thresholdLine,insetInlineStart:`${C}%`},title:`Compression threshold: ${Math.round(100*n)}%`}):void 0]})})}),(0,Q.jsxs)("span",{style:l.label,children:[f(u)," / ",f(g)," (",Math.round(x),"%)"]})]}),(0,Q.jsxs)("div",{style:l.metrics,children:[p>0?(0,Q.jsx)(h().m,{renderTooltip:()=>`Uncached read tokens: ${f(p)}`,placement:"top",render:e=>(0,Q.jsxs)("div",{...e,style:l.metric,children:[(0,Q.jsx)("div",{style:{...l.colorBox,backgroundColor:"#3498db"}}),(0,Q.jsxs)("span",{children:["Uncached Read: ",f(p)]})]})}):void 0,d>0?(0,Q.jsx)(h().m,{renderTooltip:()=>`Cached read tokens: ${f(d)}`,placement:"top",render:e=>(0,Q.jsxs)("div",{...e,style:l.metric,children:[(0,Q.jsx)("div",{style:{...l.colorBox,backgroundColor:"#9b59b6"}}),(0,Q.jsxs)("span",{children:["Cached Read: ",f(d)]})]})}):void 0,void 0!==s&&s>0?(0,Q.jsx)(h().m,{renderTooltip:()=>`Output tokens: ${f(s)}`,placement:"top",render:e=>(0,Q.jsxs)("div",{...e,style:l.metric,children:[(0,Q.jsx)("div",{style:{...l.colorBox,backgroundColor:"#e67e22"}}),(0,Q.jsxs)("span",{children:["Output: ",f(s)]})]})}):void 0,void 0!==o&&o>0?(0,Q.jsx)(h().m,{renderTooltip:()=>`Cached tokens created: ${f(o)}`,placement:"top",render:e=>(0,Q.jsxs)("div",{...e,style:l.metric,children:[(0,Q.jsx)("div",{style:{...l.colorBox,backgroundColor:"#1abc9c"}}),(0,Q.jsxs)("span",{children:["Cached Created: ",f(o)]})]})}):void 0]})]})}function Xe(e){const{clientStore:t,threadStore:n}=e,s=(0,i().IS)((()=>({topBar:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:8,fontSize:14},inferencesWrap:{display:"flex",flexDirection:"column",gap:12,fontSize:14},header:{fontSize:14}})),[]),a=(0,o().K8)((()=>null==n?void 0:n.id),[n]),d=(0,o().K8)((()=>a?t.getOrCreateClientAIChatThreadStore(a).state.inferences.length:0),[t,a]),c=(0,o().K8)((()=>Boolean(a&&t.getOrCreateClientAIChatThreadStore(a).state.loading||void 0!==(null==n?void 0:n.getCurrentInferenceId()))),[t,n,a]),p=(0,o().K8)((()=>a?t.getOrCreateClientAIChatThreadStore(a).state.inferences:[]),[t,a]),u=(0,o().K8)((()=>a?t.getOrCreateClientAIChatThreadStore(a).state.requestInfo:void 0),[t,a]),m=(0,r.useCallback)((()=>{if(!a)return;const e=t.getOrCreateClientAIChatThreadStore(a),{acceptedInferenceKeys:n}=e.state;n.length>0?e.setState({...e.state,acceptedInferenceKeys:[]}):e.setState({...e.state,acceptedInferenceKeys:e.state.inferences.map((e=>e.key))})}),[t,a]),h=(0,o().K8)((()=>t.state.configForNewTranscripts),[t]),f=(0,o().K8)((()=>t.state.debugOverrides),[t]),y=(0,o().K8)((()=>t.state.model),[t]),v=(0,r.useCallback)((e=>{t.setState({...t.state,model:e})}),[t]),j=(0,o().K8)((()=>(0,J().av)(n)),[n]);return(0,Q.jsxs)(l().Y1,{direction:"vertical",height:"fill",width:"fill",style:{pointerEvents:"auto"},children:[(0,Q.jsxs)(l().Y1,{direction:"horizontal",gap:8,padding:"8px 12px",height:46,align:"center",children:[c?(0,Q.jsx)(g().k,{}):void 0,!j&&n?(0,Q.jsx)(rt,{clientStore:t,threadStore:n},n.id):void 0,(0,Q.jsx)("div",{style:{flexGrow:1}}),(0,Q.jsx)(Be,{model:y,setModel:v,format:"badge"}),(0,Q.jsx)(be,{clientStore:t})]}),(0,Q.jsxs)(l().Y1,{direction:"vertical",gap:16,padding:"8px 12px",height:"fill",style:{overflowY:"auto"},children:[u?(0,Q.jsx)(Ye,{requestInfo:u,clientStore:t,threadStore:n}):void 0,u&&at(u)&&ot(u)?(0,Q.jsx)(lt,{requestInfo:u,clientStore:t,threadStore:n}):void 0,j&&h?(0,Q.jsx)("div",{style:{display:"flex",flexDirection:"column",gap:12},children:(0,Q.jsx)(st,{debugOverrides:f,clientStore:t,configType:h.type})}):void 0,(0,Q.jsx)(nt,{inferences:p,requestInfo:u,model:y,debugOverrides:f}),(0,Q.jsxs)("div",{style:s.inferencesWrap,children:[p.length>0?(0,Q.jsxs)("div",{style:s.topBar,children:[(0,Q.jsx)("div",{style:s.header,children:"Inferences"}),(0,Q.jsx)("div",{style:{flexGrow:1}}),d>0?(0,Q.jsx)("div",{children:`${d} inference${1===d?"":"s"}`}):void 0,!c&&d>0?(0,Q.jsx)(x().p,{onClick:m,children:"Toggle all"}):void 0]}):void 0,p.map(((e,r)=>(0,Q.jsx)(Ze,{inference:e,clientStore:t,threadStore:n},`${e.key}-${r}`)))]})]})]})}function Ye(e){var t;const{requestInfo:n,clientStore:s,threadStore:a}=e,l=(0,o().K8)((()=>null==a?void 0:a.id),[a]),d=(0,i().IS)((()=>({wrap:{display:"flex",flexDirection:"column",gap:4,padding:"4px 2px",border:`1px solid ${B().Tj.border.secondaryTranslucent}`,borderRadius:8,whiteSpace:"pre-wrap",fontSize:14},header:{display:"flex",gap:4,alignItems:"center",padding:"0 6px"},toggle:{border:"none",padding:0,margin:0}})),[]),{request:c,response:u,memories:g}=n,m=c.transcript.find((e=>"config"===e.type)),x=(0,r.useCallback)((()=>{if(!u)throw new Error("Response is required");if(!l)return;const e=s.getOrCreateClientAIChatThreadStore(l);e.setState({...e.state,requestInfo:{...n,memories:[{...b().s8,originalOutput:u}]}})}),[s,n,u,l]),f=(0,r.useCallback)((e=>{if(!l)return;const t=s.getOrCreateClientAIChatThreadStore(l);t.setState({...t.state,requestInfo:{...n,memories:e}})}),[s,n,l]),y=(0,r.useCallback)((e=>{if(!l)return;const t=s.getOrCreateClientAIChatThreadStore(l);t.setState({...t.state,requestInfo:{...n,expectedAgentTools:e}})}),[s,n,l]),v=(0,r.useCallback)((e=>{var t,n,r;if(!l)return;const a=s.getOrCreateClientAIChatThreadStore(l),o=(null===(t=e.metadata)||void 0===t?void 0:t.memories)||[],i=null===(n=e.metadata)||void 0===n?void 0:n.expectedAgentTools;e.input.type===C().uF&&a.setState({...a.state,requestInfo:{request:e.input,response:e.expected,memories:o,expectedAgentTools:i,availableToolNames:null===(r=e.metadata)||void 0===r?void 0:r.tools}})}),[s,l]),j=(0,r.useCallback)((()=>{if(!l)return;const e=s.getOrCreateClientAIChatThreadStore(l);e.setState({...e.state,requestInfo:{...n,expectedAgentTools:{expect:[{toolType:"search",minTimes:void 0,maxTimes:void 0,description:""}]}}})}),[s,n,l]),T=(0,o().K8)((()=>function(e){if(!e)return;const t=e.getMessageStores(),n=t.map((e=>e.getStep())).filter((e=>"eval-result"===(null==e?void 0:e.type)));if(0===n.length)return;const r=n[n.length-1],s=null==r?void 0:r.braintrustInfo;if(null==s||!s.project||null==s||!s.dataset||null==s||!s.originalInferenceId)return;return{project:s.project,dataset:s.dataset,exampleId:s.originalInferenceId}}(a)),[a]),k=(0,r.useMemo)((()=>({id:(null==T?void 0:T.exampleId)||c.traceId,input:{type:C().uF,...c},expected:u,metadata:{memories:g.map((({originalOutput:e,...t})=>t)),...n.expectedAgentTools&&{expectedAgentTools:n.expectedAgentTools}}})),[c,u,g,T,n.expectedAgentTools]),S=(0,r.useMemo)((()=>{if(!n.response)return;return{type:"inferenceTranscript",request:n.request,response:n.response}}),[n]),I=(0,$().tz)();return(0,Q.jsxs)("div",{style:d.wrap,children:[(0,Q.jsxs)("div",{style:d.header,children:[(0,Q.jsxs)("span",{style:{flexGrow:1},children:["Request",T?(0,Q.jsx)("a",{href:`https://www.braintrust.dev/app/Notion/p/${T.project}/datasets/${T.dataset}?r=${T.exampleId}`,target:"_blank",rel:"noopener noreferrer",style:{marginInlineStart:8,fontSize:12,color:"inherit"},children:"View in Braintrust"}):void 0]}),0===g.length?(0,Q.jsxs)(Q.Fragment,{children:[(0,Q.jsx)(h().m,{renderTooltip:()=>"Add memory for this inference",placement:"top",render:e=>(0,Q.jsx)("div",{...e,children:(0,Q.jsx)(p().A,{icon:O().plusSmallIcon,onClick:x,ariaLabel:I.formatMessage({defaultMessage:"Add memory",id:"aiInferenceTranscript.debug.addMemory"})})})}),(0,Q.jsx)(it,{onLoadExample:v,datasetInfo:T})]}):void 0,n.expectedAgentTools&&n.expectedAgentTools.expect&&0!==n.expectedAgentTools.expect.length?void 0:(0,Q.jsx)(h().m,{renderTooltip:()=>"Add agent tool expectations",placement:"top",render:e=>(0,Q.jsx)("div",{...e,children:(0,Q.jsx)(p().A,{icon:w().P,onClick:j,ariaLabel:I.formatMessage({defaultMessage:"Add agent tool expectations",id:"aiInferenceTranscript.debug.addAgentToolExpectations"})})})}),k?(0,Q.jsx)(Ve,{inference:k,scopeKey:`inferenceTranscript-${null==m?void 0:m.value.type}`}):void 0]}),(0,Q.jsx)(W().b,{label:"Input",style:d.toggle,children:(0,Q.jsx)(E().X,{language:"json",value:JSON.stringify(n.request,null,2)})}),n.response?(0,Q.jsx)(W().b,{label:"Output",style:d.toggle,children:(0,Q.jsx)(E().X,{value:JSON.stringify(n.response,null,2),language:"json"})}):null,S&&g.length>0?(0,Q.jsx)(Oe,{request:S,memories:g,onChange:f,clientStore:s}):void 0,n.expectedAgentTools&&n.expectedAgentTools.expect&&n.expectedAgentTools.expect.length>0?(0,Q.jsx)(Z,{expectations:n.expectedAgentTools,onChange:y,transcript:[...n.request.transcript,...(null===(t=n.response)||void 0===t?void 0:t.transcript)??[]]}):void 0]})}function Qe(e){const{inference:t,clientStore:s,threadStore:l}=e,d=t.key,u=(0,a().v3)(),g=(0,o().K8)((()=>null==l?void 0:l.id),[l]),m=(0,i().IS)((()=>({wrap:{display:"flex",flexDirection:"column",gap:4,padding:"4px 2px",border:`1px solid ${B().Tj.border.secondaryTranslucent}`,borderRadius:8,whiteSpace:"pre-wrap",fontSize:14},header:{padding:"0 6px",display:"flex",gap:4,alignItems:"center"},annotation:{padding:"0 6px"},toggle:{border:"none",padding:0,margin:0},typeLabel:{flexGrow:1,marginInlineStart:4,fontSize:12,fontFamily:"monospace"}})),[]),x=(0,o().K8)((()=>g?s.getOrCreateClientAIChatThreadStore(g).state.inferenceKeysToAnnotations[d]:void 0),[s,d,g]),f=(0,r.useCallback)((e=>{if(!g)return;const t=s.getOrCreateClientAIChatThreadStore(g),n=e.target.value,r={...t.state.inferenceKeysToAnnotations,[d]:n};t.setState({...t.state,inferenceKeysToAnnotations:r})}),[s,d,g]),y=(0,o().K8)((()=>{if(!g)return!1;const{acceptedInferenceKeys:e}=s.getOrCreateClientAIChatThreadStore(g).state;return e.includes(d)}),[s,d,g]),v=(0,r.useCallback)((e=>{if(!g)return;const t=s.getOrCreateClientAIChatThreadStore(g),{acceptedInferenceKeys:n,inferences:r}=t.state,a=e.shiftKey;if(n.includes(d))if(a){const e=r.findIndex((e=>e.key===d)),s=r.slice(0,e+1).map((e=>e.key));t.setState({...t.state,acceptedInferenceKeys:D().sb(n.filter((e=>!s.includes(e))))})}else t.setState({...t.state,acceptedInferenceKeys:n.filter((e=>e!==d))});else if(a){const e=r.findIndex((e=>e.key===d)),s=r.slice(0,e+1).map((e=>e.key)),a=D().sb([...n,...s]);t.setState({...t.state,acceptedInferenceKeys:a})}else t.setState({...t.state,acceptedInferenceKeys:D().sb([...n,d])})}),[s,d,g]),j=(0,r.useMemo)((()=>{const e=null==t?void 0:t.value.expected;if(!e)return"";if("string"!=typeof e)return JSON.stringify(e,null,2);try{return e.trim().startsWith("{")?JSON.stringify(JSON.parse(e),null,2):e}catch(n){return e}}),[t]),T=(0,o().K8)((()=>{if(g)return s.getOrCreateClientAIChatThreadStore(g).state.inferenceKeysToMemories[d]}),[s,d,g]),C=(0,r.useMemo)((()=>({type:"inference",inference:t.value})),[t]),k=(0,r.useCallback)((async()=>{g&&await(0,q().Ou)({environment:u,clientStore:s,inference:t,threadId:g})}),[s,u,t,g]),S=(0,r.useCallback)((e=>{if(!g)return;const t=s.getOrCreateClientAIChatThreadStore(g);t.setState({...t.state,inferenceKeysToMemories:{...t.state.inferenceKeysToMemories,[d]:e[0]}})}),[s,d,g]),I=(0,r.useCallback)((()=>{if(!g)return;if(!t.value.expected)throw new Error("Expected output is required");const e=s.getOrCreateClientAIChatThreadStore(g);e.setState({...e.state,inferenceKeysToMemories:{...e.state.inferenceKeysToMemories,[d]:{...b().s8,originalOutput:t.value.expected}}})}),[s,d,t,g]),w=(0,r.useMemo)((()=>({...t.value,metadata:{...t.value.metadata,memories:D().oE([T])}})),[t,T]),M=(0,$().tz)();return t?(0,Q.jsxs)("div",{style:m.wrap,children:[(0,Q.jsxs)("div",{style:m.header,children:[(0,Q.jsx)(h().m,{renderTooltip:()=>(0,Q.jsx)("div",{style:{width:300,whiteSpace:"normal"},children:"Checking this will 'freeze' this inference. When the request is retried, instead of running the inference again, the original output will be used."}),placement:"top",render:e=>(0,Q.jsx)("div",{...e,children:(0,Q.jsx)(c().S,{checked:y,size:14,onClick:v})})}),(0,Q.jsx)(Ie,{inference:t.value,trigger:(0,Q.jsx)("span",{style:{...m.typeLabel,cursor:"pointer",textDecoration:"underline",textDecorationStyle:"dotted"},children:et(t.value.input)})}),(0,Q.jsx)(h().m,{renderTooltip:()=>"Retry inference",placement:"top",render:e=>(0,Q.jsx)("div",{...e,children:(0,Q.jsx)(p().A,{icon:n(499872).b,onClick:k,ariaLabel:M.formatMessage({defaultMessage:"Retry",id:"aiInferenceTranscript.debug.retry"})})})}),(0,Q.jsx)(de,{inference:t.value}),T?void 0:(0,Q.jsx)(h().m,{renderTooltip:()=>"Add memory for this inference",placement:"top",render:e=>(0,Q.jsx)("div",{...e,children:(0,Q.jsx)(p().A,{icon:O().plusSmallIcon,onClick:I,ariaLabel:M.formatMessage({defaultMessage:"Add memory",id:"aiInferenceTranscript.debug.addMemory"})})})}),(0,Q.jsx)(Ve,{inference:w,scopeKey:`inference-${t.value.input.type}`,defaultState:{project:void 0,dataset:t.value.input.type,tags:[]}})]}),(0,Q.jsx)(tt,{input:t.value.input}),(0,Q.jsx)(h().m,{renderTooltip:()=>(0,Q.jsx)("div",{style:{width:300,whiteSpace:"normal"},children:"The text you type here is passed as 'context.annotation' when this inference is retried. Typically, this is rendered as a final user step in the prompt used to 'nudge' the model."}),placement:"right",render:e=>(0,Q.jsx)("div",{...e,style:m.annotation,children:(0,Q.jsx)(Ae,{value:x,placeholder:"Set annotation",onChange:f,textarea:!0,autosize:!0})})}),(0,Q.jsx)(W().b,{label:"Input",style:m.toggle,children:(0,Q.jsx)(E().X,{disabled:!0,language:"json",value:JSON.stringify({...t.value.input,examples:void 0},null,2)})}),t.value.expected?(0,Q.jsx)(W().b,{label:"Output",style:m.toggle,children:(0,Q.jsx)(E().X,{disabled:!0,value:j,language:"json"})}):null,t.value.metadata?(0,Q.jsx)(W().b,{label:"Metadata",style:m.toggle,children:(0,Q.jsx)(E().X,{disabled:!0,value:JSON.stringify(t.value.metadata,null,2),language:"json"})}):null,T?(0,Q.jsx)(Oe,{request:C,memories:[T],onChange:S,clientStore:s}):void 0]}):null}const Ze=r.memo(Qe);function et(e){let t=e.type;"fileName"in e&&(t+=` – ${e.fileName}`),"testName"in e&&(t+=` – ${e.testName}`),"functionKey"in e&&(t+=` – ${e.functionKey}`),"key"in e&&(t+=` – ${e.key}`);const n=["retries","validationRetries"];for(const r of n)if(r in e&&e[r].length>0){t+=` (${e[r].filter((e=>"assistant"!==e.type)).length} error steps)`}return t}function tt(e){const{input:t}=e,n="transcript"in t&&Array.isArray(t.transcript)?t.transcript:void 0,s=(0,r.useMemo)((()=>D().oE(null==n?void 0:n.map((e=>"agent-tool-result"===e.type?e.toolName:void 0)))),[n]),a=(0,i().IS)((()=>({container:{fontSize:12,color:B().Tj.text.secondary,paddingTop:0,paddingInlineEnd:6,paddingBottom:4,paddingInlineStart:6}})),[]);return 0===s.length?null:(0,Q.jsxs)("div",{style:a.container,children:["Tools: ",s.join(", ")]})}function nt(e){const{inferences:t,requestInfo:n,debugOverrides:a}=e,l=(0,r.useMemo)((()=>{var e;let r,s=0;for(const n of t){const e=n.value.input;if("transcript"in e&&Array.isArray(e.transcript))for(const t of e.transcript)if("agent-inference"===t.type){const e=t.startedAt||0;e>s&&(s=e,r=t)}}if(null!=n&&null!==(e=n.response)&&void 0!==e&&e.transcript)for(const t of n.response.transcript)if("agent-inference"===t.type){const e=t.startedAt||0;e>s&&(s=e,r=t)}return r}),[t,n]),d=(0,o().K8)((()=>{var e;const t=null===(e=a.contextManagementConfiguration)||void 0===e?void 0:e.summarizeTokenThreshold;return void 0!==t?Math.min(1,Math.max(0,t)):s().default.getConfigKey("ai_agent_progressive_transcript_compression_threshold","threshold")}),[a.contextManagementConfiguration]),c=(0,i().IS)((()=>({container:{padding:"8px 12px",borderBottom:`1px solid ${B().Tj.border.secondaryTranslucent}`,marginBottom:8}})),[]);if(!l)return null;return void 0!==l.inputTokens||void 0!==l.outputTokens||void 0!==l.cachedTokensRead||void 0!==l.cachedTokensCreated||void 0!==l.maxContextTokens||void 0!==l.maxInputTokens?(0,Q.jsx)("div",{style:c.container,children:(0,Q.jsx)(He,{step:l,compressionThreshold:d})}):null}function rt(e){const t=(0,$().tz)(),{clientStore:n,threadStore:s}=e,l=(0,o().K8)((()=>null==s?void 0:s.id),[s]),c=(0,a().v3)(),u=(0,i().IS)((()=>({button:{fontSize:14}})),[]),g=(0,o().K8)((()=>s.getSpaceId()),[s]),b=(0,o().K8)((()=>{const e=s.getMessageStores().map((e=>{const t=e.getStep();if(t&&"config"===t.type)return t.value.type}));return D().oE(e)[0]}),[s]),[{value:C},S]=(0,k().Yb)((async()=>{if(!g||!b)return;const e=(0,T().W)({environmentName:"production",suffix:b});return await F().callApi({eventName:"getBraintrustLogsForThread",environment:c,data:{project:e,threadId:s.id,spaceId:g}})}),[c,g,s,b]),w=(0,r.useMemo)((()=>{if(!C||"failed"===C.type)return;const e=C.data.logs,t=[],n=new Map;for(const r of e)if(r.span_id===r.root_span_id)t.push(r);else if(r.root_span_id){const e=n.get(r.root_span_id)||[];e.push(r),n.set(r.root_span_id,e)}for(const r of n.values())r.sort(((e,t)=>{var n,r;return((null===(n=e.metadata)||void 0===n?void 0:n.index)||0)-((null===(r=t.metadata)||void 0===r?void 0:r.index)||0)}));return t.sort(((e,t)=>{const n=new Date(e.created||"");return new Date(t.created||"").getTime()-n.getTime()})),{rootSpans:t,subSpanGroups:n}}),[C]),M=(0,r.useCallback)((e=>{if(!e.span_id)return;if(!l)return;const t=(null==w?void 0:w.subSpanGroups.get(e.span_id))||[],r=n.getOrCreateClientAIChatThreadStore(l);r.setState({...r.state,requestInfo:{request:e.input,response:e.output,memories:[]},inferences:D().oE(t.map(((e,t)=>{var n,r;let s;return s="number"==typeof(null===(n=e.metadata)||void 0===n?void 0:n.index)?e.metadata.index:"number"==typeof(null===(r=e.metadata)||void 0===r||null===(r=r.extraLogMetadata)||void 0===r?void 0:r.index)?e.metadata.extraLogMetadata.index:t,{type:"inference",key:(0,z().$A)(e.input),index:s,value:{id:e.id,input:e.input,expected:e.output,metadata:e.metadata}}})))})}),[n,w,l]),O=(0,r.useCallback)((()=>{var e;if(!l)return;const t=null===(e=n.getOrCreateClientAIChatThreadStore(l).state.requestInfo)||void 0===e||null===(e=e.request)||void 0===e?void 0:e.traceId;if(!b||!t)return;const r=(0,T().W)({environmentName:"production",suffix:b});window.open(`https://www.braintrust.dev/app/Notion/p/${r}/logs?r=${t}`,"_blank")}),[n,b,l]),R=(0,r.useCallback)((()=>{if(!l)return;const e=(0,T().W)({environmentName:"production",suffix:b}),t={search:JSON.stringify({filter:[{label:`input.threadId = '${l}' OR metadata.aiSessionId = '${l}'`,text:`input.threadId = '${l}' OR metadata.aiSessionId = '${l}'`,originType:"btql"}]}),tvt:"timeline",range:'"1h"'},n=new URLSearchParams(t).toString();window.open(`https://www.braintrust.dev/app/Notion/p/${e}/logs?${n}`,"_blank")}),[b,l]),B=(0,r.useCallback)((()=>{var e;if(!l)return;const t=null===(e=n.getOrCreateClientAIChatThreadStore(l).state.requestInfo)||void 0===e||null===(e=e.request)||void 0===e?void 0:e.traceId;if(!t)return;const r={time_range:1800,granularity:0,breakdowns:[],calculations:[{op:"COUNT"}],filters:[{column:"aiTraceId",op:"=",value:t}],filter_combination:"AND",orders:[]},s=`https://ui.honeycomb.io/notion/environments/production?query=${encodeURIComponent(JSON.stringify(r))}`;window.open(s,"_blank")}),[n,l]);return(0,Q.jsx)(d().A,{popupType:d().z.Popup,placementToOrigin:"bottom",alignmentToOrigin:"start",renderOrigin:e=>(0,Q.jsxs)(Q.Fragment,{children:[(0,Q.jsx)(x().p,{...e,style:u.button,children:"failed"===(null==C?void 0:C.type)?"Failed to load logs":w?`View logs (${w.rootSpans.length})`:"Loading logs"}),(0,Q.jsx)(h().m,{renderTooltip:()=>(0,Q.jsx)("span",{children:"Open Trace in Braintrust"}),render:e=>(0,Q.jsx)(p().A,{...e,icon:N().b,ariaLabel:t.formatMessage({id:"aiInferenceTranscript.openTraceInBraintrust",defaultMessage:"Open Trace in Braintrust"}),onClick:O})}),(0,Q.jsx)(h().m,{renderTooltip:()=>(0,Q.jsx)("span",{children:"Open Thread in Braintrust"}),render:e=>(0,Q.jsx)(p().A,{...e,icon:I().chatSmallIcon,ariaLabel:t.formatMessage({id:"aiInferenceTranscript.openThreadInBraintrust",defaultMessage:"Open Thread in Braintrust"}),onClick:R})}),(0,Q.jsx)(h().m,{renderTooltip:()=>(0,Q.jsx)("span",{children:"Open in Honeycomb"}),render:e=>(0,Q.jsx)(p().A,{...e,icon:A().linkSmallIcon,ariaLabel:t.formatMessage({id:"aiInferenceTranscript.openInHoneycomb",defaultMessage:"Open in Honeycomb"}),onClick:B})})]}),render:e=>(0,Q.jsx)(f().A,{menuType:m().gu.Popup,children:(0,Q.jsx)(v().A,{type:v().O.Vertical,initialFocus:0,sections:[{key:"refresh",render:e=>(0,Q.jsx)(j().A,{...e}),items:[{key:"refresh",render:e=>(0,Q.jsx)(y().A,{...e,title:"Refresh"}),action:()=>{S()}}]},{key:"dates",render:e=>(0,Q.jsx)(j().A,{...e,shouldShowBottomDivider:!0}),items:((null==w?void 0:w.rootSpans)||[]).map((t=>({key:t.id,render:e=>(0,Q.jsx)(y().A,{...e,title:t.created||"No date"}),action:()=>{e.close(),M(t)}})))||[]}]})})})}function st(e){const{clientStore:t,configType:n,debugOverrides:s}=e,a=function(e){if("researcher"===e)return"researchModeDebugOptions"}(n),l=(0,o().K8)((()=>function(e){return"researcher"===e?b().vW:{}}(n)),[n]),[d,p]=(0,r.useState)((()=>JSON.stringify(s.contextManagementConfiguration??{},null,2))),g=(0,i().IS)((()=>({wrap:{margin:"12px 0",display:"flex",flexDirection:"column",gap:8},title:{fontSize:16,color:B().Tj.text.secondary,fontWeight:500},row:{display:"flex",alignItems:"center",gap:8,color:B().Tj.text.secondary,fontSize:12},input:{width:200,backgroundColor:B().Tj.background.primary,border:`1px solid ${B().Tj.border.secondaryTranslucent}`,fontSize:12,color:B().Tj.text.secondary}})),[]),m=(0,r.useCallback)((e=>{a&&t.setState({...t.state,debugOverrides:{...t.state.debugOverrides,[a]:{...t.state.debugOverrides[a]??{},...e}}})}),[t,a]);if(!a)return null;const x=s[a]??{},h=Object.entries(l).filter((([e,t])=>"type"!==e&&("boolean"==typeof t||"string"==typeof t||"number"==typeof t))).map((([e,t])=>[e,x[e]??t]));if(0===h.length)return null;const f=h.map((([e,t])=>((e,t)=>"boolean"==typeof t?(0,Q.jsxs)("div",{style:g.row,children:[(0,Q.jsx)("span",{children:e}),(0,Q.jsx)(c().S,{checked:t,onClick:()=>m({[e]:!t}),size:12})]},e):"string"==typeof t?(0,Q.jsxs)("div",{style:g.row,children:[(0,Q.jsx)("span",{children:e}),(0,Q.jsx)(u().A,{value:t.toString(),onChange:t=>{m({[e]:t.target.value})},style:{width:200}})]},e):"number"==typeof t?(0,Q.jsxs)("div",{style:g.row,children:[(0,Q.jsx)("span",{children:e}),(0,Q.jsx)(u().A,{type:"number",value:t.toString(),onChange:t=>{m({[e]:Number(t.target.value)})},style:{...g.input,width:65}})]},e):null)(e,t)));return f.push((0,Q.jsxs)("div",{style:{display:"flex",flexDirection:"column",gap:4},children:[(0,Q.jsx)("span",{style:{color:B().Tj.text.secondary,fontSize:12},children:"contextManagementConfiguration (JSON)"}),(0,Q.jsx)("textarea",{rows:4,value:d,onChange:e=>{const n=e.target.value;p(n);try{const e=ve(JSON.parse(n));if(!e)return;t.setState({...t.state,debugOverrides:{...t.state.debugOverrides,contextManagementConfiguration:e}})}catch{}},style:{width:260,fontFamily:"monospace",fontSize:11}})]},"contextManagementConfiguration")),f.length>0?(0,Q.jsxs)("div",{style:g.wrap,children:[(0,Q.jsx)("div",{style:g.title,children:"Debug overrides"}),(0,Q.jsx)("div",{style:{display:"flex",flexWrap:"wrap",gap:16},children:f})]}):null}function at(e){var t;return(0,P().O9)(null==e||null===(t=e.request)||void 0===t||null===(t=t.debugOverrides)||void 0===t?void 0:t.evalMode)}function ot(e){var t;return[...e.request.transcript,...(null===(t=e.response)||void 0===t?void 0:t.transcript)??[]].filter((e=>"agent-tool-result"===e.type&&void 0!==e.threadOperations)).reduce(((e,t)=>{var n;return e+((null===(n=t.threadOperations)||void 0===n?void 0:n.length)??0)}),0)>0}function it(e){const{onLoadExample:t,datasetInfo:n}=e,s=(0,$().tz)(),o=(0,a().v3)(),[l,c]=(0,r.useState)(""),[u,m]=(0,r.useState)(""),[f,y]=(0,r.useState)(""),[v,j]=(0,r.useState)(!1),[b,T]=(0,r.useState)(!1);r.useEffect((()=>{n&&!b&&(n.project&&c(n.project),n.dataset&&m(n.dataset),n.exampleId&&y(n.exampleId),T(!0))}),[n,b]);const C=(0,i().IS)((()=>({form:{display:"flex",flexDirection:"column",gap:8,padding:12,minWidth:300},row:{display:"flex",flexDirection:"column",gap:4},label:{fontSize:12,fontWeight:500,color:B().Tj.text.secondary},input:{fontSize:12,padding:6},buttons:{display:"flex",gap:8,justifyContent:"flex-end",marginTop:8}})),[]),k=(0,r.useCallback)((async e=>{if(l.trim()&&u.trim()&&f.trim()){j(!0);try{const n=await F().callStreamApi({eventName:"getBraintrustDataset",environment:o,data:{project:l.trim(),dataset:u.trim()}});if("success"!==n.type)throw new Error("Failed to get dataset stream");let r=null;if(L().hS.is(n.data))for await(const e of n.data){const{inference:t}=e;if(t.id===f.trim()){r=t;break}}if(!r)return void window.alert(`Example ${f} not found in ${l}/${u}`);t(r),e()}catch(n){window.alert("Failed to load example from Braintrust")}finally{j(!1)}}}),[l,u,f,t,o]);return(0,Q.jsx)(d().A,{popupType:d().z.Popup,placementToOrigin:"bottom",alignmentToOrigin:"end",renderOrigin:e=>(0,Q.jsx)(h().m,{renderTooltip:()=>"Load memories and tool expectations from Braintrust example",placement:"top",render:t=>(0,Q.jsx)("div",{...t,children:(0,Q.jsx)(p().A,{...e,icon:S().arrowInCircleDownIcon,ariaLabel:s.formatMessage({defaultMessage:"Load from Braintrust",id:"aiInferenceTranscript.debug.loadFromBraintrust"})})})}),render:e=>(0,Q.jsxs)("div",{style:C.form,children:[(0,Q.jsxs)("div",{style:C.row,children:[(0,Q.jsx)("div",{style:C.label,children:"Project"}),(0,Q.jsx)(Ae,{value:l,onChange:e=>c(e.target.value),placeholder:"Enter Braintrust project name",style:C.input})]}),(0,Q.jsxs)("div",{style:C.row,children:[(0,Q.jsx)("div",{style:C.label,children:"Dataset"}),(0,Q.jsx)(Ae,{value:u,onChange:e=>m(e.target.value),placeholder:"Enter Braintrust dataset name",style:C.input})]}),(0,Q.jsxs)("div",{style:C.row,children:[(0,Q.jsx)("div",{style:C.label,children:"Example ID"}),(0,Q.jsx)(Ae,{value:f,onChange:e=>y(e.target.value),placeholder:"Enter Braintrust example ID",style:C.input})]}),(0,Q.jsxs)("div",{style:C.buttons,children:[(0,Q.jsx)(x().p,{onClick:()=>e.close(),children:"Cancel"}),(0,Q.jsx)(x().p,{onClick:()=>{k(e.close)},disabled:v||!l.trim()||!u.trim()||!f.trim(),children:v?(0,Q.jsx)(g().k,{}):"Load from Braintrust"})]})]})})}function lt(e){const{requestInfo:t}=e,n=(0,a().v3)(),s=(0,$().tz)(),[o,l]=(0,r.useState)(!1),d=(0,i().IS)((()=>({wrap:{display:"flex",flexDirection:"column",gap:8,padding:"8px 12px",border:`1px solid ${B().Tj.border.secondaryTranslucent}`,borderRadius:8,backgroundColor:B().Tj.background.secondary},header:{display:"flex",alignItems:"center",gap:8,fontSize:14,fontWeight:500},buttons:{display:"flex",alignItems:"center",gap:8}})),[]),c=(0,r.useMemo)((()=>{var e;return[...t.request.transcript,...(null===(e=t.response)||void 0===e?void 0:e.transcript)??[]].filter((e=>"agent-tool-result"===e.type&&void 0!==e.threadOperations))}),[t]),u=c.length>0,g=(0,r.useCallback)((()=>{if(!u)return;const e=(0,V().getAgentPreviewWrapper)(n);e.enter({environment:n,steps:c,transactionActions:K(),applyOperation:(t,r)=>{(0,_().Hp)({environment:n,operation:r,recordCache:e.getInMemoryRecordCache(),transaction:t})}}),l(!0)}),[u,n,c]),m=(0,r.useCallback)((()=>{if(!o)return;(0,V().getAgentPreviewWrapper)(n).exit(n),l(!1)}),[o,n]);if(!u)return null;const f=c.reduce(((e,t)=>{var n;return e+((null===(n=t.threadOperations)||void 0===n?void 0:n.length)??0)}),0);return(0,Q.jsxs)("div",{style:d.wrap,children:[(0,Q.jsxs)("div",{style:d.header,children:[(0,Q.jsx)("span",{style:{flexGrow:1},children:`Preview transactions (${f} operations from ${c.length} steps)`}),(0,Q.jsx)("div",{style:d.buttons,children:o?(0,Q.jsx)(h().m,{renderTooltip:()=>"Cancel preview and return to normal view",placement:"top",render:e=>(0,Q.jsx)("div",{...e,children:(0,Q.jsxs)(x().p,{onClick:m,children:[(0,Q.jsx)(p().A,{icon:R().xMarkSmallIcon,ariaLabel:s.formatMessage({defaultMessage:"Cancel",id:"aiInferenceTranscript.debug.cancel"})}),"Cancel (Undo Preview)"]})})}):(0,Q.jsx)(h().m,{renderTooltip:()=>"Preview transcript transactions in the main view",placement:"top",render:e=>(0,Q.jsx)("div",{...e,children:(0,Q.jsxs)(x().p,{onClick:g,children:[(0,Q.jsx)(p().A,{icon:M().eyeFillSmallIcon,ariaLabel:s.formatMessage({defaultMessage:"Preview",id:"aiInferenceTranscript.debug.preview"})}),"Preview"]})})})})]}),o?(0,Q.jsx)("div",{style:{fontSize:12,opacity:.7},children:"Preview is active. The main view now shows how the workspace would look after applying these transactions."}):void 0]})}},449445:(e,t,n)=>{n.r(t),n.d(t,{arrowLineDownSmallIcon:()=>s,iconDefinition:()=>r});n(296540);const r={viewBox:"0 0 16 16",fittedViewBox:"2.97 2.12 10.06 11.76",svg:(0,n(474848).jsx)("path",{d:"M8 2.125a.625.625 0 0 0-.625.625v7.128L5.378 7.881a.625.625 0 1 0-.884.884l3.064 3.064c.244.244.64.244.884 0l3.065-3.064a.625.625 0 0 0-.884-.884L8.625 9.878V2.75A.625.625 0 0 0 8 2.125m-4.403 10.5a.625.625 0 1 0 0 1.25h8.806a.625.625 0 1 0 0-1.25z"})},s=(0,n(340498).wt)("arrowLineDownSmall",r,"small")},465505:(e,t,n)=>{n.d(t,{P:()=>s});n(296540);const r={viewBox:"0 0 20 20",fittedViewBox:"2.72 1.77 14.55 16.45",svg:(0,n(474848).jsx)("path",{d:"M10.302 1.853a.63.63 0 0 0-.604 0l-6.65 3.669c-.2.11-.323.32-.323.547v7.862c0 .228.124.437.323.547l6.65 3.67a.63.63 0 0 0 .604 0l6.65-3.67c.2-.11.323-.32.323-.547V6.069a.63.63 0 0 0-.323-.547zM3.975 7.127l5.4 2.98v6.434l-5.4-2.98zm6.65 9.414v-6.434l5.4-2.98v6.435zM15.356 6.07 10 9.024 4.644 6.069 10 3.114z"})},s=(0,n(340498).wt)("cube",r,"default")},499872:(e,t,n)=>{n.d(t,{b:()=>s});n(296540);const r={viewBox:"0 0 20 20",fittedViewBox:"4.75 3.52 11.53 12.95",svg:(0,n(474848).jsx)("path",{d:"m7.006 16.267 8.523-4.971a1.5 1.5 0 0 0 0-2.592L7.006 3.733A1.5 1.5 0 0 0 4.75 5.028v9.944a1.5 1.5 0 0 0 2.256 1.295"})},s=(0,n(340498).wt)("mediaPlayFill",r,"fill")}}]);