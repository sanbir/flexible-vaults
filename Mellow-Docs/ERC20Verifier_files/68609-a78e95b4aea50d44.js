"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[68609],{16197:(e,t,o)=>{o.d(t,{d:()=>v,o:()=>m});o(944114);var i=()=>o(973647),a=()=>o(534177),n=()=>o(422540),r=()=>o(898244),s=()=>o(239381),l=()=>o(791089),c=()=>o(322867),u=()=>o(881434),p=()=>o(648651),d=()=>o(352271);function m(e){const{collectionPointer:t,collectionSchema:o,config:i,context:c,actionType:d}=e;if(!o)return{validationFailures:[],validationWarnings:[]};const m=[],v=[];let f;for(const g of i.properties||[]){var y;const e={formulasModule:c.formulasModule,handleDataRequest:(0,s().zg)(c.getRecordModel),restrictUnaccessibleProperties:"cross_space_and_read_permissions",spaceId:c.automationModel.spaceId,valueTypes:c.valueTypes.slice(0),featureGates:(0,u().f)({checkExperimentGateFn:c.checkExperimentGate}),guaranteedPropertyIds:c.guaranteedPropertyIds,enableExistenceGuarantees:c.enableExistenceGuarantees},_=null===(y=i.values)||void 0===y?void 0:y[g],h=null==o?void 0:o[g];if("relation"===(null==h?void 0:h.type)&&(0,r().o2)(c.automationModel.spaceId,h)&&m.push({actionType:d,key:g,type:"cross_space_relation"}),!h||!(0,n().I3)(h)||null==_||!_.value)continue;const{result:x,hasCrossSpaceError:S,stats:I}=(0,l().typecheckSimpleFormulaOrFormula)({context:{...e,allowedReturnTypes:n().Yy[h.type]},value:_.value,collectionPointer:t});S&&m.push({actionType:d,key:g,type:"invalid_formula_cross_space"}),f=(0,p().AP)(f,I),(0,a().O9)(x.parseErrors)&&x.parseErrors.length>0&&m.push({actionType:d,key:g,type:"invalid_formula_parse_error"}),(0,a().O9)(x.typeErrors)&&x.typeErrors.length>0&&m.push({actionType:d,key:g,type:"invalid_formula_type_error",typeErrors:c.formulasModule.cleanFormulaTypecheckerErrors(x.typeErrors),shouldNotifyOnFailure:!0}),(0,a().O9)(x.typeWarnings)&&x.typeWarnings.length>0&&v.push({actionType:d,key:g,type:"invalid_formula_type_warning",typeErrors:c.formulasModule.cleanFormulaTypecheckerErrors(x.typeWarnings)}),(0,a().O9)(x.type)||m.push({actionType:d,key:g,type:"invalid_formula_missing_return_type"})}return{validationFailures:m,validationWarnings:v,formulaStats:f}}async function v(e){const{config:t,page:o,collectionPointer:a,collectionSchema:r,actionId:u,context:m,getCurrentPropertyValue:v}=e,{simpleFormulasModule:f}=m,y=[];let g;for(const h of t.properties||[]){var _;const e=null===(_=t.values)||void 0===_?void 0:_[h],x=null==r?void 0:r[h];if(!x||!(0,n().I3)(x))continue;const S=(0,l().setPropertyValueToFormulaReturnType)(a,h,x);if(!S)return{error:new(c().Dr)({actionId:u,property:h,collectionPointer:a})};const I=n().Yy[x.type],{result:b,stats:k}=await f.executeSimpleFormulaAsyncWithStats({value:(null==e?void 0:e.value)||{type:"simple",value:void 0},context:{...m,allowedValueTypes:I,returnType:S},executeFormula:m.executeContextualFormula});if(g=(0,p().AP)(g,k),i().Q.isFail(b))return{error:new(c().F_)({actionId:u,cause:(0,n().kH)(b.error),stats:g})};const F=(0,s().rk)({result:b.value,page:o,action:(0,d().tz)(e),currentPropertyValue:null==v?void 0:v(h),propertyId:h,propertySchema:x});F&&y.push(...F)}return{value:{values:y,stats:{formulaStats:g}}}}},300985:(e,t,o)=>{o.d(t,{Z:()=>a});o(296540);const i={viewBox:"0 0 20 20",fittedViewBox:"2.49 2.37 15.01 15.25",svg:(0,o(474848).jsx)("path",{d:"M7.154 3.625h1.23a.625.625 0 1 0 0-1.25h-1.23A2.625 2.625 0 0 0 4.529 5v2.069c0 .9-.508 1.722-1.313 2.124l-.317.159a.725.725 0 0 0 0 1.297l.317.158a2.38 2.38 0 0 1 1.313 2.124V15a2.625 2.625 0 0 0 2.625 2.625h1.23a.625.625 0 1 0 0-1.25h-1.23c-.76 0-1.375-.616-1.375-1.375v-2.069c0-1.17-.564-2.256-1.492-2.931a3.63 3.63 0 0 0 1.492-2.931V5c0-.76.615-1.375 1.375-1.375m5.692 12.75h-1.23a.625.625 0 1 0 0 1.25h1.23A2.625 2.625 0 0 0 15.471 15v-2.069c0-.9.508-1.722 1.313-2.124l.317-.159a.725.725 0 0 0 0-1.296l-.317-.159a2.38 2.38 0 0 1-1.313-2.124V5a2.625 2.625 0 0 0-2.625-2.625h-1.23a.625.625 0 1 0 0 1.25h1.23c.76 0 1.375.616 1.375 1.375v2.069c0 1.17.564 2.256 1.492 2.931a3.63 3.63 0 0 0-1.492 2.931V15c0 .76-.615 1.375-1.375 1.375"})},a=(0,o(340498).wt)("curlyBraces",i,"default")},368609:(e,t,o)=>{o.r(t),o.d(t,{getActionRegistryItem:()=>We,getActionRegistryItemsWithConcern:()=>Qe});o(581454);var i=()=>o(352271),a=(o(944114),o(898992),o(672577),o(803949),()=>o(973647)),n=()=>o(433337),r=()=>o(999515),s=()=>o(247331),l=()=>o(388821),c=()=>o(799829),u=()=>o(912720),p=()=>o(950914),d=()=>o(864779),m=()=>o(201980),v=()=>o(322867),f=(o(18107),o(517642),o(658004),o(733853),o(845876),o(432475),o(515024),o(731698),o(967357),o(354520),o(737550),()=>o(69708)),y=()=>o(534177),g=()=>o(700500),_=()=>o(641007),h=()=>o(206267),x=()=>o(792071),S=()=>o(134025),I=()=>o(179034);const b=(0,v().kB)((async function(e){const{completeSprintAction:t,completeSprintExecutionContext:o}=e,i=await async function(e){const{sprintCollectionSchema:t,sprintCollectionPointer:o}=e.sprintCollectionContext,{context:i,action:a}=e.automationContext,r=c().n$[n().av].current.reducer.getCombinatorFilter(t);return await T((()=>i.executeEffectMap.queryCollection({actionId:a.id,collection:o,userTimeZone:i.userTimeZone,filter:r,limit:1})),e)}(o);if(a().Q.isFail(i))return i;const r=i.value.blockIds.at(0);if(!(0,y().O9)(r))return{error:new(v().Zm)({actionId:o.automationContext.action.id})};const s=await async function(e){const{sprintCollectionSchema:t,sprintCollectionPointer:o}=e.sprintCollectionContext,{context:i,action:a}=e.automationContext,r=c().n$[n().av].next.reducer.getCombinatorFilter(t);return await T((()=>i.executeEffectMap.queryCollection({actionId:a.id,collection:o,userTimeZone:i.userTimeZone,filter:r,limit:1})),e)}(o);if(a().Q.isFail(s))return s;const l=s.value.blockIds[0],u=await Promise.all([k({currentSprintPageId:r,completeSprintExecutionContext:o}),F({currentSprintPageId:r,completeSprintExecutionContext:o})]);let d=u[0];const f=u[1],g=function(e){const{incompleteTasksResult:t,completeTasksResult:o}=e;if(a().Q.isFail(t)||a().Q.isFail(o))return;const i=t.value.blockIds.length,n=o.value.blockIds.length,r=i+n;return{completedTaskCount:n,incompleteTaskCount:i,totalTaskCount:r,completedTaskPercent:0===r?0:n/r}}({incompleteTasksResult:d,completeTasksResult:f}),_=o.automationContext.context.automationModel.isActive()?"recurrence_automation":"button_automation";let h,b;if((0,p().vt)({eventTracker:o.automationContext.context.eventTracker,properties:{action:"complete_sprint",from:_,completeSprintActionType:t,nextSprintDateRange:o.sprintCollectionContext.nextSprintDateRange,nextSprintInput:l?{type:"pointer",pointer:{id:l,table:I().ev,spaceId:o.spaceId}}:{type:"actionId"},currentSprintTaskSummary:g}}),l)b=l,h=1;else{const e=await async function(e){const{completeSprintExecutionContext:t,currentSprintPageId:o}=e,{sprintStatusNextOptionName:i,sprintStatusPropertyId:a}=t.sprintCollectionContext,{context:n,action:r}=t.automationContext,{recordMap:s,spaceId:l}=t,c={id:o,table:I().ev,spaceId:l},u=s.getModel(c);if(!u)return{error:new(v().WY)({actionId:r.id,pointer:c})};const p=R({intl:n.intl,userTimeZone:n.userTimeZone,getRecordModel:x().b4_.fromRecordMap(s),incrementSprintIdAmount:1,sourceSprintPageModel:u}),d={title:(0,m().x9d)(p),[a]:[[i]]};return await P({completeSprintExecutionContext:t,pageProperties:d})}({completeSprintExecutionContext:o,currentSprintPageId:r});if(a().Q.isFail(e))return e;b=e.value.blockId,h=2}const C=await async function(e){const{sprintUniqueIdPropertyId:t,sprintStatusPropertyId:o,sprintStatusFutureOptionName:i,sprintCollectionPointer:a}=e.sprintCollectionContext,{context:n,action:r}=e.automationContext,s={operator:"and",filters:[{property:o,filter:{operator:"status_is",value:{type:"is_option",value:i}}}]};return await T((()=>n.executeEffectMap.queryCollection({actionId:r.id,collection:a,filter:s,userTimeZone:n.userTimeZone,sort:[{property:t,direction:"ascending"}],limit:1})),e)}(o);if(a().Q.isFail(C))return C;let D=C.value.blockIds[0];if(!D){const e=await M({completeSprintExecutionContext:o,sprintPageWithLargestUniqueId:b,incrementFutureSprintIdAmount:1});if(h=1===h?2:3,a().Q.isFail(e))return e;D=e.value.blockId}const A=await async function(e){const{sprintUniqueIdPropertyId:t,sprintCollectionPointer:o}=e.sprintCollectionContext,{context:i,action:a}=e.automationContext;return await T((()=>i.executeEffectMap.queryCollection({actionId:a.id,collection:o,userTimeZone:i.userTimeZone,sort:[{property:t,direction:"descending"}],limit:1})),e)}(o);if(a().Q.isFail(A))return A;const O=A.value.blockIds[0];if(function(e){var t;const{sprintStatusPropertySchema:o}=e.sprintCollectionContext;return(null===(t=o.options)||void 0===t?void 0:t.some((e=>e.id===n().el)))??!1}(o)){const e=await async function(e){const{sprintCollectionSchema:t,sprintCollectionPointer:o}=e.sprintCollectionContext,{context:i,action:a}=e.automationContext,r=c().n$[n().av].last.reducer.getCombinatorFilter(t);return await T((()=>i.executeEffectMap.queryCollection({actionId:a.id,collection:o,userTimeZone:i.userTimeZone,filter:r,limit:1})),e)}(o);if(a().Q.isFail(e))return e;const t=e.value.blockIds[0],i=await async function(e){const{completeSprintExecutionContext:t,currentSprintPageId:o}=e,{sprintStatusLastOptionName:i,sprintStatusPropertyId:a,sprintCollectionPointer:n}=t.sprintCollectionContext,{context:r,action:s}=t.automationContext,{spaceId:l}=t,c=[];i&&c.push(S().op.update({pointer:{id:o,table:I().ev,spaceId:l},path:["properties"],args:{[a]:[[i]]}}));return await r.executeEffectMap.saveTransaction({actionId:s.id,operations:c,info:{type:"update_pages",collection:n,editedProperties:[{id:a,type:"status"}],pageIds:[o]}})}({completeSprintExecutionContext:o,currentSprintPageId:r});if(a().Q.isFail(i))return i;if(t){const e=await async function(e){const{completeSprintExecutionContext:t,lastSprintPageId:o}=e,{sprintStatusPastOptionName:i,sprintStatusPropertyId:a,sprintCollectionPointer:n}=t.sprintCollectionContext,{context:r,action:s}=t.automationContext,{spaceId:l}=t,c=[S().op.update({pointer:{id:o,table:I().ev,spaceId:l},path:["properties"],args:{[a]:[[i]]}})];return await r.executeEffectMap.saveTransaction({actionId:s.id,operations:c,info:{type:"update_pages",collection:n,editedProperties:[{id:a,type:"status"}],pageIds:[o]}})}({completeSprintExecutionContext:o,lastSprintPageId:t});if(a().Q.isFail(e))return e}}else{const e=await async function(e){const{completeSprintExecutionContext:t,currentSprintPageId:o}=e,{sprintStatusPastOptionName:i,sprintStatusPropertyId:a,sprintCollectionPointer:n}=t.sprintCollectionContext,{context:r,action:s}=t.automationContext,{spaceId:l}=t,c=[S().op.update({pointer:{id:o,table:I().ev,spaceId:l},path:["properties"],args:{[a]:[[i]]}})];return await r.executeEffectMap.saveTransaction({actionId:s.id,operations:c,info:{type:"update_pages",collection:n,editedProperties:[{id:a,type:"status"}],pageIds:[o]}})}({completeSprintExecutionContext:o,currentSprintPageId:r});if(a().Q.isFail(e))return e}const N=await async function(e){const{completeSprintExecutionContext:t,nextSprintPageId:o}=e,{sprintStatusCurrentOptionName:i,sprintStatusPropertyId:a,sprintCollectionPointer:n,nextSprintDateRange:r,sprintDatePropertyId:s}=t.sprintCollectionContext,{context:l,action:c}=t.automationContext,{spaceId:u}=t,p=[S().op.update({pointer:{id:o,table:I().ev,spaceId:u},path:["properties"],args:{[a]:[[i]],[s]:[(0,m().wmz)(["d",r])]}})];return await l.executeEffectMap.saveTransaction({actionId:c.id,operations:p,info:{type:"update_pages",collection:n,editedProperties:[{id:a,type:"status"}],pageIds:[o]}})}({completeSprintExecutionContext:o,nextSprintPageId:b});if(a().Q.isFail(N))return N;const q=await async function(e){const{completeSprintExecutionContext:t,nextFutureSprintPageId:o}=e,{sprintStatusNextOptionName:i,sprintStatusPropertyId:a,sprintCollectionPointer:n}=t.sprintCollectionContext,{context:r,action:s}=t.automationContext,{recordMap:l,spaceId:c}=t,u={id:o,table:I().ev,spaceId:c},p=l.getModel(u);if(!p)return{error:new(v().WY)({actionId:s.id,pointer:u})};l.addModel(p);const d=[S().op.update({pointer:p.pointer,path:["properties"],args:{[a]:[[i]]}})];return await r.executeEffectMap.saveTransaction({actionId:s.id,operations:d,info:{type:"update_pages",collection:n,editedProperties:[{id:a,type:"status"}],pageIds:[o]}})}({completeSprintExecutionContext:o,nextFutureSprintPageId:D});if(a().Q.isFail(q))return q;const V=await M({completeSprintExecutionContext:o,sprintPageWithLargestUniqueId:O,incrementFutureSprintIdAmount:h});if(a().Q.isFail(V))return V;const W=new Set([]);for(;;){if(a().Q.isFail(d))return d;if(0===d.value.blockIds.length)break;const e=d.value.blockIds.filter((e=>!W.has(e)));if("complete_sprint_and_move_incomplete_tasks_to_next_sprint"===t&&e.length>0){const t=await w({completeSprintExecutionContext:o,taskIds:e,nextSprintPageId:b});if(a().Q.isFail(t))return t}else{if(!("complete_sprint_and_move_incomplete_tasks_to_backlog"===t&&e.length>0))break;{const t=await E(o,e);if(a().Q.isFail(t))return t}}e.forEach((e=>W.add(e))),d=await k({currentSprintPageId:r,completeSprintExecutionContext:o})}return{value:{success:!0}}}),(e=>e.completeSprintExecutionContext.automationContext.context.automationModel.id));async function k(e){const{currentSprintPageId:t,completeSprintExecutionContext:o}=e,{taskStatusCompleteGroupName:i}=o.taskCollectionContext;return await C({currentSprintPageId:t,statusFilter:{operator:"status_is_not",value:{type:"is_group",value:i}},completeSprintExecutionContext:o})}async function F(e){const{currentSprintPageId:t,completeSprintExecutionContext:o}=e,{taskStatusCompleteGroupName:i}=o.taskCollectionContext;return await C({currentSprintPageId:t,statusFilter:{operator:"status_is",value:{type:"is_group",value:i}},completeSprintExecutionContext:o})}async function C(e){const{currentSprintPageId:t,statusFilter:o,completeSprintExecutionContext:i}=e,{taskStatusPropertyId:a,taskSprintRelationPropertyId:n,taskCollectionPointer:r}=i.taskCollectionContext,{context:s,action:l}=i.automationContext,c={operator:"and",filters:[{property:a,filter:o},{filter:{operator:"relation_contains",value:{type:"exact",value:t}},property:n}]};return await T((()=>s.executeEffectMap.queryCollection({limit:999,actionId:l.id,collection:r,userTimeZone:s.userTimeZone,filter:c})),i)}async function T(e,t){const{spaceId:o,recordMap:i}=t,{context:n}=t.automationContext,r=await e();if(a().Q.isFail(r))return r;const s=r.value;if(s.recordMap)i.assign(s.recordMap.toRecordMap());else{const e=s.blockIds.map((e=>({id:e,table:I().ev,spaceId:o}))),t=await n.loadRecordModel(e);i.assign(t)}return{value:{blockIds:s.blockIds}}}async function M(e){const{completeSprintExecutionContext:t,sprintPageWithLargestUniqueId:o,incrementFutureSprintIdAmount:i}=e,{sprintStatusFutureOptionName:a,sprintStatusPropertyId:n}=t.sprintCollectionContext,{context:r,action:s}=t.automationContext,{recordMap:l,spaceId:c}=t,u={id:o,table:I().ev,spaceId:c},p=l.getModel(u);if(!p)return{error:new(v().WY)({actionId:s.id,pointer:u})};const d=R({intl:r.intl,userTimeZone:r.userTimeZone,getRecordModel:x().b4_.fromRecordMap(l),incrementSprintIdAmount:i,sourceSprintPageModel:p}),f={title:(0,m().x9d)(d),[n]:[[a]]};return await P({completeSprintExecutionContext:t,pageProperties:f})}async function P(e){const{completeSprintExecutionContext:t,pageProperties:o}=e,{recordMap:i,sprintCollectionContext:n,automationContext:r,spaceId:s}=t,{context:l,action:c}=r,u=n.sprintCollectionPointer,p=i.getModel(u);if(!p)return{error:new(v()._r)("invalid_record",`Could not find collection record: ${u.id}`)};let d;const m=l.useCrdtDefault,f=p.getDefaultTemplatePagePointer();if(f){const e=await l.executeEffectMap.initializeTemplateInDatabase({actionId:c.id,templateId:f.id,collection:p.getSpaceShardedPointer(),propertyUpdates:o,useCrdt:m,automationExecutionContext:l});if(a().Q.isFail(e))return e;d=e.value.pageId;const t={id:d,table:I().ev,spaceId:s},n=await l.loadRecordModel(t);if(!n)return{error:new(v()._r)("invalid_record",`Could not find new sprint page: ${t.id}`)};i.addModel(n)}else{var y;d=(null===(y=l.spaceIdCreator)||void 0===y?void 0:y.idInSavedSpace(I().ev))??h().JW();const{model:e,operations:t}=x().zgg.create({id:d,type:g().xd.page,parentPointer:p.pointer,space_id:s,properties:o,createdBy:l.author||_().TI,legacyNonCrdt:!m});l.runtimeRecordPointerSet.add(e.pointer);const n=await l.executeEffectMap.saveTransaction({actionId:c.id,operations:t,info:{type:"create_page",collection:u,pageId:d}});if(a().Q.isFail(n))return n;i.setModel(e.pointer,e)}return{value:{blockId:d}}}async function w(e){const{completeSprintExecutionContext:t,taskIds:o,nextSprintPageId:i}=e,{taskSprintRelationPropertyId:a,taskCollectionPointer:n}=t.taskCollectionContext,{context:r,action:s}=t.automationContext,{spaceId:l}=t,c=o.map((e=>S().op.update({pointer:{id:e,table:I().ev,spaceId:l},path:["properties"],args:{[a]:[(0,m().wmz)((0,m().ld4)(i,l))]}})));return await r.executeEffectMap.saveTransaction({actionId:s.id,operations:c,info:{type:"update_pages",collection:n,editedProperties:[{id:a,type:"relation"}],pageIds:o}})}async function E(e,t){const{taskSprintRelationPropertyId:o,taskCollectionPointer:i}=e.taskCollectionContext,{context:a,action:n}=e.automationContext,{spaceId:r}=e,s=t.map((e=>S().op.update({pointer:{id:e,table:I().ev,spaceId:r},path:["properties"],args:{[o]:void 0}})));return await a.executeEffectMap.saveTransaction({actionId:n.id,operations:s,info:{type:"update_pages",collection:i,editedProperties:[{id:o,type:"relation"}],pageIds:t}})}const D=(0,f().YK)({defaultSprintName:{id:"completeSprint.newSprint.defaultName",defaultMessage:"Sprint"},sprintNameWithId:{id:"completeSprint.newSprintWithId.name",defaultMessage:"Sprint {sprintId}"}});function R(e){var t;const{intl:o,userTimeZone:i,getRecordModel:a,sourceSprintPageModel:n,incrementSprintIdAmount:r}=e,s=n.getRenderTitle({intl:o,userTimeZone:i,getRecordModel:a}),l=null==s||null===(t=s.trim().split(" "))||void 0===t?void 0:t.at(-1);let c;if(l){const e=parseInt(l);isNaN(e)||(c=e+r)}return void 0!==c?o.formatMessage(D.sprintNameWithId,{sprintId:c}):o.formatMessage(D.defaultSprintName)}const A={type:"complete_sprint",invertible:!1,hasSideEffects:!0,hasNewReversableEffect:!1,isAvailableForContext:e=>"recurrence"===e.automation.getTriggerType(),resolveExecutionDependencies:(e,t)=>{const o=t.getConfig(),i=[];return null!=o&&o.sprint_collection&&i.push({type:"record_permission",pointer:o.sprint_collection,minimumRole:"editor"}),null!=o&&o.task_collection&&i.push({type:"record_permission",pointer:o.task_collection,minimumRole:"editor"}),r().q.return(i)},typecheck:(e,t)=>({value:{valueTypes:[]}}),execute:async(e,t)=>{var r,f,y,g,_,h,x,S,I,k,F;const C=t.getConfig();if(!C)return{error:new(v().k2)({actionId:t.id})};const T=l().RecordMap.create(),M=await e.loadRecordModel(C.sprint_collection);if(!M)return{error:new(v().WY)({actionId:t.id,pointer:C.sprint_collection})};T.addModel(M);const P=M.getNormalizedSchema();if(!(0,c().wy)({appUri:null===(r=M.getFormat())||void 0===r?void 0:r.app_config_uri,collectionSchema:P}))return{error:new(v().Qo)({actionId:t.id,sprintCollectionPointer:M.pointer})};const w=null===(f=M.getFormat())||void 0===f||null===(f=f.app_uri_map)||void 0===f?void 0:f[n().Hx.StatusV2];if(!w)return{error:new(v().Dr)({actionId:t.id,collectionPointer:C.sprint_collection,property:n().Hx.StatusV2})};const E=null===(y=M.getFormat())||void 0===y||null===(y=y.app_uri_map)||void 0===y?void 0:y[n().Hx.UniqueId];if(!E)return{error:new(v().Dr)({actionId:t.id,collectionPointer:C.sprint_collection,property:n().Hx.UniqueId})};const D=null===(g=M.getFormat())||void 0===g||null===(g=g.app_uri_map)||void 0===g?void 0:g[n().Hx.Dates];if(!D)return{error:new(v().Dr)({actionId:t.id,collectionPointer:C.sprint_collection,property:n().Hx.Dates})};const R=P[w];if(!R||"status"!==R.type)return{error:new(v().Dr)({actionId:t.id,collectionPointer:C.sprint_collection,property:n().Hx.StatusV2})};const A=null===(_=R.options)||void 0===_||null===(_=_.find((e=>e.id===n().aJ)))||void 0===_?void 0:_.value,O=null===(h=R.options)||void 0===h||null===(h=h.find((e=>e.id===n().el)))||void 0===h?void 0:h.value,N=null===(x=R.options)||void 0===x||null===(x=x.find((e=>e.id===n().Xk)))||void 0===x?void 0:x.value,q=null===(S=R.options)||void 0===S||null===(S=S.find((e=>e.id===n().tO)))||void 0===S?void 0:S.value,V=null===(I=R.options)||void 0===I||null===(I=I.find((e=>e.id===n().Jd)))||void 0===I?void 0:I.value;if(!(A&&N&&q&&V))return{error:new(v()._r)("invalid_property_schema",`Could not find required options for ${n().Hx.StatusV2}.`)};const W={id:e.automationModel.id,table:u().yB,spaceId:M.id},Q=e.automationModel;if(!Q.isType("recurrence"))return{error:new(v().WY)({actionId:t.id,pointer:W})};const G=await e.loadRecordModel(C.task_collection);if(!G)return{error:new(v().WY)({actionId:t.id,pointer:C.task_collection})};T.addModel(G);const B=null===(k=G.getFormat())||void 0===k||null===(k=k.app_uri_map)||void 0===k?void 0:k[n().yx.Status];if(!B)return{error:new(v().Dr)({actionId:t.id,collectionPointer:C.task_collection,property:n().yx.Status})};const H=null===(F=G.getFormat())||void 0===F||null===(F=F.app_uri_map)||void 0===F?void 0:F[n().yx.TaskToSprintRelation];if(!H)return{error:new(v().Dr)({actionId:t.id,collectionPointer:C.task_collection,property:n().yx.TaskToSprintRelation})};const U=G.getNormalizedSchema(),K=U[B];if(!K||"status"!==K.type)return{error:new(v().Dr)({actionId:t.id,collectionPointer:C.task_collection,property:n().yx.Status})};const z=(0,p().Q6)(e.intl,K);if(!z)return{error:new(v()._r)("invalid_property_schema",`Could not find required group for ${n().yx.Status}.`)};const L=function(e){let t,a;if(e.forEach((e=>{e.kind===s().FormulaContextValueKind.ContextValue&&(e.id===i().GF&&"date"===e.value.type&&(0,o(597777).oM)(e.value.value)?t=e.value.value:e.id===i().uM&&"text"===e.value.type&&(a=(0,m().q4_)(e.value.value)))})),!(t&&a))return;return{nextSprintDateRange:t,completeSprintActionType:a}}(e.values);let Y,$;if(L)Y=L.completeSprintActionType,$=L.nextSprintDateRange;else{const t=Q.getTrigger().recurrence;if(!t)throw new(v().yc);const o=(0,d().Vv)(t);if(!o)return{error:new(v()._r)("misc",`Invalid recurrence for sprint recurrence automation: ${Q.id}`)};$=(0,d().wI)({userTimeZone:e.userTimeZone,sprintSchedule:o}),Y=C.complete_sprint_action}const Z={spaceId:M.space_id,automationContext:{action:t,context:e},sprintCollectionContext:{sprintCollectionPointer:C.sprint_collection,sprintCollectionSchema:P,nextSprintDateRange:$,sprintDatePropertyId:D,sprintStatusCurrentOptionName:N,sprintStatusFutureOptionName:V,sprintStatusNextOptionName:q,sprintStatusPastOptionName:A,sprintStatusLastOptionName:O,sprintStatusPropertyId:w,sprintStatusPropertySchema:R,sprintUniqueIdPropertyId:E},taskCollectionContext:{taskCollectionPointer:C.task_collection,taskCollectionSchema:U,taskSprintRelationPropertyId:H,taskStatusCompleteGroupName:z,taskStatusPropertyId:B,taskStatusPropertySchema:K},recordMap:T},j=await b({completeSprintAction:Y,completeSprintExecutionContext:Z});return a().Q.isFail(j)?j:{value:{values:[]}}}};var O=()=>o(422540),N=()=>o(239381),q=()=>o(791089),V=(o(296540),o(474848));const W={viewBox:"0 0 20 20",fittedViewBox:"3.12 3.12 13.75 13.75",svg:(0,V.jsxs)(V.Fragment,{children:[(0,V.jsx)("path",{d:"M6.375 8.333c0-.345.28-.625.625-.625h6a.625.625 0 1 1 0 1.25H7a.625.625 0 0 1-.625-.625M7 11.042a.625.625 0 1 0 0 1.25h6a.625.625 0 0 0 0-1.25z"}),(0,V.jsx)("path",{d:"M3.125 5.25c0-1.174.951-2.125 2.125-2.125h9.5c1.174 0 2.125.951 2.125 2.125v9.5a2.125 2.125 0 0 1-2.125 2.125h-9.5a2.125 2.125 0 0 1-2.125-2.125zm2.125-.875a.875.875 0 0 0-.875.875v9.5c0 .483.392.875.875.875h9.5a.875.875 0 0 0 .875-.875v-9.5a.875.875 0 0 0-.875-.875z"})]})},Q=(0,o(340498).wt)("equalSquare",W,"default");var G=()=>o(881434),B=()=>o(648651);const H=(0,f().YK)({defineVariablesName:{id:"automations.actions.defineVariablesName",defaultMessage:"Define variables"},defineVariablesDescription:{id:"automations.actions.defineVariablesDescription",defaultMessage:"Create and edit custom variables for your automation."},variableDescription:{id:"automations.actions.variableDescription",defaultMessage:"This is a variable of type: {readableReturnType}"}}),U=new Set(["button","event","recurrence"]),K={type:"define_variables",invertible:void 0,hasSideEffects:!1,hasNewReversableEffect:!1,display:{icon:Q,name:H.defineVariablesName,description:H.defineVariablesDescription},isAvailableForContext:e=>{const t=e.automation.getTriggerType();if("event"===t){return!(!e.actorOnlyEditedUnaliveColumns&&!e.isSubscribed)}return U.has(t)},*resolveExecutionDependencies(e,t){var o;const i=[],a=null===(o=t.getConfig())||void 0===o?void 0:o.values;if((0,y().O9)(a))for(const n of Object.values(a))(0,y().O9)(n.value)&&i.push(...yield*e.getFormulaContentsDependencies({minimumRole:"reader",value:n.value}));return i},typecheck:(e,t)=>{const i=[],a=new Set,n=t.getConfig(),{values:r,variableIds:l}=n??{},c=[],u=[];let p;if((0,y().O9)(l)&&l.length>0&&(0,y().O9)(r)){const{intl:n}=e,d={formulasModule:e.formulasModule,handleDataRequest:(0,N().zg)(e.getRecordModel),restrictUnaccessibleProperties:"cross_space_and_read_permissions",spaceId:e.automationModel.spaceId,valueTypes:e.valueTypes.slice(0),featureGates:(0,G().f)({checkExperimentGateFn:e.checkExperimentGate}),guaranteedPropertyIds:e.guaranteedPropertyIds,enableExistenceGuarantees:e.enableExistenceGuarantees};for(const m of l){const l=r[m];if(!(0,y().O9)(l)||!(0,y().O9)(l.value))continue;const{result:v,hasCrossSpaceError:f,stats:g}=(0,q().typecheckSimpleFormulaOrFormula)({context:d,value:l.value});f&&c.push({actionType:"define_variables",key:m,type:"invalid_formula_cross_space"}),p=(0,B().AP)(p,g),(0,y().O9)(v.parseErrors)&&v.parseErrors.length>0&&c.push({actionType:"define_variables",key:m,type:"invalid_formula_parse_error"}),(0,y().O9)(v.typeErrors)&&v.typeErrors.length>0&&c.push({actionType:"define_variables",key:m,type:"invalid_formula_type_error",typeErrors:e.formulasModule.cleanFormulaTypecheckerErrors(v.typeErrors),shouldNotifyOnFailure:!0}),(0,y().O9)(v.typeWarnings)&&v.typeWarnings.length>0&&u.push({actionType:"define_variables",key:m,type:"invalid_formula_type_warning",typeErrors:e.formulasModule.cleanFormulaTypecheckerErrors(v.typeWarnings)}),(0,y().O9)(v.type)||c.push({actionType:"define_variables",key:m,type:"invalid_formula_missing_return_type"});const _=v.type??{type:"unknown"},h=(0,N().$y)({source:"action",action_id:t.id,action_output_type:"variable",variable_id:m});!0===v.resultExists&&a.add((0,N().Bk)(h)),i.push({description:n.formatMessage(H.variableDescription,{readableReturnType:n.formatMessage((0,o(708685).getHumanReadableType)(_)).toLocaleLowerCase()}),id:h,kind:s().FormulaContextValueKind.ContextValue,name:l.name,type:_})}}return{value:{validationFailures:c,validationWarnings:u,valueTypes:i,stats:{formulaStats:p},guaranteedPropertyIds:a}}},execute:async(e,t)=>{const{formulasModule:o,simpleFormulasModule:i}=e,n=[],r=t.getConfig(),{values:l,variableIds:c}=r??{};let u;if((0,y().O9)(c)&&c.length>0&&(0,y().O9)(l))for(const p of c){const r=l[p];if((0,y().O9)(r)&&(0,y().O9)(r.value))if("simple"===r.value.type){const{result:o,stats:l}=await i.executeSimpleFormulaAsyncWithStats({value:r.value,context:{...e,returnType:{type:"text"}},executeFormula:e.executeContextualFormula});if(u=(0,B().AP)(u,l),a().Q.isFail(o))return{error:new(v().F_)({actionId:t.id,cause:(0,O().kH)(o.error),stats:u})};n.push({id:(0,N().$y)({source:"action",action_id:t.id,action_output_type:"variable",variable_id:p}),kind:s().FormulaContextValueKind.ContextValue,value:o.value})}else{const i=performance.now(),l=await o.executeFormulaAsync(r.value.value??[[""]],e),c=Math.trunc(performance.now()-i),d=a().Q.isSuccess(l);if(u=(0,B().AP)(u,{formulaTypecheckDurationMs:void 0,formulaTypecheckSuccess:void 0,formulaExecutionDurationMs:c,formulaExecutionSuccess:d,totalFormulas:1,simpleFormulaTypecheckDurationMs:void 0,simpleFormulaTypecheckSuccess:void 0,simpleFormulaExecutionDurationMs:void 0,simpleFormulaExecutionSuccess:void 0,totalSimpleFormulas:void 0}),a().Q.isFail(l))return{error:new(v().F_)({actionId:t.id,cause:(0,O().kH)(l.error),stats:u})};n.push({id:(0,N().$y)({source:"action",action_id:t.id,action_output_type:"variable",variable_id:p}),kind:s().FormulaContextValueKind.ContextValue,value:l.value})}}return{value:{values:n,stats:{formulaStats:u}}}}};const z=(0,f().YK)({duplicateBlocks:{id:"automations.actions.duplicateBlocks",defaultMessage:"Insert blocks"},duplicateBlocksDescription:{id:"automations.actions.duplicateBlocksDescription",defaultMessage:"Insert text or blocks on this page."}}),L={type:"duplicate_blocks",invertible:!0,hasSideEffects:!0,hasNewReversableEffect:!0,display:{icon:o(764781).V,name:z.duplicateBlocks,description:z.duplicateBlocksDescription},isAvailableForContext:e=>"button_block"===e.contextType,resolveExecutionDependencies:(e,t)=>{const o=[{type:"record_permission",pointer:e.automationModel.getParentPointer(),minimumRole:"content_only_editor"}];return e.parentPage&&o.push({type:"record_permission",pointer:e.parentPage.pointer,minimumRole:"content_only_editor"}),r().q.return(o)},typecheck:()=>({value:{valueTypes:[]}}),execute:async(e,t)=>{const o=(t.getBlocks()??[])[0],i=t.getInsertionPoint(),n={};if((0,y().O9)(o)){const t=await e.executeEffectMap.duplicateBlockChildren({blockPointer:{table:I().ev,id:o,spaceId:e.automationModel.getSpaceId()},insertionPoint:i});a().Q.isSuccess(t)&&B().hs.aggregateActionStats(n,t.value.stats)}return{value:{stats:n,values:[]}}}};const Y=(0,f().YK)({modalConfirmation:{id:"automations.actions.modalConfirmation",defaultMessage:"Show confirmation"},modalConfirmationDescription:{id:"automations.actions.modalConfirmationDescription",defaultMessage:"Shows a confirmation window before proceeding."}}),$={type:"modal_confirmation",invertible:void 0,hasSideEffects:!1,hasNewReversableEffect:!1,display:{icon:o(406533).questionMarkCircleIcon,name:Y.modalConfirmation,description:Y.modalConfirmationDescription},isAvailableForContext:e=>"button"===e.automation.getTriggerType(),*resolveExecutionDependencies(e,t){const o=[],i=t.getConfig();return null!=i&&i.text&&o.push(...yield*e.getFormulaContentsDependencies({minimumRole:"reader",value:i.text})),o},typecheck:(e,t)=>{const o=t.getConfig();if(null==o||!o.text)return{value:{valueTypes:[]}};const i=[],a=[],{result:n,hasCrossSpaceError:r,stats:s}=(0,q().typecheckSimpleFormulaOrFormula)({context:{formulasModule:e.formulasModule,handleDataRequest:(0,N().zg)(e.getRecordModel),restrictUnaccessibleProperties:"cross_space_and_read_permissions",spaceId:e.automationModel.spaceId,valueTypes:e.valueTypes.slice(0),featureGates:(0,G().f)({checkExperimentGateFn:e.checkExperimentGate}),guaranteedPropertyIds:e.guaranteedPropertyIds,enableExistenceGuarantees:e.enableExistenceGuarantees},value:o.text});return r&&i.push({actionType:"modal_confirmation",key:"text",type:"invalid_formula_cross_space"}),n.parseErrors&&n.parseErrors.length>0&&i.push({actionType:"modal_confirmation",type:"invalid_formula_parse_error",key:"text"}),n.typeErrors&&n.typeErrors.length>0&&i.push({actionType:"modal_confirmation",type:"invalid_formula_type_error",key:"text",typeErrors:e.formulasModule.cleanFormulaTypecheckerErrors(n.typeErrors),shouldNotifyOnFailure:!0}),n.typeWarnings&&n.typeWarnings.length>0&&a.push({actionType:"modal_confirmation",type:"invalid_formula_type_warning",key:"text",typeErrors:e.formulasModule.cleanFormulaTypecheckerErrors(n.typeWarnings)}),n.type||i.push({actionType:"modal_confirmation",type:"invalid_formula_missing_return_type",key:"text"}),{value:{validationFailures:i,validationWarnings:a,valueTypes:[],stats:{formulaStats:s}}}},execute:async(e,t)=>{var o,i,n;const{simpleFormulasModule:r}=e,s=t.getConfig();let l,c=[];if(null!=s&&s.text){const{result:o,stats:i}=await r.executeSimpleFormulaAsyncWithStats({value:s.text,context:{...e,returnType:{type:"text"}},executeFormula:e.executeContextualFormula});if(l=i,a().Q.isFail(o))return{error:new(v().F_)({actionId:t.id,cause:(0,O().kH)(o.error),stats:l})};c=(0,N().Ht)(o.value)}(0,m().AhH)(c)>u().cK&&(c=(0,m().JG8)(c,u().cK,[(0,m().Ey_)("â€¦")]));const p=await e.executeEffectMap.displayModal({format:{icon:null===(o=e.automationModel.getProperties())||void 0===o?void 0:o.icon,text:c,continueButtonText:(null==s||null===(i=s.continue_button)||void 0===i?void 0:i.text)??"",cancelButtonText:(null==s||null===(n=s.cancel_button)||void 0===n?void 0:n.text)??""}});return a().Q.isFail(p)?p:"cancel"===p.value.result?{value:{formulaStats:l,stopExecution:!0,values:[]}}:{value:{values:[],formulaStats:l}}}};const Z=(0,f().YK)({openPage:{id:"automations.actions.openPageOrUrl",defaultMessage:"Open page, form, or URL"},openPageDescription:{id:"automations.actions.openPageOrUrlDescription",defaultMessage:"Opens a specified page or URL."}}),j={type:"open_page",invertible:!1,hasSideEffects:!1,hasNewReversableEffect:!1,display:{icon:o(955363).arrowDiagonalUpRightIcon,name:Z.openPage,description:Z.openPageDescription},isAvailableForContext:e=>"button"===e.automation.getTriggerType(),resolveExecutionDependencies:(e,t)=>{var o,i;const a=t.getConfig();return"page"===(null==a||null===(o=a.target)||void 0===o?void 0:o.type)?r().q.return([{type:"record_permission",pointer:null==a?void 0:a.target.page,minimumRole:"reader"}]):"variable"===(null==a||null===(i=a.target)||void 0===i?void 0:i.type)?r().q.return(e.getFormulaContextValueDependencies({targetId:a.target.id,minimumRole:"reader"})):r().q.return([])},typecheck:(e,t)=>{const o=t.getConfig();if(null==o||!o.target)return{value:{validationFailures:[{type:"missing_required_config",actionType:"open_page",key:"target"}]}};if("page"===o.target.type){if(!e.getRecordModel(o.target.page))return{value:{validationFailures:[{type:"missing_required_config",actionType:"open_page",key:"target",shouldNotifyOnFailure:!0}]}}}return{value:{valueTypes:[]}}},execute:(e,t)=>{const o=t.getConfig();if(null==o||!o.target)return Promise.resolve({error:new(v().ry)({pointer:null==o?void 0:o.target,actionId:t.id})});if("page"===o.target.type||"variable"===o.target.type){let i;if("page"===o.target.type)i=o.target.page;else if("variable"===o.target.type){const a=(0,N().q$)(e.values,o.target.id);if(!a)return Promise.resolve({error:new(v().dd)({actionId:t.id,source:"action",variable:void 0})});if("block"===a.value.type)i=a.value.value;else{if("array"!==a.value.type)return Promise.resolve({error:new(v().dd)({actionId:t.id,source:"action",variable:a.value})});{const e=a.value.values[0];if(!e||"block"!==e.type)return Promise.resolve({error:new(v().dd)({actionId:t.id,source:"action",variable:a.value})});i=e.value}}}else(0,y().HB)(o.target);e.executeEffectMap.navigateToPage({actionId:t.id,page:i,openIn:t.getOpenPageIn()})}else"url"===o.target.type?e.executeEffectMap.openUrl({actionId:t.id,url:o.target.url}):(0,y().HB)(o.target);return Promise.resolve({value:{values:[]}})}};function J(e){return{...e,typecheck(t,o){const{runtimeStats:i}=t,n=i?B().hs.getOrCreateAction(i,o.pointer,o.type):void 0,r=performance.now(),s=e.typecheck(t,o),l="modal_confirmation"===o.type?1:Math.trunc(performance.now()-r);return n&&(n.typecheckStartTime=r,n.typecheckDurationMs=l,a().Q.isFail(s)?n.typecheckSuccess=!1:(B().hs.aggregateActionStats(n,s.value.stats),n.typecheckSuccess=!0)),s},async execute(t,o){const{runtimeStats:i}=t,n=i?B().hs.getOrCreateAction(i,o.pointer,o.type):void 0,r=performance.now(),s=await e.execute(t,o),l=Math.trunc(performance.now()-r);return n&&(n.executionStartTime=r,n.executionDurationMs=l,a().Q.isFail(s)?(n.executionSuccess=!1,s.error instanceof v().F_&&B().hs.aggregateActionStats(n,{formulaStats:s.error.data.stats})):(B().hs.aggregateActionStats(n,s.value.stats),n.executionSuccess=!0)),s}}}var X=()=>o(498212);const ee=(0,f().YK)({publishSite:{id:"automations.actions.publishSite",defaultMessage:"Publish site"},publishSiteDescription:{id:"automations.actions.publishSiteDescription",defaultMessage:"Publishes a specified page as a site."}}),te={type:"publish_site",invertible:!1,hasSideEffects:!0,hasNewReversableEffect:!1,display:{icon:o(12193).globeIcon,name:ee.publishSite,description:ee.publishSiteDescription},isAvailableForContext:e=>!!e.checkExperimentGate("publish_site_automation_action")&&"event"===e.automation.getTriggerType(),resolveExecutionDependencies:(e,t)=>{var o,i;const a=[],n=t.getConfig();return n?("page"===(null===(o=n.target)||void 0===o?void 0:o.type)?a.push({type:"record_permission",pointer:n.target.page,minimumRole:"read_and_write"}):"variable"===(null==n||null===(i=n.target)||void 0===i?void 0:i.type)&&a.push(...e.getFormulaContextValueDependencies({targetId:n.target.id,minimumRole:"read_and_write"})),r().q.return(a)):r().q.return(a)},typecheck:(e,t)=>{const o=t.getConfig();if(null==o||!o.target)return{value:{valueTypes:[],validationFailures:[{type:"missing_required_config",actionType:"publish_site",key:"target"}]}};if("page"===o.target.type){if(!e.getRecordModel(o.target.page))return{value:{valueTypes:[],validationFailures:[{actionType:"publish_site",type:"missing_required_config",key:"target"}]}}}else if("variable"===o.target.type){const t=(0,N().IV)(e.valueTypes,o.target.id);if(!t)return{value:{valueTypes:[],validationFailures:[{actionType:"publish_site",type:"missing_target_variable",key:"target"}]}};if("block"!==t.type.type)return{value:{valueTypes:[],validationFailures:[{actionType:"publish_site",type:"invalid_context_value_type",key:"target"}]}}}else(0,y().HB)(o.target);return{value:{valueTypes:[]}}},execute:async(e,t)=>{if(!e.author)return Promise.resolve({error:new(v().Q)({actionId:t.id,contextValueId:"author"})});const i=t.getConfig();if(null==i||!i.target)return Promise.resolve({error:new(v().ry)({pointer:void 0,actionId:t.id})});let a;if("page"===i.target.type)a=i.target.page;else if("variable"===i.target.type){const o=(0,N().q$)(e.values,i.target.id);if("block"!==(null==o?void 0:o.value.type))return Promise.resolve({error:new(v().dd)({actionId:t.id,source:"action",variable:null==o?void 0:o.value})});a=o.value.value}else(0,y().HB)(i.target);const n=await e.loadRecordModel(a);if(!n)return Promise.resolve({error:new(v().ry)({pointer:a,actionId:t.id})});const r=Date.now(),s=[],l=n.getFormat().site_id,c={id:l??(0,X().Ay)(),table:o(101628).Eu,spaceId:n.getSpaceId()};return l||(s.push(S().op.update({pointer:c,path:[],args:{space_id:n.getSpaceId(),type:"site",version:1,last_version:0,parent_id:n.id,parent_table:n.table,created_time:r,created_by_id:e.author.id,created_by_table:e.author.table,last_edited_time:r,last_edited_by_id:e.author.id,last_edited_by_table:e.author.table,header:{}}})),s.push(S().op.update({pointer:n.pointer,path:["format"],args:{site_id:c.id}})),s.push({command:"setPermissionItem",pointer:a,path:["permissions"],args:{type:"public_permission",role:"reader"}}),await e.executeEffectMap.saveTransaction({actionId:t.id,operations:s,info:{type:"publish_site",pageId:a.id,siteId:c.id}})),Promise.resolve({value:{values:[]}})}};var oe=()=>o(519831);const ie=(0,f().YK)({queryCollection:{id:"automations.actions.queryCollection",defaultMessage:"Get pages"},queryCollectionDescription:{id:"automations.actions.queryCollectionDescription",defaultMessage:"Get a list of pages from a database with optional filters and sorts, to be used in a subsequent automation step."},queryCollectionPages:{id:"automations.actions.queryCollectionPages",defaultMessage:"Pages from step {stepNumber}"}}),ae={type:"query_collection",invertible:void 0,hasSideEffects:!1,hasNewReversableEffect:!1,display:{icon:o(207207).magnifyingGlassIcon,name:ie.queryCollection,description:ie.queryCollectionDescription},isAvailableForContext:()=>!1,resolveExecutionDependencies:(e,t)=>{const o=t.getConfig();return null!=o&&o.collection?r().q.return([{type:"record_permission",pointer:null==o?void 0:o.collection,minimumRole:"reader"}]):r().q.return([])},typecheck:(e,t)=>{const o=t.getConfig();if(null==o||!o.collection)return{value:{valueTypes:[]}};const i=(0,N().$y)({source:"action",action_id:t.id,action_output_type:"pages"}),a=e.automationModel.getActionIds().indexOf(t.id)??-1;return{value:{valueTypes:[{kind:s().FormulaContextValueKind.ContextValue,id:i,name:e.intl.formatMessage(ie.queryCollectionPages,{stepNumber:a+1}),type:{type:"array",of:{type:"block",collection:o.collection}}}]}}},execute:async(e,t)=>{const o=t.getConfig();if(null==o||!o.collection)return{value:{values:[]}};if(null==o||!o.collection.spaceId)return{error:new(v().ry)({pointer:null==o?void 0:o.collection,actionId:t.id})};const i={table:oe().Vl,id:null==o?void 0:o.collection.id,spaceId:null==o?void 0:o.collection.spaceId},a=await e.executeEffectMap.queryCollection({actionId:t.id,collection:i,userTimeZone:e.userTimeZone,filter:null==o?void 0:o.filter,sort:null==o?void 0:o.sort,limit:null==o?void 0:o.limit});if(a.error)return a;const n=(0,N().$y)({source:"action",action_id:t.id,action_output_type:"pages"}),r={kind:s().FormulaContextValueKind.ContextValue,id:n,value:{type:"array",values:a.value.blockIds.map((e=>({type:"block",value:{table:I().ev,id:e,spaceId:i.spaceId}})))}};return{value:{stats:a.value.stats,values:[r]}}}};o(823215),o(430670);var ne=()=>o(764880),re=()=>o(842599),se=()=>o(824862),le=()=>o(437607),ce=()=>o(798880);const ue=(0,f().YK)({sendGmailNotification:{id:"automations.actions.sendGmailNotification",defaultMessage:"Send mail..."},sendGmailNotificationDescription:{id:"automations.actions.sendGmailNotificationDescription",defaultMessage:"Sends a notification to one or more people in Notion."}}),pe=new Set(X().w7),de={type:"send_gmail_notification",invertible:void 0,hasSideEffects:!0,hasNewReversableEffect:!1,display:{icon:o(407444).gmailIcon,name:ue.sendGmailNotification,description:ue.sendGmailNotificationDescription},isDisabledForContext:e=>{var t;const i=(null===(t=e.spaceModel)||void 0===t?void 0:t.getBotSettings())??{};return!(0,o(322769).nH)({spaceBotSettings:i,integrationId:o(617871).eg})},isAvailableForContext:e=>{const t=e.automation.getTriggerType();if(("canAddAction"===e.checkType||"canSaveAction"===e.checkType&&"button"!==t)&&!e.actorOnlyEditedUnaliveColumns&&!e.isSubscribed)return!1;const o=e.automationActions.filter((e=>e.isType("send_gmail_notification")));if(!("canAddAction"===e.checkType?o.length<1:o.length<=1))return!1;const a="event"===t,n="button"===t,r=(0,i().g)(e);return a||n||r},*resolveExecutionDependencies(e,t){var o,i,a;const n=[],r=t.getConfig(),s=null==r?void 0:r.external_bot_id;s&&n.push({type:"record_permission",pointer:{table:se().GP,id:s},minimumRole:"reader"});const l=[...(null==r||null===(o=r.to)||void 0===o||null===(o=o.value)||void 0===o?void 0:o.value)||[],...(null==r||null===(i=r.cc)||void 0===i||null===(i=i.value)||void 0===i?void 0:i.value)||[],...(null==r||null===(a=r.bcc)||void 0===a||null===(a=a.value)||void 0===a?void 0:a.value)||[]];return(0,m().Fbh)(l).forEach((e=>n.push({type:"record_permission",pointer:{table:ce().oo,id:e},minimumRole:"reader"}))),null!=r&&r.email_subject&&n.push(...yield*e.getFormulaContentsDependencies({minimumRole:"reader",value:r.email_subject})),null!=r&&r.email_body&&n.push(...yield*e.getFormulaContentsDependencies({minimumRole:"reader",value:r.email_body})),n},typecheck:(e,t)=>{var o,i,a,n,r,s;if(!e.isSubscribed)return{value:{validationFailures:[{type:"requires_subscription_upgrade",actionType:"send_gmail_notification",key:"subscription"}]}};const l=t.getConfig();if(!l||!l.external_bot_id)return{value:{validationFailures:[{type:"missing_required_config",actionType:"send_gmail_notification",key:"external_bot_id"}]}};const c=null==l?void 0:l.to;if(!c)return{value:{validationFailures:[{type:"missing_required_config",actionType:"send_gmail_notification",key:"to"}]}};if(!c.value||!c.value.value||0===(null===(o=c.value.value)||void 0===o?void 0:o.length))return{value:{validationFailures:[{type:"missing_required_config",actionType:"send_gmail_notification",key:"to"}]}};const u=(0,m().Fbh)(c.value.value).map((t=>(0,ne().xC)({pointer:{table:ce().oo,id:t},getRecordModel:e.getRecordModel}))),p=(0,re().C3)((0,m().k4p)(c.value.value)).map((e=>({type:"email",value:e}))),d=(0,m().IQD)(c.value.value);if(u.every((e=>{var t;return(null===(t=e.asActor)||void 0===t?void 0:t.table)===ce().oo&&e.asActor.getIsDeleted()}))&&0===(0,m().kNd)(c.value.value).length&&0===p.length&&0===d.length)return{value:{validationFailures:[{type:"invalid_required_config",actionType:"send_gmail_notification",key:"to"}]}};const v=e.getRecordModel({id:l.external_bot_id,table:se().GP});if(null==v||!v.alive)return{value:{validationFailures:[{type:"missing_required_config",actionType:"send_gmail_notification",key:"external_bot_id",shouldNotifyOnFailure:!0}]}};const f=parseInt(v.getLastEditedAt().toString());if(l.external_bot_id===(null===(i=l.auth_failure)||void 0===i?void 0:i.bot_id)&&null!==(a=l.auth_failure)&&void 0!==a&&a.should_reauthenticate&&f<((null===(n=l.auth_failure)||void 0===n?void 0:n.last_failure_time)??0))return{value:{validationFailures:[{type:"invalid_required_config",actionType:"send_gmail_notification",key:"external_bot_id"}]}};if(!l.email_subject||null===(r=l.email_subject)||void 0===r||!r.value||(0,m().w9s)(l.email_subject.value))return{value:{validationFailures:[{type:"missing_required_config",actionType:"send_gmail_notification",key:"email_subject"}]}};if(!l.email_body||null===(s=l.email_body)||void 0===s||!s.value||(0,m().w9s)(l.email_body.value))return{value:{validationFailures:[{type:"missing_required_config",actionType:"send_gmail_notification",key:"email_body"}]}};const y=[],g=[];let _;const h={formulasModule:e.formulasModule,handleDataRequest:(0,N().zg)(e.getRecordModel),restrictUnaccessibleProperties:"cross_space_and_read_permissions",spaceId:e.automationModel.spaceId,valueTypes:e.valueTypes.slice(0),featureGates:(0,G().f)({checkExperimentGateFn:e.checkExperimentGate}),guaranteedPropertyIds:e.guaranteedPropertyIds,enableExistenceGuarantees:e.enableExistenceGuarantees};for(const[m,x]of[["email_subject",l.email_subject],["email_body",l.email_body]]){const{result:t,hasCrossSpaceError:o,stats:i}=(0,q().typecheckSimpleFormulaOrFormula)({context:h,value:x});o&&y.push({actionType:"send_gmail_notification",key:m,type:"invalid_formula_cross_space"}),_=(0,B().AP)(_,i),t.parseErrors&&t.parseErrors.length>0&&y.push({actionType:"send_gmail_notification",type:"invalid_formula_parse_error",key:m}),t.typeErrors&&t.typeErrors.length>0&&y.push({actionType:"send_gmail_notification",type:"invalid_formula_type_error",key:m,typeErrors:e.formulasModule.cleanFormulaTypecheckerErrors(t.typeErrors),shouldNotifyOnFailure:!0}),t.typeWarnings&&t.typeWarnings.length>0&&g.push({actionType:"send_gmail_notification",type:"invalid_formula_type_warning",key:m,typeErrors:e.formulasModule.cleanFormulaTypecheckerErrors(t.typeWarnings)}),t.type||y.push({actionType:"send_gmail_notification",type:"invalid_formula_missing_return_type",key:m})}return{value:{validationFailures:y,validationWarnings:g,valueTypes:[],stats:{formulaStats:_}}}},execute:async(e,t)=>{var o,i,a,n,r,s,l,c;const{simpleFormulasModule:u}=e,p=null===(o=t.getConfig())||void 0===o?void 0:o.to,d=null===(i=t.getConfig())||void 0===i?void 0:i.cc,m=null===(a=t.getConfig())||void 0===a?void 0:a.bcc,f=null===(n=t.getConfig())||void 0===n?void 0:n.reply_to,y=null===(r=t.getConfig())||void 0===r?void 0:r.from_name,g=null===(s=t.getConfig())||void 0===s?void 0:s.email_subject,_=null===(l=t.getConfig())||void 0===l?void 0:l.email_body,h=null===(c=t.getConfig())||void 0===c?void 0:c.external_bot_id;if(!p||!p.value)return{error:new(v().k2)({actionId:t.id,missingConfigKey:"to"})};if(!g)return{error:new(v().k2)({actionId:t.id,missingConfigKey:"email_subject"})};if(!_)return{error:new(v().k2)({actionId:t.id,missingConfigKey:"email_body"})};if(!h)return{error:new(v().k2)({actionId:t.id,missingConfigKey:"external_bot_id"})};const x=e.automationModel.getCreatedByPointer(),S=void 0!==e.spaceId?{spaceId:e.spaceId}:void 0,I=e.experimentService.checkGate({gateName:"automations_send_gmail_page_pointer",actor:x,customIDs:S});let b,k;try{const o=await me(t,e,p,u,k,{resolveMentionsFromText:I});k=o.formulaStats;const i=await me(t,e,d,u,k,{resolveMentionsFromText:I});k=i.formulaStats;const a=await me(t,e,m,u,k,{resolveMentionsFromText:I});k=a.formulaStats;const n=await me(t,e,f,u,k,{resolveMentionsFromText:I});k=n.formulaStats,b={to:o.value,cc:i.value,bcc:a.value,replyTo:n.value.at(0)}}catch(C){if(C instanceof v()._r)return{error:C};throw C}const F=await fe(t,e,_,u,k);if(k=F.formulaStats,0!==b.to.length){const o=y&&await fe(t,e,y,u,k),i=null==o?void 0:o.value;k=(null==o?void 0:o.formulaStats)??k;const a=await fe(t,e,g,u,k);k=a.formulaStats;const n=await e.executeEffectMap.sendGmailNotification({action:t,...b,fromName:i,subject:a.value,body:F.value,intl:e.intl,userTimeZone:e.userTimeZone,...I?{contextValues:e.values}:{}});if(null!=n&&n.error)return n}else e.executeEffectMap.logMessage({data:{miscDataToConvertToString:{unresolvedOrEmptyTarget:p,actionId:t.id,spaceId:t.pointer.spaceId,automationId:e.automationModel.id}},from:"sendGmailNotification",level:"info",type:"sendGmailNotificationEmptyResolvedTargets"});return{value:{stats:{formulaStats:k,usersMentioned:new Set([...b.to.filter((e=>"group"!==e.type)),...b.cc.filter((e=>"group"!==e.type)),...b.bcc.filter((e=>"group"!==e.type))]).size,groupsMentioned:new Set([...b.to.filter((e=>"group"===e.type)),...b.cc.filter((e=>"group"===e.type)),...b.bcc.filter((e=>"group"===e.type))]).size},values:[]}}}};async function me(e,t,o,i,n,r){if(null==o||!o.value)return{value:[],formulaStats:n};const{result:s,stats:l}=await i.executeSimpleFormulaAsyncWithStats({value:null==o?void 0:o.value,context:{...t,returnType:{type:"unknown"}},executeFormula:t.executeContextualFormula}),c=(0,B().AP)(n,l);if(a().Q.isFail(s))throw new(v().F_)({actionId:e.id,cause:(0,O().kH)(s.error),stats:c});return{value:ve(s.value,r),formulaStats:c}}function ve(e,t){const o=[];switch(e.type){case"array":o.push(...e.values.flatMap((e=>ve(e,t))));break;case"person":e.value.table===ce().oo?pe.has(e.value.id)||o.push({type:"user",value:{table:ce().oo,id:e.value.id}}):e.value.table===le().n&&o.push({type:"group",value:{table:le().n,id:e.value.id,spaceId:e.value.spaceId}});break;case"text":{const i=e.value;t.resolveMentionsFromText&&((0,m().Fbh)(i).forEach((e=>{pe.has(e)||o.push({type:"user",value:{table:ce().oo,id:e}})})),(0,m().FAS)(i).forEach((({groupId:e,spaceId:t})=>{o.push({type:"group",value:{table:le().n,id:e,spaceId:t}})}))),(0,re().C3)((0,m().q4_)(i)).forEach((e=>{(0,re().DT)(e)&&o.push({type:"email",value:e})}));break}}return o}async function fe(e,t,o,i,n){const{result:r,stats:s}=await i.executeSimpleFormulaAsyncWithStats({value:o,context:{...t,returnType:{type:"text"}},executeFormula:t.executeContextualFormula}),l=(0,B().AP)(n,s);if(a().Q.isFail(r))throw new(v().F_)({actionId:e.id,cause:(0,O().kH)(r.error),stats:l});return{value:(0,N().Ht)(r.value),formulaStats:l}}var ye=()=>o(381283);const ge=(0,f().YK)({sendInAppNotification:{id:"automations.actions.sendInAppNotification",defaultMessage:"Send notification to..."},sendInAppNotificationDescription:{id:"automations.actions.sendInAppNotificationDescription",defaultMessage:"Sends a notification to one or more people in Notion."}}),_e={type:"send_in_app_notification",invertible:void 0,hasSideEffects:!0,hasNewReversableEffect:!1,display:{icon:o(104077).r,name:ge.sendInAppNotification,description:ge.sendInAppNotificationDescription},isAvailableForContext:e=>{const t=e.automation.getTriggerType();if(!("event"===t||"button"===t||(0,i().g)(e)))return!1;if("button"!==t&&!e.actorOnlyEditedUnaliveColumns&&!e.isSubscribed)return!1;const o=e.automationActions.filter((e=>e.isType("send_in_app_notification")));return"canAddAction"===e.checkType?o.length<1:o.length<=1},*resolveExecutionDependencies(e,t){var o;const i=[],a=t.getConfig(),n=null==a||null===(o=a.target)||void 0===o?void 0:o.type;if(!n)return[];if("property"===n){var r;const e=null==a||null===(r=a.target)||void 0===r?void 0:r.collectionPointer;e&&i.push({type:"record_permission",pointer:e,minimumRole:"reader"})}else if("formula"===n){var s;const e=null==a||null===(s=a.target)||void 0===s||null===(s=s.value)||void 0===s?void 0:s.value;(0,m().Fbh)(e).forEach((e=>i.push({type:"record_permission",pointer:{table:ce().oo,id:e},minimumRole:"reader"})));(0,m().FAS)(e).forEach((e=>i.push({type:"record_permission",pointer:(0,le().S4)({spacePermissionGroupId:e.groupId,spaceId:e.spaceId}),minimumRole:"reader"})))}else(0,y().HB)(n);return a.notification_message&&i.push(...yield*e.getFormulaContentsDependencies({minimumRole:"reader",value:a.notification_message})),i},typecheck:(e,t)=>{var o;const i=t.getConfig(),a=null==i?void 0:i.target;if(!i||!a)return{value:{validationFailures:[{type:"missing_required_config",actionType:"send_in_app_notification",key:"target",shouldNotifyOnFailure:!0}]}};if("property"===a.type){if(!a.propertyId)return{value:{validationFailures:[{type:"missing_required_config",actionType:"send_in_app_notification",key:"propertyId",shouldNotifyOnFailure:!0}]}};if(!a.collectionPointer)return{value:{validationFailures:[{type:"missing_required_config",actionType:"send_in_app_notification",key:"collectionPointer",shouldNotifyOnFailure:!0}]}};const t=e.getRecordModel({id:a.collectionPointer.id,table:oe().Vl}),o=null==t?void 0:t.getSchema()[a.propertyId];if(!o)return{value:{validationFailures:[{type:"deleted_required_config",actionType:"send_in_app_notification",key:"propertyId",shouldNotifyOnFailure:!0}]}};if(!(0,ye().J)(o))return{value:{validationFailures:[{type:"invalid_required_config",actionType:"send_in_app_notification",key:"propertyId",shouldNotifyOnFailure:!0}]}}}else if("formula"===a.type){var n,r,s;const t=(0,m().Fbh)(null===(n=a.value)||void 0===n?void 0:n.value).map((t=>(0,ne().xC)({pointer:{table:ce().oo,id:t},getRecordModel:e.getRecordModel}))),o=(0,m().FAS)(null===(r=a.value)||void 0===r?void 0:r.value).map((t=>{const o=(0,le().gK)({spacePermissionGroupId:t.groupId,spaceId:t.spaceId});return e.getRecordModel({table:le().n,id:o,spaceId:t.spaceId})})).filter(y().O9);if(!a.value||!a.value.value||0===(null===(s=a.value.value)||void 0===s?void 0:s.length))return{value:{validationFailures:[{type:"missing_required_config",actionType:"send_in_app_notification",key:"formulaValue"}]}};if(t.every((e=>{var t;return(null===(t=e.asActor)||void 0===t?void 0:t.table)===ce().oo&&e.asActor.getIsDeleted()}))&&o.every((e=>!e.isAlive()))&&0===(0,m().kNd)(a.value.value).length)return{value:{validationFailures:[{type:"invalid_required_config",actionType:"send_in_app_notification",key:"formulaValue"}]}}}if(!i.notification_message||null===(o=i.notification_message)||void 0===o||!o.value||(0,m().w9s)(i.notification_message.value))return{value:{validationFailures:[{type:"missing_required_config",actionType:"send_in_app_notification",key:"notification_message",shouldNotifyOnFailure:!0}]}};const l=[],c=[],u={formulasModule:e.formulasModule,handleDataRequest:(0,N().zg)(e.getRecordModel),restrictUnaccessibleProperties:"cross_space_and_read_permissions",spaceId:e.automationModel.spaceId,valueTypes:e.valueTypes.slice(0),featureGates:(0,G().f)({checkExperimentGateFn:e.checkExperimentGate}),guaranteedPropertyIds:e.guaranteedPropertyIds,enableExistenceGuarantees:e.enableExistenceGuarantees},{result:p,hasCrossSpaceError:d,stats:v}=(0,q().typecheckSimpleFormulaOrFormula)({context:u,value:i.notification_message});return d&&l.push({actionType:"send_in_app_notification",key:"notification_message",type:"invalid_formula_cross_space"}),p.parseErrors&&p.parseErrors.length>0&&l.push({actionType:"send_in_app_notification",key:"notification_message",type:"invalid_formula_parse_error"}),p.typeErrors&&p.typeErrors.length>0&&l.push({actionType:"send_in_app_notification",key:"notification_message",type:"invalid_formula_type_error",typeErrors:e.formulasModule.cleanFormulaTypecheckerErrors(p.typeErrors),shouldNotifyOnFailure:!0}),p.typeWarnings&&p.typeWarnings.length>0&&c.push({actionType:"send_in_app_notification",key:"notification_message",type:"invalid_formula_type_warning",typeErrors:e.formulasModule.cleanFormulaTypecheckerErrors(p.typeWarnings)}),p.type||l.push({actionType:"send_in_app_notification",key:"notification_message",type:"invalid_formula_missing_return_type"}),{value:{validationFailures:l,validationWarnings:c,valueTypes:[],stats:{formulaStats:v}}}},execute:async(e,t)=>{var i,n,r;const{simpleFormulasModule:s}=e,l=null===(i=t.getConfig())||void 0===i?void 0:i.target,c=null===(n=t.getConfig())||void 0===n?void 0:n.notification_message;if(!l||!c)return{error:new(v().k2)({actionId:t.id,missingConfigKey:t.getConfig()?l?"notification_message":"target":"config"})};const u={userIds:new Set,groupIds:new Set},p=null===(r=e.formulaVariableResolution)||void 0===r||null===(r=r.thisPageBlockModel)||void 0===r?void 0:r.pointer,d=null==p?void 0:p.id,f=l.type;let g;switch(f){case"formula":if(!l.value)return{error:new(v().k2)({actionId:t.id,missingConfigKey:"target"})};const{result:i,stats:n}=await s.executeSimpleFormulaAsyncWithStats({value:l.value,context:{...e,returnType:{type:"person"}},executeFormula:e.executeContextualFormula});if(g=(0,B().AP)(g,n),a().Q.isFail(i))return{error:new(v().F_)({actionId:t.id,cause:(0,O().kH)(i.error),stats:g})};const r=(0,N().Ht)(i.value);(0,m().Fbh)(r).forEach((e=>u.userIds.add(e)));(0,m().FAS)(r).forEach((e=>{const t=(0,le().gK)({spacePermissionGroupId:e.groupId,spaceId:e.spaceId});u.groupIds.add(t)}));break;case"property":const c=l.propertyId,p=l.collectionPointer;if(!c||!p)return{error:new(v().k2)({actionId:t.id,missingConfigKey:c?"collectionPointer":"propertyId"})};const _=await e.loadRecordModel(p);if(!_||!d)return{error:new(v().Ob)({actionId:t.id,propertyId:c,failedToResolve:{collectionId:p.id}})};{const i=await e.loadRecordModel({table:I().ev,id:d,spaceId:t.pointer.spaceId});if(!i)return{error:new(v().Ob)({actionId:t.id,propertyId:c,failedToResolve:{blockId:d}})};const a=_.getNormalizedSchema()[c];if(!a||!(0,ye().J)(a))return{error:new(v().Ob)({actionId:t.id,propertyId:c,failedToResolve:{collectionId:p.id}})};const n="created_by"===a.type,r="last_edited_by"===a.type;if(n){const e=i.getCreatedByPointer();e&&e.table===ce().oo&&u.userIds.add(e.id)}else if(r){const e=i.getLastEditedByPointer();e&&e.table===ce().oo&&u.userIds.add(e.id)}else{const e=null==i?void 0:i.getProperties();if(!e)return{error:new(v().Ob)({actionId:t.id,propertyId:c,failedToResolve:{blockId:i.id}})};{const t=e[c],n=(0,o(363170).e)({textValue:t,propertySchema:a,blockCreatorPointer:i.getCreatedByPointer()});n.length>0&&n.map((e=>{e.table===le().n?u.groupIds.add(e.id):u.userIds.add(e.id)}))}}}break;default:(0,y().HB)(f)}const{result:_,stats:h}=await s.executeSimpleFormulaAsyncWithStats({context:{...e,returnType:{type:"text"}},executeFormula:e.executeContextualFormula,value:c});if(g=(0,B().AP)(g,h),a().Q.isFail(_))return{error:new(v().F_)({actionId:t.id,cause:_.error,stats:g})};if(0!==u.userIds.size||0!==u.groupIds.size){var x;const o=await e.executeEffectMap.sendInAppNotification({actionPointer:t.pointer,pagePointer:null===(x=e.formulaVariableResolution)||void 0===x||null===(x=x.thisPageBlockModel)||void 0===x?void 0:x.pointer,spaceId:t.pointer.spaceId,targets:{userIds:Array.from(u.userIds),groupIds:Array.from(u.groupIds)},message:(0,N().Ht)(_.value)});if(null!=o&&o.error)return o}else e.executeEffectMap.logMessage({data:{miscDataToConvertToString:{unresolvedOrEmptyTarget:l,actionId:t.id,spaceId:t.pointer.spaceId,automationId:e.automationModel.id}},from:"sendInAppNotification",level:"info",type:"sendInAppNotificationEmptyResolvedTargets"});return{value:{stats:{usersMentioned:u.userIds.size,groupsMentioned:u.groupIds.size,formulaStats:g},values:[]}}}};var he=()=>o(300985),xe=()=>o(841369);const Se=(0,f().YK)({httpRequest:{id:"automations.actions.httpRequest",defaultMessage:"Send webhook"},httpRequestDescription:{id:"automations.actions.httpRequestDescription",defaultMessage:"Calls a custom URL."}}),Ie={type:"http_request",invertible:!1,hasSideEffects:!0,hasNewReversableEffect:!1,requiresPriorTransactionsCommitted:!0,display:{icon:he().Z,name:Se.httpRequest,description:Se.httpRequestDescription},isAvailableForContext:e=>{const t=e.automation.getTriggerType();if(("canAddAction"===e.checkType||"canSaveAction"===e.checkType&&"button"!==t)&&!e.actorOnlyEditedUnaliveColumns&&!e.isSubscribed)return!1;const o=e.automationActions.filter((e=>e.isType("http_request")));return!!("canAddAction"===e.checkType?o.length<5:o.length<=5)&&("event"===t||"button"===t||(0,i().g)(e))},isDisabledForContext:e=>{const t=e.spaceModel;if(!t)return!1;const o=t.getSettings();return!(!t.isEnterprisePlan()||!o.disallow_webhook_automation_action)},resolveExecutionDependencies:(e,t)=>r().q.return([]),typecheck:(e,t)=>{var o,i;if(!e.isSubscribed)return{value:{validationFailures:[{type:"requires_subscription_upgrade",actionType:"http_request",key:"subscription"}]}};const a=null===(o=t.getConfig())||void 0===o?void 0:o.url,n=[];(0,xe().gY)(a,{allowLocalhost:"local"===e.env})||n.push({type:"invalid_url",actionType:"http_request",key:"url"}),((null===(i=t.getConfig())||void 0===i||null===(i=i.customHeaders)||void 0===i?void 0:i.length)||0)>xe().qu&&n.push({type:"too_many_custom_headers",actionType:"http_request",key:"customHeaders"});const r=new Set;for(const l of(null===(s=t.getConfig())||void 0===s?void 0:s.customHeaders)||[]){var s;l.key&&(0,xe().LM)(l.key)&&!r.has(l.key.toLowerCase())||l.id&&n.push({type:"empty_custom_header_field",actionType:"http_request",key:["customHeaders",l.id,"key"]}),l.value&&(0,xe().br)(l.value)||l.id&&n.push({type:"empty_custom_header_field",actionType:"http_request",key:["customHeaders",l.id,"value"]}),r.add(l.key.toLowerCase())}return n.length>0?{value:{validationFailures:n}}:{value:{valueTypes:[]}}},execute:async(e,t)=>{var o;const i=null===(o=e.formulaVariableResolution)||void 0===o?void 0:o.thisPageBlockModel,a=await e.executeEffectMap.sendHttpRequest({action:t,pagePointer:null==i?void 0:i.pointer,eventId:e.eventId});return a.error?a:{value:{values:[]}}}};const be=(0,f().YK)({slackNotification:{defaultMessage:"Send Slack notification toâ€¦",id:"automations.actions.slackNotification"},slackNotificationDescription:{defaultMessage:"Sends a Slack notification to a user or channel.",id:"automations.actions.slackNotificationDescription"}}),ke={type:"slack_notification",invertible:void 0,hasSideEffects:!1,hasNewReversableEffect:!1,display:{icon:o(888382).slackIcon,name:be.slackNotification,description:be.slackNotificationDescription},isAvailableForContext:e=>{if("event"===e.contextType){const t=e.automationActions.filter((e=>e.isType("slack_notification")));return"canAddAction"===e.checkType?t.length<1:t.length<=1}return!!e.automation.isButtonType()||!!(0,i().g)(e)},resolveExecutionDependencies:(e,t)=>{const o=t.getConfig();return null!=o&&o.external_bot_id?r().q.return([{minimumRole:"reader",pointer:{id:o.external_bot_id,table:se().GP},type:"record_permission"}]):r().q.return([])},typecheck:(e,t)=>{if(!e.isSubscribed)return{value:{validationFailures:[{type:"requires_subscription_upgrade",actionType:"slack_notification",key:"subscription"}]}};const o=t.getConfig();if(null==o||!o.external_bot_id)return{value:{validationFailures:[{type:"missing_required_config",actionType:"slack_notification",key:"external_bot_id"}]}};const i=e.getRecordModel({id:o.external_bot_id,table:se().GP});return i&&i.alive?o.target?{value:{valueTypes:[]}}:{value:{validationFailures:[{type:"missing_required_config",actionType:"slack_notification",key:"target"}]}}:{value:{validationFailures:[{type:"missing_required_value",actionType:"slack_notification",key:"external_bot_id",shouldNotifyOnFailure:!0}]}}},execute:async(e,t)=>{var o;let i,n;const r=null===(o=t.getConfig())||void 0===o?void 0:o.custom_message;if((0,y().O9)(r)){const{simpleFormulasModule:o}=e,{result:i,stats:s}=await o.executeSimpleFormulaAsyncWithStats({value:r,context:{...e,returnType:{type:"text"}},executeFormula:e.executeContextualFormula});if(a().Q.isFail(i))return{error:new(v().F_)({actionId:t.id,cause:(0,O().kH)(i.error),stats:s})};n=(0,N().Ht)(i.value)}if((0,y().O9)(e.event)){var s;const t=null===(s=e.event)||void 0===s||null===(s=s.data.record_diff.before)||void 0===s?void 0:s.properties;i={type:e.event.type,beforeBlockValueProperties:(0,y().O9)(t)?t:void 0,authors:e.event.authors,record_id:e.event.record_id,space_id:e.event.space_id}}const l=await e.executeEffectMap.sendSlackNotification({action:t,event:i,customMessage:n});return a().Q.isFail(l)?l:{value:{values:[]}}}};var Fe=()=>o(496603),Ce=()=>o(898244),Te=()=>o(236162),Me=()=>o(142748),Pe=()=>o(16197);const we=(0,f().YK)({updatePages:{id:"automations.actions.updatePages",defaultMessage:"Edit pages inâ€¦"},updatePagesDescription:{id:"automations.actions.updatePagesDescription",defaultMessage:"Edits the properties of specified pages in a database."}}),Ee=new Set(["button","event"]);async function De(e){const{pointer:t,context:o,actionId:i}=e,a=await o.loadRecordModel(t);if(!a)return{error:new(v().WY)({pointer:t,actionId:i})};const n=await(0,Te().wC)({block:a,loadRecordModel:o.loadRecordModel});return n?{value:n.getSpaceShardedPointer()}:{error:new(v().WY)({pointer:t,actionId:i})}}function Re(e){const{actionModels:t,contextValue:i}=e,{automationValueInfo:a,collectionPointer:n,actionModel:r}=(0,o(241319).y)({actionModels:t,id:i.id});return"action"!==a.source?{error:new(v().dd)({source:"global",variable:i.value})}:r&&"create_page"===r.getType()&&n?{value:n}:{error:new(v().dd)({actionId:a.action_id,source:"action",variable:i.value})}}const Ae={type:"update_pages",invertible:!0,hasSideEffects:!0,hasNewReversableEffect:!1,display:{icon:o(105819).pencilLineIcon,name:we.updatePages,description:we.updatePagesDescription},isAvailableForContext:e=>{const t=e.automation.getTriggerType(),o=(0,i().g)(e);if("event"===t||o){if(!e.isSubscribed&&!e.actorOnlyEditedUnaliveColumns)return!1;const t=e.automationActions.filter((e=>{var t;return e.isType("update_pages")&&"collection"===(null===(t=e.getConfig())||void 0===t||null===(t=t.target)||void 0===t?void 0:t.type)}));return"canAddAction"===e.checkType?t.length<5:t.length<=5}return Ee.has(t)||o},*resolveExecutionDependencies(e,t){var o,i;const a=[],n=t.getConfig();if("collection"===(null==n||null===(o=n.target)||void 0===o?void 0:o.type)?a.push({type:"record_permission",pointer:null==n?void 0:n.target.collection,minimumRole:"content_only_editor"}):"variable"===(null==n||null===(i=n.target)||void 0===i?void 0:i.type)&&a.push(...e.getFormulaContextValueDependencies({minimumRole:"content_only_editor",targetId:n.target.id})),null!=n&&n.values)for(const r of Object.values(n.values))null!=r&&r.value&&a.push(...yield*e.getFormulaContentsDependencies({minimumRole:"reader",value:r.value}));return a},typecheck:(e,t)=>{var i,n;const r=t.getConfig();if(null==r||!r.target)return{value:{validationFailures:[{type:"missing_required_config",actionType:"update_pages",key:"target",shouldNotifyOnFailure:!0}],validationWarnings:[]}};let s;if("collection"===r.target.type){const t=function(e,t){if(!(0,Me()._n)(e.collection,t))return{error:[{actionType:"update_pages",key:"collection",type:"collection_in_trash",shouldNotifyOnFailure:!0}]};return{value:{collectionModel:t(e.collection)}}}(r.target,e.getRecordModel);if(a().Q.isFail(t))return{value:{validationFailures:t.error}};const{value:{collectionModel:i}}=t;s=i;const n=null==i?void 0:i.getNormalizedSchema();if(r.target.filter&&i&&n){const e=function(e){const{filter:t,collectionModel:i,collectionSchema:a}=e,n=new Set;(0,o(502856).xc)({propertyIdSet:n,filter:t});let r=!1;return n.forEach((e=>{const t=null==a?void 0:a[e];if("relation"===(null==t?void 0:t.type))r=r||(0,Ce().o2)(i.pointer.spaceId,t);else if("rollup"===(null==t?void 0:t.type)&&t.relation_property){const e=null==a?void 0:a[t.relation_property];"relation"===(null==e?void 0:e.type)&&(r=r||(0,Ce().o2)(i.pointer.spaceId,e))}})),r}({filter:r.target.filter,collectionModel:i,collectionSchema:n});if(e)return{value:{validationFailures:[{actionType:"update_pages",key:"filter",type:"cross_space_property_in_filter"}]}}}}else if("page"===r.target.type){const t=function(e,t){if(!(0,Me()._n)(e.page,t))return{error:[{actionType:"update_pages",key:"block",type:"block_in_trash"}]};const o=t(e.page),i=null!=o&&o.isPageBlock()?(0,Te().SH)({block:o,getRecordModel:t}):void 0;return{value:{collectionModel:i}}}(r.target,e.getRecordModel);if(a().Q.isFail(t))return{value:{validationFailures:t.error}};const{value:{collectionModel:o}}=t;s=o}else if("variable"===r.target.type){const t=function(e,t,o){const i=(0,N().IV)(t,e.id);if(!i)return{error:[{actionType:"update_pages",key:"target",type:"missing_target_variable",shouldNotifyOnFailure:!0}]};if("block"===i.type.type&&i.type.collection){return!(0,Me()._n)(i.type.collection,o)?{error:[{actionType:"update_pages",key:"collection",type:"collection_in_trash",shouldNotifyOnFailure:!0}]}:{value:{collectionModel:o(i.type.collection)}}}if("array"===i.type.type&&"block"===i.type.of.type&&i.type.of.collection){return!(0,Me()._n)(i.type.of.collection,o)?{error:[{actionType:"update_pages",key:"collection",type:"collection_in_trash",shouldNotifyOnFailure:!0}]}:{value:{collectionModel:o(i.type.of.collection)}}}return{error:[{actionType:"update_pages",key:"target",type:"missing_target_variable",shouldNotifyOnFailure:!0}]}}(r.target,e.valueTypes,e.getRecordModel);if(a().Q.isFail(t))return{value:{validationFailures:t.error}};const{value:{collectionModel:o}}=t;s=o}else(0,y().HB)(r.target);if(!(0,y().O9)(null==r?void 0:r.properties))return{value:{validationFailures:[{type:"missing_required_config",actionType:"update_pages",key:"property",shouldNotifyOnFailure:!0}],validationWarnings:[]}};const{validationFailures:l,validationWarnings:c,formulaStats:u}=(0,Pe().o)({collectionPointer:null===(i=s)||void 0===i?void 0:i.getSpaceShardedPointer(),collectionSchema:null===(n=s)||void 0===n?void 0:n.getNormalizedSchema(),config:r,context:e,actionType:"update_pages"});return{value:{valueTypes:[],validationFailures:l,validationWarnings:c,stats:{formulaStats:u}}}},execute:async(e,t)=>{const i=performance.now();let n=i;const r=t.getConfig();if(null==r||!r.target)return{error:new(v().ry)({pointer:null==r?void 0:r.target,actionId:t.id})};let l,c,u,p=e.loadRecordModel;if("collection"===(null==r?void 0:r.target.type)){const o=await p(r.target.collection);if(!o)return{error:new(v().WY)({pointer:r.target.collection,actionId:t.id})};let i;for(const t of e.values){if(t.kind!==s().FormulaContextValueKind.ContextValue)continue;const e=(0,N().y5)(t.id);if("global"!==e.source)continue;if("current_user"!==e.global)continue;const o=t.value;"person"===o.type&&(o.value.table===ce().oo&&(i=o.value))}const n=await e.executeEffectMap.queryCollection({actionId:t.id,collection:r.target.collection,userTimeZone:e.userTimeZone,currentUserPointer:i,filter:r.target.filter,limit:r.target.limit,sort:r.target.sort});if(a().Q.isFail(n))return n;u=n.value.blockIds,l=o.getNormalizedSchema(),c=r.target.collection,n.value.recordMap&&(p=x().h0Y.tryUntilFound(x().h0Y.fromRecordMapWithRole(n.value.recordMap),p))}else if("variable"===r.target.type){const o=(0,N().q$)(e.values,r.target.id);if(!o)return{error:new(v().Q)({actionId:t.id,contextValueId:r.target.id})};if("block"===o.value.type){e.runtimeRecordPointerSet.add(o.value.value);let i=await De({pointer:o.value.value,context:e,actionId:t.id});if(a().Q.isFail(i)){const t=Re({actionModels:e.actionModels,contextValue:o});if(a().Q.isFail(t))return i;i=t}u=[o.value.value.id],c=i.value;const n=await e.executeEffectMap.getCollectionSchema({actionId:t.id,pointer:c});if(a().Q.isFail(n))return n;l=n.value.collectionSchema}else{if("array"!==o.value.type)return"undefined"===o.value.type?{value:{values:[]}}:{error:new(v().dd)({actionId:t.id,source:"action",variable:o.value})};{if(0===o.value.values.length)return{value:{values:[]}};const i=o.value.values[0];if(!i||"block"!==i.type)return{error:new(v().dd)({actionId:t.id,source:"action",variable:i})};e.runtimeRecordPointerSet.add(i.value);const n=await p(i.value),r=n?await(0,Te().wC)({block:n,loadRecordModel:p}):void 0;if(!r)return{error:new(v().WY)({pointer:i.value,actionId:t.id})};for(let a=1;a<o.value.values.length;a++){const i=o.value.values[a];if(!i||"block"!==i.type)return{error:new(v().dd)({actionId:t.id,source:"action",variable:i})};e.runtimeRecordPointerSet.add(i.value);const n=await p(i.value),s=n?await(0,Te().wC)({block:n,loadRecordModel:p}):void 0;if(!s||s.id!==r.id)return{error:new(v().mU)({actionId:t.id,actualCollectionPointer:null==s?void 0:s.getSpaceShardedPointer(),expectedCollectionPointer:r.getSpaceShardedPointer(),pointer:i.value})}}const s=r.getSpaceShardedPointer();u=Fe().oE(o.value.values.map((e=>"block"===e.type?e.value.id:void 0)));const d=await e.executeEffectMap.getCollectionSchema({actionId:t.id,pointer:s});if(a().Q.isFail(d))return d;l=d.value.collectionSchema,c=s}}}else if("page"===r.target.type){const o=r.target.page,i=await De({pointer:o,context:e,actionId:t.id});if(a().Q.isFail(i))return i;u=[o.id],c=i.value;const n=await e.executeEffectMap.getCollectionSchema({actionId:t.id,pointer:c});if(a().Q.isFail(n))return n;l=n.value.collectionSchema}else(0,y().HB)(r.target);const d={};B().hs.aggregateActionStats(d,{pagesUpdated:u.length});let m=!1,f=!0;const g=[],_=e.values.filter((e=>e.kind!==s().FormulaContextValueKind.ThisRow));for(const h of u){const u={table:I().ev,id:h,spaceId:c.spaceId},x=await p(u);if(!x)return{error:new(v().WY)({pointer:u,actionId:t.id})};const b=await e.makeGetRecordModelFn([x.pointer]);if(!(0,Me()._n)(x.pointer,b))return{error:new(v().tC)({pointer:x.pointer,actionId:t.id})};const k=x.getProperties(),F=await(0,Pe().d)({config:r,page:x,collectionPointer:c,collectionSchema:l,actionId:t.id,context:{...e,values:[..._,{kind:s().FormulaContextValueKind.ThisRow,value:{type:"block",value:x.pointer}}]},getCurrentPropertyValue:e=>null==k?void 0:k[e]});if(a().Q.isFail(F))return F;if(B().hs.aggregateActionStats(d,F.value.stats),(0,y().O9)(e.actionExecutionTimeoutMs)&&performance.now()-i>=e.actionExecutionTimeoutMs)return{error:new(v().rm)({actionId:t.id})};(0,y().O9)(e.actionExecutionMaxEventLoopBlockTimeMs)&&performance.now()-n>=e.actionExecutionMaxEventLoopBlockTimeMs&&(await(0,o(763824).bT)(),n=performance.now());const C=F.value.values,T=Oe({pageModel:x,context:e,propertyUpdateOperations:C});T&&e.executeEffectMap.incrementMetric("automations.update_pages_action.single_concurrent_update"),m||=T,f&&=T,C.length>0&&!T&&(g.push(...C),e.author&&g.push(S().op.update({pointer:{table:I().ev,id:h,spaceId:c.spaceId},path:[],args:{last_edited_time:Date.now(),last_edited_by_table:e.author.table,last_edited_by_id:e.author.id}})))}if(g.length>0){m&&e.executeEffectMap.incrementMetric("automations.update_pages_action.concurrent_update_some"),f&&e.executeEffectMap.incrementMetric("automations.update_pages_action.concurrent_update_all");const o=(r.properties??[]).map((e=>{var t;const o=null===(t=l)||void 0===t?void 0:t[e];if(o)return{id:e,type:o.type}})).filter(y().O9);if((0,y().O9)(e.updatePagesJitterAmountMs)&&e.updatePagesJitterAmountMs>0){const t=Math.floor(Math.random()*e.updatePagesJitterAmountMs);await e.executeEffectMap.sleepForJitter(t)}const i=await e.executeEffectMap.saveTransaction({actionId:t.id,info:{type:"update_pages",pageIds:u,collection:c,editedProperties:o},operations:g});if(a().Q.isFail(i))return i;B().hs.aggregateActionStats(d,{totalOperations:g.length})}return{value:{stats:d,values:[]}}}};function Oe(e){const{pageModel:t,context:i,propertyUpdateOperations:a}=e,n=t.getLastEditedByPointer();if(!(n&&i.author&&o(696706).L3.isEqualIdTable(n,i.author)&&Date.now()-t.getLastEditedTime()<o(615234).Xb))return!1;const r=Fe().mg(t.__IM_SORRY__getValue()),s=l().RecordMap.create();s.setValue(t.pointer,r),(0,o(328876).applyOperationsToRecordMap)({recordMap:s,operations:a,updateOnly:!0});const c=s.getModel(t.pointer);return!!c&&Fe().n4(t.getProperties(),c.getProperties())}const Ne=(0,f().YK)({actionName:{id:"automations.actions.worker",defaultMessage:"Run worker"},actionDescription:{id:"automations.actions.worker.description",defaultMessage:"Executes a worker capability"}}),qe={type:"worker",invertible:!1,hasSideEffects:!0,hasNewReversableEffect:!1,requiresPriorTransactionsCommitted:!0,display:{icon:he().Z,name:Ne.actionName,description:Ne.actionDescription},isAvailableForContext:e=>!!e.checkExperimentGate("workers"),isDisabledForContext:e=>!1,resolveExecutionDependencies:(e,t)=>r().q.return([]),typecheck:(e,t)=>{const o=t.getConfig(),i=[];return null!=o&&o.workerId||i.push({type:"missing_required_config",actionType:"worker",key:"workerId"}),null!=o&&o.capabilityKey||i.push({type:"missing_required_config",actionType:"worker",key:"capabilityKey"}),i.length>0?{value:{validationFailures:i}}:{value:{valueTypes:[]}}},execute:async(e,t)=>{var o;const i=null===(o=e.formulaVariableResolution)||void 0===o?void 0:o.thisPageBlockModel,n=await e.executeEffectMap.executeWorker({action:t,pagePointer:null==i?void 0:i.pointer,eventId:e.eventId});return a().Q.isFail(n)?n:{value:{values:[]}}}},Ve={query_collection:J(ae),create_page:J(o(462618).I),update_pages:J(Ae),open_page:J(j),slack_notification:J(ke),duplicate_blocks:J(L),modal_confirmation:J($),complete_sprint:J(A),send_in_app_notification:J(_e),send_gmail_notification:J(de),define_variables:J(K),http_request:J(Ie),publish_site:J(te),worker:J(qe)};function We(e){return Ve[e]}function Qe(e){return(0,i()._N)(e).map((e=>We(e)))}},402137:(e,t,o)=>{o.d(t,{w:()=>l});o(18107),o(967357),o(814603),o(147566),o(198721);const i="://",a="www.",n=/.+\..+\..+/,r=/\.{2,}/,s=/.+\..+/;function l(e){const t=e.trim();if(0===t.length)return!1;if(-1===t.indexOf(".")&&-1===t.indexOf("localhost"))return!1;if("."===t.at(t.length-1)||-1!==t.indexOf(" "))return!1;let o,l=`${-1===t.indexOf(i)?"http://":""}${t}`;try{o=new URL(l)}catch(u){const e=-1===l.indexOf(a),[t,n]=l.split(i);l=`${t}${i}${e?"www.":""}${n}`;try{o=new URL(l)}catch(u){return!1}}const c=o.hostname;return!r.test(c)&&(!(t.includes(a)&&"localhost"!==c&&!n.test(c))&&!("localhost"!==c&&!s.test(c)))}},462618:(e,t,o)=>{o.d(t,{I:()=>x,M:()=>_});o(16280),o(944114),o(517642),o(658004),o(733853),o(845876),o(432475),o(515024),o(731698);var i=()=>o(973647),a=()=>o(534177),n=()=>o(422540),r=()=>o(700500),s=()=>o(247331),l=()=>o(239381),c=()=>o(792071),u=()=>o(142748),p=()=>o(199378),d=()=>o(179034),m=()=>o(96689),v=()=>o(16197),f=()=>o(322867),y=()=>o(648651);const g=(0,o(69708).YK)({createPage:{id:"automations.actions.createPage",defaultMessage:"Add page toâ€¦"},createPageDescription:{id:"automations.actions.createPageDescription",defaultMessage:"Adds a new page to a database."},createPageVariableName:{id:"automations.actions.createPageVariableName",defaultMessage:"Page added"},createPageVariableNameWithStepNumber:{id:"automations.actions.createPageVariableNameWithStepNumber",defaultMessage:"Page added in step {stepNumber}"},createPageVariableDescription:{id:"automations.actions.createPageVariableDescription",defaultMessage:"The page created from an add page action"}}),_={relation:!0,person:!0,multi_select:!0,title:!1,text:!1,url:!1,email:!1,phone_number:!1,checkbox:!1,created_by:!1,last_edited_by:!1,file:!1,select:!1,status:!1,number:!1,date:!1,created_time:!1,last_edited_time:!1,last_visited_time:!1,formula:!1,rollup:!1,button:!1,auto_increment_id:!1,location:!1,verification:!1,place:!1},h=new Set(["button","event","recurrence"]),x={type:"create_page",invertible:!0,hasSideEffects:!0,hasNewReversableEffect:!0,display:{icon:o(617668).plusIcon,name:g.createPage,description:g.createPageDescription},isAvailableForContext:e=>{const t=e.automation.getTriggerType();if("event"===t){return!(!e.actorOnlyEditedUnaliveColumns&&!e.isSubscribed)}return h.has(t)},*resolveExecutionDependencies(e,t){const i=[],a=t.getConfig();if(!a)return i;const n=I(a);if(!n)return i;const r=e.checkExperimentGate("can_create_pages_in_collection_permission");if("collection"===n.type){const e=n.collection;r?i.push({type:"record_permission",pointer:e,minimumRole:"none",additionalPermissionChecks:["canCreatePagesInCollection"]}):i.push({type:"record_permission",pointer:e,minimumRole:"content_only_editor"});const t=yield*o(999515).q.fetchRecord(e),s=null==t?void 0:t.getDefaultTemplatePagePointer();s&&i.push({type:"record_permission",pointer:{spaceId:null==t?void 0:t.getSpaceId(),...s},minimumRole:"none"}),a.template_page_id&&i.push({type:"record_permission",pointer:{id:a.template_page_id,spaceId:e.spaceId,table:d().ev},minimumRole:"reader"})}if(a.values)for(const o of Object.values(a.values))null!=o&&o.value&&i.push(...yield*e.getFormulaContentsDependencies({minimumRole:"reader",value:o.value}));return i},typecheck:(e,t)=>{const o=t.getConfig();if(!o)return{value:{validationFailures:[{type:"empty_config",key:"config",actionType:"create_page",shouldNotifyOnFailure:!0}],validationWarnings:[]}};const i=I(o);if(!i)return{value:{validationFailures:[{type:"missing_required_config",actionType:"create_page",key:"collection",shouldNotifyOnFailure:!0}],validationWarnings:[]}};if("private_space"===i.type){const o=(0,l().$y)({source:"action",action_id:t.id,action_output_type:"page"}),i=(e.automationModel.getActionIds().indexOf(t.id)??-1)+1,a=e.intl.formatMessage(g.createPageVariableName),n={description:e.intl.formatMessage(g.createPageVariableDescription),kind:s().FormulaContextValueKind.ContextValue,id:o,name:a,type:{type:"block",collection:void 0},stepNumberForDisplay:i};for(const r of e.automationModel.getActionIds()){if(r===t.id)continue;const o=e.getRecordModel({id:r,spaceId:e.automationModel.getSpaceId(),table:p().SC});if("publish_site"===(null==o?void 0:o.type))return{value:{validationFailures:[{type:"create_private_page_and_publish_site",actionType:"create_page",key:"private_space",shouldNotifyOnFailure:!0}]}}}return{value:{valueTypes:[n],validationFailures:[],validationWarnings:[],stats:{formulaStats:void 0}}}}if("variable"===i.type)return{value:{valueTypes:[],validationFailures:[],validationWarnings:[],stats:{formulaStats:void 0}}};"collection"!==i.type&&(0,a().HB)(i);const n=i.collection,r=e.getRecordModel(n);if(!r)return{value:{validationFailures:[{type:"collection_not_found",actionType:"create_page",key:n.id,shouldNotifyOnFailure:!0}],validationWarnings:[]}};if(!u()._n(r.pointer,e.getRecordModel))return{value:{validationFailures:[{type:"collection_in_trash",actionType:"create_page",key:"collection",shouldNotifyOnFailure:!0}],validationWarnings:[]}};if(!n.spaceId)return{error:new(f().N9)("Collection missing space ID")};if(o.template_page_id){const t={id:o.template_page_id,table:d().ev},i=e.getRecordModel(t);if(!i)return{value:{validationFailures:[{type:"invalid_optional_config",actionType:"create_page",key:"template",shouldNotifyOnFailure:!0}]}};if(!i.isTemplate())return{value:{validationFailures:[{type:"invalid_optional_config",actionType:"create_page",key:"template",shouldNotifyOnFailure:!0}]}};if(i.getParentId()!==n.id)return{value:{validationFailures:[{type:"invalid_optional_config",actionType:"create_page",key:"template",shouldNotifyOnFailure:!0}]}};if(!u()._n(t,e.getRecordModel))return{value:{validationFailures:[{type:"template_in_trash",actionType:"create_page",key:"template",shouldNotifyOnFailure:!0}]}}}let c=!1;for(const a of e.automationModel.getActionIds()){if(a===t.id)continue;const o=e.getRecordModel({id:a,spaceId:e.automationModel.getSpaceId(),table:p().SC});"create_page"===(null==o?void 0:o.type)&&(c=!0)}const m=(0,l().$y)({source:"action",action_id:t.id,action_output_type:"page"}),y=(e.automationModel.getActionIds().indexOf(t.id)??-1)+1,_=c?e.intl.formatMessage(g.createPageVariableNameWithStepNumber,{stepNumber:y}):e.intl.formatMessage(g.createPageVariableName),h={description:e.intl.formatMessage(g.createPageVariableDescription),kind:s().FormulaContextValueKind.ContextValue,id:m,name:_,type:{type:"block",collection:n},associatedCollectionForDisplay:n,stepNumberForDisplay:y},{validationFailures:x,validationWarnings:S,formulaStats:b}=(0,v().o)({collectionPointer:r.getSpaceShardedPointer(),collectionSchema:r.getNormalizedSchema(),config:o,context:e,actionType:"create_page"});return{value:{valueTypes:[h],validationFailures:x,validationWarnings:S,stats:{formulaStats:b}}}},execute:async(e,t)=>{const{author:p,executeEffectMap:g,loadRecordModel:_,useCrdtDefault:h}=e,x=t.getConfig();if(!x)return{error:new(f().ry)({pointer:void 0,actionId:t.id})};const b=I(x);if(!b)return{error:new(f().ry)({pointer:void 0,actionId:t.id})};if("private_space"===b.type)return await async function(e,t,a){var u;const{author:p,executeEffectMap:v,useCrdtDefault:g}=e,_=e.spaceIdCreator.idInSavedSpace(d().ev),h=e.spaceIdCreator.getSpaceId();if(!p)throw new Error("Author is not set");const x=o(696706).L3.fromPointerLike({id:h,table:m().NX,spaceId:h});if((null==p?void 0:p.table)!==o(798880).oo)throw new Error("Author is not a user");let S,I=(0,o(201980).x9d)("");const b=null===(u=a.values)||void 0===u?void 0:u.title;if(null!=b&&b.value){const{simpleFormulasModule:o}=e,{result:a,stats:r}=await o.executeSimpleFormulaAsyncWithStats({value:b.value,context:{...e,returnType:{type:"text"}},executeFormula:e.executeContextualFormula});if(S=r,i().Q.isFail(a))return{error:new(f().F_)({actionId:t.id,cause:(0,n().kH)(a.error),stats:S})};I=(0,l().Ht)(a.value)}const{model:k,operations:F}=c().zgg.create({id:_,type:r().xd.page,parentPointer:x,space_id:h,createdBy:p,properties:{title:I},legacyNonCrdt:!g}),C=[];C.push(...F),C.push((0,(()=>o(370085))().mJ)({spaceParentId:h,recordId:_})),p&&C.push(k.ops.setPermissionItem({user_id:p.id,role:"editor",type:"user_permission"}));const T={blocksCreated:1,pagesCreated:1};if(C.length>0){const e=await v.saveTransaction({actionId:t.id,info:{type:"create_page",collection:void 0,pageId:_},operations:C});if(e.error)return e;y().hs.aggregateActionStats(T,e.value.stats)}const M=(0,l().$y)({source:"action",action_id:t.id,action_output_type:"page"}),P={kind:s().FormulaContextValueKind.ContextValue,id:M,value:{type:"block",value:k.pointer}};return e.runtimeRecordPointerSet.add(k.pointer),{value:{stats:T,values:[P]}}}(e,t,x);if("variable"===b.type)return{error:new(f().ry)({pointer:void 0,actionId:t.id})};if("collection"!==b.type)return{error:new(f().ry)({pointer:void 0,actionId:t.id})};const k=b.collection;if(!k.spaceId)return{error:new(f().ry)({pointer:k,actionId:t.id})};const F=await _(k);if(!F)return{value:{values:[]}};const C=F.getSpaceShardedPointer(),T=await e.makeGetRecordModelFn([k]);if(!u()._n(C,T))return{error:new(f().tC)({pointer:C,actionId:t.id})};let M;if(x.template_page_id){const t={id:x.template_page_id,spaceId:k.spaceId,table:d().ev};S(t,await e.makeGetRecordModelFn([t]))&&(M=x.template_page_id)}if(!(0,a().O9)(M)){const t=null==F?void 0:F.getDefaultTemplatePagePointer();if(t){S(t,await e.makeGetRecordModelFn([t]))&&(M=t.id)}}const P=F.isPageTreeCollection(),w=F.getRootPagePointer(),E=await async function(e){const{isPageTreeCollection:t,rootPagePointer:o,actionId:i,loadRecordModel:a,useCrdtDefault:n}=e;if(t&&o){const e=await a(o);return e?{value:e.isCrdtEnabled()}:{error:new(f().ry)({pointer:o,actionId:i})}}return{value:n}}({isPageTreeCollection:P,rootPagePointer:w,actionId:t.id,loadRecordModel:_,useCrdtDefault:h});if(i().Q.isFail(E))return E;const{value:D}=E;let R,A;const O={},N=[];if(M){const o=await e.executeEffectMap.initializeTemplateInDatabase({actionId:t.id,templateId:M,collection:k,propertyUpdates:{},useCrdt:D,automationExecutionContext:e});if(i().Q.isFail(o))return o;R=o.value.pageId,A=o.value.pageModel,o.value.stats&&y().hs.aggregateActionStats(O,o.value.stats)}else{var q;R=(null===(q=e.spaceIdCreator)||void 0===q?void 0:q.idInSavedSpace(d().ev))??o(206267).Dt();const{model:t,operations:i}=c().zgg.create({id:R,type:r().xd.page,parentPointer:F.pointer,space_id:k.spaceId,createdBy:p||o(641007).TI,legacyNonCrdt:!D});A=t,N.push(...i),y().hs.aggregateActionStats(O,{blocksCreated:1,pagesCreated:1})}const V=F.getNormalizedSchema();if(V){const o=await(0,v().d)({config:x,page:A,collectionPointer:k,collectionSchema:V,actionId:t.id,context:e});if(i().Q.isFail(o))return o;y().hs.aggregateActionStats(O,o.value.stats),N.push(...o.value.values)}if(P&&w){const e=(0,o(152565).YE)(w.table,d().ev);if(!e)throw new Error(`Could not find child path for parent table ${w.table} and child table ${d().ev}`);N.push({pointer:w,path:e,command:"insertChildrenAfter",args:{ids:[R]}})}if(N.length>0){const e=await g.saveTransaction({actionId:t.id,info:{type:"create_page",collection:k,pageId:R},operations:N});if(e.error)return e;y().hs.aggregateActionStats(O,e.value.stats)}const W=(0,l().$y)({source:"action",action_id:t.id,action_output_type:"page"}),Q={kind:s().FormulaContextValueKind.ContextValue,id:W,value:{type:"block",value:A.pointer}};return e.runtimeRecordPointerSet.add(A.pointer),{value:{stats:O,values:[Q]}}}};function S(e,t){if(!t(e))return!1;const o=!u()._n(e,t),i=u().Ou(e,t);return!(o||i)}function I(e){let t=e.target;return!t&&e.collection&&(t={type:"collection",collection:e.collection}),t}},648651:(e,t,o)=>{o.d(t,{AP:()=>n,WV:()=>c,hs:()=>a,oh:()=>l});o(944114);var i=()=>o(534177);const a={create:(e,t)=>({pointer:e,platform:t,typecheckStartTime:void 0,typecheckDurationMs:void 0,typecheckSuccess:void 0,totalActionDependencies:void 0,getDependenciesDurationMs:void 0,executionStartTime:void 0,executionDurationMs:void 0,executionSuccess:void 0,totalOperations:void 0,totalBlocksCreated:void 0,totalPagesCreated:void 0,totalPagesUpdated:void 0,totalUsersMentioned:void 0,totalActions:0,actionStats:{},transactionIds:void 0,formulaStats:void 0}),createAction:(e,t)=>({pointer:e,actionType:t,typecheckStartTime:void 0,typecheckDurationMs:void 0,typecheckSuccess:void 0,totalDependencies:void 0,getDependenciesDurationMs:void 0,executionStartTime:void 0,executionDurationMs:void 0,executionSuccess:void 0,totalOperations:void 0,blocksCreated:void 0,pagesCreated:void 0,pagesUpdated:void 0,usersMentioned:void 0,groupsMentioned:void 0,transactionIds:void 0,formulaStats:void 0}),getOrCreateAction:(e,t,o)=>(e.actionStats[t.id]||(e.actionStats[t.id]=a.createAction(t,o)),e.actionStats[t.id]),aggregate(e){let t,o,i,a,r,l,c,u;const p=Object.values(e.actionStats),d=[];for(const m of p)t=s(t,m.totalDependencies),o=s(o,m.getDependenciesDurationMs),i=s(i,m.totalOperations),a=s(a,m.blocksCreated),r=s(r,m.pagesCreated),l=s(l,m.pagesUpdated),c=s(c,m.usersMentioned),u=n(u,m.formulaStats),Array.isArray(m.transactionIds)&&m.transactionIds.length>0&&d.push(...m.transactionIds);return e.totalActionDependencies=t,e.getDependenciesDurationMs=o,e.totalOperations=i,e.totalBlocksCreated=a,e.totalPagesCreated=r,e.totalPagesUpdated=l,e.totalUsersMentioned=c,e.formulaStats=u,d.length>0&&(e.transactionIds=d),e.totalActions=p.length,e},aggregateActionStats(e,t){(0,i().O9)(t)&&(e.typecheckDurationMs=s(e.typecheckDurationMs,t.typecheckDurationMs),e.totalDependencies=s(e.totalDependencies,t.totalDependencies),e.getDependenciesDurationMs=s(e.getDependenciesDurationMs,t.getDependenciesDurationMs),e.executionDurationMs=s(e.executionDurationMs,t.executionDurationMs),e.totalOperations=s(e.totalOperations,t.totalOperations),e.blocksCreated=s(e.blocksCreated,t.blocksCreated),e.pagesCreated=s(e.pagesCreated,t.pagesCreated),e.pagesUpdated=s(e.pagesUpdated,t.pagesUpdated),e.usersMentioned=s(e.usersMentioned,t.usersMentioned),e.formulaStats=n(e.formulaStats,t.formulaStats),Array.isArray(t.transactionIds)&&t.transactionIds.length>0&&(e.transactionIds=e.transactionIds??[],e.transactionIds.push(...t.transactionIds)))}};function n(e,t){return(0,i().O9)(t)?{formulaTypecheckDurationMs:s(null==e?void 0:e.formulaTypecheckDurationMs,t.formulaTypecheckDurationMs),formulaTypecheckSuccess:r(null==e?void 0:e.formulaTypecheckSuccess,t.formulaTypecheckSuccess),formulaExecutionDurationMs:s(null==e?void 0:e.formulaExecutionDurationMs,t.formulaExecutionDurationMs),formulaExecutionSuccess:r(null==e?void 0:e.formulaExecutionSuccess,t.formulaExecutionSuccess),totalFormulas:s(null==e?void 0:e.totalFormulas,t.totalFormulas),simpleFormulaTypecheckDurationMs:s(null==e?void 0:e.simpleFormulaTypecheckDurationMs,t.simpleFormulaTypecheckDurationMs),simpleFormulaTypecheckSuccess:r(null==e?void 0:e.simpleFormulaTypecheckSuccess,t.simpleFormulaTypecheckSuccess),simpleFormulaExecutionDurationMs:s(null==e?void 0:e.simpleFormulaExecutionDurationMs,t.simpleFormulaExecutionDurationMs),simpleFormulaExecutionSuccess:r(null==e?void 0:e.simpleFormulaExecutionSuccess,t.simpleFormulaExecutionSuccess),totalSimpleFormulas:s(null==e?void 0:e.totalSimpleFormulas,t.totalSimpleFormulas)}:e}function r(e,t){return(0,i().O9)(e)&&(0,i().O9)(t)?e&&t:(0,i().O9)(e)?e:(0,i().O9)(t)?t:void 0}function s(e,t){return(0,i().O9)(t)?(e??0)+t:e}function l(e){return!!((0,i().O9)(e.executionStartTime)&&(0,i().O9)(e.executionDurationMs)&&(0,i().O9)(e.executionSuccess))}function c(e){return!!((0,i().O9)(e.executionStartTime)&&(0,i().O9)(e.executionDurationMs)&&(0,i().O9)(e.executionSuccess))}},791089:(e,t,o)=>{o.r(t),o.d(t,{analyzeSimpleFormulaOrFormulaSync:()=>s,executeSimpleFormulaAsyncWithStats:()=>m,filterTextValueToSimpleFormulaValueTokens:()=>_().LU,fromSimpleFormulaArrayValue:()=>_().FW,getDependenciesForSimpleFormula:()=>_().BT,getDependenciesForSimpleFormulaOrFormula:()=>_().MP,getReferencedContextValueIds:()=>_().yP,isAnnotationSimpleValueToken:()=>_().eU,setPropertyValueToFormulaReturnType:()=>_().qB,setPropertyValueToSimpleFormulaReturnType:()=>_().Iv,simpleFormulaValueTypeToFormulaReturnType:()=>_().BZ,simpleFormulaValueWithoutToken:()=>_().h0,singleSimpleValueTokenToTextToken:()=>_().ii,toSimpleFormulaArrayValue:()=>_().M0,toSimpleFormulaSingleValue:()=>_().fd,typecheckSimpleFormulaOrFormula:()=>l});o(944114),o(517642),o(658004),o(733853),o(845876),o(432475),o(515024),o(731698);var i=()=>o(534177),a=()=>o(201980),n=()=>o(871202),r=()=>o(80979);function s(e){const{context:t,value:o}=e;if((0,i().O9)(o)&&(0,i().O9)(o.value)){if("simple"===o.type)return function(e,t){const o=[],i=[],n=[];for(const s of e){const e=(0,a().uPN)(s);if(!(0,a().x9g)(e))continue;const l=(0,r().analyzeFormulaSync)([s],t);o.push(...l.parseErrors??[]),i.push(...l.typeErrors??[]),n.push(...l.typeWarnings??[])}return{type:{type:"text"},parseErrors:o,typeErrors:i,typeWarnings:n}}(o.value,t);{const e=(0,r().analyzeFormulaSync)(o.value,t);return(0,i().O9)(e.type)?e:{parseErrors:e.parseErrors,type:{type:"unknown"},typeErrors:e.typeErrors,typeWarnings:e.typeWarnings}}}return{type:{type:"unknown"}}}function l(e){const{context:t,value:o,collectionPointer:i}=e,r=performance.now(),l=s({context:t,value:o}),c=Math.trunc(performance.now()-r),u=!(l.typeErrors&&0!==l.typeErrors.length||l.parseErrors&&0!==l.parseErrors.length),p=!!u&&function({context:e,value:t,collectionPointer:o}){if(!t.value)return!1;let i=!1;if("formula"===t.type){(0,n().hasAccessToCode)({collectionPointer:o,context:e,depth:0,code:t.value,visitedPointers:new Set,hasAccessFn:n().hasSameSpaceAccess})||(i=!0)}else if("simple"===t.type)for(const r of t.value){const t=(0,a().uPN)(r);if(!(0,a().x9g)(t))continue;(0,n().hasAccessToCode)({collectionPointer:o,context:e,depth:0,code:[r],visitedPointers:new Set,hasAccessFn:n().hasSameSpaceAccess})||(i=!0)}return i}({context:t,value:o,collectionPointer:i});return{result:l,hasCrossSpaceError:p,stats:{formulaTypecheckDurationMs:void 0,formulaTypecheckSuccess:void 0,formulaExecutionDurationMs:void 0,formulaExecutionSuccess:void 0,totalFormulas:void 0,simpleFormulaTypecheckDurationMs:void 0,simpleFormulaTypecheckSuccess:void 0,simpleFormulaExecutionDurationMs:void 0,simpleFormulaExecutionSuccess:void 0,totalSimpleFormulas:void 0,..."simple"===o.type?{simpleFormulaTypecheckDurationMs:c,simpleFormulaTypecheckSuccess:u,totalSimpleFormulas:1}:{formulaTypecheckDurationMs:c,formulaTypecheckSuccess:u,totalFormulas:1}}}}o(898992),o(354520),o(581454);var c=()=>o(973647),u=()=>o(302322),p=()=>o(239381);function d(e){return!("number"===e.type||"text"===e.type||"checkbox"===e.type)}async function m(e){const{context:t,value:o}=e,a=performance.now(),n=await v(e),r=Math.trunc(performance.now()-a),s=c().Q.isSuccess(n);return"simple"===o.type?d(t.returnType)?{result:n,stats:{formulaTypecheckDurationMs:void 0,formulaTypecheckSuccess:void 0,formulaExecutionDurationMs:void 0,formulaExecutionSuccess:void 0,totalFormulas:void 0,simpleFormulaTypecheckDurationMs:void 0,simpleFormulaTypecheckSuccess:void 0,simpleFormulaExecutionDurationMs:r,simpleFormulaExecutionSuccess:s,totalSimpleFormulas:1}}:{result:n}:"formula"===o.type?{result:n,stats:{formulaTypecheckDurationMs:void 0,formulaTypecheckSuccess:void 0,formulaExecutionDurationMs:r,formulaExecutionSuccess:s,totalFormulas:1,simpleFormulaTypecheckDurationMs:void 0,simpleFormulaTypecheckSuccess:void 0,simpleFormulaExecutionDurationMs:void 0,simpleFormulaExecutionSuccess:void 0,totalSimpleFormulas:void 0}}:(0,i().HB)(o.type)}async function v(e){const{context:t,executeFormula:o,ignoreErrors:n,value:r}=e,{returnType:s}=t,l=r.value;if("simple"===r.type){let e=l;if(!d(s)&&g(e)){const i=await f({context:t,executeFormula:o,value:e});if(c().Q.isFail(i))return n?{value:{type:"undefined"}}:i;e=i.value}if("number"===s.type){const t=u().M(e);return(0,i().O9)(t)&&!isNaN(t)?{value:{type:"number",value:t}}:{value:{type:"undefined"}}}if("text"===s.type)return{value:{type:"text",value:e??[]}};if("checkbox"===s.type){return{value:{type:"checkbox",value:"true"===a().q4_(e)}}}return o(t,e)}return"formula"===r.type?o(t,l):(0,i().HB)(r.type)}async function f(e){const{context:t,executeFormula:o,ignoreErrors:n,value:r}=e;if(!(0,i().O9)(r))return{value:void 0};const s=[];let l=[];for(const i of r)if(l=a().uPN(i),a().tVx(l)){const e=await o(t,[i]);if(c().Q.isFail(e)&&!n)return e;c().Q.isSuccess(e)&&s.push(...y((0,p().Ht)(e.value),l))}else if(a().TVE(l)){const e=await o(t,[i]);if(c().Q.isFail(e)&&!n)return e;c().Q.isSuccess(e)&&s.push(...y((0,p().Ht)(e.value),l))}else s.push(i);return{value:s}}function y(e,t){if(0===a().AhH(e))return e;const o=t.filter((e=>a().jcO(e)));return 0===o.length?e:a().__s(e.map((e=>{const t=a().uPN(e);return 0===t.length?a().Ey_(a().N8A(e),o):a().Ey_(a().N8A(e),a().RFR(t,o))})))}function g(e){if(!(0,i().O9)(e))return!1;let t;for(const o of e)if(t=a().uPN(o),0!==t.length&&a().x9g(t))return!0;return!1}var _=()=>o(490704)},841369:(e,t,o)=>{o.d(t,{LM:()=>d,Sx:()=>r,br:()=>m,gY:()=>l,i8:()=>n,qu:()=>s});o(517642),o(658004),o(733853),o(845876),o(432475),o(515024),o(731698);var i=()=>o(188835),a=()=>o(402137);const n=2048,r=1e3,s=10;function l(e,t){if(!e)return!1;if(e.length>n)return!1;const o=i().parse(e);return!(!o||!o.host)&&(("http:"===o.protocol||"https:"===o.protocol)&&(!!(t.allowLocalhost||"localhost"!==o.hostname&&"127.0.0.1"!==o.hostname&&"0.0.0.0"!==o.hostname)&&(0,a().w)(e)))}const c=/^[\w-]+$/,u=/^[\w\s:;.,\\\/"'?!(){}[\]@<>=+*#$&|~^%-]+$/,p=new Set(["user-agent","content-type","host","content-length","accept-encoding","connection"]);function d(e){return e.length<=r&&!p.has(e.toLowerCase())&&c.test(e)}function m(e){return e.length<=r&&u.test(e)}},871202:(e,t,o)=>{o.r(t),o.d(t,{hasAccessDefaultFn:()=>_,hasAccessToCode:()=>I,hasAccessToProperty:()=>S,hasReadPermissionsAccess:()=>h,hasSameSpaceAccess:()=>x,testOnly:()=>b});o(517642),o(658004),o(733853),o(845876),o(432475),o(515024),o(731698),o(898992),o(354520);var i=()=>o(496603),a=()=>o(763824),n=()=>o(973647),r=()=>o(534177),s=()=>o(898244),l=()=>o(247331),c=()=>o(443881),u=()=>o(239381),p=()=>o(501053),d=()=>o(373907);function*m(e){const{collectionPointer:t,context:o,propertyId:i,propertySchema:a,visitedPointers:n,hasAccessFn:r}=e,s=(0,c().G7)({...t,propertyId:i});if(n.has(s))return!0;n.add(s);const l=r({propertySchema:a,spaceId:o.spaceId});return"boolean"==typeof l?l:yield*l}function*v(e){var t,o;const{collectionPointer:a,depth:p,collectionSchema:m,context:v,propertyId:f,propertySchema:y,visitedPointers:_,hasAccessFn:h}=e;if("v2"!==y.version||p>l().FORMULA_MAX_DEPTH)return!1;const x=(0,c().G7)({...a,propertyId:f});if(_.has(x))return!0;if(_.add(x),!(0,r().O9)(null===(t=y.formula2)||void 0===t?void 0:t.code))return!0;const S=(0,d().$t)(null===(o=y.formula2)||void 0===o?void 0:o.code);if(n().Q.isFail(S))return!0;const{spaceId:I}=v,b=(0,c().zm)({formulaTypecheckContextValues:[{kind:l().FormulaContextValueKind.ThisRow,type:{collection:a,type:"block"}}],node:S.value,spaceId:I}),k=(0,i().hS)(b,(e=>(0,c().G7)(e)));if(0===k.length)return!0;const{getRecordModel:F}=yield{collectionBlockProperties:[{blockPointers:[],collectionPointer:a,property:f,schema:m}],recordPointers:k.filter((e=>(0,u().T3)(e)))};for(const i of k)if((0,s().pq)(i)){const e=F(i);if(!(0,r().O9)(e))return!1;const t=i.propertyId,o=e.getSchema(),a=o[t];if(!a)continue;if((0,s().bT)(a)||(0,s().lb)(a)){if(!(yield*g({collectionPointer:i,collectionSchema:o,context:v,depth:p+1,propertyId:t,propertySchema:a,visitedPointers:_,hasAccessFn:h})))return!1}else if((0,s().nC)(a)){if(!(yield*g({collectionPointer:i,collectionSchema:o,context:v,depth:p,propertyId:t,propertySchema:a,visitedPointers:_,hasAccessFn:h})))return!1}}else if(!(0,r().O9)(F(i)))return!1;return!0}function*f(e){const{collectionPointer:t,depth:o,collectionSchema:i,context:a,propertyId:n,propertySchema:r,visitedPointers:u,hasAccessFn:d}=e;if("v2"===r.version||o>l().FORMULA_MAX_DEPTH)return!1;const m=(0,c().G7)({...t,propertyId:n});if(u.has(m))return!0;u.add(m);const v=(0,p().kh)(r.formula);if(0===v.length)return!0;for(const l of v){const e=i[l];if(e)if((0,s().bT)(e)||(0,s().lb)(e)){if(!(yield*g({collectionPointer:t,depth:o+1,collectionSchema:i,context:a,propertyId:l,propertySchema:e,visitedPointers:u,hasAccessFn:d})))return!1}else if((0,s().nC)(e)){if(!(yield*g({collectionPointer:t,collectionSchema:i,context:a,depth:o,propertyId:l,propertySchema:e,visitedPointers:u,hasAccessFn:d})))return!1}}return!0}function*y(e){const{collectionPointer:t,depth:o,collectionSchema:i,context:a,propertyId:n,propertySchema:r,visitedPointers:u,hasAccessFn:p}=e;if(o>l().FORMULA_MAX_DEPTH)return!1;const d=(0,c().G7)({...t,propertyId:n});if(u.has(d))return!0;if(u.add(d),!r.relation_property||!r.target_property)return!0;const m=i[r.relation_property];if(!m||"relation"!==m.type)return!0;const v=p({propertySchema:m,spaceId:a.spaceId});if(!("boolean"==typeof v?v:yield*v))return!1;const f=(0,s().Nv)(m);if(!f)return!0;const{getRecordModel:y}=yield{recordPointers:[f]},_=y(f),h=null==_?void 0:_.getNormalizedSchema();if(r.target_property_type&&h){const e=h[r.target_property];if(e&&r.target_property_type===e.type){if((0,s().lb)(e))return yield*g({collectionPointer:f,collectionSchema:h,context:a,depth:o+1,propertyId:r.target_property,propertySchema:e,visitedPointers:u,hasAccessFn:p});if((0,s().nC)(e))return yield*g({collectionPointer:f,collectionSchema:h,context:a,depth:o,propertyId:r.target_property,propertySchema:e,visitedPointers:u,hasAccessFn:p})}}return!0}function*g(e){const{collectionPointer:t,depth:o,collectionSchema:i,context:a,propertyId:n,propertySchema:r,visitedPointers:l,hasAccessFn:c}=e;return(0,s().nC)(r)?yield*m({collectionPointer:t,context:a,propertyId:n,propertySchema:r,visitedPointers:l,hasAccessFn:c}):(0,s().lb)(r)?"v2"===r.version?yield*v({collectionPointer:t,depth:o,collectionSchema:i,context:a,propertyId:n,propertySchema:r,visitedPointers:l,hasAccessFn:c}):yield*f({collectionPointer:t,depth:o,collectionSchema:i,context:a,propertyId:n,propertySchema:r,visitedPointers:l,hasAccessFn:c}):!(0,s().bT)(r)||(yield*y({collectionPointer:t,depth:o,collectionSchema:i,context:a,propertyId:n,propertySchema:r,visitedPointers:l,hasAccessFn:c}))}function*_(e){const{propertySchema:t,spaceId:o}=e,i=(0,s().Nv)(t);if(!(0,r().O9)(i))return!0;const{getRecordModel:a}=yield{recordPointers:[i]},n=a(i);return(0,r().O9)(n)&&x({spaceId:o,propertySchema:t})}function*h(e){const{propertySchema:t}=e,o=(0,s().Nv)(t);if(!(0,r().O9)(o))return!0;const{getRecordModel:i}=yield{recordPointers:[o]},a=i(o);return(0,r().O9)(a)}function x(e){const{propertySchema:t,spaceId:o}=e;return!(0,s().o2)(o,t)}async function S(e){const{collectionPointer:t,collectionSchema:o,context:i,propertyId:n,hasAccessFn:r}=e,s=o[n];return!s||await async function(e){const{context:t}=e;try{const o=g(e);let i=o.next();for(;!i.done;){const e=t.handleDataRequest(i.value);i=o.next((0,a().yL)(e)?await e:e)}return i.value}catch(o){return!0}}({collectionPointer:t,depth:0,collectionSchema:o,context:i,propertyId:n,propertySchema:s,visitedPointers:new Set,hasAccessFn:r})}function I(e){const{context:t}=e;try{const o=function*(e){const{collectionPointer:t,depth:o,context:a,code:p,visitedPointers:m,hasAccessFn:v}=e,f=(0,d().$t)(p);if(n().Q.isFail(f))return!0;const{spaceId:y}=a,_=a.valueTypes.filter((e=>e.kind!==l().FormulaContextValueKind.ThisRow)),h=(0,c().zm)({formulaTypecheckContextValues:t?[..._,{kind:l().FormulaContextValueKind.ThisRow,type:{collection:t,type:"block"}}]:[],node:f.value,spaceId:y}),x=(0,i().hS)(h,(e=>(0,c().G7)(e)));if(0===x.length)return!0;const{getRecordModel:S}=yield{collectionBlockProperties:[],recordPointers:x.filter((e=>(0,u().T3)(e)))};for(const i of x)if((0,s().pq)(i)){const e=S(i);if(!(0,r().O9)(e))return!1;const t=i.propertyId,n=e.getSchema(),l=n[t];if(!l)continue;if((0,s().bT)(l)||(0,s().lb)(l)){if(!(yield*g({collectionPointer:i,collectionSchema:n,context:a,depth:o+1,propertyId:t,propertySchema:l,visitedPointers:m,hasAccessFn:v})))return!1}else if((0,s().nC)(l)&&!(yield*g({collectionPointer:i,collectionSchema:n,context:a,depth:o,propertyId:t,propertySchema:l,visitedPointers:m,hasAccessFn:v})))return!1}else if(!(0,r().O9)(S(i)))return!1;return!0}(e);let a=o.next();for(;!a.done;){const e=t.handleDataRequest(a.value);a=o.next(e)}return a.value}catch(o){return!0}}const b={hasAccessDefaultFn:_,hasAccessToProperty:S,hasAccessToFormula1Property:f,hasAccessToFormula2Property:v,hasAccessToRelationProperty:m,hasAccessToRollupProperty:y}},881434:(e,t,o)=>{o.d(t,{f:()=>n});o(898992),o(908872);var i=()=>o(680141);const a=["formula_null_check"];function n(e){const{checkExperimentGateFn:t}=e;return[...a,...i().Y].reduce(((e,o)=>(e[o]=t(o),e)),{})}}}]);