"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[67720],{15154:(e,t,n)=>{n.d(t,{_:()=>i});n(296540);const o={viewBox:"0 0 20 20",fittedViewBox:"3.12 3.12 13.76 13.76",svg:(0,n(474848).jsx)("path",{d:"M4.75 3.125c-.897 0-1.625.728-1.625 1.625v10.5c0 .898.728 1.625 1.625 1.625H7.5c.897 0 1.625-.727 1.625-1.625V4.75c0-.897-.728-1.625-1.625-1.625zM4.375 4.75c0-.207.168-.375.375-.375H7.5c.207 0 .375.168.375.375v10.5a.375.375 0 0 1-.375.375H4.75a.375.375 0 0 1-.375-.375zM12.5 3.125c-.898 0-1.625.728-1.625 1.625v10.5c0 .898.727 1.625 1.625 1.625h2.75c.898 0 1.625-.727 1.625-1.625V4.75c0-.897-.727-1.625-1.625-1.625zm-.375 1.625c0-.207.168-.375.375-.375h2.75c.207 0 .375.168.375.375v10.5a.375.375 0 0 1-.375.375H12.5a.375.375 0 0 1-.375-.375z"})},i=(0,n(340498).wt)("mediaPause",o,"default")},66529:(e,t,n)=>{n.r(t),n.d(t,{canAcceptAutocompletionsWithoutDot:()=>I,getFormulaEditorInfoAtPosition:()=>S});n(18107),n(944114),n(517642),n(658004),n(733853),n(845876),n(432475),n(515024),n(731698),n(967357),n(898992),n(354520),n(672577),n(803949),n(581454);var o=()=>n(303151),i=()=>n(778078),r=()=>n(763824),a=()=>n(973647),s=()=>n(534177),l=()=>n(510916),u=()=>n(958970),d=()=>n(247331),c=()=>n(106714),p=()=>n(44907),m=()=>n(871202),f=()=>n(44738),g=()=>n(349835),y=()=>n(239381),h=()=>n(628048);async function x(e,t,n){const o=[],i=new Set;if(void 0!==e){const a=t.handleDataRequest({recordPointers:[e]}),l=((0,r().yL)(a)?await a:a).getRecordModel(e),u=null==l?void 0:l.getNormalizedSchema();if(u)for(const[r,c]of Object.entries(u))if(void 0!==(null==c?void 0:c.type)&&(0,s().Xk)(d().FormulaTokenSupportedBlockSystemPropertyList,null==c?void 0:c.type)&&i.add(c.type),r!==t.sourceProperty&&null!=c&&c.name&&d().FORMULAS_SUPPORTED_COLLECTION_PROPERTY_TYPES.includes(null==c?void 0:c.type)&&b(n,c.name)){let n;"cross_space_only"===t.restrictUnaccessibleProperties?n=m().hasSameSpaceAccess:"read_permissions_only"===t.restrictUnaccessibleProperties?n=m().hasReadPermissionsAccess:"cross_space_and_read_permissions"===t.restrictUnaccessibleProperties&&(n=m().hasAccessDefaultFn);(!t.restrictUnaccessibleProperties||!n||await(0,m().hasAccessToProperty)({collectionPointer:e,collectionSchema:u,context:t,propertyId:r,hasAccessFn:n}))&&o.push({kind:d().FormulaEditorInfoCompletionKind.Token,name:c.name,token:{type:d().FormulaTokenType.BlockProperty,property:(0,y().XH)(r),collection:e}})}}for(const r of Object.values(d().FormulaTokenSupportedBlockSystemProperty)){if(i.has(r))continue;const e=(0,l().i)(r);(""===n||b(n,e))&&o.push({kind:d().FormulaEditorInfoCompletionKind.Token,token:{type:d().FormulaTokenType.BlockProperty,property:r,collection:void 0},name:e})}return o}function b(e,t){return""===e||(0,i().It)(e,t)}async function v(e){const{prefix:t,context:n,receiverType:o,includeDeprecatedCompletions:r,dotMemberExpression:a}=e,s=[],l=[],u=[],c=new Set;if(void 0===o){var p;n.valueTypes.forEach((e=>{if(e.kind===d().FormulaContextValueKind.Binding){const n=e.id;!c.has(n)&&t!==e.id&&b(t,e.id)&&(s.push({kind:d().FormulaEditorInfoCompletionKind.Binding,text:n,type:e.type}),c.add(n))}}));const e=null===(p=n.valueTypes.find((e=>e.kind===d().FormulaContextValueKind.ThisRow)))||void 0===p?void 0:p.type;"block"===(null==e?void 0:e.type)&&void 0!==e.collection&&l.push(...await x(e.collection,n,t)),n.valueTypes.forEach((e=>{if(e.kind===d().FormulaContextValueKind.ContextValue&&b(t,e.name)){const t=(0,y().Bk)(e.id);l.push({kind:d().FormulaEditorInfoCompletionKind.Token,name:e.name,token:{type:d().FormulaTokenType.ContextValue,valueId:t}})}}))}else"block"===o.type&&l.push(...await x(o.collection,n,t));const m=new Map;for(const i in h().LP){var f;if(!c.has(i)&&b(t,i)&&(r||!i.startsWith("_"))&&("toNumber"!==i||null==o||!o.type||!h().Qi.includes(o.type))&&(!a||!h().bq.includes(i))&&(null===(f=n.featureGates.formulas_disabled_functions)||void 0===f||!f.includes(i))){const e=h().LP[i];if(void 0!==o){var g,v;const t=(null===(g=e.parameters)||void 0===g||null===(g=g.expected)||void 0===g||null===(g=g[0])||void 0===g?void 0:g.type)??(null===(v=e.parameters)||void 0===v||null===(v=v.varargs)||void 0===v||null===(v=v[0])||void 0===v?void 0:v.type);if(void 0===t||!(0,y().s7)(o,t))continue}const t={kind:d().FormulaEditorInfoCompletionKind.LibraryFunction,libraryFunction:e},n=h().u_[i]||"generic";if("internal"===n)continue;m.has(n)||m.set(n,[]),m.get(n).push(t),c.add(i)}}const k=Array.from(m.keys()).sort(((e,t)=>"generic"===e?-1:"generic"===t?1:e.localeCompare(t)));for(const i of k){const e=m.get(i);u.push(...e)}return[...(0,i().Ay)(t,s,(e=>e.text)),...(0,i().Ay)(t,l,(e=>e.name??"")),...(0,i().Ay)(t,[],(e=>e.builtin)),...(0,i().Ay)(t,u,(e=>e.libraryFunction.name))]}function k(e,t){const n=[...e].reverse().find((e=>e.kind===g().NM.Call));if((null==n?void 0:n.kind)===g().NM.Call){let e=-1;if(t>n.lParenOffset&&(void 0===n.rParenOffset||t<=n.rParenOffset))for(e=0;e<n.commaOffsets.length&&!(n.commaOffsets[e]>t);e++);return{expression:n.expression,parameterIndex:e}}}const T={[d().FormulaEditorInfoCompletionKind.Binding]:0,[d().FormulaEditorInfoCompletionKind.Token]:1,[d().FormulaEditorInfoCompletionKind.Builtin]:2,[d().FormulaEditorInfoCompletionKind.LibraryFunction]:3};function I(e){const{nodeAtPosition:t,dotMemberExpression:n}=e;return!(!n||!t)&&(t.kind===g().NM.NotionToken||t.kind===g().NM.MemberBlockProperty||t.kind===g().NM.Call||t.kind===g().NM.Boolean||t.kind===g().NM.Number||t.kind===g().NM.String||t.kind===g().NM.Array)}async function S(e){var t,n;const{formula:i,inputPosition:r,context:s,includeDeprecatedCompletions:l}=e,[m,x]=(0,c().kb)(i),S=(0,c().NZ)(x,r);let C=m.substring(0,S);const w=C[C.length-1],A=/[\s.]/.test(w);A&&(C=`${C}_`);const j=(0,p().p8)(),P=(0,p().TM)(j).tokenize(C).tokens,E=(0,p()._M)(j);E.input=P;const F=E.expression(),_=(0,u().f)(F);if(a().Q.isFail(_))return{value:void 0};const B=await(0,f()._)(_.value,s,x),{node:R}=B,D=P[P.length-1];let N=!1,L=P;void 0!==D&&(0,o().G)(D,j.IdentifierName)&&(L=[...L],L.pop(),N=!0);const V=E.computeContentAssist("expression",L),U=N?D.image.substring(0,D.image.length-(A?1:0)):void 0,H=(0,y().Kp)(R,S),Y=H.at(-1),K={inputPosition:r,mappedPosition:S,nodePath:H,callParameter:k(H,S)};if(P.find((e=>e.tokenType===j.UnclosedStringLiteral)))return K.completions=[],{value:K};const W=[],z=k(H,S),O={handleDataRequest:s.handleDataRequest,restrictUnaccessibleProperties:s.restrictUnaccessibleProperties,sourceProperty:s.sourceProperty,spaceId:s.spaceId,valueTypes:R.valueTypes,featureGates:s.featureGates};let G;for(let o=1;o<=5;o++){const e=(0,y().Kp)(R,S-o);if(G=e[e.length-1],void 0!==G)break}(null===(t=G)||void 0===t?void 0:t.kind)===g().NM.RecoveryNode&&(G=void 0);const $=void 0!==G,q=!G||G.kind===g().NM.Unary||G.kind===g().NM.Equality||G.kind===g().NM.Identifier,Q=!G||G.kind===g().NM.Equality||G.kind===g().NM.Identifier;for(const o of V){var Z,X,J,ee,te,ne,oe,ie,re;if(o.nextTokenType===j.IdentifierName||o.nextTokenType===j.Dot){const e="dotMemberExpression"===o.ruleStack[o.ruleStack.length-1];if(Y&&e){if(Y.kind===g().NM.UnifiedFunctionProperty){const t=Y.expression;K.completionsInfo={type:"member dot receiver",prefix:U,receiverNode:t};const n=await v({prefix:U??"",context:O,receiverType:t.type,includeDeprecatedCompletions:l,dotMemberExpression:e});W.push(...n)}else if(I({nodeAtPosition:Y,dotMemberExpression:e})){K.completionsInfo={type:"member dot receiver",prefix:U,receiverNode:Y};const t=await v({prefix:U??"",context:O,receiverType:Y.type,includeDeprecatedCompletions:l,dotMemberExpression:e});W.push(...t)}}else{K.completionsInfo={type:"free identifier",prefix:U};const t=await v({prefix:U??"",context:O,includeDeprecatedCompletions:l,dotMemberExpression:e});if(W.push(...t),z&&(z.expression.kind===g().NM.UnifiedFunctionProperty&&0===z.parameterIndex||z.expression.kind===g().NM.Identifier&&1===z.parameterIndex)){const e=z.expression.kind===g().NM.UnifiedFunctionProperty?z.expression.name:z.expression.text,t=h().LP[e];if(((null==t?void 0:t.parameters)===h().Ux||(null==t?void 0:t.parameters)===h().MB)&&b(U??"",d().CURRENT_VALUE_NAME)&&U!==d().CURRENT_VALUE_NAME&&U!==`${d().CURRENT_VALUE_NAME}.`){var ae,se;const e=z.expression,t="function"===e.type.type&&"array"===(null===(ae=e.type.boundTargetType)||void 0===ae?void 0:ae.type)&&(null===(se=e.type.boundTargetType)||void 0===se?void 0:se.of)||{type:"unknown"};W.push({kind:d().FormulaEditorInfoCompletionKind.Binding,text:d().CURRENT_VALUE_NAME,type:t}),W.push({kind:d().FormulaEditorInfoCompletionKind.Binding,text:d().CURRENT_INDEX_NAME,type:{type:"number"}})}}}}else if(o.nextTokenType===j.AdditionOperator&&$&&(null==Y?void 0:Y.type.type)!==g().NM.Array&&"text"===(null===(Z=G)||void 0===Z?void 0:Z.type.type)){const e=M(["+"],U??"");W.push(...e)}else if(o.nextTokenType===j.AdditionOperator&&$&&(null==Y?void 0:Y.type.type)!==g().NM.Array&&"number"===(null===(X=G)||void 0===X?void 0:X.type.type)){const e=M(["+","-"],U??"");W.push(...e)}else if(o.nextTokenType===j.MultiplicationOperator&&$&&(null==Y?void 0:Y.type.type)!==g().NM.Array&&"number"===(null===(J=G)||void 0===J?void 0:J.type.type)){const e=M(["*","/"],U??"");W.push(...e)}else if(o.nextTokenType!==j.RelationalOperator||!$||(null==Y?void 0:Y.type.type)===g().NM.Array||"number"!==(null===(ee=G)||void 0===ee?void 0:ee.type.type)&&"text"!==(null===(te=G)||void 0===te?void 0:te.type.type)&&"date"!==(null===(ne=G)||void 0===ne?void 0:ne.type.type)){if(o.nextTokenType===j.EqualityOperator&&$&&null!==(oe=G)&&void 0!==oe&&oe.type.type&&"unknown"!==(null===(ie=G)||void 0===ie?void 0:ie.type.type)){const e=M(["==","!="],U??"");W.push(...e)}else if(o.nextTokenType===j.BooleanLiteral&&q){const e=M(["true","false"],U??"");W.push(...e)}else if(o.nextTokenType===j.And&&$&&"checkbox"===(null===(re=G)||void 0===re?void 0:re.type.type)){const e=M(["and","or"],U??"");W.push(...e)}else if(o.nextTokenType===j.UnaryOperator&&Q){const e=M(["not"],U??"");W.push(...e)}}else{const e=M([">",">=","<","<="],U??"");W.push(...e)}}const le=null===(n=P[P.length-1])||void 0===n?void 0:n.tokenType;if(0===W.length&&le===j.IdentifierName){const e=P.slice(-4).reverse(),t=[];for(let o=0;o<e.length;o++){var ue;if((null===(ue=e[o])||void 0===ue?void 0:ue.tokenType)!==j.IdentifierName)break;const n=N?e[o].image.substring(0,e[o].image.length-(A?1:0)):void 0;void 0!==n&&(0===o?t.push(n):t.push(n+t[o-1]))}let n=[];for(let o=1;o<t.length;o++){const e=t[o],i=await v({prefix:e.trim(),context:O,includeDeprecatedCompletions:l,dotMemberExpression:!1});if(i.length>0){n=i.map((t=>({...t,overridePrefixLength:e.length+o})))}}W.push(...n)}return K.completions=W.sort(((e,t)=>{const n=e.kind,o=t.kind;return T[n]-T[o]})),{value:K}}function M(e,t){return e.filter((e=>b(t,e))).map((e=>({kind:d().FormulaEditorInfoCompletionKind.Builtin,builtin:e})))}},79118:(e,t,n)=>{n.d(t,{Eo:()=>x,Fz:()=>m,KI:()=>s,M4:()=>u,YW:()=>k,iY:()=>T,mO:()=>f,qE:()=>d,vm:()=>y});var o=()=>n(604995),i=()=>n(247331),r=()=>n(239381);const a=(0,n(69708).YK)({buttonAutomationCurrentUserDescription:{defaultMessage:"The user who clicked this button",id:"automations.contextValue.buttonAutomationCurrentUserDescription"},buttonAutomationCurrentUserName:{defaultMessage:"Whoever clicked",id:"automations.contextValue.buttonAutomationCurrentUserName"},buttonAutomationCurrentUserTooltip:{defaultMessage:"The person who clicked the button",id:"automations.contextValue.buttonAutomationCurrentUserTooltip"},buttonAutomationThisPageDescription:{defaultMessage:"The page containing this button",id:"automations.contextValue.buttonAutomationThisPageDescription"},buttonAutomationThisPageName:{defaultMessage:"This page",id:"automations.contextValue.buttonAutomationThisPageName"},buttonAutomationThisPageTooltip:{defaultMessage:"The page containing this button",id:"automations.contextValue.buttonAutomationThisPageTooltip"},eventAutomationCurrentUserDescription:{defaultMessage:"The user who made the edit that triggered this automation to run.",id:"automations.contextValue.eventAutomationCurrentUserDescription"},eventAutomationCurrentUserName:{defaultMessage:"Whoever triggered",id:"automations.contextValue.eventAutomationCurrentUserName"},eventAutomationCurrentUserTooltip:{defaultMessage:"The person whose action triggered this automation",id:"automations.contextValue.eventAutomationCurrentUserTooltip"},eventAutomationThisPageDescription:{defaultMessage:"The page that was edited to trigger this automation to run.",id:"automations.contextValue.eventAutomationThisPageDescription"},eventAutomationThisPageName:{defaultMessage:"Trigger page",id:"automations.contextValue.eventAutomationThisPageName"},eventAutomationThisPageTooltip:{defaultMessage:"The page that triggered this automation",id:"automations.contextValue.eventAutomationThisPageTooltip"},now:{id:"automations.triggers.now.label",defaultMessage:"Time triggered"},nowDescription:{id:"automations.triggers.now.description",defaultMessage:"The time when this automation begins to run."},nowTooltip:{id:"automations.triggers.now.tooltip",defaultMessage:"The time this automation was triggered"},pageCreator:{id:"automations.triggers.pageCreator.label",defaultMessage:"Page creator"},pageCreatorDescription:{id:"automations.triggers.pageCreator.description",defaultMessage:"The user who created the page that was edited to trigger this automation to run."},pageCreatorTooltip:{id:"automations.triggers.pageCreator.tooltip",defaultMessage:"Person who created page"},today:{id:"automations.triggers.today.label",defaultMessage:"Date triggered"},todayDescription:{id:"automations.triggers.today.description",defaultMessage:"The date when this automation begins to run."},todayTooltip:{id:"automations.triggers.today.tooltip",defaultMessage:"The date this automation was triggered"}});function s(){return(0,r().$y)({source:"global",global:"button_page"})}function l(e,t,n){return{description:n,name:e,tooltip:t,compile:(o,r)=>({description:n?o.formatMessage(n):void 0,id:s(),kind:i().FormulaContextValueKind.ContextValue,name:o.formatMessage(e),tooltipName:o.formatMessage(t),type:{collection:r,type:"block"}}),evaluate:e=>({kind:i().FormulaContextValueKind.ContextValue,id:s(),value:{type:"block",value:e}})}}const u=l(a.buttonAutomationThisPageName,a.buttonAutomationThisPageTooltip,a.buttonAutomationThisPageDescription),d=l(a.eventAutomationThisPageName,a.eventAutomationThisPageTooltip,a.eventAutomationThisPageDescription);function c(){return(0,r().$y)({source:"global",global:"current_user"})}function p(e,t,n){return{description:n,name:e,tooltip:t,compile:o=>({description:n?o.formatMessage(n):void 0,id:c(),kind:i().FormulaContextValueKind.ContextValue,name:o.formatMessage(e),tooltipName:o.formatMessage(t),type:{type:"person"}}),evaluate:e=>({id:c(),kind:i().FormulaContextValueKind.ContextValue,value:{type:"person",value:e}})}}const m=p(a.buttonAutomationCurrentUserName,a.buttonAutomationCurrentUserTooltip,a.buttonAutomationCurrentUserDescription),f=p(a.eventAutomationCurrentUserName,a.eventAutomationCurrentUserTooltip,a.eventAutomationCurrentUserDescription);function g(){return(0,r().$y)({source:"global",global:"now"})}const y={description:a.nowDescription,name:a.now,tooltip:a.nowTooltip,compile(e){return{description:this.description?e.formatMessage(this.description):void 0,id:g(),kind:i().FormulaContextValueKind.ContextValue,name:e.formatMessage(this.name),tooltipName:this.tooltip?e.formatMessage(this.tooltip):void 0,type:{type:"date"}}},evaluate:e=>({id:g(),kind:i().FormulaContextValueKind.ContextValue,value:{type:"date",value:(0,o().KQ)(Date.now(),e)}})};function h(){return(0,r().$y)({source:"global",global:"today"})}const x={description:a.todayDescription,name:a.today,tooltip:a.todayTooltip,compile(e){return{description:this.description?e.formatMessage(this.description):void 0,id:h(),kind:i().FormulaContextValueKind.ContextValue,name:e.formatMessage(this.name),tooltipName:this.tooltip?e.formatMessage(this.tooltip):void 0,type:{type:"date"}}},evaluate:e=>({id:h(),kind:i().FormulaContextValueKind.ContextValue,value:{type:"date",value:(0,o().p6)(Date.now(),e)}})};function b(){return(0,r().$y)({source:"global",global:"page_creator"})}function v(e,t){return{description:a.pageCreatorDescription,name:e,tooltip:t,compile(n){return{description:this.description?n.formatMessage(this.description):void 0,id:b(),kind:i().FormulaContextValueKind.ContextValue,name:n.formatMessage(e),tooltipName:n.formatMessage(t),type:{type:"person"}}},evaluate:e=>({id:b(),kind:i().FormulaContextValueKind.ContextValue,value:{type:"person",value:e}})}}const k=v(a.pageCreator,a.pageCreatorTooltip),T=v(a.pageCreator,a.pageCreatorTooltip)},103966:(e,t,n)=>{n.d(t,{Z:()=>d});var o=()=>n(496603),i=()=>n(534177),r=()=>n(416504),a=()=>n(519831),s=()=>n(79118);const l={type:"button",getCreatePermissions(e){const{parentPointer:t}=e;return[{minimumRole:"read_and_write",pointer:t,type:"record_permission"}]},getEditPermissions(e){const{automationModel:t}=e;return[{minimumRole:"read_and_write",pointer:t.getParentPointer(),type:"record_permission"}]},getManagePermissions(e){const{automationModel:t}=e;return[{minimumRole:"read_and_write",pointer:t.getParentPointer(),type:"record_permission"}]},getExecutePermissions(e){const{automationModel:t}=e;return[{minimumRole:"reader",pointer:t.getParentPointer(),type:"record_permission"}]},typecheck(e){const{automationModel:t,contextType:r,getRecordModel:l,intl:u}=e,d=s().Fz.compile(u),c=s().vm.compile(u),p=s().Eo.compile(u),m=t.getParentPointer();let f,g;if("button_block"===r){if(e.pageBlockModel){const t=(0,n(236162).SH)({block:e.pageBlockModel,getRecordModel:l});f=s().M4.compile(u,null==t?void 0:t.pointer),g=s().YW.compile(u)}}else if("button_property"===r){const e=l(m);if((null==e?void 0:e.table)!==a().Vl)return{error:new(n(322867).N9)(`Unable to load automation parent: ${n(696706).L3.toKey(m)}`)};f=s().M4.compile(u,e.pointer),g=s().YW.compile(u)}else(0,i().HB)(r);return{value:{valueTypes:(0,o().oE)([d,c,p,f,g])}}},execute(e){const{formulaVariableResolution:t}=e,{executingUserPointer:n,executingUserTimeZone:i,thisPageBlockModel:a}=t??{},l=a?s().M4.evaluate(a.pointer):void 0,u=null==a?void 0:a.getCreatedByPointer(),d=u?s().YW.evaluate(u):void 0,c=n?s().Fz.evaluate(n):void 0,p=(0,r().P)(),m=s().vm.evaluate(i??p),f=s().Eo.evaluate(i??p);return{value:{values:(0,o().oE)([l,d,c,m,f])}}},isAvailableForContext:e=>!0};n(944114);const u={button:l,event:{type:"event",getCreatePermissions(e){const{parentPointer:t,spacePointer:n}=e;return[{minimumRole:"editor",pointer:t,type:"record_permission"},{minimumRole:"read_and_write",pointer:n,type:"record_permission"}]},getEditPermissions(e){const{automationModel:t}=e,o=[{minimumRole:"editor",pointer:t.getParentPointer(),type:"record_permission"},{minimumRole:"read_and_write",pointer:t.getSpacePointer(),type:"record_permission"}],r=t.getTrigger();if("event"===r.type){const e=r.event;(0,i().O9)(e.source)&&"filter"!==e.source.type&&(e.source.type===a().Vl||e.source.type===n(869558).Gy?o.push({minimumRole:"reader",pointer:e.source.pointer,type:"record_permission"}):(0,i().HB)(e.source))}return o},getManagePermissions(e){const{automationModel:t}=e;return[{minimumRole:"editor",pointer:t.getParentPointer(),type:"record_permission"},{minimumRole:"read_and_write",pointer:t.getSpacePointer(),type:"record_permission"}]},getExecutePermissions(e){const{automationModel:t}=e;return[{minimumRole:"reader",pointer:t.getParentPointer(),type:"record_permission"}]},typecheck(e){const{automationModel:t,intl:n}=e,i=s().mO.compile(n),r=s().iY.compile(n),l=s().vm.compile(n),u=s().Eo.compile(n),d=t.getParentPointer();let c;return d.table===a().Vl&&(c=s().qE.compile(n,d)),{value:{valueTypes:(0,o().oE)([i,r,l,u,c])}}},execute(e){const{formulaVariableResolution:t}=e,{executingUserPointer:n,executingUserTimeZone:a,thisPageBlockModel:l}=t??{},u=l?s().qE.evaluate(l.pointer):void 0,d=n?s().mO.evaluate(n):void 0,c=(0,r().P)(),p=s().vm.evaluate(a??c),m=null==l?void 0:l.getCreatedByPointer(),f=(0,i().O9)(m)?s().iY.evaluate(m):void 0,g=s().Eo.evaluate(a??c);return{value:{values:(0,o().oE)([u,d,p,g,f])}}},isAvailableForContext:e=>!!e.actorOnlyEditedUnaliveColumns||e.hasPremiumAutomations},recurrence:{type:"recurrence",getCreatePermissions(e){const{parentPointer:t}=e;return[{minimumRole:"read_and_write",pointer:t,type:"record_permission"}]},getEditPermissions(e){const{automationModel:t}=e;return[{minimumRole:"read_and_write",pointer:t.getParentPointer(),type:"record_permission"}]},getManagePermissions(e){const{automationModel:t}=e;return[{minimumRole:"read_and_write",pointer:t.getParentPointer(),type:"record_permission"}]},getExecutePermissions(e){const{automationModel:t}=e;return[{minimumRole:"reader",pointer:t.getParentPointer(),type:"record_permission"}]},typecheck(e){const{intl:t}=e;return{value:{valueTypes:[s().vm.compile(t),s().Eo.compile(t)]}}},execute(e){const{formulaVariableResolution:t}=e,{executingUserTimeZone:n}=t??{},o=(0,r().P)();return{value:{values:[s().vm.evaluate(n??o),s().Eo.evaluate(n??o)]}}},isAvailableForContext(e){const{automation:t,automationActions:o,hasPremiumAutomations:r}=e;if(t.parent_table===n(179034).ev)return!0;if(t.parent_table===a().Vl){const e=n(388821).RecordMap.create();for(const t of o)e.addModel(t);return!!t.isCompleteSprintAutomation({getRecordModel:n(792071).b4_.fromRecordMap(e)})||r}(0,i().HB)(t.parent_table)}}};function d(e){return u[e]}},112698:(e,t,n)=>{n.d(t,{B:()=>h});n(296540);var o=()=>n(907258),i=()=>n(755531),r=()=>n(726637),a=()=>n(484714),s=()=>n(590526),l=()=>n(401497),u=()=>n(26697),d=()=>n(69708),c=()=>n(100622),p=()=>n(534177),m=()=>n(284371),f=()=>n(824160),g=()=>n(991249),y=n(474848);function h({upsell:e,mobileStyle:t,desktopStyle:n,analyticsName:c,onClick:m,disableTooltip:h}){const b=(0,l().eP)(),v=(0,a().v3)(),{device:k}=v,T=(0,s().K8)((()=>{const{sidebarSpaceStore:e}=o().default.state;return null==e?void 0:e.canAdmin()}),[]);if("none"===e.type)return null;if(k.isMobileNative)return null;const I=(()=>{switch(e.product){case"personal":return(0,y.jsx)(d().sA,{defaultMessage:"Personal Pro",id:"upgradeButton.personal.text"});case"plus":return(0,y.jsx)(d().sA,{defaultMessage:"Plus ↗",id:"upgradeButton.plus.textWithArrow"});case"business":return(0,y.jsx)(d().sA,{defaultMessage:"Business ↗",id:"upgradeButton.business.textWithArrow"});case"enterprise":return(0,y.jsx)(d().sA,{defaultMessage:"Enterprise ↗",id:"upgradeButton.enterprise.textWithArrow"});case"ai":return(0,y.jsx)(d().sA,{defaultMessage:"AI ↗",id:"upgradeButton.ai.textWithArrow"});case"ai_credit_pack":return(0,y.jsx)(d().sA,{defaultMessage:"AI Credit Pack ↗",id:"upgradeButton.ai_credit_pack.textWithArrow"});case"sites_custom_hostnames":return(0,y.jsx)(d().sA,{defaultMessage:"Custom Hostnames ↗",id:"upgradeButton.sites_custom_hostnames.textWithArrow"});default:e.product,(0,p().HB)(e.product)}})();return r().A.isMobile||!T?(0,y.jsx)(f().A,{mobileStyle:t,children:I}):(0,y.jsx)(u().m,{delayThreshold:120,disableTooltip:h,placement:"bottom",renderTooltip:()=>(0,y.jsx)("div",{style:{maxWidth:500},children:(0,y.jsx)(d().sA,{defaultMessage:"Upgrade to use this feature.",id:"premiumFeatureUpgradeButton.upgrade.tooltip"})}),originGap:6,render:t=>(0,y.jsx)(f().A,{desktopStyle:n,innerStyle:x(e.product,b),onClick:t=>function(e,t,n,o,r){g().K(o,{from:t,upsell:n,spaceStore:(0,i().S)()}),r&&r(e)}(t,c,e,v,m),...t,children:I})})}function x(e,t){switch(e){case"plus":case"business":case"enterprise":return{color:c().Tj.blue.text.accentPrimary,background:"light"===t?c().oZ.diffBackground:"rgba(35, 131, 226, 0.2)",fontWeight:m().Wy.medium};default:return{}}}},129574:(e,t,n)=>{n.d(t,{v:()=>ui});n(944114),n(517642),n(658004),n(733853),n(845876),n(432475),n(515024),n(731698),n(898992),n(354520),n(803949),n(581454);var o=n(296540),i=()=>n(564884),r=()=>n(59226),a=()=>n(242422),s=()=>n(782482),l=()=>n(726637),u=()=>n(787470),d=()=>n(484714),c=()=>n(951500),p=()=>n(852507),m=()=>n(118884),f=()=>n(590526),g=()=>n(401497),y=()=>n(79926),h=()=>n(267956),x=()=>n(755125),b=()=>n(547033),v=()=>n(906536),k=()=>n(465628),T=()=>n(232615),I=()=>n(563015),S=()=>n(106714),M=()=>n(349835),C=()=>n(239381),w=()=>n(416504),A=()=>n(591779),j=()=>n(96689),P=()=>n(201980),E=()=>n(69708),F=()=>n(100622),_=()=>n(496603),B=()=>n(973647),R=()=>n(534177),D=()=>n(862292),N=()=>n(884107),L=()=>n(89053),V=()=>n(991114),U=()=>n(949305),H=()=>n(29923);class Y extends H().R{constructor(){super({key:"formula_assistant_visible",namespace:"formula_editor",important:!0,trackingType:"necessary"})}getIsAssistantVisible(){return this.state??!0}toggleAssistant(){this.setState(!this.getIsAssistantVisible())}}const K=new Y;var W=()=>n(164891),z=()=>n(528093),O=()=>n(483795),G=()=>n(882990),$=()=>n(158489),q=()=>n(898244),Q=()=>n(713998),Z=()=>n(638681);const X=Z().union([Z().object({required:{type:Z().literal("formula"),formula:Z().string()},optional:{format:Z().union([Z().literal("number"),Z().literal("bar"),Z().literal("ring")])},exact:!0}),Z().object({required:{type:Z().literal("chat"),message:Z().string()},optional:{},exact:!0}),Z().object({required:{type:Z().literal("retry")},optional:{},exact:!0})]);var J=()=>n(388821),ee=()=>n(450648),te=()=>n(179034),ne=()=>n(519831),oe=()=>n(155792),ie=()=>n(798880),re=()=>n(720665),ae=()=>n(671593),se=()=>n(348869),le=()=>n(634054),ue=()=>n(962753),de=()=>n(594794),ce=()=>n(295304),pe=()=>n(547149);function me(e){var t;const{clipboardActions:n,formulasModule:o,store:i,transaction:r}=e,a=n.getFormulaEditorInformation();if(!a)return;if(!("editing"===T().default.state.mode&&(null===(t=(0,k().H)(T().default.state.multiSelection))||void 0===t?void 0:t.selection)))return;const s=i.getValue();if(!s)return;const l=o.textValueToFormulaTokens({formulasModule:o,getRecordModel:i.getRecordModel,textValue:s,featureGates:(0,L().i)(),valueTypes:a.valueTypes,spaceId:a.spaceId});(0,ce().R9)({environment:i.environment,store:i,value:l,transaction:r})}const{MAX_RECURSION_DEPTH:fe,MAX_RECORDS_PER_COLLECTION:ge,MAX_TOTAL_COLLECTIONS:ye}={MAX_RECURSION_DEPTH:3,MAX_RECORDS_PER_COLLECTION:3,MAX_TOTAL_COLLECTIONS:10};async function he(e){const{environment:t,collectionStore:n,recordMap:o,collectionModel:i,visitedCollections:r,depth:a=0}=e;if(a>=fe||r.has(i.id)||r.size>=ye)return;r.add(i.id),o.addModel(i);const s=i.getNormalizedSchema(),l=[],u=[];for(const[m,f]of Object.entries(s))if(f&&"relation"===f.type){const e=(0,q().Nv)(f);if(!e)continue;const t=n.getRecordModel(e);t&&(l.push(m),u.push(t))}const d=await async function(e){const{collectionModel:t,collectionStore:n,environment:o}=e,i=t.getSpaceShardedPointer(),r=await le().mA(o,{source:"assistant",parentRecordStore:n,collectionPointer:i,limit:ge});if(B().Q.isFail(r))return[];const a=r.value.blockIds.slice(0,ge),s=[];for(const l of a){const e=n.getRecordModel({table:te().ev,id:l});e&&s.push(e)}return s}({collectionModel:i,collectionStore:n,environment:t});for(const m of d)o.addModel(m);const c=function(e){const{blockModels:t,collectionSchema:n,collectionStore:o}=e;if(!t||0===t.length)return[];const i=[];for(const r of t){const e=r.getProperties();for(const[t,r]of Object.entries(n)){if(!r||"person"!==r.type||!e[t])continue;const n=(0,P().Fbh)(e[t]);for(const e of n){const t=o.getRecordModel({table:ie().oo,id:e});t&&i.push(t)}}}return i}({blockModels:d,collectionSchema:s,collectionStore:n});for(const m of c)o.addModel(m);const p=function(e){const{collectionStore:t,relationPropertyIds:n,blockModels:o}=e,i=[];for(const r of o){const e=r.getProperties();for(const t of n){const n=e[t];n&&i.push(...(0,Q().n)(n))}}return i.map((e=>t.getRecordModel(e))).filter((e=>void 0!==e))}({collectionStore:n,relationPropertyIds:l,blockModels:d});for(const m of p)o.addModel(m);for(const m of u){if(r.size>=ye)break;await he({environment:t,collectionStore:n,recordMap:o,collectionModel:m,visitedCollections:r,depth:a+1})}}async function xe(e){const{environment:t,spaceId:n,userPrompt:o,formulaErrors:i,existingFormula:r,typecheckContext:a,formulaResult:s,returnType:l}=e,u=J().RecordMap.create(),d={formula_null_check:a.featureGates.formula_null_check??!1,formula_dependency_limits:!1,formula_compiler_diff_rate:0,formulas_disabled_functions:a.featureGates.formulas_disabled_functions??[],collections_text_sort_locale_collator:a.featureGates.collections_text_sort_locale_collator??!1,edge_relations:a.featureGates.edge_relations??!1,formulas_pass_timezone_when_parsing_date:a.featureGates.formulas_pass_timezone_when_parsing_date??!1,formula_total_dependency_limit:1e6,formula_per_formula_dependency_limit:1e5,formula_total_dependency_warning_threshold:5e5,formula_per_formula_dependency_warning_threshold:5e4};let c;for(const p of a.valueTypes)"block"===p.type.type&&p.type.collection&&(c=p.type.collection.id);if(c){const e={table:ne().Vl,id:c,spaceId:n},o=new(G().y)(t,e),i=o.getModel();i&&await he({environment:t,collectionStore:o,recordMap:u,collectionModel:i,visitedCollections:new Set,depth:0})}return[{id:(0,de().Z1)({environment:t,table:oe().mS,spaceId:n}),type:"config",value:{type:"formulas",formulaErrors:i,existingFormula:r,valueTypes:a.valueTypes,sourceProperty:a.sourceProperty,collectionFeatureGates:d,formulaResult:s,returnType:l,collectionId:c}},{id:(0,de().Z1)({environment:t,table:oe().mS,spaceId:n}),type:"agent-record-map",threadRecordMap:(0,$().he)(u)},{id:(0,de().Z1)({environment:t,table:oe().mS,spaceId:n}),type:"user",value:[[o]],userId:t.currentUser.id??""}]}var be=()=>n(907258),ve=()=>n(699143),ke=()=>n(874832),Te=()=>n(758304),Ie=()=>n(493552),Se=()=>n(108184),Me=()=>n(639919),Ce=()=>n(103975),we=()=>n(135221),Ae=()=>n(729368),je=()=>n(366437),Pe=()=>n(29554),Ee=()=>n(330966),Fe=()=>n(301421),_e=()=>n(260850),Be=()=>n(292985);const Re=5;function De({scrollableRef:e,environment:t}){const[n,i]=(0,o.useState)(!0),[r,a]=(0,o.useState)(!0),s=(0,o.useCallback)((()=>{const t=e.current;if(!t)return;const n=t.scrollHeight-t.scrollTop-t.clientHeight<Re;i(n),!n&&r&&a(!1),n&&!r&&a(!0)}),[e,r]);(0,o.useEffect)((()=>{const t=e.current;if(!t)return;t.addEventListener("scroll",s);const n=new MutationObserver((()=>{s(),r&&(t.scrollTop=t.scrollHeight)}));return n.observe(t,{childList:!0,subtree:!0,characterData:!0}),s(),()=>{t.removeEventListener("scroll",s),n.disconnect()}}),[s,e,r]);const l=(0,o.useCallback)(((n="smooth")=>{const o=e.current;o&&(0,Be().V)({element:o,environment:t,options:{top:o.scrollHeight,behavior:n}})}),[e,t]),u=(0,o.useCallback)((()=>{l(),a(!0)}),[l]);return{isScrolledToBottom:n,shouldAutoScroll:r,scrollToBottom:l,scrollToBottomAndSetAutoscroll:u}}var Ne=()=>n(756117),Le=()=>n(312788),Ve=()=>n(807449),Ue=()=>n(695115),He=()=>n(265060),Ye=()=>n(26697),Ke=()=>n(765974),We=()=>n(846523),ze=()=>n(284371),Oe=()=>n(704658),Ge=n(474848);const $e=(0,E().YK)({learnMore:{id:"infoBanner.learnMore",defaultMessage:"Learn more"}});function qe(e){const{navigate:t}=(0,o.useContext)(Le().E),{upsellMessage:n,isInferenceDown:i,upgradeButtonTextProps:r,isUpgradeSystemEnabled:a}=e,s=(0,d().v3)(),l=(0,E().tz)(),u=(0,o.useMemo)((()=>{if(i)return()=>{t({environment:s,url:"https://www.notion-status.com",openInNew:"tab"})}}),[i,s,t]),c=(0,o.useMemo)((()=>i?(0,Ge.jsx)(E().sA,{...Me().$.cannotSubmitMessageSeeStatusPage}):a?r?(0,Ge.jsx)(Oe().UpgradeButton,{...r}):null:n),[i,n,a,r]),p=Boolean(a?r:n)||i,m=(0,g().IS)((()=>({inlineErrorContainer:{marginBottom:-12,position:"relative",display:"flex",flexDirection:"column",zIndex:-1},inlineError:{backgroundColor:i?F().Tj.red.background.primary:F().Tj.background.secondary,color:i?F().Tj.red.text.primary:F().Tj.text.secondary,fontWeight:ze().Wy.medium,borderStartStartRadius:10,borderStartEndRadius:10,borderEndEndRadius:0,borderEndStartRadius:0,paddingTop:8,paddingInlineEnd:16,paddingBottom:18,paddingInlineStart:16,display:"flex",alignItems:"center",fontSize:"12px",width:"100%",border:"none",justifyContent:"space-between",position:"relative",overflow:"hidden"},inlineErrorContent:{display:"flex",alignItems:"center",gap:8,flex:1},warningIcon:{fill:i?F().Tj.red.text.primary:F().Tj.text.secondary},messageAndInfoWrapper:{display:"flex",alignItems:"center",gap:8,flex:1},inlineErrorText:{textWrap:"pretty"},learnMoreIcon:{fill:i?F().Tj.red.text.primary:F().Tj.text.secondary},inlineErrorExtension:{position:"absolute",bottom:0,insetInlineStart:0,insetInlineEnd:0,height:32,zIndex:-1}})),[i]),f=(0,o.useMemo)((()=>({visible:p,initial:{opacity:0,translateY:40},animate:{opacity:p?1:0,translateY:p?0:40},exit:{opacity:0,translateY:40},config:{duration:300}})),[p]);return(0,Ge.jsx)(Ne().A,{visible:f.visible,initial:f.initial,animate:f.animate,exit:f.exit,config:f.config,children:(0,Ge.jsx)("div",{style:m.inlineErrorContainer,children:(0,Ge.jsxs)("div",{style:m.inlineError,children:[(0,Ge.jsxs)("div",{style:m.inlineErrorContent,children:[i?(0,Ge.jsx)(Ve().I,{icon:Ke().exclamationMarkTriangleFillIcon,size:"sm",style:m.warningIcon}):null,(0,Ge.jsxs)("div",{style:m.messageAndInfoWrapper,children:[(0,Ge.jsx)("div",{style:m.inlineErrorText,children:c}),u?(0,Ge.jsx)(Ye().m,{renderTooltip:()=>l.formatMessage($e.learnMore),render:e=>(0,Ge.jsx)(Ue().A,{onClick:u,icon:()=>(0,Ge.jsx)(He().Q,{iconGroup:We().u,variantName:"default",size:"lg",colorVariant:"secondary",style:m.learnMoreIcon}),ariaLabel:l.formatMessage($e.learnMore),size:"xs",...e})}):void 0]})]}),(0,Ge.jsx)("div",{style:m.inlineErrorExtension})]})})})}var Qe=()=>n(718827),Ze=()=>n(613601),Xe=()=>n(322972),Je=()=>n(557943),et=()=>n(128933),tt=()=>n(769864),nt=()=>n(669358),ot=()=>n(394888),it=()=>n(89002),rt=()=>n(31511),at=()=>n(687681),st=()=>n(241021),lt=()=>n(838239),ut=()=>n(227358),dt=()=>n(342461);const ct=(0,E().YK)({feedbackModalTitleThumbsDown:{id:"formulaAssistant.feedbackModal.titleThumbsDown",defaultMessage:"How can we improve this result?"},feedbackModalTitleThumbsUp:{id:"formulaAssistant.feedbackModal.titleThumbsUp",defaultMessage:"What was good about this result?"},feedbackModalDescription:{id:"formulaAssistant.feedbackModal.description",defaultMessage:"Your feedback helps Notion AI improve. Your prompt, formula, relevant database information, and feedback will be shared with Notion."},sendFeedbackButton:{id:"formulaAssistant.sendFeedbackButton",defaultMessage:"Send feedback"},feedbackPlaceholder:{id:"formulaAssistant.feedbackPlaceholder",defaultMessage:"Share your feedback"},submitSuccess:{id:"formulaAssistant.submitSuccess",defaultMessage:"Your feedback has been submitted, thanks!"}});function pt(e){const{onSubmit:t,feedbackType:n}=e,i=(0,E().tz)(),[r,a]=(0,o.useState)(""),s=(0,o.useCallback)((()=>{t({feedback:r,submitted:!0}),et().D6({label:i.formatMessage(ct.submitSuccess)})}),[r,i,t]);return(0,Ge.jsx)(it().t,{header:(0,Ge.jsx)(lt().Y,{iconAndTitle:(0,Ge.jsx)("div",{style:{padding:"0 24px"},children:(0,Ge.jsx)(ut().Z,{iconGroup:at().u,title:i.formatMessage("thumbs_up"===n?ct.feedbackModalTitleThumbsUp:ct.feedbackModalTitleThumbsDown)})}),description:i.formatMessage(ct.feedbackModalDescription)}),footer:(0,Ge.jsx)(st().a,{layout:"vertical",primaryButtons:[{label:i.formatMessage(ct.sendFeedbackButton),onClick:s}]}),children:(0,Ge.jsx)(ve().Y1,{padding:2,children:(0,Ge.jsx)(rt().A,{placeholder:i.formatMessage(ct.feedbackPlaceholder),textarea:!0,focusAfterAnimation:!0,value:r,onChange:e=>a(e.target.value),textareaSubmitOnEnter:!0,onSubmit:e=>{e.preventDefault(),e.stopPropagation(),s()}})})})}const mt=(0,E().YK)({feedbackSuccess:{id:"formulaInferenceFeedback.success",defaultMessage:"Thank you for your feedback!"}});function ft(e){const{traceId:t,spaceId:n}=e??{},i=(0,f().K8)((()=>t?nt().A.state[t]??void 0:void 0),[t]),r=(0,E().tz)(),a=(0,d().v3)(),s=(0,o.useCallback)((async e=>{if(!t||!n)return;if(void 0===e)return void nt().A.update((e=>({...e,[t]:void 0})));let o="";const i=await async function(e){return await(0,dt().showAsyncModal)((t=>(0,Ge.jsx)(ot().s,{isOpen:t.isOpen,onDismiss:t.onDismiss,onClosed:t.onClosed,areaConstraint:{width:{type:"fixed",length:400}},render:()=>(0,Ge.jsx)(pt,{onSubmit:t.resolve,feedbackType:e})})))}(e);i&&i.submitted&&(o=i.feedback,nt().A.update((n=>({...n,[t]:e}))),et().D6({label:r.formatMessage(mt.feedbackSuccess)}),tt().callApi({eventName:"saveInferenceTranscriptFeedback",environment:a,data:{spaceId:n,type:"formulas",traceId:t,feedbackType:e,userComment:o}}))}),[a,n,t,r]);return[i,s]}function gt(e){const{spaceId:t,traceId:n}=e,[i,r]=ft({spaceId:t,traceId:n}),a=(0,g().IS)((()=>({feedbackButtons:{gap:2,display:"flex",color:F().Tj.icon.secondary},thumbsDownIcon:{transform:"rotate(180deg)"}})),[]),s=(0,E().tz)(),l=(0,o.useCallback)((()=>{r("thumbs_down"===i?void 0:"thumbs_down")}),[i,r]),u=(0,o.useCallback)((()=>{r("thumbs_up"===i?void 0:"thumbs_up")}),[i,r]);return(0,Ge.jsxs)("div",{style:a.feedbackButtons,children:[(0,Ge.jsx)(Ue().A,{icon:"thumbs_up"===i?Xe().P:Je().s,size:"sm",ariaLabel:s.formatMessage({id:"formula.feedback.thumbsUp",defaultMessage:"This formula is helpful"}),onClick:e=>{e.stopPropagation(),u()}}),(0,Ge.jsx)(Ue().A,{icon:"thumbs_down"===i?Xe().P:Je().s,iconStyle:a.thumbsDownIcon,size:"sm",ariaLabel:s.formatMessage({id:"formula.feedback.thumbsDown",defaultMessage:"This formula is not helpful"}),onClick:e=>{e.stopPropagation(),l()}})]})}var yt=()=>n(132855),ht=()=>n(340498),xt=()=>n(286088),bt=()=>n(35392);function vt(e){const t=(0,E().tz)(),{onSubmit:n,canSend:o}=e,i=(0,xt().q2)(),r=(0,d().WS)(),a=t.formatMessage({id:"completions.CompletionMenuActionBar.sendTooltip",defaultMessage:"Send to AI"});return(0,Ge.jsx)(Ye().m,{renderTooltip:()=>(0,Ge.jsxs)("div",{children:[a,(0,Ge.jsx)(bt().A,{style:i.keyboardShortcutInverted,name:"enter"})]}),placement:"bottom",render:e=>(0,Ge.jsx)(Ue().A,{icon:yt().arrowInCircleUpFillIcon,onClick:n,colorPalette:o?"blue":void 0,colorVariant:o?"accentPrimary":"secondary",disabled:!o,iconStyle:{height:r?ht().lD.lg:ht().Ev.lg,width:r?ht().lD.lg:ht().Ev.lg},ariaLabel:a,style:{pointerEvents:"auto",height:r?24:20,width:r?24:20},...e})})}function kt(e){const{assistantState:t,spaceId:n,canSubmit:o,hasModifiedFormula:i,onStop:r,onBack:a,onRevert:s,onSubmit:l}=e;switch(t.type){case"input":return(0,Ge.jsxs)(Ge.Fragment,{children:[i?(0,Ge.jsx)(Mt,{onUndo:s}):void 0,t.latestTraceId?(0,Ge.jsx)(gt,{spaceId:n,traceId:t.latestTraceId}):void 0,(0,Ge.jsx)(It,{onSubmit:l,isEnabled:o})]});case"generating":return(0,Ge.jsx)(Tt,{onStop:r});case"refused":return t.isGenerating?(0,Ge.jsx)(Tt,{onStop:r}):(0,Ge.jsxs)(Ge.Fragment,{children:[(0,Ge.jsx)(gt,{spaceId:n,traceId:t.latestTraceId}),(0,Ge.jsx)(St,{onBack:a})]});case"error":return(0,Ge.jsxs)(Ge.Fragment,{children:[(0,Ge.jsx)(gt,{spaceId:n,traceId:t.latestTraceId}),(0,Ge.jsx)(St,{onBack:a})]});default:(0,R().HB)(t)}}function Tt(e){const{onStop:t}=e,n=(0,E().tz)(),o=(0,g().IS)((()=>({lightweightButton:{display:"flex",alignItems:"center",justifyContent:"center",padding:"2px 6px",borderRadius:6,height:26},cancelText:{fontSize:14,color:F().Tj.text.secondary},escText:{textTransform:"uppercase",fontWeight:ze().Wy.medium,fontSize:11,marginInlineStart:6,color:F().Tj.text.tertiary,display:l().A.isMobile?"none":"inline",lineHeight:"normal"}})),[]);return(0,Ge.jsx)(s().N,{debugName:"FormulaAssistantInput_CancelButton",capture:!l().A.isMobile,onEsc:t,priority:1,children:(0,Ge.jsx)(ve().Y1,{width:"hug",align:"center",children:(0,Ge.jsxs)(Qe().Ay,{style:o.lightweightButton,onClick:t,children:[(0,Ge.jsx)("span",{style:o.cancelText,children:n.formatMessage(Ct.cancelText)}),(0,Ge.jsx)("span",{style:o.escText,children:n.formatMessage(Ct.escText)})]})})})}function It(e){const{isEnabled:t,onSubmit:n}=e;return(0,Ge.jsx)(ve().Y1,{width:24,height:24,align:"center",style:{marginInlineStart:2},children:(0,Ge.jsx)(vt,{onSubmit:n,canSend:t})})}function St(e){const{onBack:t}=e,n=(0,E().tz)(),o=(0,g().IS)((()=>({backButtonStyle:{boxSizing:"border-box",display:"flex",flexDirection:"row",justifyContent:"center",alignItems:"center",padding:"4px 8px",gap:4,background:l().A.isMobile?F().Tj.background.primary:"transparent",boxShadow:l().A.isMobile?F().Tj.inputBoxShadow:void 0,border:l().A.isMobile?`1px solid ${F().Tj.border.primary}`:void 0,borderRadius:6,cursor:"pointer",fontSize:14,fontWeight:ze().Wy.medium,lineHeight:"20px",textAlign:"center",color:F().Tj.text.secondary,whiteSpace:"nowrap"}})),[]);return(0,Ge.jsx)(s().N,{debugName:"FormulaAssistantInput_BackButton",capture:!0,onEsc:t,priority:1,children:(0,Ge.jsx)(Ye().m,{renderTooltip:()=>(0,Ge.jsx)("div",{children:n.formatMessage(Ct.backButtonTooltip)}),placement:"bottom",render:e=>(0,Ge.jsx)(ve().Y1,{width:"hug",height:24,align:"center",children:(0,Ge.jsx)(Qe().Ay,{style:o.backButtonStyle,onClick:t,...e,children:n.formatMessage(Ct.backButton)})})})})}function Mt(e){const{onUndo:t}=e,n=(0,E().tz)(),o=(0,g().IS)((()=>({buttonStyle:{width:24,height:24}})),[]);return(0,Ge.jsx)(Ue().A,{colorVariant:"secondary",size:"sm",style:o.buttonStyle,onClick:t,ariaLabel:n.formatMessage(Ct.undoMessage),icon:Ze().arrowUTurnUpLeftSmallIcon})}const Ct=(0,E().YK)({cancelText:{id:"formulaAssistantInput.cancelText",defaultMessage:"Cancel"},escText:{id:"formulaAssistantInput.escText",defaultMessage:"esc"},backButton:{id:"formulaAssistantInput.backMobile",defaultMessage:"Back"},backButtonTooltip:{id:"formulaAssistantInput.backButtonTooltip",defaultMessage:"Press ESC to go back"},undoMessage:{id:"formulaAssistantInput.undo",defaultMessage:"Undo"}}),wt=10,At=20+2*wt,jt=32,Pt=(At-jt)/2,Et=10,Ft=Object.freeze({property:!0});function _t(e){const{assistantState:t,store:n,onSubmit:i,onChange:r,onBlur:a,onFocus:s,onBack:l}=e,u=(0,E().tz)(),c=(0,o.useMemo)((()=>{const e={thinking:[Dt.assistantIsThinking,Dt.assistantIsPondering,Dt.assistantIsReasoning],writing:[Dt.assistantIsWriting,Dt.assistantIsGenerating],fixing:[Dt.assistantIsFixing,Dt.assistantIsRepairing]},t={thinking:e.thinking[Math.floor(Math.random()*e.thinking.length)],writing:e.writing[Math.floor(Math.random()*e.writing.length)],fixing:e.fixing[Math.floor(Math.random()*e.fixing.length)]};return e=>{switch(e){case"thinking":return t.thinking;case"writing":return t.writing;case"fixing":return t.fixing;case"reading-errors":return Dt.assistantIsReadingErrors;default:(0,R().HB)(e)}}}),[]),p=(0,g().IS)((()=>({textContainer:{fontSize:14,lineHeight:"20px",color:F().Tj.text.primary,maxHeight:180,overflow:"auto",width:"100%"}})),[]),m=(0,o.useRef)(null);switch(De({scrollableRef:m,environment:(0,d().v3)()}),t.type){case"input":return(0,Ge.jsx)("div",{ref:m,style:p.textContainer,children:(0,Ge.jsx)(Ae().A,{disabled:!1,pasteBehavior:"plaintext",inPageFind:je().Os.none,store:n,placeholder:u.formatMessage(Dt.assistantPlaceholder),placeholderStyle:{cursor:"text"},disableEnter:!1,onEnter:i,onChange:r,onEsc:a,onBlur:a,onFocus:s,disableRichTextActions:!0,disableSlashCommands:!0,disableEmbedMenu:!0,disableComment:!0,disableSelectAllBlocks:!0,disableSelectionDrag:!0,disableMobileActionBar:!0,disableInsertedDeletedAnnotations:!0,disableSuggestEdit:!0,disableEmojiCommands:!0,disableStyleAnnotations:!0,disabledMentionTypes:Ft})});case"generating":return(0,Ge.jsxs)(Ge.Fragment,{children:[(0,Ge.jsx)(Te().N,{styleKey:"bodyRegular",colorVariant:"secondary",animate:!0,text:u.formatMessage(c(t.generatingStep))}),(0,Ge.jsx)(we().A,{isTriColored:!0})]});case"refused":return(0,Ge.jsx)(Ie().D,{styleKey:"bodyRegular",colorVariant:"secondary",onClick:l,children:t.refusalMessage});case"error":return(0,Ge.jsx)(Ie().D,{styleKey:"bodyRegular",colorVariant:"secondary",onClick:l,children:u.formatMessage(Dt.genericErrorMessage)});default:(0,R().HB)(t)}}function Bt(e){const{isLoading:t}=e;return t?(0,Ge.jsx)(Nt,{}):(0,Ge.jsx)(Rt,{...e})}function Rt(e){const{formulaAssistantStore:t,onStop:n,onSubmit:a,setFormulaValue:s,spaceId:l,currentFormulaTextValue:u,sessionId:c}=e,p=(0,d().v3)(),[m,y]=(0,o.useState)(!1),h=(0,f().K8)((()=>t.state.prompt),[t]),{store:b}=(0,O().AI)({initialValue:h,source:"formula"}),v=(0,f().O$)(t),k=(0,z()._)({name:"ai_formulas",spaceId:l,userId:p.currentUser.id,amount:1}),{upsellMessage:T}=(0,U().x)({featureAvailability:k,upsellFrom:"ai_formulas",showOptimisticUpsell:!1}),I=(0,Ee().o)({featureAvailability:k,source:"ai_formulas",type:"text"}),S=(0,r().X)("upgrade_system_ai"),M=null!==v.formulaBeforeLatestRequest&&v.formulaBeforeLatestRequest!==u,C=(0,f().K8)((()=>{var e;const t=null===(e=be().default.state.currentUserStore)||void 0===e?void 0:e.getModel();return!(!t||!Me().R.isInferenceTranscriptConfigTypeDown({configType:"formulas",spaceId:l,actor:t}))}),[l]),w=(0,f().K8)((()=>"input"===v.type&&(0,Pe().r4)(v.prompt,b).trim().length>0&&!C&&!(S?Boolean(I):T)),[v,C,T,S,I,b]),A=(0,o.useCallback)((()=>{requestAnimationFrame((()=>{const e=Fe().n.findNodeFromStore(b);e&&(e.focus(),(0,_e().z)({store:b}))}))}),[b]),j=(0,o.useCallback)((()=>{y(!0),A()}),[y,A]),P=(0,o.useCallback)((()=>{y(!1),(0,x().clear)({environment:p})}),[y,p]),E=(0,o.useCallback)((()=>{"input"===v.type&&null!==v.formulaBeforeLatestRequest&&(s(v.formulaBeforeLatestRequest),(0,i().u)({environment:p,event:{eventName:"formula_assistant_rejected",eventProperties:{formula_assistant_session_id:c}}}))}),[v,s,p,c]),_=(0,o.useCallback)((()=>{t.setPrompt(b.getValue()??[])}),[t,b]),B=(0,o.useCallback)((async()=>{w&&(await a((0,Pe().r4)(v.prompt,b)),A(),(0,Se().maybeUpdateAiEligibility)(p,l))}),[v.prompt,w,a,A,l,p,b]),D=(0,o.useCallback)((()=>{t.resetToInitial(),A()}),[t,A]),N=(0,o.useCallback)((()=>{n(),t.resetToInitial(),A(),(0,i().u)({environment:p,event:{eventName:"formula_assistant_stopped",eventProperties:{formula_assistant_session_id:c,assistant_state:"generating"===v.type?v.generatingStep:void 0}}})}),[n,A,p,c,v,t]),L=(0,g().IS)((()=>({outerContainer:{boxSizing:"border-box",width:"100%",background:F().Tj.background.elevated,boxShadow:F().Tj.shadowXS,minHeight:At,borderRadius:Et,position:"relative",paddingInline:8,display:"flex",gap:6},outerContainerFocused:{boxShadow:F().Tj.inputBlueFocusRing},buttonContainer:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"flex-end",height:jt,gap:2,marginTop:Pt}})),[]),V=(0,o.useMemo)((()=>{switch(v.type){case"generating":switch(v.generatingStep){case"thinking":return"thinking";case"writing":case"fixing":case"reading-errors":return"writing";default:return(0,R().HB)(v.generatingStep)}case"error":return"error";case"refused":case"input":return"idle";default:(0,R().HB)(v)}}),[v]);return(0,Ge.jsxs)(ve().Y1,{direction:"vertical",width:"fill",style:{minWidth:0},children:[(0,Ge.jsx)(qe,{upsellMessage:T,upgradeButtonTextProps:I,isUpgradeSystemEnabled:S,isInferenceDown:C}),(0,Ge.jsxs)("div",{style:{...L.outerContainer,...m&&L.outerContainerFocused},tabIndex:0,onFocus:j,children:[(0,Ge.jsx)(ve().Y1,{width:"hug",height:jt,align:"center",style:{marginTop:Pt},children:(0,Ge.jsx)(Ce().M,{variant:"xsmall_plus",highLevelState:V,includeBoxShadow:!0})}),(0,Ge.jsx)(ve().Y1,{direction:"horizontal",gap:8,width:"fill",align:"center-left",style:{paddingTop:wt,paddingBottom:wt},children:(0,Ge.jsx)(_t,{assistantState:v,store:b,onBlur:P,onFocus:j,onChange:_,onBack:D,onSubmit:B})}),(0,Ge.jsx)("div",{role:"button",tabIndex:0,style:L.buttonContainer,onMouseDown:e=>{e.preventDefault()},children:(0,Ge.jsx)(kt,{assistantState:v,spaceId:l,canSubmit:w,onStop:N,onRevert:E,onBack:D,onSubmit:B,hasModifiedFormula:M})})]})]})}const Dt=(0,E().YK)({assistantPlaceholder:{id:"formulaAssistantInput.assistantPlaceholder",defaultMessage:"Write, fix, or explain a formula..."},assistantIsReadingErrors:{id:"formulaAssistantInput.assistantIsReadingErrors",defaultMessage:"Reading errors"},assistantIsThinking:{id:"formulaAssistantInput.assistantIsThinking",defaultMessage:"Thinking"},assistantIsPondering:{id:"formulaAssistantInput.assistantIsPondering",defaultMessage:"Pondering"},assistantIsReasoning:{id:"formulaAssistantInput.assistantIsReasoning",defaultMessage:"Reasoning"},assistantIsGenerating:{id:"formulaAssistantInput.assistantIsGenerating",defaultMessage:"Generating"},assistantIsWriting:{id:"formulaAssistantInput.assistantIsWriting",defaultMessage:"Writing"},assistantIsFixing:{id:"formulaAssistantInput.assistantIsFixing",defaultMessage:"Fixing"},assistantIsRepairing:{id:"formulaAssistantInput.assistantIsRepairing",defaultMessage:"Repairing"},genericErrorMessage:{id:"formulaAssistantInput.genericErrorMessage",defaultMessage:"Failed to respond. Please try again!"}});function Nt(){const e=(0,g().IS)((()=>({skeletonContainer:{boxSizing:"border-box",width:"100%",background:F().Tj.background.elevated,boxShadow:F().Tj.shadowXS,borderRadius:Et,position:"relative",paddingInline:8,display:"flex",alignItems:"center",gap:6}})),[]);return(0,Ge.jsxs)("div",{style:e.skeletonContainer,children:[(0,Ge.jsx)(ve().Y1,{width:"hug",height:jt,align:"center",children:(0,Ge.jsx)(ke().P,{emphasized:!0,style:{width:24,height:24,borderRadius:12}})}),(0,Ge.jsx)(ve().Y1,{width:"fill",height:At,align:"center-left",children:(0,Ge.jsx)(ke().P,{emphasized:!0,style:{height:14,borderRadius:3,width:"60%"}})}),(0,Ge.jsx)(ve().Y1,{width:24,height:24,align:"center",children:(0,Ge.jsx)(ke().P,{emphasized:!0,style:{width:18,height:18,borderRadius:9}})})]})}n(18107),n(967357);var Lt=()=>n(250910),Vt=()=>n(546926),Ut=()=>n(890492),Ht=()=>n(81068),Yt=()=>n(663639),Kt=()=>n(736847),Wt=()=>n(452004),zt=()=>n(852424),Ot=()=>n(247331),Gt=()=>n(66529),$t=()=>n(145076),qt=()=>n(307663);const Qt={true:{name:"true",type:{type:"checkbox"},description:$t().Q$.true,examples:[{input:"true"},{input:[(0,qt().Py)("Checked"),[" == true"]]}]},false:{name:"false",type:{type:"checkbox"},description:$t().Q$.false,examples:[{input:"false"},{input:[(0,qt().Py)("Checked"),[" == false"]]}]},and:{name:"and",type:{type:"checkbox"},description:$t().Q$.and,examples:[{input:"3 > 2 and 2 > 3",output:"false"},{input:[(0,qt().Py)("Naughty"),[" && "],(0,qt().Py)("Nice")]}]},or:{name:"or",type:{type:"checkbox"},description:$t().Q$.or,examples:[{input:"3 > 2 or 2 > 3",output:"true"},{input:[(0,qt().Py)("Naughty"),[" || "],(0,qt().Py)("Nice")]}]},not:{name:"not",type:{type:"checkbox"},description:$t().Q$.not,examples:[{input:"not true",output:"false"},{input:"not (2 > 3)",output:"true"},{input:[["!"],(0,qt().Py)("Checked")]}]},"+":{name:"+",type:{type:"number"},description:$t().Q$["+"],examples:[{input:"3 + 2",output:"5"},{input:"add(-1, 2)",output:"1"}]},"-":{name:"-",type:{type:"number"},description:$t().Q$["-"],examples:[{input:"3 - 2",output:"1"},{input:"subtract(-1, 2)",output:"-3"}]},"*":{name:"*",type:{type:"number"},description:$t().Q$["*"],examples:[{input:"3 * 2",output:"6"},{input:"multiply(-1, 2)",output:"-2"}]},"/":{name:"/",type:{type:"number"},description:$t().Q$["/"],examples:[{input:"3 / 2",output:"1.5"},{input:"divide(-1, 2)",output:"-0.5"}]},"%":{name:"%",type:{type:"number"},description:$t().Q$["%"],examples:[{input:"3 % 2",output:"1"},{input:"mod(-1, 2)",output:"-1"}]},"^":{name:"^",type:{type:"number"},description:$t().Q$["^"],examples:[{input:"3 ^ 2",output:"9"},{input:"pow(-1, 2)",output:"1"}]},"==":{name:"==",type:{type:"checkbox"},description:$t().Q$["=="],examples:[{input:"3 == 2",output:"false"},{input:'equal("A", "A")',output:"true"}]},"!=":{name:"!=",type:{type:"checkbox"},description:$t().Q$["!="],examples:[{input:"3 != 2",output:"true"},{input:'unequal("A", "A")',output:"false"}]},">":{name:">",type:{type:"checkbox"},description:$t().Q$[">"],examples:[{input:"3 > 2",output:"true"},{input:'now() > parseDate("2040-01-01")',output:"false"}]},"<":{name:"<",type:{type:"checkbox"},description:$t().Q$["<"],examples:[{input:"3 < 2",output:"false"},{input:'now() < parseDate("2040-01-01")',output:"true"}]},">=":{name:">=",type:{type:"checkbox"},description:$t().Q$[">="],examples:[{input:"3 >= 2",output:"true"},{input:'now() >= parseDate("2040-01-01")',output:"false"}]},"<=":{name:"<=",type:{type:"checkbox"},description:$t().Q$["<="],examples:[{input:"3 <= 2",output:"false"},{input:'now() <= parseDate("2040-01-01")',output:"true"}]}};var Zt=()=>n(628048),Xt=()=>n(406533),Jt=()=>n(736767),en=()=>n(300474),tn=()=>n(212497),nn=()=>n(338381),on=()=>n(67657);const rn=(0,E().YK)({property:{id:"formula2Input.propertyHelper.descriptionGeneric",defaultMessage:"Database property."},titlePropertyDescription:{id:"formulaLibrary.property.title.description",defaultMessage:"Title property."},textPropertyDescription:{id:"formulaLibrary.property.text.description",defaultMessage:"Text property."},urlPropertyDescription:{id:"formulaLibrary.property.url.description",defaultMessage:"URL property."},emailPropertyDescription:{id:"formulaLibrary.property.email.description",defaultMessage:"Email property."},phoneNumberPropertyDescription:{id:"formulaLibrary.property.phoneNumber.description",defaultMessage:"Phone number property."},selectPropertyDescription:{id:"formulaLibrary.property.select.description",defaultMessage:"Select property."},multiSelectPropertyDescription:{id:"formulaLibrary.property.multiSelect.description",defaultMessage:"Multi-select property, list."},statusPropertyDescription:{id:"formulaLibrary.property.status.description",defaultMessage:"Status property."},checkboxPropertyDescription:{id:"formulaLibrary.property.checkbox.description",defaultMessage:"Checkbox property."},datePropertyDescription:{id:"formulaLibrary.property.date.description",defaultMessage:"Date property."},personPropertyDescription:{id:"formulaLibrary.property.person.description",defaultMessage:"Person property, list."},relationPropertyDescription:{id:"formulaLibrary.property.relation.description",defaultMessage:"Relation property, list."},rollupPropertyDescriptionList:{id:"formulaLibrary.property.rollup.description",defaultMessage:"Rollup property, list."},rollupPropertyDescription:{id:"formulaLibrary.property.rollup.descriptionWithList",defaultMessage:"Rollup property."},numberPropertyDescription:{id:"formulaLibrary.property.number.description",defaultMessage:"Number property."},formulaPropertyDescription:{id:"formulaLibrary.property.formula.description",defaultMessage:"Formula property."},formulaPropertyDescriptionList:{id:"formulaLibrary.property.formula.descriptionWithList",defaultMessage:"Formula property, list."},createdTimePropertyDescription:{id:"formulaLibrary.property.createdTime.description",defaultMessage:"Created time property."},lastEditedTimePropertyDescription:{id:"formulaLibrary.property.lastEditedTime.description",defaultMessage:"Last edited time property."},createdByPropertyDescription:{id:"formulaLibrary.property.createdBy.description",defaultMessage:"Created by property."},lastEditedByPropertyDescription:{id:"formulaLibrary.property.lastEditedBy.description",defaultMessage:"Last edited by property."},filePropertyDescription:{id:"formulaLibrary.property.file.description",defaultMessage:"File property, list."},autoincrementIdDescription:{id:"formulaLibrary.property.autoincrementId.description",defaultMessage:"ID property."}}),an={title:{name:"title",type:{type:"text"},description:rn.titlePropertyDescription,examples:e=>e?[{input:[(0,qt().Y2)(e)],isCopyable:!0},{input:[(0,qt().Y2)(e),['.style("b")']],isCopyable:!0},{input:[(0,qt().Py)("Full Name"),['.split(" ").at(0)']]}]:[{input:[(0,qt().Py)("Title")]},{input:[(0,qt().Py)("Title"),['.style("b")']]},{input:[(0,qt().Py)("Name"),['.split(" ").at(0)']]}]},text:{name:"text",type:{type:"text"},description:rn.textPropertyDescription,examples:e=>e?[{input:[(0,qt().Y2)(e)],isCopyable:!0},{input:[["upper("],(0,qt().Y2)(e),[")"]],isCopyable:!0},{input:[(0,qt().Y2)(e),['.style("b", "red")']],isCopyable:!0}]:[{input:[["upper("],(0,qt().Py)("Name"),[")"]]},{input:[(0,qt().Py)("Name"),['.style("b", "red")']]}]},url:{name:"url",type:{type:"text"},description:rn.urlPropertyDescription,examples:e=>e?[{input:[(0,qt().Y2)(e)],isCopyable:!0},{input:[(0,qt().Y2)(e),[' ? link("Link", '],(0,qt().Y2)(e),[').style("green") : ""']],isCopyable:!0}]:[{input:[(0,qt().Py)("URL"),[' ? link("Link", '],(0,qt().Py)("URL"),[').style("green") : ""']]}]},email:{name:"email",type:{type:"text"},description:rn.emailPropertyDescription,examples:e=>e?[{input:[(0,qt().Y2)(e)],isCopyable:!0},{input:[(0,qt().Y2)(e),[' ? link("Email", "mailto:" + '],(0,qt().Y2)(e),[').style("blue") : ""']],isCopyable:!0}]:[{input:[(0,qt().Py)("Email"),[' ? link("Email", "mailto:" + '],(0,qt().Py)("Email"),[').style("blue") : ""']]}]},phone_number:{name:"phone_number",type:{type:"text"},description:rn.phoneNumberPropertyDescription,examples:e=>e?[{input:[(0,qt().Y2)(e)],isCopyable:!0},{input:[(0,qt().Y2)(e),[' ? link("Call", "tel:" + '],(0,qt().Y2)(e),[').style("blue") : ""']],isCopyable:!0}]:[{input:[(0,qt().Py)("Email"),[' ? link("Call", "tel:" + '],(0,qt().Py)("Email"),[').style("blue") : ""']]}]},number:{name:"number",type:{type:"number"},description:rn.numberPropertyDescription,examples:e=>e?[{input:[(0,qt().Y2)(e)],isCopyable:!0},{input:[(0,qt().Y2)(e),[" / 2"]],isCopyable:!0},{input:[["pi() * "],(0,qt().Y2)(e),[" ^ 2"]],isCopyable:!0}]:[{input:[(0,qt().Py)("Cost"),[" / "],(0,qt().Py)("Total Units")]},{input:[["pi() * "],(0,qt().Py)("Radius"),[" ^ 2"]]}]},select:{name:"select",type:{type:"text"},description:rn.selectPropertyDescription,examples:e=>{const t=[{input:[(0,qt().Py)("Priority"),[' == "High"']]},{input:[['["Feature", "Bug"].includes('],(0,qt().Py)("Task Type"),[")"]]}];return e&&t.unshift({input:[(0,qt().Y2)(e)],isCopyable:!0}),t}},multi_select:{name:"select",type:{type:"array",of:{type:"text"}},description:rn.multiSelectPropertyDescription,examples:e=>e?[{input:[(0,qt().Y2)(e)],isCopyable:!0},{input:[(0,qt().Y2)(e),[".length()"]],isCopyable:!0},{input:[(0,qt().Py)("Tags"),['.includes("Finance")']]}]:[{input:[(0,qt().Py)("Tags"),[".length()"]]},{input:[(0,qt().Py)("Tags"),['.includes("Finance")']]}]},status:{name:"status",type:{type:"text"},description:rn.statusPropertyDescription,examples:e=>"Status"===(null==e?void 0:e.name)?[{input:[(0,qt().Y2)(e)],isCopyable:!0},{input:[(0,qt().Y2)(e),[' == "Done"']],isCopyable:!0},{input:[['["Not started", "In progress"].includes('],(0,qt().Y2)(e),[")"]],isCopyable:!0}]:[{input:[(0,qt().Py)("Status"),[' == "Done"']]},{input:[['["Not started", "In progress"].includes('],(0,qt().Py)("Status"),[")"]]}]},checkbox:{name:"checkbox",type:{type:"checkbox"},description:rn.checkboxPropertyDescription,examples:e=>e?[{input:[(0,qt().Y2)(e)],isCopyable:!0},{input:[["not "],(0,qt().Y2)(e)],isCopyable:!0},{input:[(0,qt().Py)("Signed"),[" and "],(0,qt().Py)("Sealed"),[" and "],(0,qt().Py)("Delivered")]}]:[{input:[["not"],(0,qt().Py)("Done")]},{input:[(0,qt().Py)("Signed"),[" and "],(0,qt().Py)("Sealed"),[" and "],(0,qt().Py)("Delivered")]}]},date:{name:"date",type:{type:"date"},description:rn.datePropertyDescription,examples:e=>e?[{input:[(0,qt().Y2)(e)],isCopyable:!0},{input:[(0,qt().Y2)(e),[" > now()"]],isCopyable:!0},{input:[(0,qt().Y2)(e),['.dateAdd(1, "weeks")']],isCopyable:!0},{input:[["dateBetween("],(0,qt().Y2)(e),[', now(), "days")']],isCopyable:!0}]:[{input:[(0,qt().Py)("Due Date"),[" > now()"]]},{input:[["formatDate("],(0,qt().Py)("Date"),[', "YYYY/MM/DD HH:mm")']]},{input:[["dateBetween("],(0,qt().Py)("Birthday"),[', now(), "days")']]}]},person:{name:"person",type:{type:"array",of:{type:"text"}},description:rn.personPropertyDescription,examples:e=>e?[{input:[(0,qt().Y2)(e)],isCopyable:!0},{input:[(0,qt().Y2)(e),[".length()"]],isCopyable:!0},{input:[(0,qt().Y2)(e),[".at(0)"]],isCopyable:!0},{input:[(0,qt().Y2)(e),[".map(current.email())"]],isCopyable:!0},{input:[(0,qt().Y2)(e),['.some(current.name() == "Alice")']]}]:[{input:[(0,qt().Py)("Participants"),[".at(0)"]]},{input:[(0,qt().Py)("Participants"),[".length()"]]},{input:[(0,qt().Py)("Participants"),['.some(current.name() == "Alice")']]}]},relation:{name:"relation",type:{type:"array",of:{type:"block"}},description:rn.relationPropertyDescription,examples:e=>e?[{input:[(0,qt().Y2)(e)],isCopyable:!0},{input:[(0,qt().Y2)(e),[".length()"]],isCopyable:!0},{input:[(0,qt().Py)("Tasks"),[".filter(current."],(0,qt().Py)("Status"),[' != "Done")']]}]:[{input:[(0,qt().Py)("Tasks"),[".length()"]]},{input:[(0,qt().Py)("Tasks"),[".filter(current."],(0,qt().Py)("Status"),[' != "Done")']]}]},rollup:{name:"rollup",type:e=>{if("rollup"===(null==e?void 0:e.type)&&("show_unique"===e.aggregation||void 0===e.aggregation))return{type:"array",of:{type:"unknown"}};if(e&&"aggregation"in e&&void 0!==e.aggregation){return{type:(0,on().ou)((0,on().ZP)(e.aggregation))}}return{type:"unknown"}},description:e=>"rollup"!==(null==e?void 0:e.type)||"show_unique"!==e.aggregation&&void 0!==e.aggregation?rn.rollupPropertyDescription:rn.rollupPropertyDescriptionList,examples:(e,t)=>{let n;return n=!t||"rollup"!==(null==t?void 0:t.type)||"show_unique"!==t.aggregation&&void 0!==t.aggregation?[{input:[(0,qt().Py)("Average cost"),[" * 12"]]},{input:[(0,qt().Py)("Sum of customers"),[" > 100"]]}]:[void 0!==e?{input:[(0,qt().Y2)(e),[".length()"]],isCopyable:!0}:{input:[(0,qt().Py)("Purchases"),[".length()"]]},{input:[["sum("],(0,qt().Py)("Purchases"),[".map(current."],(0,qt().Py)("Cost"),["))"]]}],e&&n.unshift({input:[(0,qt().Y2)(e)],isCopyable:!0}),n}},file:{name:"file",type:{type:"array",of:{type:"text"}},description:rn.filePropertyDescription,examples:e=>e?[{input:[(0,qt().Y2)(e)],isCopyable:!0},{input:[(0,qt().Y2)(e),[".length()"]],isCopyable:!0},{input:[(0,qt().Y2)(e),['.filter(current.match(".pdf$"))']],isCopyable:!0},{input:[(0,qt().Y2)(e),['.map(link("File", current))']],isCopyable:!0}]:[{input:[(0,qt().Py)("Attachments"),[".length()"]]},{input:[(0,qt().Py)("Attachments"),['.filter(current.match(".pdf$"))']]},{input:[(0,qt().Py)("Attachments"),['.map(link("File", current))']]}]},formula:{name:"formula",type:e=>{var t,n,o;return e&&"formula2"in e&&null!==(t=e.formula2)&&void 0!==t&&null!==(t=t.result_type)&&void 0!==t&&t.type?e.formula2.result_type:e&&"formula"in e&&null!==(n=e.formula)&&void 0!==n&&n.result_type?{type:null===(o=e.formula)||void 0===o?void 0:o.result_type}:{type:"unknown"}},description:e=>{var t;return e&&"formula2"in e&&"array"===(null===(t=e.formula2)||void 0===t||null===(t=t.result_type)||void 0===t?void 0:t.type)?rn.formulaPropertyDescriptionList:rn.formulaPropertyDescription},examples:(e,t)=>{var n,o;let i={type:"unknown"};if(t&&"formula2"in t&&null!==(n=t.formula2)&&void 0!==n&&null!==(n=n.result_type)&&void 0!==n&&n.type)i=t.formula2.result_type;else if(t&&"formula"in t&&null!==(o=t.formula)&&void 0!==o&&o.result_type){var r;i={type:null===(r=t.formula)||void 0===r?void 0:r.result_type}}if(!e)return[];const a=[{input:[(0,qt().Y2)(e)],isCopyable:!0}];switch(i.type){case"array":switch(a.push({input:[(0,qt().Y2)(e),[".length()"]],isCopyable:!0}),i.of.type){case"text":a.push({input:[(0,qt().Y2)(e),['.join("\\n")']],isCopyable:!0});break;case"number":a.push({input:[(0,qt().Y2)(e),[".sum()"]],isCopyable:!0});break;case"date":a.push({input:[(0,qt().Y2)(e),['.map(dateBetween(now(), current, "days"))']],isCopyable:!0});break;case"person":a.push({input:[(0,qt().Y2)(e),[".map(current.name())"]],isCopyable:!0}),a.push({input:[(0,qt().Y2)(e),[".some(current.name() == 'Alice')"]],isCopyable:!0});break;case"checkbox":a.push({input:[(0,qt().Y2)(e),[".every(current == true)"]],isCopyable:!0});break;case"block":a.push({input:[(0,qt().Py)("Primary Tasks"),[".filter(current."],(0,qt().Py)("Status"),[' == "Done")']]})}break;case"number":a.push({input:[(0,qt().Y2)(e),[" * 2 > 100"]],isCopyable:!0});break;case"text":a.push({input:[(0,qt().Y2)(e),[".upper()"]],isCopyable:!0});break;case"date":a.push({input:[(0,qt().Y2)(e),[" > now()"]],isCopyable:!0});break;case"person":a.push({input:[(0,qt().Y2)(e),[".name()"]],isCopyable:!0});break;case"checkbox":a.push({input:[["not "],(0,qt().Y2)(e)],isCopyable:!0});break;case"block":a.push({input:[(0,qt().Y2)(e),[".map(current."],(0,qt().pC)(Ot().FormulaTokenSupportedBlockSystemProperty.CreatedBy),[")"]]})}return a}},created_time:{name:"created_time",type:{type:"date"},description:rn.createdTimePropertyDescription,examples:e=>e?[{input:[(0,qt().Y2)(e)],isCopyable:!0},{input:[(0,qt().Y2)(e),['.dateAdd(1, "weeks")']],isCopyable:!0},{input:[(0,qt().Y2)(e),[' > dateSubtract(now(), 1, "years")']],isCopyable:!0}]:[{input:[(0,qt().pC)(Ot().FormulaTokenSupportedBlockSystemProperty.CreatedTime),['.dateAdd(1, "weeks")']]},{input:[(0,qt().pC)(Ot().FormulaTokenSupportedBlockSystemProperty.CreatedTime),[' > dateSubtract(now(), 1, "years")']]}]},last_edited_time:{name:"last_edited_time",type:{type:"date"},description:rn.lastEditedTimePropertyDescription,examples:e=>e?[{input:[(0,qt().Y2)(e)],isCopyable:!0},{input:[(0,qt().Y2)(e),['.dateAdd(1, "weeks")']],isCopyable:!0},{input:[(0,qt().Y2)(e),[' > dateSubtract(now(), 1, "month")']],isCopyable:!0}]:[{input:[(0,qt().pC)(Ot().FormulaTokenSupportedBlockSystemProperty.LastEditedTime),['.dateAdd(1, "weeks")']]},{input:[(0,qt().pC)(Ot().FormulaTokenSupportedBlockSystemProperty.LastEditedTime),[' > dateSubtract(now(), 1, "month")']]}]},created_by:{name:"created_by",type:{type:"person"},description:rn.createdByPropertyDescription,examples:e=>e?[{input:[(0,qt().Y2)(e)],isCopyable:!0},{input:[(0,qt().Y2)(e),[".name()"]],isCopyable:!0},{input:[(0,qt().Y2)(e),[".email()"]],isCopyable:!0}]:[{input:[(0,qt().pC)(Ot().FormulaTokenSupportedBlockSystemProperty.CreatedBy),[".name()"]]},{input:[(0,qt().pC)(Ot().FormulaTokenSupportedBlockSystemProperty.CreatedBy),[".email()"]]}]},last_edited_by:{name:"last_edited_by",type:{type:"person"},description:rn.lastEditedByPropertyDescription,examples:e=>e?[{input:[(0,qt().Y2)(e)],isCopyable:!0},{input:[(0,qt().Y2)(e),[".name()"]],isCopyable:!0},{input:[(0,qt().Y2)(e),[".email()"]],isCopyable:!0}]:[{input:[(0,qt().pC)(Ot().FormulaTokenSupportedBlockSystemProperty.LastEditedBy),[".name()"]]},{input:[(0,qt().pC)(Ot().FormulaTokenSupportedBlockSystemProperty.LastEditedBy),[".email()"]]}]},auto_increment_id:{name:"auto_increment_id",type:{type:"number"},description:rn.autoincrementIdDescription,examples:e=>e?[{input:[(0,qt().Y2)(e)],isCopyable:!0},{input:[(0,qt().Y2)(e),['.split("-").first() /* Prefix */']],isCopyable:!0},{input:[(0,qt().Y2)(e),['.split("-").last().toNumber() /* ID */']],isCopyable:!0}]:[{input:[(0,qt().Py)("ID Code")]},{input:[(0,qt().Py)("Task ID"),['.split("-").first() /* Prefix */']],output:'"TASK"'},{input:[(0,qt().Py)("Task ID"),['.split("-").last().toNumber() /* ID */']],output:"123"}]},button:null,location:null,last_visited_time:null,verification:null,place:null},sn={text:{examples:e=>e?[{input:[(0,qt().HH)({id:e.id})]},{input:[["upper("],(0,qt().HH)({id:e.id}),[")"]]},{input:[(0,qt().HH)({id:e.id}),['.style("b", "red")']]}]:[]},number:{examples:e=>e?[{input:[(0,qt().HH)(e)],isCopyable:!0},{input:[(0,qt().HH)(e),[" / 2"]],isCopyable:!0},{input:[["pi() * "],(0,qt().HH)(e),[" ^ 2"]],isCopyable:!0}]:[]},checkbox:{examples:e=>e?[{input:[(0,qt().HH)(e)]},{input:[["not "],(0,qt().HH)(e)]}]:[]},date:{examples:e=>e?[{input:[(0,qt().HH)(e)]},{input:[(0,qt().HH)(e),[" > now()"]]},{input:[(0,qt().HH)(e),['.dateAdd(1, "weeks")']]},{input:[["dateBetween("],(0,qt().HH)(e),[', now(), "days")']]}]:[]},block:{examples:e=>e?[{input:[(0,qt().HH)(e)]},{input:[(0,qt().HH)(e),[".format()"]]},{input:[(0,qt().HH)(e),["."],(0,qt().pC)(Ot().FormulaTokenSupportedBlockSystemProperty.CreatedBy)]}]:[]},person:{examples:e=>e?[{input:[(0,qt().HH)(e)]},{input:[(0,qt().HH)(e),[".email()"]]},{input:[(0,qt().HH)(e),['.name() == "Alice"']]}]:[]},array:{examples:e=>e?[{input:[(0,qt().HH)(e)]},{input:[(0,qt().HH)(e),[".length()"]]},{input:[(0,qt().HH)(e),[".at(0).format()"]]}]:[]},select:null,function:null,unknown:null,undefined:null};var ln=()=>n(627503),un=()=>n(979004),dn=()=>n(924703),cn=()=>n(354584),pn=()=>n(712030),mn=()=>n(267419),fn=()=>n(141768);function gn({style:e}){const t=(0,g().IS)((()=>({helper:{display:"flex",flexDirection:"column",fontSize:12,height:"auto",width:"100%",gap:8,overflow:"auto",textWrap:"wrap",...e},nameContainer:{display:"flex",alignItems:"center",fontSize:14,fontWeight:600},skeletonIcon:{width:14,height:14,borderRadius:7,flexShrink:0,marginInlineEnd:6},skeletonName:{height:15,borderRadius:3,width:"40%",marginTop:3,marginBottom:3},skeletonDescription:{height:18,borderRadius:3,width:"30%"},skeletonExample:{height:30.5,borderRadius:5,margin:"0 -4px",padding:"0 6px",border:`1px solid ${F().Tj.border.secondary}`,display:"flex",alignItems:"center"},skeletonExampleTextShort:{height:16.5,borderRadius:3,width:"40%"},skeletonExampleTextMedium:{height:16.5,borderRadius:3,width:"60%"},skeletonExampleTextLong:{height:16.5,borderRadius:3,width:"80%"},examples:{display:"flex",flexDirection:"column",gap:4}})),[e]);return(0,Ge.jsxs)("div",{style:t.helper,children:[(0,Ge.jsxs)("div",{style:t.nameContainer,children:[(0,Ge.jsx)(ke().P,{style:t.skeletonIcon}),(0,Ge.jsx)(ke().P,{style:t.skeletonName})]}),(0,Ge.jsx)(ke().P,{style:t.skeletonDescription}),(0,Ge.jsxs)("div",{style:t.examples,children:[(0,Ge.jsx)("div",{style:t.skeletonExample,children:(0,Ge.jsx)(ke().P,{style:t.skeletonExampleTextShort})}),(0,Ge.jsx)("div",{style:t.skeletonExample,children:(0,Ge.jsx)(ke().P,{style:t.skeletonExampleTextMedium})}),(0,Ge.jsx)("div",{style:t.skeletonExample,children:(0,Ge.jsx)(ke().P,{style:t.skeletonExampleTextLong})})]})]})}function yn({infoHelper:e,getRecordModel:t,typecheckContextValues:n,style:o,isLoading:i}){const r=(0,E().tz)();if(i)return(0,Ge.jsx)(gn,{style:o});const a=e;if(void 0===(null==a?void 0:a.kind))return null;switch(a.kind){case Ot().FormulaEditorInfoCompletionKind.Token:return(0,Ge.jsx)(bn,{completion:a,getRecordModel:t,style:o,typecheckContextValues:n});case Ot().FormulaEditorInfoCompletionKind.LibraryFunction:{const n=Boolean(null==e?void 0:e.calledFromUnifiedFunctionProperty),i=function(e,t){if(t&&void 0!==e.syntax[1])return e.syntax[1];return e.syntax[0]}(a.libraryFunction,n),r=function(e,t){if(t&&void 0!==e.examples[1])return e.examples[1];return e.examples[0]}(a.libraryFunction,n),s=a.libraryFunction.returnType;return(0,Ge.jsx)(xn,{icon:Bn("function"==typeof s?s([]).type:s.type),name:i,description:(0,Ge.jsx)(E().sA,{...a.libraryFunction.description,values:{br:(0,Ge.jsx)("br",{})}}),examples:r.length>0?r.map(((e,n)=>(0,Ge.jsx)(hn,{example:e,getRecordModel:t},n))):void 0,style:o})}case Ot().FormulaEditorInfoCompletionKind.Binding:var s;return a.text===Ot().CURRENT_VALUE_NAME?(0,Ge.jsx)(xn,{icon:Bn(a.type.type),name:a.text,description:r.formatMessage(Sn.currentValueDescription),style:o}):a.text===Ot().CURRENT_INDEX_NAME?(0,Ge.jsx)(xn,{icon:Bn(a.type.type),name:a.text,description:r.formatMessage(Sn.currentIndexDescription),style:o}):(0,Ge.jsx)(xn,{icon:Bn(a.type.type),name:a.text,description:r.formatMessage("array"===(null==a||null===(s=a.type)||void 0===s?void 0:s.type)?Sn.listVariableType:Sn.variableType),style:o});case Ot().FormulaEditorInfoCompletionKind.Builtin:{const e=Qt[a.builtin];return(0,Ge.jsx)(xn,{icon:Bn(e.type.type),name:e.name,description:r.formatMessage(e.description),examples:e.examples.length>0?e.examples.map(((e,n)=>(0,Ge.jsx)(hn,{example:e,getRecordModel:t},n))):void 0,style:o})}default:return(0,R().HB)(a)}}function hn({example:e,getRecordModel:t,typecheckContextValues:n}){const i=(0,y().fJ)(cn().y),r=(0,pn().Ol)(),s=(0,d().v3)(),{device:u}=s,c=(0,en().r)(),p=(0,g().DP)(),m=(0,E().tz)(),h=(0,mn()._)(),x=(0,f().K8)((()=>{var o;const d=document.createElement("div"),f="string"!=typeof e.input?P().q4_(e.input):e.input,g=(null===(o=i.value)||void 0===o?void 0:o.highlight(`${f}`,i.value.languages[un().PrismLanguages.notion],un().PrismLanguages.notion))??"";d.innerHTML=fn().bi(g);const y=_().oE(Array.from(d.childNodes).map(Tn)),x="string"==typeof e.input?[[e.input],[" = "]]:e.input.concat([[" = "]]),b=fn().YH(x,_().oE(y)),v=x.map(P().uPN).map(((e,n)=>(0,dn().sT)({annotations:e,theme:p,getRecordModel:t,spaceId:c,isSafariOrIOS:u.isSafari||u.isIOS})));return b.map(((e,o)=>{const i=v[e.textTokenIndex],d=x[e.textTokenIndex];return P().qXl(d)?(0,dn().Au)({args:{textValue:{value:x,spaceId:c},getRecordModel:t,getRecordRole:()=>{},disableHover:!1,disableStyleAnnotations:!1,disableInsertedDeletedAnnotations:!1,disableDateStyleAnnotations:!1,disableSuggestionAnnotations:!1,disableLinks:!1,userTimeZone:(0,w().P)(),disabled:!1,isAndroid:u.isAndroid,isSafariOrIOS:u.isSafari||u.isIOS,isFirefox:u.isFirefox,isWindows:u.isWindows,emojiType:r,highlightDiscussionId:void 0,theme:p,intl:m,renderedPageBlockId:void 0,parentBlockId:void 0,katex:void 0,isClient:!0,baseUrl:l().A.domainBaseUrl,publicDomainName:l().A.publicDomainName,currentUserId:s.currentUser.id,getPublicBaseUrlForPageOrCollection:void 0,externalIntegrations:[],formulaValueTypes:n??[],emojiData:h,isMobileNative:u.isMobileNative,isMobileNativeExternalLinkFixEnabled:a().default.checkGate({gateName:"mobile_native_external_link_fix"}),displayInUserTimezone:!0},style:i.style,classNames:i.classNames,index:o,token:d,tokenValue:P().N8A(d),tokenAnnotations:P().uPN(d)}):(0,Ge.jsx)("span",{className:[e.classNames||"",...i.classNames].join(" "),style:i.style,"data-token-index":e.textTokenIndex,children:e.value},o)}))}),[e.input,i.value,p,t,c,u.isAndroid,u.isSafari,u.isFirefox,u.isIOS,u.isWindows,u.isMobileNative,r,m,s.currentUser.id,n,h]),b=(0,f().K8)((()=>Array.isArray(e.output)?(0,dn().S5)({textValue:{value:e.output,spaceId:c},getRecordModel:t,getRecordRole:()=>{},disableHover:!1,disableStyleAnnotations:!1,disableInsertedDeletedAnnotations:!1,disableDateStyleAnnotations:!1,disableSuggestionAnnotations:!1,disableLinks:!1,userTimeZone:(0,w().P)(),disabled:!1,isAndroid:u.isAndroid,isSafariOrIOS:u.isSafari||u.isIOS,isFirefox:u.isFirefox,isWindows:u.isWindows,emojiType:r,theme:p,intl:m,katex:void 0,isClient:!0,baseUrl:l().A.domainBaseUrl,publicDomainName:l().A.publicDomainName,currentUserId:s.currentUser.id,getPublicBaseUrlForPageOrCollection:void 0,externalIntegrations:[],formulaValueTypes:[],emojiData:h,isMobileNative:u.isMobileNative,isMobileNativeExternalLinkFixEnabled:a().default.checkGate({gateName:"mobile_native_external_link_fix"}),displayInUserTimezone:!0}):e.output),[u.isAndroid,u.isIOS,u.isSafari,u.isFirefox,u.isWindows,u.isMobileNative,h,r,s.currentUser.id,e.output,t,m,c,p]),v=!1!==e.isCopyable&&("string"==typeof e.input||!0===e.isCopyable),k=(0,o.useCallback)((async()=>{if(v){const n=(Array.isArray(e.input)?(0,ee().r4)({intl:m,textValue:e.input,getRecordModel:t,userTimeZone:(0,w().P)()}):e.input).replaceAll(/\/\*.*\*\//g,"").trim();(await(0,tn().jd)())({stringValue:n,environment:s,copiedMessage:In.copiedExampleMessage})}}),[s,e.input,t,m,v]),T=(0,g().IS)((()=>({code:{fontFamily:"monospace",whiteSpaceCollapse:"preserve",fontSize:11,borderRadius:5,border:`1px solid ${F().Tj.border.secondary}`,margin:"0 -4px",padding:"0 6px",pointerEvents:"none",opacity:.95,display:"flex",flexDirection:"row",alignItems:"center",tabSize:2},left:{flexGrow:1,padding:"6px 0"},right:{alignSelf:"center"},copyButton:{height:22,width:22,pointerEvents:"auto"},copyButtonIcon:{height:ht().Ev.xs,width:ht().Ev.xs}})),[]);return(0,Ge.jsxs)("div",{style:T.code,dir:"ltr",children:[(0,Ge.jsxs)("div",{style:T.left,children:[(0,Ge.jsx)("div",{children:x}),b?(0,Ge.jsxs)("div",{children:["= ",b]}):null]}),v?(0,Ge.jsx)("div",{style:T.right,children:(0,Ge.jsx)(Ye().m,{renderTooltip:()=>m.formatMessage(In.copyToClipboard),render:e=>(0,Ge.jsx)(Ue().A,{ariaLabel:m.formatMessage(In.copyToClipboard),onClick:k,icon:ln().a,style:T.copyButton,iconStyle:T.copyButtonIcon,disallowTabbing:!0,...e})})}):null]})}function xn({name:e,icon:t,description:n,examples:o,style:i}){const r=(0,g().IS)((()=>({helper:{display:"flex",flexDirection:"column",fontSize:12,height:"auto",width:"100%",gap:8,overflow:"auto",textWrap:"wrap",...i},name:{fontSize:14,fontWeight:600,display:"flex",alignItems:"center"},description:{color:F().Tj.text.secondary},iconStyle:{height:ht().Ev.sm,width:ht().Ev.sm,fill:F().Tj.icon.secondary,display:"inline",marginInlineEnd:6},examples:{display:"flex",flexDirection:"column",gap:4}})),[i]);return(0,Ge.jsxs)("div",{style:r.helper,children:[(0,Ge.jsxs)("span",{style:r.name,children:[void 0!==t?t(r.iconStyle):void 0,e]}),void 0!==n?(0,Ge.jsx)("span",{style:r.description,children:n}):void 0,void 0!==o?(0,Ge.jsx)("div",{style:r.examples,children:o}):void 0]})}function bn({completion:e,getRecordModel:t,style:n,typecheckContextValues:o}){const i=(0,E().tz)(),{name:r,description:a,icon:s,examples:l}=(0,f().K8)((()=>{if(!t)return{};if(e.token.type===Ot().FormulaTokenType.BlockProperty){var n;if((0,C().ix)(e.token))return{};if(Ot().FormulaTokenSupportedBlockSystemPropertyList.includes(e.token.property)&&!e.token.collection){var r;const n=null===(r=Ot().FormulaTokenSupportedBlockSystemPropertyToType[e.token.property])||void 0===r?void 0:r.type,o=n?zt().LE[n]:void 0,a=an[e.token.property],s="function"==typeof(null==a?void 0:a.description)?a.description():null==a?void 0:a.description,l=e.name??e.token.property;return{name:l,icon:o,description:s?i.formatMessage(s):void 0,examples:null!==a?vn(a,t,{collection:e.token.collection,property:e.token.property,name:l},{name:l,type:e.token.property}):void 0}}if(!e.token.collection)return{};const o=(0,C().Yi)(e.token.property),a=t(e.token.collection),s=null==a||null===(n=a.getNormalizedSchema())||void 0===n?void 0:n[o];if(!s)return{};const l=an[s.type];return l?{name:e.name,icon:zt().LE[s.type],description:i.formatMessage("function"==typeof l.description?l.description(s):l.description),examples:vn(l,t,{collection:e.token.collection,property:o,name:e.name},s)}:{}}if(e.token.type===Ot().FormulaTokenType.ContextValue){const n=(0,C()._H)(o,(0,C().GH)(e.token.valueId));if(!n||n.kind!==Ot().FormulaContextValueKind.ContextValue)return{};const i=n.type.type,r=sn[i];return{name:n.name,description:n.description??n.tooltipName,icon:Bn(n.type.type),examples:null!=r&&r.examples?kn(r,t,o,n):void 0}}if(e.token.type===Ot().FormulaTokenType.Block||e.token.type===Ot().FormulaTokenType.Checkbox||e.token.type===Ot().FormulaTokenType.Date||e.token.type===Ot().FormulaTokenType.Person)return{};(0,R().HB)(e.token)}),[e.name,e.token,t,o,i]);return void 0===r?null:(0,Ge.jsx)(xn,{name:r,icon:s,description:a,examples:l,style:n})}function vn(e,t,n,o){const i=e.examples;let r=[];return r="function"==typeof i?i(n,o).map(((e,n)=>(0,Ge.jsx)(hn,{example:e,getRecordModel:t},n))):i.map(((e,n)=>(0,Ge.jsx)(hn,{example:e,getRecordModel:t},n))),r.length>0?r:void 0}function kn(e,t,n,o){const i=e.examples;let r=[];return r="function"==typeof i?i(o).map(((e,o)=>(0,Ge.jsx)(hn,{example:e,getRecordModel:t,typecheckContextValues:n},o))):i.map(((e,o)=>(0,Ge.jsx)(hn,{example:e,getRecordModel:t,typecheckContextValues:n},o))),r.length>0?r:void 0}function Tn(e){return nn().KH(e)?[e.data]:nn().vq(e)?[e.textContent||"",e.className]:void 0}const In=(0,E().YK)({copiedExampleMessage:{id:"formula2Input.helperText.copiedExampleMessage",defaultMessage:"Copied example to clipboard!"},copyToClipboard:{defaultMessage:"Copy to Clipboard",id:"database.copyButton.copyToClipboard"}}),Sn=(0,E().YK)({currentValueDescription:{id:"formula2Input.helperText.currentValueDescription",defaultMessage:"Returns the value of the current item in the list function."},currentIndexDescription:{id:"formula2Input.helperText.currentIndexDescription",defaultMessage:"Returns the index of the current item in the list function, starting from 0."},variableType:{id:"formula2Input.variableHelper.description",defaultMessage:"User-defined variable."},listVariableType:{id:"formula2Input.variableHelper.descriptionWithList",defaultMessage:"User-defined variable, list."}}),Mn=(0,E().YK)({showDocumentation:{id:"formulas.autocompleteMenu.showDocumentation",defaultMessage:"Show documentation"}}),Cn=["generic","conditional","text","number","date","people","list","variable","special"];function wn(){const e=(0,g().IS)((()=>({menu:{top:0,insetInlineStart:0,insetInlineEnd:0,bottom:0,position:"absolute",marginBottom:2},menuSection:{paddingTop:6,paddingBottom:2},sectionTitle:{height:12,borderRadius:3,width:"30%",marginTop:6,marginBottom:l().A.isMobile?12:6,marginInlineStart:8},skeletonIcon:{width:ht().Ev.sm,height:ht().Ev.sm,margin:3,borderRadius:8,flexShrink:0},skeletonTitle:{height:16.8,borderRadius:3,width:"80%"}})),[]);let t;t=l().A.isMobile?{menuType:Vt().gu.Modal,forceFullScreenSlideUp:!0,hideMobileTopbar:!0}:{menuType:Vt().gu.Popup,width:228,minWidth:228,maxWidth:228};const n=[{key:"skeleton-properties",render:t=>(0,Ge.jsxs)(Kt().A,{...t,style:e.menuSection,disableMobileBorders:!0,children:[(0,Ge.jsx)(ke().P,{style:e.sectionTitle}),Array.from({length:l().A.isMobile?6:3},((t,n)=>(0,Ge.jsx)(Ht().A,{focused:!1,disabled:!0,icon:(0,Ge.jsx)(ke().P,{style:e.skeletonIcon}),title:(0,Ge.jsx)(ke().P,{style:e.skeletonTitle})},`skeleton-property-${n}`)))]}),items:[]},{key:"skeleton-functions",render:t=>(0,Ge.jsxs)(Kt().A,{...t,style:e.menuSection,disableMobileBorders:!0,children:[(0,Ge.jsx)(ke().P,{style:e.sectionTitle}),Array.from({length:l().A.isMobile?6:3},((t,n)=>(0,Ge.jsx)(Ht().A,{focused:!1,disabled:!0,icon:(0,Ge.jsx)(ke().P,{style:e.skeletonIcon}),title:(0,Ge.jsx)(ke().P,{style:e.skeletonTitle})},`skeleton-function-${n}`)))]}),items:[]},{key:"skeleton-functions-2",render:t=>(0,Ge.jsxs)(Kt().A,{...t,style:e.menuSection,disableMobileBorders:!0,children:[(0,Ge.jsx)(ke().P,{style:e.sectionTitle}),Array.from({length:l().A.isMobile?6:3},((t,n)=>(0,Ge.jsx)(Ht().A,{focused:!1,disabled:!0,icon:(0,Ge.jsx)(ke().P,{style:e.skeletonIcon}),title:(0,Ge.jsx)(ke().P,{style:e.skeletonTitle})},`skeleton-function-${n}`)))]}),items:[]}];return(0,Ge.jsx)(Ut().A,{...t,scrollerStyle:e.menu,children:(0,Ge.jsx)(Yt().A,{type:Yt().O.Vertical,initialFocus:0,priority:1,store:(0,f().uB)(void 0,Wt().$),sections:n})})}function An(e){const{isLoading:t,isAssistantGenerating:n,setInfoHelper:i}=e;return(0,o.useEffect)((()=>{t&&i(void 0)}),[t,n,i]),t?(0,Ge.jsx)(wn,{}):(0,Ge.jsx)(jn,{...e})}function jn(e){const{store:t,selection:n,cursorEditorInfo:i,cursorEditorInfoRef:r,context:a,onChange:s,getRecordModel:u,setInfoHelper:d,isAssistantGenerating:c}=e,p=(0,E().tz)(),m=(0,g().IS)((()=>({menu:{top:0,insetInlineStart:0,insetInlineEnd:0,bottom:0,position:"absolute",marginBottom:2},menuSection:{paddingTop:6,paddingBottom:2}})),[]),y=(0,f().uB)(void 0,Wt().$),{sections:h,orderedCompletions:x}=(0,o.useMemo)((()=>{const e=_().$z((null==i?void 0:i.completions)??[],"kind"),o=[],l=[];let f=0;return Object.entries(e).forEach((([e,i])=>{if(e===Ot().FormulaEditorInfoCompletionKind.LibraryFunction.toString()){const e={};for(const t of i){const n=t.kind===Ot().FormulaEditorInfoCompletionKind.LibraryFunction&&Zt().u_[t.libraryFunction.name]||"generic";e[n]||(e[n]=[]),e[n].push(t)}(0,R().uv)(e).filter((e=>"internal"!==e)).sort(((e,t)=>{const n=Cn.indexOf(e),o=Cn.indexOf(t);return-1!==n&&-1!==o?n-o:-1!==n?-1:-1!==o?1:e.localeCompare(t)})).forEach((i=>{const g=f++,h=e[i],x=(null==h?void 0:h.map(((e,o)=>{const p=l.length;return l.push(e),{key:`${i}-${o}`,render:t=>(0,Ge.jsx)(Pn,{...t,completion:e,context:a,getRecordModel:u,menuListStore:y,indexGlobal:p,section:g,indexLocal:o,cursorEditorInfoRef:r,setInfoHelper:d,isAssistantGenerating:c}),action:()=>{var o;c||void 0!==e&&r.current&&(d({...e,calledFromUnifiedFunctionProperty:"member dot receiver"===(null===(o=r.current.completionsInfo)||void 0===o?void 0:o.type)}),Dn({completion:e,store:t,selection:n,onChange:s,cursorEditorInfo:r.current}))}}})))||[];o.push({key:`function-${i}`,render:e=>(0,Ge.jsx)(Kt().A,{...e,style:m.menuSection,title:p.formatMessage(Un[i])}),items:x})}))}else{const g=f++,h=i.map(((o,i)=>{const p=l.length;return l.push(o),{key:`${e}-${i}`,render:e=>(0,Ge.jsx)(Pn,{...e,completion:o,context:a,getRecordModel:u,menuListStore:y,indexGlobal:p,section:g,indexLocal:i,cursorEditorInfoRef:r,setInfoHelper:d,isAssistantGenerating:c}),action:()=>{var e;c||void 0!==o&&r.current&&(d({...o,calledFromUnifiedFunctionProperty:"member dot receiver"===(null===(e=r.current.completionsInfo)||void 0===e?void 0:e.type)}),Dn({completion:o,store:t,selection:n,onChange:s,cursorEditorInfo:r.current}))}}}));o.push({key:e,render:t=>(0,Ge.jsx)(Kt().A,{...t,style:m.menuSection,title:p.formatMessage(Ln[e])}),items:h})}})),{sections:o,orderedCompletions:l}}),[a,null==i?void 0:i.completions,r,u,p,c,y,s,n,d,t,m.menuSection]),b=(0,o.useCallback)((e=>{var t;l().A.isMobile||d({...e,calledFromUnifiedFunctionProperty:"member dot receiver"===(null===(t=r.current)||void 0===t||null===(t=t.completionsInfo)||void 0===t?void 0:t.type)})}),[r,d]),v=(0,o.useCallback)((e=>{if(l().A.isMobile)return;const t=void 0!==e.indexGlobal?x[e.indexGlobal]:void 0;t&&b(t)}),[x,b]),k=(0,f().K8)((()=>y.state.focus.indexGlobal),[y]);let T;return(0,o.useEffect)((()=>{var e,t,n,o;if(l().A.isMobile)return;const r=void 0!==k?x[k]:void 0;if(r)return void b(r);const a="function"===(null==i||null===(e=i.callParameter)||void 0===e||null===(e=e.expression)||void 0===e||null===(e=e.type)||void 0===e?void 0:e.type)?null===(t=i.callParameter.expression)||void 0===t?void 0:t.type:void 0;void 0!==a&&void 0!==(null==i||null===(n=i.callParameter)||void 0===n?void 0:n.parameterIndex)&&(null==i||null===(o=i.callParameter)||void 0===o?void 0:o.parameterIndex)>-1&&d({kind:Ot().FormulaEditorInfoCompletionKind.LibraryFunction,libraryFunction:a.libraryFunction,calledFromUnifiedFunctionProperty:a.calledFromUnifiedFunctionProperty})}),[i,k,x,b,d]),(0,o.useEffect)((()=>{h.length>0&&y.update((e=>({focus:{...e,section:0,indexLocal:0,indexGlobal:0,footerFocused:!1}})))}),[h.length,y,d]),T=l().A.isMobile?{menuType:Vt().gu.Modal,forceFullScreenSlideUp:!0,hideMobileTopbar:!0}:{menuType:Vt().gu.Popup,width:228,minWidth:228,maxWidth:228},(0,Ge.jsx)(Ut().A,{...T,scrollerStyle:m.menu,children:(0,Ge.jsx)(Yt().A,{type:Yt().O.Vertical,initialFocus:0,store:y,onKeyboardArrow:v,disableCommandEnter:!0,disableInitialScroll:!0,sections:_().oE([...h,0===h.length&&{key:"no-results",render:e=>(0,Ge.jsx)(Kt().A,{...e,disableDesktopPadding:!0,style:m.menuSection,children:(0,Ge.jsx)(Rn,{})}),items:[]}])})})}const Pn=o.forwardRef((function(e,t){const{completion:i,context:r,getRecordModel:a,menuListStore:s,indexGlobal:u,section:d,indexLocal:c,cursorEditorInfoRef:p,setInfoHelper:m,isAssistantGenerating:y,onMouseEnter:h,...x}=e,b=(0,g().IS)((()=>({icon:{width:ht().Ev.sm,fill:F().Tj.icon.secondary},mobileQuestionMarkIcon:{width:28,height:28,fill:F().Tj.icon.tertiary},lightParentheses:{color:F().Tj.text.tertiary},text:{color:y?F().Tj.text.secondary:F().Tj.text.primary},menuItem:{cursor:y?"default":"pointer",direction:"ltr"}})),[y]),v=(0,o.useCallback)((e=>{l().A.isMobile||s.update((()=>({focus:{indexGlobal:u,indexLocal:c,section:d,footerFocused:!1}}))),null==h||h(e)}),[u,c,d,s,h]),k=e=>{e.preventDefault()},T=(0,f().K8)((()=>s.state.focus.indexGlobal===u),[s,u]),I=(0,E().tz)(),S=(0,o.useMemo)((()=>l().A.isMobile?(0,Ge.jsx)(Lt().A,{popupType:Lt().z.BottomSheet,renderOrigin:e=>(0,Ge.jsx)(Ue().A,{...e,ariaLabel:I.formatMessage(Mn.showDocumentation),iconStyle:b.mobileQuestionMarkIcon,style:{width:32,height:32},icon:Xt().questionMarkCircleIcon}),render:e=>{var t;let o;return o=l().A.isMobile?{menuType:Vt().gu.Modal,title:(0,Ge.jsx)(E().sA,{defaultMessage:"Documentation",id:"database.formulaPropertyEntryMenuItem.title"}),right:(0,Ge.jsx)(E().sA,{...n(245720).W.done}),onClickRight:e.close}:{menuType:Vt().gu.Popup},(0,Ge.jsx)(Ut().A,{...o,children:(0,Ge.jsx)(Kt().A,{children:(0,Ge.jsx)(n(424400).Ay,{title:(0,Ge.jsx)(yn,{infoHelper:{...i,calledFromUnifiedFunctionProperty:"member dot receiver"===(null==p||null===(t=p.current)||void 0===t||null===(t=t.completionsInfo)||void 0===t?void 0:t.type)},getRecordModel:a,style:{padding:4},typecheckContextValues:r.valueTypes,isLoading:!1}),style:{paddingTop:16,paddingBottom:16}})})})}}):(0,Ge.jsx)(En,{visible:T&&!y})),[i,r.valueTypes,p,a,T,y,b.mobileQuestionMarkIcon,I]),M=(0,f().K8)((()=>{var e;if(i.kind!==Ot().FormulaEditorInfoCompletionKind.Token||i.token.type!==Ot().FormulaTokenType.BlockProperty||!a)return;if(Ot().FormulaTokenSupportedBlockSystemPropertyList.includes(i.token.property))return i.token.property;if((0,C().ix)(i.token)||!i.token.collection)return;const t=(0,C().Yi)(i.token.property),n=a(i.token.collection);return null==n||null===(e=n.getNormalizedSchema())||void 0===e||null===(e=e[t])||void 0===e?void 0:e.type}),[i,a]);if(i.kind===Ot().FormulaEditorInfoCompletionKind.Token){if(i.token.type===Ot().FormulaTokenType.Checkbox)return null;if(i.token.type===Ot().FormulaTokenType.BlockProperty)return(0,Ge.jsx)(Ht().A,{...x,icon:M?zt().LE[M](b.icon):(0,Ge.jsx)(Fn,{type:"unknown"}),title:(0,Ge.jsx)("span",{style:b.text,children:i.name??i.token.property}),right:S,onMouseEnter:v,onMouseDown:k,style:b.menuItem,ref:t});if(i.token.type===Ot().FormulaTokenType.ContextValue){const e=(0,C().IV)(r.valueTypes,(0,C().GH)(i.token.valueId));return e?(0,Ge.jsx)(Ht().A,{...x,icon:(0,Ge.jsx)(_n,{contextValue:e}),title:(0,Ge.jsx)("div",{style:{display:"flex"},children:(0,Ge.jsx)("span",{style:b.text,children:e.name})}),right:S,onMouseEnter:v,style:b.menuItem,ref:t}):null}if(i.token.type===Ot().FormulaTokenType.Date)return null;if(i.token.type===Ot().FormulaTokenType.Block)return null;if(i.token.type===Ot().FormulaTokenType.Person)return null;(0,R().HB)(i.token)}else{if(i.kind===Ot().FormulaEditorInfoCompletionKind.LibraryFunction){const e=i.libraryFunction.returnType;return(0,Ge.jsx)(Ht().A,{...x,icon:(0,Ge.jsx)(Fn,{type:"function"==typeof e?e([]).type:e.type}),title:(0,Ge.jsxs)(Ge.Fragment,{children:[(0,Ge.jsx)("span",{style:b.text,children:i.libraryFunction.name}),(0,Ge.jsx)("span",{style:b.lightParentheses,children:"()"})]}),right:S,onMouseEnter:v,style:b.menuItem,ref:t})}if(i.kind===Ot().FormulaEditorInfoCompletionKind.Builtin)return(0,Ge.jsx)(Ht().A,{...x,title:(0,Ge.jsx)("span",{style:b.text,children:i.builtin}),icon:(0,Ge.jsx)(Fn,{type:Qt[i.builtin].type.type}),right:S,onMouseEnter:v,style:b.menuItem,ref:t});if(i.kind===Ot().FormulaEditorInfoCompletionKind.Binding)return(0,Ge.jsx)(Ht().A,{...x,title:(0,Ge.jsx)("span",{style:b.text,children:i.text}),icon:(0,Ge.jsx)(Fn,{type:i.type.type}),right:S,onMouseEnter:v,style:b.menuItem,ref:t});(0,R().HB)(i)}})),En=o.memo((function({visible:e}){const t=(0,g().IS)((()=>({icon:{transition:"opacity 50ms 200ms",visibility:e?"visible":"hidden",opacity:e?1:0}})),[e]);return(0,Ge.jsx)(Ve().I,{icon:n(871114).o,size:"xs",colorVariant:"secondary",style:t.icon})})),Fn=o.memo((function({type:e}){var t;const n=(0,g().IS)((()=>({icon:{width:ht().Ev.sm,fill:F().Tj.icon.secondary,transition:"transform .3s ease"}})),[]);return null===(t=Bn(e))||void 0===t?void 0:t(n.icon)}));function _n(e){const{contextValue:t}=e,o=(0,g().IS)((()=>({stepNumber:{color:F().Tj.icon.secondary}})),[]);return(0,R().O9)(t.stepNumberForDisplay)?(0,Ge.jsx)(n(931077).Q,{size:n(494379).H.Small,number:t.stepNumberForDisplay,style:o.stepNumber}):(0,Ge.jsx)(Fn,{type:t.type.type})}function Bn(e){return"text"===e?zt().LE.text:"number"===e?zt().LE.number:"checkbox"===e?zt().LE.checkbox:"date"===e?zt().LE.date:"block"===e?zt().LE.relation:"person"===e?zt().LE.person:"select"===e?zt().LE.select:"array"===e?zt().LE.multi_select:"function"===e||void 0===e||"unknown"===e||"undefined"===e?zt().LE.formula:void(0,R().HB)(e)}function Rn(){return(0,Ge.jsx)(Jt().A,{caption:(0,Ge.jsx)(E().sA,{defaultMessage:"No results",id:"FormulaAutocompleteMenu.noResults.message"})})}function Dn(e){var t,n;const{completion:o,store:i,selection:r,onChange:a,cursorEditorInfo:s}=e,l=(null==r?void 0:r.startIndex)||0,u=(null==r?void 0:r.endIndex)||0,d=l!==u,c="member dot receiver"===(null===(t=s.completionsInfo)||void 0===t?void 0:t.type),p=(s.nodePath??[]).at(-1),m=(0,Gt().canAcceptAutocompletionsWithoutDot)({nodeAtPosition:p,dotMemberExpression:c}),f=(null===(n=s.completionsInfo)||void 0===n?void 0:n.prefix)||"",g="overridePrefixLength"in o?o.overridePrefixLength??0:f.length,y=d?l:u-g,h=i.getValue();if(o.kind===Ot().FormulaEditorInfoCompletionKind.Token)if(o.token.type===Ot().FormulaTokenType.Checkbox);else if(o.token.type===Ot().FormulaTokenType.BlockProperty){if((0,C().ix)(o.token))return;const e=(0,P().lzV)(h,y,u),t=o.token.collection?(0,C().Yi)(o.token.property):o.token.property,n=(0,P().wmz)((0,P().ESw)({collection:o.token.collection,property:t,name:o.name})),i=y+(m?1:0)+1;a({newValue:(0,P().xym)(e,m?[["."],n]:[n],y),newSelection:{startIndex:i,endIndex:i}})}else if(o.token.type===Ot().FormulaTokenType.ContextValue){const e=(0,P().lzV)(h,y,u),t=(0,C().GH)(o.token.valueId),n=(0,P().wmz)((0,P().CA$)({id:t}));a({newValue:(0,P().xym)(e,m?[["."],n]:[n],y),newSelection:{startIndex:y+1,endIndex:y+1}})}else o.token.type===Ot().FormulaTokenType.Date||o.token.type===Ot().FormulaTokenType.Block||o.token.type===Ot().FormulaTokenType.Person||(0,R().HB)(o.token);else if(o.kind===Ot().FormulaEditorInfoCompletionKind.LibraryFunction){var x,b,v;const e=(0,P().lzV)(h,y,u),t=(0,P().Ey_)(`${o.libraryFunction.name}()`,[]),n=(0,P().xym)(e,m?[["."],t]:[t],y);let i=y+o.libraryFunction.name.length+1;m&&(i+=1),void 0===(null===(x=o.libraryFunction)||void 0===x||null===(x=x.parameters)||void 0===x?void 0:x.varargs)&&(null===(b=o.libraryFunction)||void 0===b||null===(b=b.parameters)||void 0===b||null===(b=b.expected)||void 0===b||!b.length||1===(null===(v=o.libraryFunction)||void 0===v||null===(v=v.parameters)||void 0===v||null===(v=v.expected)||void 0===v?void 0:v.length)&&c)&&(i+=1);a({newValue:n,newSelection:{startIndex:i,endIndex:i}})}else if(o.kind===Ot().FormulaEditorInfoCompletionKind.Binding||o.kind===Ot().FormulaEditorInfoCompletionKind.Builtin){const e=(0,P().lzV)(h,y,u);let t="";o.kind===Ot().FormulaEditorInfoCompletionKind.Binding?t=o.text:o.kind===Ot().FormulaEditorInfoCompletionKind.Builtin?(t=o.builtin,((null==p?void 0:p.kind)!==M().NM.Call||c)&&(void 0!==p&&p.kind!==M().NM.RecoveryNode&&(t=" "+t),t+=" ")):(0,R().HB)(o);const n=(0,P().Ey_)(t,[]),i=(0,P().xym)(e,[n],y),r=y+t.length;a({newValue:i,newSelection:{startIndex:r,endIndex:r}})}else(0,R().HB)(o)}const Nn=(0,E().YK)({[Ot().FormulaEditorInfoCompletionKind.Token]:{defaultMessage:"Properties",id:"formulaAutocompleteMenu.token.message"},[Ot().FormulaEditorInfoCompletionKind.LibraryFunction]:{defaultMessage:"Functions",id:"formulaAutocompleteMenu.function.message"},[Ot().FormulaEditorInfoCompletionKind.Binding]:{defaultMessage:"Variables",id:"formulaAutocompleteMenu.variables.message"},[Ot().FormulaEditorInfoCompletionKind.Builtin]:{defaultMessage:"Built-ins",id:"formulaAutocompleteMenu.builtin.message"}}),Ln={[Ot().FormulaEditorInfoCompletionKind.Token]:Nn[Ot().FormulaEditorInfoCompletionKind.Token],[Ot().FormulaEditorInfoCompletionKind.LibraryFunction]:Nn[Ot().FormulaEditorInfoCompletionKind.LibraryFunction],[Ot().FormulaEditorInfoCompletionKind.Binding]:Nn[Ot().FormulaEditorInfoCompletionKind.Binding],[Ot().FormulaEditorInfoCompletionKind.Builtin]:Nn[Ot().FormulaEditorInfoCompletionKind.Builtin]},Vn=(0,E().YK)({conditional:{defaultMessage:"Conditional",id:"formulaAutocompleteMenu.category.conditional.message"},text:{defaultMessage:"Text",id:"formulaAutocompleteMenu.category.text.message"},number:{defaultMessage:"Number",id:"formulaAutocompleteMenu.category.number.message"},date:{defaultMessage:"Date",id:"formulaAutocompleteMenu.category.date.message"},people:{defaultMessage:"People",id:"formulaAutocompleteMenu.category.people.message"},list:{defaultMessage:"List",id:"formulaAutocompleteMenu.category.list.message"},generic:{defaultMessage:"General",id:"formulaAutocompleteMenu.category.generic.message"},variable:{defaultMessage:"Variable",id:"formulaAutocompleteMenu.category.variable.message"},special:{defaultMessage:"Special",id:"formulaAutocompleteMenu.category.special.message"},internal:{defaultMessage:"Internal",id:"formulaAutocompleteMenu.category.internal.message"}}),Un={conditional:Vn.conditional,text:Vn.text,number:Vn.number,date:Vn.date,people:Vn.people,list:Vn.list,generic:Vn.generic,variable:Vn.variable,special:Vn.special,internal:Vn.internal};n(823215);var Hn=()=>n(757695),Yn=()=>n(970236),Kn=()=>n(287188),Wn=()=>n(708685),zn=()=>n(784892),On=()=>n(971003),Gn=()=>n(968021);const $n=new(H().R)({key:"formulas_show_structure",namespace:n(553737).Bq,important:!0,trackingType:"preference"});var qn=()=>n(956394),Qn=()=>n(648747);function Zn({values:e,blockStore:t,formulaSchema:n,shouldTruncate:o,showNestedStructure:i}){const r=(0,g().IS)((()=>({comma:{marginInlineEnd:2},moreIndicator:{color:F().Tj.text.secondary,opacity:.5,fontSize:i?12:14}})),[i]),a=e.length>5,s=a?e.slice(0,3):e,l=a?e.length-4:0,u=a?e[e.length-1]:void 0;return(0,Ge.jsxs)(Ge.Fragment,{children:[s.map(((e,r)=>(0,Ge.jsx)(Xn,{value:e,withComma:a||r<s.length-1,blockStore:t,formulaSchema:n,renderWrapper:!1,shouldTruncate:o,showNestedStructure:i},r))),a&&u?(0,Ge.jsxs)(Ge.Fragment,{children:[(0,Ge.jsxs)("span",{children:[(0,Ge.jsxs)("span",{style:r.moreIndicator,children:["... (",(0,Ge.jsx)(E().sA,{defaultMessage:"{count} items",id:"formula.preview.truncatedItems.message",values:{count:l}}),")"]}),(0,Ge.jsx)("span",{style:r.comma,children:", "})]}),(0,Ge.jsx)(Xn,{value:u,withComma:!1,blockStore:t,formulaSchema:n,renderWrapper:!1,shouldTruncate:o,showNestedStructure:i},"last")]}):void 0]})}function Xn({value:e,withComma:t,blockStore:n,formulaSchema:i,renderWrapper:r,shouldTruncate:a,showNestedStructure:s}){const[l,u]=(0,f().K8)((()=>{var t;if(!e)return[[],"text"];if("undefined"===e.type&&s)return[[qn().Or],"empty"];let o=(0,Qn().O)(e,n.getRecordModel,(0,w().P)());s&&(o=function(e){return e.map((e=>{if("text"===e.type&&e.value){const t=e.value.map((e=>{if((0,P().bHQ)(e)){return[eo((0,P().N8A)(e))]}if((0,P().BEe)(e)){return[eo((0,P().N8A)(e)),e[1]]}return e}));return{...e,value:t}}return e}))}(o));return[o,(null===(t=o[0])||void 0===t?void 0:t.type)??"text"]}),[n.getRecordModel,e,s]),d=(0,g().IS)((()=>({rightBracket:{marginInlineStart:2},leftBracket:{marginInlineEnd:2},comma:{marginInlineEnd:2},formulaPreview:{color:F().Tj.text.secondary,fontSize:s?12:14,fontFamily:s?ze().Tf.githubMono:void 0,display:"inline-flex",alignItems:"center",gap:s?0:6,...a?ze().RC:{}},typeIndicator:{opacity:.5,marginInlineStart:4,fontSize:8},wrapperDiv:{display:"inline-flex",alignItems:"center",justifyContent:"center",textWrap:"wrap",wordBreak:"break-word"}})),[a,s]);let c;if("array"===e.type)c=(0,Ge.jsxs)("span",{style:d.formulaPreview,children:[s?(0,Ge.jsxs)(Ge.Fragment,{children:[(0,Ge.jsx)("span",{style:d.leftBracket,children:"["}),(0,Ge.jsx)(Zn,{values:e.values,blockStore:n,formulaSchema:i,shouldTruncate:a,showNestedStructure:s}),(0,Ge.jsx)("span",{style:d.rightBracket,children:"]"}),(0,Ge.jsx)("span",{style:d.typeIndicator,children:`list(${e.values.length})`})]}):(0,Ge.jsx)(Zn,{values:e.values,blockStore:n,formulaSchema:i,shouldTruncate:a,showNestedStructure:s}),t?(0,Ge.jsx)("span",{style:d.comma,children:", "}):void 0]});else{const e=t&&!s&&(0,qn().GL)(u,i);c=null==l?void 0:l.map(((r,l)=>(0,Ge.jsxs)(o.Fragment,{children:[(0,Ge.jsxs)("span",{style:d.formulaPreview,children:[(0,Ge.jsx)(qn().yZ,{token:r,targetPropertySchema:i,blockStore:n,withComma:e,numberRightAlign:!1,disableLinks:!1,shouldTruncate:a}),s&&Jn(r)?(0,Ge.jsx)("span",{style:d.typeIndicator,children:Jn(r)}):null]}),s&&t?(0,Ge.jsx)("span",{style:d.comma,children:", "}):null]},`${r.id}-${l}`)))}return r?(0,Ge.jsx)(qn().Ye,{propertyType:u,rootPropertySchema:i,numberRightAlign:!1,children:c}):(0,Ge.jsx)("div",{style:d.wrapperDiv,children:c})}function Jn(e){switch(e.type){case"text":case"url":case"email":case"phone_number":return`text(${(0,P().AhH)(e.value)})`;case"select":return`text(${e.value})`;case"number":return"num";case"date":return"date";case"checkbox":case"person":case"empty":case"relation":case"file":case"error":return null;default:return(0,R().HB)(e)}}function eo(e){return e.replace(/\\/g,"\\\\").replace(/\n/g,"\\n").replace(/\t/g,"\\t").replace(/\r/g,"\\r")}var to=()=>n(876776);function no(e){const t=(0,f().O$)($n);return e||(t??!1)}function oo({isLoading:e,hasErrors:t,hasWarnings:n,debouncedErrorMessagesWithRange:o,formulaResult:i,returnType:r,formulaSchema:a,collectionStore:s,selectedBlockStore:l,setSelectedBlockStore:u,showFixWithAiButton:d,isAiGenerating:c,onFixWithAi:p}){const m=no(void 0===s),f=(0,g().IS)((()=>({outputContainerWrapper:{display:"flex",flexDirection:"column",zIndex:1,width:"100%",textWrap:"nowrap",gap:8,padding:16,borderTop:`1px solid ${F().Tj.border.primary}`},contentContainer:{display:"flex",flexDirection:"column",alignItems:"flex-start",justifyContent:"center",zIndex:1,minHeight:24,width:"100%",gap:4},headerContainer:{display:"flex",flexDirection:"row",alignItems:"center",gap:2,opacity:.8,minHeight:24}})),[]);return(0,Ge.jsxs)("div",{style:f.outputContainerWrapper,children:[(0,Ge.jsx)("div",{style:f.headerContainer,children:e?(0,Ge.jsx)(po,{showDropdown:void 0!==s}):(0,Ge.jsx)(ro,{collectionStore:s,selectedBlockStore:l,setSelectedBlockStore:u})}),(0,Ge.jsx)("div",{style:f.contentContainer,children:e?(0,Ge.jsx)(co,{}):(0,Ge.jsx)(io,{selectedBlockStore:l,hasErrors:t,hasWarnings:n,debouncedErrorMessagesWithRange:o,formulaResult:i,returnType:r,formulaSchema:a,isDebugMode:m,showFixWithAiButton:d,isAiGenerating:c,onFixWithAi:p})})]})}function io({selectedBlockStore:e,hasErrors:t,hasWarnings:n,debouncedErrorMessagesWithRange:i,formulaResult:r,returnType:a,formulaSchema:s,isDebugMode:l,showFixWithAiButton:u,isAiGenerating:d,onFixWithAi:c}){const p=(0,g().IS)((()=>({containerWithWarnings:{display:"flex",flexDirection:"column",gap:4,width:"100%"},outputContainer:{display:"flex",justifyContent:"space-between",gap:6,position:"relative",width:"100%",overflow:"hidden"},resultAndWarningsContainer:{display:"flex",flexDirection:"column",gap:4,width:"100%"},badgeStyle:{display:"flex",height:20,padding:"2px 5px",justifyContent:"center",alignItems:"center",borderRadius:6,background:F().Tj.gray.background.secondaryTranslucent,marginInlineStart:0,alignSelf:"flex-start"}})),[]),m=(0,E().tz)(),f=m.formatMessage({id:"formulas.editor.type",defaultMessage:"Type: "}),y=m.formatMessage({id:"formulas.editor.valid",defaultMessage:"Valid"}),h=(0,o.useMemo)((()=>a?(0,Wn().getHumanReadableType)(a):$t().qY.unknown),[a]),x=i.filter((e=>"error"===e.severity)),b=i.filter((e=>"warning"===e.severity));if(t)return(0,Ge.jsxs)("div",{style:p.resultAndWarningsContainer,children:[x.length>0?(0,Ge.jsx)(lo,{errorMessagesWithRange:x}):(0,Ge.jsx)(co,{}),n&&b.length>0&&l?(0,Ge.jsx)(lo,{errorMessagesWithRange:b}):void 0,u&&c?(0,Ge.jsx)(fo,{onClick:c,disabled:d}):void 0]});const v=e&&s;return(0,Ge.jsxs)("div",{style:p.containerWithWarnings,children:[(0,Ge.jsxs)("div",{style:p.outputContainer,children:[v?(0,Ge.jsx)(ao,{formulaResult:r,formulaSchema:s,selectedBlockStore:e}):n?void 0:(0,Ge.jsx)("div",{children:(0,Ge.jsx)(Ie().D,{as:"span",styleKey:"bodyRegular",colorPalette:"green",colorVariant:"secondary",children:y})}),(0,Ge.jsx)(Yn().E,{content:(0,Ge.jsxs)(Ie().D,{styleKey:"captionRegular",colorVariant:"secondary",children:[f,(0,Ge.jsx)(E().sA,{...h})]}),style:p.badgeStyle})]}),n&&b.length>0&&l?(0,Ge.jsxs)(Ge.Fragment,{children:[(0,Ge.jsx)(lo,{errorMessagesWithRange:b}),u&&c?(0,Ge.jsx)(fo,{onClick:c,disabled:d}):void 0]}):void 0]})}function ro({collectionStore:e,selectedBlockStore:t,setSelectedBlockStore:n}){const o=(0,E().tz)(),i=o.formatMessage({id:"formulas.editor.syntaxValidation",defaultMessage:"Syntax validation"}),r=o.formatMessage({id:"formulas.editor.previewWith",defaultMessage:"Preview with"}),a=(0,g().IS)((()=>({headerContent:{display:"flex",alignItems:"center",justifyContent:"space-between",width:"100%",gap:8},leftSection:{display:"flex",alignItems:"center",gap:2}})),[]);return(0,Ge.jsxs)("div",{style:a.headerContent,children:[(0,Ge.jsxs)("div",{style:a.leftSection,children:[(0,Ge.jsx)(Ie().D,{styleKey:"captionMedium",colorVariant:"secondary",children:e?r:i}),e?(0,Ge.jsx)(to().Y,{selectedBlockStore:t,setSelectedBlockStore:n,collectionStore:e}):void 0]}),e?(0,Ge.jsx)(mo,{}):void 0]})}function ao({formulaResult:e,formulaSchema:t,selectedBlockStore:n}){const i=(0,E().tz)().formatMessage({id:"formulas.editor.empty",defaultMessage:"No output"}),r=(0,f().K8)((()=>function e(t){if(!t||"undefined"===t.type)return!0;if("text"===t.type){return 0===(0,Pe().r4)(t.value,n).trim().length}return"array"===t.type&&(0===t.values.length||t.values.every(e))}(e)),[e,n]),a=(0,f().K8)((()=>$n.state??!1),[]),s=(0,o.useMemo)((()=>({baseStyles:{sizing:"small",tokenFormat:zn().NY.Medium,tokenWrapStyle:{display:"flex",flexWrap:"wrap",overflow:"hidden",...Gn().Cn[zn().NY.Medium]},textStyle:{overflow:"hidden"}},store:n,isEmptyStore:Hn().Store.createValue(!1),canEdit:!1,disabled:!1,shouldRenderTooltip:!0,shouldWrap:!0,collectionContextStore:void 0,templateVariableContext:void 0,property:void 0,propertyFormat:void 0,propertySchema:t,trackEditBlockProperty:()=>{},surface:"table",containerRef:null,collectionSchemaStore:Hn().Store.createValue(void 0)})),[n,t]);return!e||r?(0,Ge.jsx)("div",{children:(0,Ge.jsx)(Ie().D,{as:"span",styleKey:"bodyRegular",colorVariant:"tertiary",children:i})}):(0,Ge.jsx)("div",{style:{maxWidth:"100%",position:"relative",overflow:"hidden",display:"flex",alignItems:"center",gap:8},children:(0,Ge.jsx)(On().L8.Provider,{value:s,children:(0,Ge.jsx)(Xn,{showNestedStructure:a,value:e,withComma:!1,blockStore:n,formulaSchema:t,renderWrapper:!0,shouldTruncate:!0})})})}const so=l().A.isMobile?2:3;function lo({errorMessagesWithRange:e}){return(0,Ge.jsx)(Ge.Fragment,{children:e.slice(0,so).map(((e,t)=>(0,Ge.jsx)(uo,{errorMessageWithRange:e},t)))})}function uo({errorMessageWithRange:e}){const{msg:t,range:n,severity:o,helpLink:i}=e,r=(0,E().tz)(),a="warning"===o?"yellow":"red",s=n?` [${n.startIndex},${n.endIndex}]`:"",l=(0,g().IS)((()=>({container:{display:"flex",alignItems:"center",gap:4}})),[]);return(0,Ge.jsxs)("div",{style:l.container,children:[(0,Ge.jsxs)("div",{children:[(0,Ge.jsx)(Ie().D,{as:"span",styleKey:"bodyRegular",colorPalette:a,colorVariant:"accentPrimary",children:t}),(0,Ge.jsx)(Ie().D,{as:"span",styleKey:"bodyRegular",colorPalette:a,colorVariant:"secondary",children:s})]}),i?(0,Ge.jsx)(Ye().m,{placement:"top",renderTooltip:()=>r.formatMessage({id:"formulas.editor.learnMore",defaultMessage:"Learn more"}),render:e=>(0,Ge.jsx)(Ue().A,{...e,icon:Xt().questionMarkCircleIcon,onClick:()=>window.open(i,"_blank","noopener,noreferrer"),size:"sm",colorPalette:a,colorVariant:"accentPrimary",ariaLabel:r.formatMessage({id:"formulas.editor.helpLink",defaultMessage:"Help"})})}):void 0]})}function co(){const e=(0,g().IS)((()=>({outputContainer:{display:"flex",justifyContent:"space-between",gap:6,position:"relative",width:"100%",overflow:"hidden"},lineContainer:{display:"flex",alignItems:"center",justifyContent:"center",width:"50%"},lineSkeleton:{height:16,borderRadius:4,flex:1},badgeSkeleton:{height:20,width:80,borderRadius:6}})),[]);return(0,Ge.jsxs)("div",{style:e.outputContainer,children:[(0,Ge.jsx)("div",{style:e.lineContainer,children:(0,Ge.jsx)(ke().P,{style:e.lineSkeleton})}),(0,Ge.jsx)(ke().P,{style:e.badgeSkeleton})]})}function po({showDropdown:e}){const t=(0,g().IS)((()=>({headerContainer:{display:"flex",alignItems:"center",justifyContent:"space-between",width:"100%",gap:8,opacity:.8,height:24},leftSection:{display:"flex",alignItems:"center",gap:2},textSkeleton:{height:14,width:80,borderRadius:4},dropdownSkeleton:{height:16,width:80,borderRadius:6},advancedModeContainer:{display:"flex",alignItems:"center",gap:6},toggleSkeleton:{height:16,width:32,borderRadius:8},advancedModeLabelSkeleton:{height:16,width:90,borderRadius:4}})),[]);return(0,Ge.jsxs)("div",{style:t.headerContainer,children:[(0,Ge.jsxs)("div",{style:t.leftSection,children:[(0,Ge.jsx)(ke().P,{style:t.textSkeleton}),e?(0,Ge.jsx)(ke().P,{style:t.dropdownSkeleton}):void 0]}),e?(0,Ge.jsxs)("div",{style:t.advancedModeContainer,children:[(0,Ge.jsx)(ke().P,{style:t.toggleSkeleton}),(0,Ge.jsx)(ke().P,{style:t.advancedModeLabelSkeleton})]}):void 0]})}function mo(){const e=(0,f().K8)((()=>$n.state??!1),[]),t=(0,E().tz)().formatMessage({id:"formulas.editor.debugMode",defaultMessage:"Debug mode"}),n=(0,g().IS)((()=>({toggleContainer:{display:"flex",alignItems:"center",gap:6}})),[]);return(0,Ge.jsxs)("div",{style:n.toggleContainer,children:[(0,Ge.jsx)(Kn().A,{on:e,onClick:()=>{$n.setState(!e)},"aria-label":t}),(0,Ge.jsx)(Ie().D,{styleKey:"captionRegular",colorVariant:"secondary",children:t})]})}function fo({onClick:e,disabled:t}){const n=(0,E().tz)().formatMessage({id:"formulas.editor.fixWithAI",defaultMessage:"Fix with AI"}),o=(0,g().IS)((()=>({button:{display:"flex",alignItems:"center",gap:6,padding:"4px 8px",borderRadius:6,backgroundColor:"transparent",border:`1px solid ${F().Tj.border.primary}`,cursor:t?"not-allowed":"pointer",height:26,width:"fit-content",opacity:t?.5:1,marginTop:4}})),[t]);return(0,Ge.jsx)(Qe().Ay,{style:o.button,onClick:e,disabled:t,children:(0,Ge.jsx)(Ie().D,{styleKey:"bodyRegular",colorVariant:"primary",children:n})})}var go=()=>n(771540),yo=()=>n(631524),ho=()=>n(160432),xo=()=>n(995847),bo=()=>n(232930);const vo=(0,E().YK)({undoMessage:{defaultMessage:"Undo",id:"database.formula.undoFormulaInput.tooltip"},doneHint:{defaultMessage:"Close",id:"database.formula.closeFormulaInput.tooltip"},cancel:{defaultMessage:"Cancel",id:"formulas.formulaInputHeader.cancel"},close:{id:"formula2Input.close",defaultMessage:"Done"},save:{id:"formula2Input.save",defaultMessage:"Save"},formulaHeader:{id:"formula2Input.EditFormula",defaultMessage:"Edit formula"},learnTooltip:{id:"formula2Input.learnAboutFormulas",defaultMessage:"Learn about formulas!"},discardAllChanges:{id:"formula2Input.discardAllChanges",defaultMessage:"Discard all changes"},revertTooltip:{id:"formula2Input.revertTooltip",defaultMessage:"Reverts to the original formula when first opened."},startLoading:{id:"formula2Input.startLoading",defaultMessage:"Start loading"},stopLoading:{id:"formula2Input.stopLoading",defaultMessage:"Stop loading"}});function ko(e){const{disabled:t,onClickCancel:n,onClickRevert:o,onClickClose:i,onClickUndo:r,setIsLoading:a,autosave:s=!0,isEdited:u=!1}=e,d=(0,g().IS)((()=>({headerRow:{display:"flex",flexDirection:"row",alignItems:"center",paddingTop:0,paddingInlineEnd:0,paddingBottom:0,paddingInlineStart:6,gap:3,height:24,flex:"none",flexGrow:1}})),[]);return(0,Ge.jsxs)(ve().Y1,{direction:"horizontal",style:d.headerRow,children:[n&&!t&&l().A.isMobile?(0,Ge.jsxs)(Ge.Fragment,{children:[(0,Ge.jsx)(ve().Y1,{width:"hug",children:(0,Ge.jsx)(To,{onClick:n})}),(0,Ge.jsx)(ve().Y1,{width:"fill"})]}):(0,Ge.jsx)(ve().Y1,{width:"hug",children:(0,Ge.jsx)(So,{setIsLoading:a})}),(0,Ge.jsx)(ve().Y1,{width:"fill"}),(0,Ge.jsxs)(ve().Y1,{width:"hug",direction:"horizontal",gap:6,align:"center-right",children:[r&&!t?(0,Ge.jsx)(Mo,{onClick:r}):void 0,o&&!t?(0,Ge.jsx)(Co,{onClick:o}):void 0,(0,Ge.jsx)(Io,{onClick:i,autosave:s,isEdited:u})]})]})}function To(e){const{onClick:t}=e,n=(0,E().tz)();return(0,Ge.jsx)(yo().p,{colorPalette:"gray",size:"sm",onClick:t,children:n.formatMessage(vo.cancel)})}function Io(e){const{onClick:t,autosave:n=!0,isEdited:o=!1}=e,i=(0,E().tz)(),r=(0,d().v3)(),a=(0,g().IS)((()=>({closeButton:{display:"flex",alignItems:"center",justifyContent:"center",borderRadius:"100%",background:F().Tj.background.tertiaryTranslucent,width:24,height:24},closeButtonHover:{background:F().Tj.buttonPressedBackground},doneButton:{display:"flex",flexDirection:"row",justifyContent:"center",alignItems:"center",padding:8,gap:6,width:52,height:28,borderRadius:6,flex:"none",flexGrow:0},doneButtonCommandHint:{color:F().Tj.text.inverseSecondary}})),[]);return n?(0,Ge.jsx)(Ye().m,{renderTooltip:()=>i.formatMessage(vo.doneHint),render:e=>(0,Ge.jsx)(Qe().Ay,{onClick:t,style:a.closeButton,hoveredStyle:a.closeButtonHover,...e,children:(0,Ge.jsx)(Ve().I,{icon:xo().xMarkSmallIcon,size:"xs",colorVariant:"secondary"})})}):(0,Ge.jsx)(Ye().m,{renderTooltip:()=>(0,Ge.jsxs)("span",{children:[i.formatMessage(vo.doneHint)," ",(0,Ge.jsx)("span",{style:a.doneButtonCommandHint,children:(0,go()._w)({environment:r}).esc})]}),render:e=>(0,Ge.jsx)(ho().A,{colorPalette:"blue",onClick:t,style:a.doneButton,...e,children:i.formatMessage(o?vo.save:vo.close)})})}function So(e){const{setIsLoading:t}=e,n=(0,E().tz)(),[i,r]=o.useState(!1),[a,s]=o.useState(!1),l=(0,g().IS)((()=>({headerTitle:{display:"flex",alignItems:"center",gap:4},helpButton:{width:24,height:24,flex:"none",flexGrow:0},loadingToggleButton:{width:24,height:24,flex:"none",flexGrow:0}})),[]);return(0,Ge.jsxs)("div",{style:l.headerTitle,onMouseEnter:()=>{r(!0)},onMouseLeave:()=>{r(!1)},children:[(0,Ge.jsx)(Ie().D,{styleKey:"bodyLgSemibold",colorVariant:"primary",children:n.formatMessage(vo.formulaHeader)}),(0,Ge.jsx)(Ye().m,{placement:"top",render:e=>(0,Ge.jsx)(Ue().A,{...e,ariaLabel:n.formatMessage(vo.learnTooltip),icon:Xt().questionMarkCircleIcon,href:(0,bo().x)("guides.formulas"),external:!0,style:l.helpButton}),renderTooltip:()=>n.formatMessage(vo.learnTooltip)}),void 0]})}function Mo(e){const{onClick:t}=e,n=(0,E().tz)(),o=(0,g().IS)((()=>({undoButton:{display:"none",height:28,padding:"0px 8px",justifyContent:"center",alignItems:"center",gap:6,color:F().Tj.text.primary}})),[]);return(0,Ge.jsx)(yo().p,{colorPalette:"gray",size:"sm",style:o.undoButton,onClick:t,children:n.formatMessage(vo.undoMessage)})}function Co(e){const{onClick:t}=e,n=(0,E().tz)(),o=(0,g().IS)((()=>({revertButton:{display:"flex",height:28,padding:"0px 8px",justifyContent:"center",alignItems:"center",gap:6,color:F().Tj.text.primary}})),[]);return(0,Ge.jsx)(Ye().m,{placement:"top",render:e=>(0,Ge.jsx)(yo().p,{...e,"aria-label":n.formatMessage(vo.revertTooltip),colorPalette:"gray",size:"sm",style:o.revertButton,onClick:t,children:n.formatMessage(vo.discardAllChanges)}),renderTooltip:()=>n.formatMessage(vo.revertTooltip)})}n(737550);var wo=()=>n(135168),Ao=()=>n(717137),jo=()=>n(711339),Po=()=>n(634201),Eo=()=>n(803960),Fo=()=>n(558842),_o=()=>n(495262),Bo=()=>n(109335),Ro=()=>n(675925),Do=()=>n(477450),No=()=>n(548161),Lo=()=>n(659602),Vo=()=>n(335722),Uo=()=>n(562800),Ho=()=>n(66372);const Yo=Gn().gJ,Ko=l().A.isMobile?6:4,Wo=l().A.isMobile?12:14,zo=24+Gn().Yu*Ko,Oo=24+Gn().Yu*Wo;var Go=()=>n(412237);const $o=(0,E().YK)({aiToggleTooltip:{id:"formulas.aiToggleTooltip",defaultMessage:"Toggle formula assistant"}});function qo({isAssistantVisible:e,onToggleAssistant:t}){const[n,i]=(0,o.useState)(!1),r=(0,E().tz)(),a=(0,g().IS)((()=>({toggleButton:{display:"none",position:"absolute",bottom:4,insetInlineStart:4,width:16,height:16,borderRadius:4,alignItems:"center",justifyContent:"center",zIndex:20,cursor:"pointer",transition:"all 0.2s ease",opacity:.7,background:n?F().Tj.buttonHoveredBackground:"transparent"}})),[n]);return(0,Ge.jsx)(Ye().m,{placement:"top",alignment:"center",delayThreshold:500,renderTooltip:()=>(0,Ge.jsx)(Ie().D,{styleKey:"captionMedium",colorVariant:"inversePrimary",children:r.formatMessage($o.aiToggleTooltip)}),render:n=>(0,Ge.jsx)("div",{...n,style:{...a.toggleButton},onClick:e=>{e.preventDefault(),e.stopPropagation(),t()},onMouseDown:e=>{e.preventDefault(),e.stopPropagation()},onFocus:e=>{e.preventDefault(),e.stopPropagation()},onMouseEnter:e=>{var t;i(!0),null===(t=n.onMouseEnter)||void 0===t||t.call(n,e)},onMouseLeave:e=>{var t;i(!1),null===(t=n.onMouseLeave)||void 0===t||t.call(n,e)},role:"button","aria-pressed":e,"aria-label":r.formatMessage($o.aiToggleTooltip),tabIndex:0,children:(0,Ge.jsx)(Ve().I,{icon:Go().aiFaceSmallIcon,size:l().A.isMobile?"xs":"xxs",colorVariant:"secondary"})})})}var Qo=()=>n(246474);const Zo={borderRadius:4,flexGrow:1,flexShrink:1,fontFamily:ze().vc(n(609679).locale).githubMono,fontSize:Yo,height:"100%",width:"100%",minHeight:"1em",padding:12,tabSize:2,textAlign:"start",whiteSpace:"pre-wrap",wordBreak:"break-all",unicodeBidi:"inherit"},Xo=(0,E().YK)({formulaPlaceholder:{id:"formulas.formulaPlaceholder",defaultMessage:"Your formula"}});function Jo(e){const{analyticsContext:t,clipboardActions:n,disabled:i,errorRanges:r,formulasModule:a,handleClose:s,markdownLinkifyIt:l,parentSpaceId:u,Prism:c,store:m,tinyMceMicrosoftWordPasteFilter:y,valueTypes:h,isAssistantVisible:x,onToggleAssistant:b,setIsLoading:I,parentCollectionStore:S}=e;(0,o.useEffect)((()=>{I(!1)}),[I]);const M=(0,o.useRef)(null),C=(0,g().DP)(),w=(0,d().v3)(),A=(0,f().K8)((()=>m.getValue()||[]),[m],{debugName:"FormulaInputTextImpl.textValueStore"}),j=(0,o.useRef)(null),{isScrolledToBottom:E,scrollToBottomAndSetAutoscroll:B,scrollToBottom:R}=De({scrollableRef:j,environment:w}),D=function({scrollableRef:e,textValue:t}){const[n,i]=(0,o.useState)(0),[r,a]=(0,o.useState)(zo);return(0,o.useLayoutEffect)((()=>{const t=e.current;if(!t)return;const o=t.scrollHeight;n!==o&&i(o),o!==r?zo>o?r!==zo&&a(zo):o>Oo?r!==Oo&&a(Oo):void 0!==r&&a(void 0):n&&n>o&&o===Oo&&a(void 0)}),[t,r,e,n]),r}({scrollableRef:j,textValue:A}),[N,L]=(0,o.useState)(!0),V=(0,g().IS)((()=>({default:{boxSizing:"border-box",width:"100%",height:D,background:F().Tj.background.secondary,boxShadow:F().Tj.inputBoxShadow,borderRadius:10,position:"relative"},scrollableInner:{width:"100%",height:"100%",overflow:"auto",scrollbarWidth:"thin",scrollbarColor:`${F().Tj.icon.secondary} transparent`},focused:{boxShadow:F().Tj.inputBlueFocusRing},scrollToBottomButton:{position:"absolute",insetInlineStart:"50%",bottom:12,marginInlineStart:-16,zIndex:20,padding:6,borderRadius:20,backgroundColor:F().Tj.primaryBlack,border:"none",transition:"opacity 150ms ease-out",opacity:0,pointerEvents:"none"},scrollToBottomButtonVisible:{opacity:.7,pointerEvents:"auto"},chevronDownIcon:{fill:F().Tj.white}})),[D]),U=(0,o.useCallback)((()=>{var e;return(null===(e=M.current)||void 0===e?void 0:e.getNode())||void 0}),[M]),H=(0,f().K8)((()=>{var e;const t=T().default.state;return"editing"===t.mode&&(null===(e=(0,k().H)(t.multiSelection))||void 0===e?void 0:e.store)===m}),[m]),Y=(0,o.useCallback)((()=>{var e;return null===(e=U())||void 0===e?void 0:e.blur()}),[U]),K=(0,o.useCallback)((()=>{const e=Po().PE(P().q4_(A));return{endIndex:e.length,startIndex:e.length}}),[A]),z=(0,o.useCallback)((()=>{if(H)return(0,Ho().D)(m)}),[H,m]),O=(0,o.useCallback)((e=>{Pe().HP({canEdit:!i,editorNode:U(),environment:w,event:e,store:m,textValue:A})}),[w,A,U,m,i]),G=(0,o.useCallback)((e=>{if(i)return;const t=T().default.state;"editing"===t.mode&&t.multiSelection.start.store===m&&pe().createAndCommit({userAction:"FormulaInputTextImpl.handleDelete",environment:w,canUndo:!0,perform:o=>{Bo().wT({environment:w,multiSelection:t.multiSelection,deleteForwards:!0,transaction:o,event:e,editorMode:"default"}),o.postEnqueueActions.push((()=>{pe().createAndCommit({userAction:"FormulaInputTextImpl.normalizeTextValue",environment:w,canUndo:!0,perform:e=>{me({clipboardActions:n,formulasModule:a,store:m,transaction:e})}})}))}})}),[i,w,m,n,a]),$=(0,o.useCallback)((e=>{if(i)return;const t=T().default.state;if("editing"===t.mode&&t.multiSelection.start.store===m){if(Bo().CZ({device:w.device,event:e,multiSelection:t.multiSelection}))return;pe().createAndCommit({userAction:"FormulaInputTextImpl.handleBackspace",environment:w,canUndo:!0,perform:o=>{Bo().wT({environment:w,multiSelection:t.multiSelection,deleteForwards:!1,transaction:o,event:e,editorMode:"default"}),o.postEnqueueActions.push((()=>{pe().createAndCommit({userAction:"FormulaInputTextImpl.normalizeTextValue",environment:w,canUndo:!0,perform:e=>{me({clipboardActions:n,formulasModule:a,store:m,transaction:e})}})}))}})}}),[i,w,m,n,a]),q=(0,o.useCallback)((e=>{var t,n,o;if(i)return;if(null===(t=e.preventDefault)||void 0===t||t.call(e),M.current&&M.current.isComposing())return;const r=T().default.state,a="editing"===r.mode&&(0,k().H)(r.multiSelection);if(!a)return;const s=Po().PE(P().q4_(A)),l=null===(n=s.slice(0,a.selection.startIndex).join("").split("\n"))||void 0===n?void 0:n.at(-1),u=(null==l||null===(o=l.match(/^\t*/))||void 0===o?void 0:o[0].length)||0,d=(null==l?void 0:l.split("").reverse())||[];let c=0;const p=d.some((e=>{if(")"===e)c++;else if("("===e){if(0===c)return!0;c--}return!1}))?u+1:u;let f="\t".repeat(p);const g=")"===s[a.selection.endIndex],y=Boolean(null==l?void 0:l.endsWith("("))&&g;y&&(f+=`\n${"\t".repeat(p-1)}`),pe().createAndCommit({userAction:"FormulaInputTextImpl.handleShiftEnter",environment:w,canUndo:!0,perform:e=>{ce().$D({environment:w,editorMode:"default",store:m,string:`\n${f}`,selection:a.selection,disableMentions:!0,disableSlashCommands:!0,disableEmojiCommands:!0,transaction:e}),y&&(0,v().t)({store:m,selection:{startIndex:a.selection.startIndex+p+1,endIndex:a.selection.startIndex+p+1}})}})}),[i,w,m,A]),Q=(0,o.useCallback)((e=>{var t;const o=window.getSelection();null!=o&&o.anchorNode&&null!==(t=U())&&void 0!==t&&t.contains(o.anchorNode)&&n.copy({environment:w,event:e,markdownLinkifyIt:l})}),[w,U,l,n]),Z=(0,o.useCallback)((e=>{!i&&H?n.cutWithMaybeConfirmation({environment:w,event:e,markdownLinkifyIt:l}):e.preventDefault()}),[i,w,l,n,H]),X=(0,o.useCallback)((e=>{i||!H||function(e){if(!e.clipboardData)return!1;for(const t of Array.from(e.clipboardData.items))if(t.getAsFile())return!0;return!1}(e)?e.preventDefault():pe().createAndCommit({userAction:"FormulaInputTextImpl.handlePaste",environment:w,canUndo:!0,perform:t=>{(0,Ro().o)(w,{action:"paste",block_type:"equation",from:"formula_editor"},(o=>{n.paste({environment:w,event:e,disableEmbedMenu:!0,transaction:t,onPasteFiles:n.pasteFilesForBlocks,formulasModule:a,markdownLinkifyIt:l,tinyMceMicrosoftWordPasteFilter:y,spaceStore:(0,wo().f)(S)}),o()}))}})}),[i,w,l,y,a,n,H,S]),J=(0,o.useCallback)((e=>{Pe().sp({environment:w,event:e,textValue:A,editorNode:U(),store:m,canEdit:!i})}),[w,A,U,m,i]),ee=(0,o.useCallback)((e=>{Pe().W5({environment:w,event:e,textValue:A,editorNode:U(),store:m,canEdit:!i})}),[w,A,U,m,i]),te=(0,o.useCallback)((e=>{i||e.preventDefault()}),[i]),ne=(0,o.useCallback)((e=>{pe().createAndCommit({userAction:"FormulaInputTextImpl.handleMoveUp",environment:w,canUndo:!0,perform:e=>{ce().$P({environment:w,transaction:e,direction:"up"})}})}),[w]),oe=(0,o.useCallback)((e=>{pe().createAndCommit({userAction:"FormulaInputTextImpl.handleMoveDown",environment:w,canUndo:!0,perform:e=>{ce().$P({environment:w,transaction:e,direction:"down"})}})}),[w]),ie=(0,o.useCallback)((e=>{var t;e.preventDefault&&e.preventDefault();const n=_o().li();(null==n||null===(t=n.getFirstStore())||void 0===t?void 0:t.id)===m.id&&_o().tN({environment:w,preventSelectText:!1})}),[w,m.id]),re=(0,o.useCallback)((e=>{var t;e.preventDefault&&e.preventDefault();const n=_o().Bl();(null==n||null===(t=n.getFirstStore())||void 0===t?void 0:t.id)===m.id&&_o().ZS({environment:w})}),[w,m.id]),ae=(0,o.useCallback)((e=>{if(i)return;e.preventDefault();const t=T().default.state,n="editing"===t.mode&&(0,k().H)(t.multiSelection);if(n){const{selection:e}=n,t=e.startIndex===e.endIndex;pe().createAndCommit({userAction:"FormulaInputTextImpl.handleTab",environment:w,canUndo:!0,perform:n=>{t?ce().$D({environment:w,editorMode:"default",store:m,string:"\t",selection:e,disableMentions:!0,disableSlashCommands:!0,disableEmojiCommands:!0,disableFilters:!0,transaction:n}):ce().RJ({environment:w,store:m,editorMode:"default",selection:e,transaction:n,shouldStripTokens:!1,disableFilters:!0})}})}}),[i,w,m]),se=(0,o.useCallback)((e=>{if(i)return;e.preventDefault();const t=T().default.state,n="editing"===t.mode&&(0,k().H)(t.multiSelection);if(n){const{selection:e}=n,t=e.startIndex===e.endIndex;pe().createAndCommit({userAction:"FormulaInputTextImpl.handleUntab",environment:w,canUndo:!0,perform:n=>{if(t){const t=P().q4_(m.getValue()||[]),o=Po().PE(t),i=o[e.startIndex-1];if("\t"===i)ce().jQ({environment:w,store:m,selection:{startIndex:e.startIndex-1,endIndex:e.startIndex},transaction:n});else if(" "===i){const t=" "===o[e.startIndex-2]?2:1;ce().jQ({environment:w,store:m,selection:{startIndex:e.startIndex-t,endIndex:e.startIndex},transaction:n})}}else ce().Ye({environment:w,store:m,editorMode:"default",selection:e,transaction:n,shouldStripTokens:!1,disableFilters:!0})}})}}),[i,w,m]),le=(0,o.useCallback)((e=>{const{newValue:o}=e;jo().default.measureAfterNextFlush({metricName:"formulas_typing_lag",startTime:performance.now()},{environment:w,getData:()=>t}),pe().createAndCommit({userAction:"FormulaInputTextImpl.handleMutation",environment:w,canUndo:!0,perform:e=>{ce().dw({environment:w,editorMode:"default",store:m,newValue:o,disableMentions:!0,disableSlashCommands:!0,disableEmojiCommands:!0,disableFilters:!0,transaction:e}),e.postEnqueueActions.push((()=>{pe().createAndCommit({userAction:"FormulaInputTextImpl.normalizeTextValue",environment:w,canUndo:!0,perform:e=>{me({clipboardActions:n,formulasModule:a,store:m,transaction:e})}})}))}})}),[t,w,a,m,n]),ue=(0,o.useCallback)((({leafRef:e,wrapperRef:t,...n},o)=>{const{device:a}=w,s=A.length>0;return(0,Ge.jsxs)("div",{ref:t,...n,role:"textbox",tabIndex:0,onKeyDown:e=>"Enter"===e.key&&e.shiftKey?(e.preventDefault(),e.stopPropagation(),void q(e.nativeEvent)):"Tab"===e.key?(e.preventDefault(),e.stopPropagation(),void(e.shiftKey?se(e.nativeEvent):ae(e.nativeEvent))):void(null==n||n.onKeyDown(e)),style:{flexGrow:1,display:"table",position:"relative",width:"100%",height:"100%",direction:"ltr"},children:[(0,Ge.jsx)(ni,{hasText:s}),(0,Ge.jsx)(Do().A,{leafRef:(0,Fo().Px)(M,e),style:Zo,isDisabled:i,debugName:"FormulaInputTextImpl",store:m,getHtml:()=>(0,Qo()._)({currentUserId:w.currentUser.id,errorRanges:r,getPublicBaseUrlForPage:Uo().tN(w),isAndroid:a.isAndroid,isMobileNative:a.isMobileNative,isSafariOrIOS:a.isSafari||a.isIOS,isFirefox:a.isFirefox,isWindows:a.isWindows,parentSpaceId:u,Prism:c,store:m,textValue:A,theme:C,valueTypes:h}),getSelection:z,onMutation:le,spellCheck:!1,autoCorrect:"off",autoCapitalize:"off",onSelect:o,onMouseOver:J,onMouseOut:ee,suppressNewlineEvents:!1,expandSelectionOnTripleClick:!0,placeholder:" "})]})}),[w,i,m,z,le,J,ee,r,u,c,A,C,h,ae,se,q]);return(0,p().w)((()=>{(0,_e().z)({store:m}),R("instant")})),(0,Ge.jsxs)("div",{style:{...V.default,...N&&V.focused},onFocus:()=>{L(!0);const e=U();e&&e.focus(),(0,_e().z)({store:m})},onBlur:()=>{L(!1),Y()},children:[(0,Ge.jsx)("div",{style:V.scrollableInner,ref:j,children:(0,Ge.jsxs)(Ao().A,{debugName:"FormulaInputTextImpl",capture:H,allowEnter:!0,allowTabUntab:!0,allowUndo:!0,allowEsc:!0,allowCopyPaste:!0,children:[" ",(0,Ge.jsx)(No().F,{store:m,disabled:i,clearBrowserSelection:Y,getEndSelection:K,onBlur:Y,onClick:O,onDelete:G,onBackspace:$,onShiftEnter:q,onCommandShiftEnter:_().D_,onTab:ae,onUntab:se,onToggleBold:te,onToggleItalics:te,onToggleUnderline:te,onToggleStrike:te,onToggleCode:_().D_,onCopy:Q,onCut:Z,onPaste:X,onMoveUp:ne,onMoveDown:oe,onUndo:ie,onRedo:re,onEsc:s,render:ue,disableStyleAnnotations:!0,disableMentions:!0,disableSlashCommands:!0,canSelectAllBlocks:!1,canInsertText:!0,canSelectionDrag:!0,disableMobileActionBar:!0,topBottomPadding:40,pasteBehavior:"inline"})]})}),(0,Ge.jsx)("button",{onClick:e=>{e.preventDefault(),e.stopPropagation(),B()},style:{...V.scrollToBottomButton,...!E&&V.scrollToBottomButtonVisible},children:(0,Ge.jsx)(Ve().I,{icon:Eo().arrowChevronSingleDownIcon,size:"sm",style:V.chevronDownIcon})}),b?(0,Ge.jsx)(W().y,{experimentId:"formula_assistant",groups:{on:i?null:(0,Ge.jsx)(qo,{isAssistantVisible:x,onToggleAssistant:b}),control:null}}):null]})}function ei(){const e=(0,g().IS)((()=>({container:{boxSizing:"border-box",width:"100%",height:zo,background:F().Tj.background.secondary,boxShadow:F().Tj.inputBoxShadow,borderRadius:6,position:"relative"},scrollableInner:{width:"100%",height:"100%",display:"flex",flexDirection:"column",gap:6,paddingTop:11,paddingInlineEnd:12,paddingBottom:10,paddingInlineStart:12}})),[]);return(0,Ge.jsx)("div",{style:e.container,children:(0,Ge.jsxs)("div",{style:e.scrollableInner,children:[(0,Ge.jsx)(ke().P,{emphasized:!0,style:{height:14,borderRadius:3,width:"100%"}}),(0,Ge.jsx)(ke().P,{emphasized:!0,style:{height:14,borderRadius:3,width:"50%"}})]})})}function ti(e){const{value:t}=(0,y().fJ)(cn().y),{value:n}=(0,y().fJ)(Lo().g),{value:o}=(0,y().fJ)(Vo().S),{value:i}=(0,y().fJ)(D().T.formulas),{value:r}=(0,y().fJ)(N().R.clipboardActions);return t&&i&&r?(0,Ge.jsx)(Jo,{...e,Prism:t,clipboardActions:r,formulasModule:i,markdownLinkifyIt:n,tinyMceMicrosoftWordPasteFilter:o}):(0,Ge.jsx)(ei,{})}function ni(e){const{hasText:t}=e,n=(0,E().tz)();return(0,Ge.jsx)(ve().Y1,{direction:"horizontal",gap:8,padding:"10px 12px",style:{position:"absolute",inset:0,pointerEvents:"none",userSelect:"none"},children:t?null:(0,Ge.jsx)(ve().Y1,{height:20,align:"center-left",children:(0,Ge.jsx)(Ie().D,{colorVariant:"disabled",styleKey:"bodyRegular",children:n.formatMessage(Xo.formulaPlaceholder)})})})}Jo.displayName="FormulaInputTextImpl";class oi extends Hn().Store{constructor(...e){super(...e),this.setPrompt=e=>{this.update((t=>({...t,prompt:e})))},this.startGeneratingState=e=>{this.update((t=>({...t,type:"generating",generatingStep:e})))},this.setTraceId=e=>{this.update((t=>({...t,latestTraceId:e})))},this.setFormulaBeforeLatestRequest=e=>{this.update((t=>({...t,formulaBeforeLatestRequest:e})))},this.updateGeneratingState=e=>{this.update((t=>({...t,generatingStep:e})))},this.resetToInitial=()=>{this.update((e=>({...e,type:"input"})))},this.setRefusalMessage=e=>{this.update((t=>({...t,type:"refused",refusalMessage:e,isGenerating:!0})))},this.setFinalRefusedState=e=>{this.update((t=>({...t,type:"refused",refusalMessage:e,isGenerating:!1})))},this.setError=()=>{this.update((e=>({...e,type:"error"})))}}getInitialState(){return{type:"input",prompt:(0,P().x9d)(""),latestTraceId:"",formulaBeforeLatestRequest:null}}}const ii=new Map;const ri=!1,ai=400,si=100,li=[];function ui(e){const{initialCode:t,parentSpaceId:n,disabled:M,typecheckContext:H,formulas:Y,handleCancel:G,onCodeChange:$,onTypeChange:q,parentCollectionStore:Q,handleClose:Z,getRecordModel:J,autosave:te=!0,formulaSchema:ne,collectionStore:ie,blockStore:le}=e,[fe,ge]=(0,o.useState)(le),[ye,he]=(0,o.useState)(!0),be=(0,E().tz)(),ve=(0,d().v3)(),[ke]=(0,o.useState)((()=>crypto.randomUUID()));(0,p().w)((()=>{(0,i().u)({environment:ve,event:{eventName:"formula_editor_open",eventProperties:{formula_assistant_session_id:ke,has_existing_formula:Boolean(t&&t.length>0),collection_id:null==Q?void 0:Q.id}}})}));const Te=(0,o.useRef)(0),Ie=(0,o.useRef)(0),Se=(0,o.useRef)(0),Me=(0,o.useRef)({parseErrors:[],typeErrors:[],typeWarnings:[],evaluationErrors:[]}),[Ce,we]=(0,o.useState)(),{value:Ae}=(0,y().fJ)(D().T.formulaEditor),{value:je}=(0,y().fJ)(D().T.formulas),Pe=(0,c().l)(H.valueTypes),Ee=(0,o.useMemo)((()=>{const e={};return Q&&(e.collection_id=[[Q.id]]),e.value_types=[[JSON.stringify(Pe)]],e}),[Q,Pe]),{store:Fe,setValue:_e}=(0,O().AI)({initialValue:t,onChange:$,source:"formula",properties:Ee}),Be=(0,o.useCallback)((e=>{const{newValue:t,newSelection:n}=e;_e(t);const{startIndex:o,endIndex:i}=n,r={start:{store:Fe,index:o},end:{store:Fe,index:i}};(0,b().setMultiSelection)({multiSelection:r})}),[_e,Fe]),Re=(0,f().K8)((()=>{var e;const t=T().default.state;if("editing"===t.mode&&(null===(e=(0,k().H)(t.multiSelection))||void 0===e?void 0:e.store)===Fe)return{startIndex:t.multiSelection.start.index,endIndex:t.multiSelection.end.index}}),[Fe],{useDeepEqual:!0}),De=(0,f().K8)((()=>Fe.getValue()),[Fe]),Ne=(0,o.useMemo)((()=>!_().n4(De,t)),[De,t]),Le=(0,A().lW)(De,si,Object.is),Ve=(0,V().C)(),Ue=(0,f().K8)((()=>h().A.state.publicPageData),[]),[He,Ye]=(0,o.useState)([]),Ke=(0,f().K8)((()=>{Ye(li);const e=null==fe?void 0:fe.getModel();if(!e||!Le||O().Pe||!je)return;const t=je.evaluateRawCollectionFormula2({block:e,property:H.sourceProperty??"formula",formulaCode:Le,getRecordModel:J,intl:be,userTimeZone:(0,w().P)(),depth:0,visitedProperties:new Set,formulaTimeoutTimestampMs:Date.now()+Ve,resultCache:new Map,regExpCache:new Map,formatDateCache:new Map,publicPageDataCollection:{id:null==Ue?void 0:Ue.collectionId,schema:null==Ue?void 0:Ue.collectionSchema},experimentService:a().default,collectionFeatureGates:(0,L().i)(),spaceIdCreator:ve.idCreator.getSpaceIdCreatorSync(n)});if(t){if(!B().Q.isFail(t))return t.value;(0,I().eJ)(t.error)&&Ye([t.error])}}),[fe,Le,je,be,Ve,null==Ue?void 0:Ue.collectionId,null==Ue?void 0:Ue.collectionSchema,H.sourceProperty,J,n,ve]),[We,ze]=(0,f().K8)((()=>!De||O().Pe?[void 0,void 0]:Y.processFormulaInput(De)),[De,Y]),Oe=(0,f().K8)((()=>{if(We)return Y.parseFormulaInputToCst(We,ze)}),[We,Y,ze]),$e=(0,f().K8)((()=>{if(Oe)return Y.convertFormulaCSTToAST(Oe[0])}),[Y,Oe]),[qe,Qe]=(0,o.useState)(void 0),Ze=no(void 0===ie),Xe=(0,o.useMemo)((()=>{if(H)return{...H,enableExistenceGuarantees:Ze}}),[H,Ze]);(0,o.useEffect)((()=>{!async function(){if($e&&Xe&&B().Q.isSuccess($e)){const e=await Y.addTypesToFormulaASTAsync($e.value,Xe,ze);Qe(e);const t=e.node.type;we(t),null==q||q(t)}else Qe(void 0),we(void 0)}()}),[$e,Xe,ze,Oe,Y,q]);const Je=(0,o.useMemo)((()=>void 0!==qe?[...(0,C().KH)(qe.node,!1),...qe.errors]:[]),[qe]),et=(0,o.useMemo)((()=>void 0!==qe?qe.warnings:[]),[qe]),tt=(0,o.useMemo)((()=>({parseErrors:(null==Oe?void 0:Oe[1])??[],typeErrors:Je,typeWarnings:et,evaluationErrors:He})),[He,Oe,Je,et]);(0,o.useEffect)((()=>{Me.current=tt}),[tt]);const nt=(0,A().lW)(tt,ai,Object.is),ot=0===(0,P().q4_)(De).trim().length,it=!ot&&tt.parseErrors.length+tt.typeErrors.length+tt.evaluationErrors.length>0,rt=!ot&&tt.typeWarnings.length>0,at=(0,f().K8)((()=>function(e){const{errors:t,intl:n,codeLength:o,formulas:i}=e,{parseErrors:r,typeErrors:a,typeWarnings:s,evaluationErrors:l}=t,u=[];a&&a.length>0?a.forEach((e=>{const t=(0,I().ew)((0,I().rA)(n,e));u.push({msg:n.formatMessage(...t),range:{startIndex:e.node.startOffset,endIndex:e.node.endOffset+1},severity:(0,I().SA)(e)})})):l&&l.length>0&&l.forEach((e=>{const t=(0,I().ew)((0,I().yI)(n,e));u.push({msg:n.formatMessage(...t),range:i.isUniqueFormulaEvaluatorError(e)?{startIndex:e.node.startOffset,endIndex:e.node.endOffset+1}:void 0,severity:(0,I().SA)(e)})}));r&&r.forEach((e=>{const t=(0,I().ew)((0,I().ml)(e));u.push({msg:n.formatMessage(...t),range:"eof"===e.offset?{startIndex:o-1,endIndex:o}:{startIndex:e.offset,endIndex:e.offset+1},severity:(0,I().SA)(e)})}));s&&s.forEach((e=>{const t=(0,I().ew)((0,I().rA)(n,e));u.push({msg:n.formatMessage(...t),range:{startIndex:e.node.startOffset,endIndex:e.node.endOffset+1},severity:(0,I().SA)(e),helpLink:di(e)})}));return u}({errors:nt,codeLength:ze?(0,S().sE)(ze):(0,P().q4_)(De).length,formulas:Y,intl:be})),[De,nt,Y,be,ze]),st=(0,o.useMemo)((()=>at.filter((e=>"error"===e.severity||Ze)).map((e=>e.range?{...e.range,severity:e.severity}:void 0)).filter(R().O9)),[at,Ze]),[lt,ut]=(0,o.useState)(void 0),dt=(0,o.useRef)(void 0),[ct,pt]=(0,o.useState)(void 0),mt=(0,o.useRef)(1);(0,o.useEffect)((()=>{mt.current++;const e=mt.current;!async function(){if(Ae){const t=await Ae.getFormulaEditorInfoAtPosition({formula:De??[],inputPosition:Re&&Re.startIndex===Re.endIndex?Re.startIndex:0,context:H,includeDeprecatedCompletions:!1});B().Q.isSuccess(t)&&mt.current===e&&(dt.current=t.value,ut(t.value))}}()}),[Re,Ae,H,De]);const ft=(0,o.useCallback)((()=>{_e(t)}),[t,_e]),gt=function(e){const t=e?ii.get(e):void 0,n=(0,f().uB)(t,oi);return(0,o.useEffect)((()=>{e&&ii.set(e,n)}),[e,n]),n}(H.sourceProperty),yt=(0,f().O$)(gt),ht=null!==yt.formulaBeforeLatestRequest&&yt.formulaBeforeLatestRequest!==De,xt=(0,o.useCallback)((()=>{"input"===yt.type&&null!==yt.formulaBeforeLatestRequest&&_e(yt.formulaBeforeLatestRequest)}),[yt,_e]),bt=(0,f().K8)((()=>"generating"===yt.type),[yt]),vt=(0,o.useMemo)((()=>at.map((e=>{if("string"==typeof e.msg)return e.range?`${e.msg} [${e.range.startIndex},${e.range.endIndex}]`:e.msg})).filter(R().O9)),[at]),kt=(0,f().K8)((()=>{const e=J({table:j().NX,id:n});return Boolean(null==e?void 0:e.isAiEnabledOnSpace())}),[J,n]),Tt=(0,z()._)({name:"ai_formulas",spaceId:n,userId:ve.currentUser.id,amount:1}),{upsellMessage:It}=(0,U().x)({featureAvailability:Tt,upsellFrom:"ai_formulas",showOptimisticUpsell:!1}),St=!It,Mt=(0,r().X)("formulas_fix_with_ai_button"),Ct=(0,f().K8)((()=>K.getIsAssistantVisible()),[]),wt=(0,o.useCallback)((()=>{K.toggleAssistant()}),[]),At=(0,o.useRef)(null),jt=(0,o.useCallback)((async e=>{var o;const r=Fe.getValue(),a=n,s=await N().R.clipboardActions.load();let l=!1;null===(o=At.current)||void 0===o||o.abort();const u=new AbortController;At.current=u;const d=await async function(e){const{environment:t,spaceId:n,getRecordModel:o,userPrompt:i,formulaErrors:r,typecheckContext:a,handleFormulaStream:s,formulaAssistantStore:l,abortSignal:u,existingFormulaTextValue:d,intl:c,formulaResult:p,returnType:m}=e,f=(0,de().Z1)({environment:t,table:oe().mS,spaceId:n});l.startGeneratingState("thinking");let g=(0,ee().r4)({textValue:d,intl:c,getRecordModel:o,userTimeZone:(0,w().P)(),valueTypes:a.valueTypes});const y=await xe({environment:t,spaceId:n,userPrompt:i,formulaErrors:r,existingFormula:g,typecheckContext:a,formulaResult:p,returnType:m});if(!y)return l.setError(),{type:"error",traceId:f};let h=!1,x="",b="",v=0;return await(0,se().g)({environment:t,data:{generateTitle:!1,traceId:f,transcript:y,spaceId:n,isUserInAnySalesAssistedSpace:(0,ue().h0)(t),isSpaceSalesAssisted:(0,ue().lM)(t,n)},onResponse:e=>{if("generate-formula"!==e.type)return;const t=(0,re().$l)(e.value);if(!(0,ae().Xj)(X,t))return;if(l.state.latestTraceId!==f&&l.setTraceId(f),"retry"===t.type)return g=x,l.updateGeneratingState("reading-errors"),h=!0,void(v+=1);if("chat"===t.type?(l.setRefusalMessage(t.message),b=t.message):"formula"===t.type&&(x=t.formula),g.startsWith(x))return;const n=l.state;"generating"!==n.type||"writing"===n.generatingStep||h||(l.updateGeneratingState("writing"),l.setFormulaBeforeLatestRequest(d)),"generating"===n.type&&"fixing"!==n.generatingStep&&h&&l.updateGeneratingState("fixing"),s(x)},abortSignal:u}),null!=u&&u.aborted?{type:"aborted",traceId:f}:(x.length>0&&g.includes(x)&&s(x),b?l.setFinalRefusedState(b):x.length>0?l.resetToInitial():l.setError(),{type:"success",formula:x,traceId:f,completionType:x?"formula":"refusal",retryCount:v})}({environment:ve,spaceId:a,getRecordModel:J,userPrompt:e,formulaErrors:vt,existingFormulaTextValue:r,typecheckContext:H,handleFormulaStream:e=>{l||((0,v().t)({store:Fe}),l=!0),function(e){const{clipboardActions:t,environment:n,formulasModule:o,formulaString:i,store:r}=e;pe().createAndCommit({userAction:"FormulaInputText.handleMutation",environment:n,canUndo:!0,perform:e=>{ce().kE({environment:n,store:r,newValue:i,editorMode:"default",disableMentions:!0,disableSlashCommands:!0,disableEmojiCommands:!0,disableFilters:!0,transaction:e}),e.postEnqueueActions.push((()=>{pe().createAndCommit({userAction:"FormulaInputText.normalizeTextValue",environment:n,canUndo:!0,perform:e=>{me({clipboardActions:t,formulasModule:o,store:r,transaction:e})}})}))}})}({environment:ve,clipboardActions:s,formulasModule:Y,formulaString:e,store:Fe})},formulaAssistantStore:gt,abortSignal:u.signal,intl:be,formulaResult:Ke,returnType:Ce});Te.current+=1,"success"===d.type&&("formula"===d.completionType?(Ie.current+=1,(0,i().u)({environment:ve,event:{eventName:"formula_assistant_prompt",eventProperties:{formula_assistant_session_id:ke,trace_id:d.traceId,response_type:"formula",retry_count:d.retryCount,had_existing_formula:Boolean(t&&t.length>0)}}})):"refusal"===d.completionType?(Se.current+=1,(0,i().u)({environment:ve,event:{eventName:"formula_assistant_prompt",eventProperties:{formula_assistant_session_id:ke,trace_id:d.traceId,response_type:"refusal",had_existing_formula:Boolean(t&&t.length>0)}}})):(0,R().HB)(d.completionType)),(0,x().clear)({environment:ve}),At.current=null}),[gt,n,H,vt,ve,Y,Fe,be,J,ke,t,Ke,Ce]),Pt=(0,o.useCallback)((()=>{var e;null===(e=At.current)||void 0===e||e.abort(),At.current=null}),[]),Et=(0,o.useCallback)((()=>{const e=M?t:Fe.getValue();Z(e)}),[Z,M,t,Fe]);(0,m().X)((()=>{const e=Te.current,n=Se.current,o=Ie.current,r={eventName:"formula_assistant_session",eventProperties:{formula_assistant_session_id:ke,total_prompts:e,generated_formula_count:o,refusal_count:n,had_existing_formula:Boolean(t&&t.length>0)}};e>0&&(0,i().u)({environment:ve,event:r})}));const Ft=(0,f().K8)((()=>{const e=yt;return ye||"generating"===e.type&&("fixing"===e.generatingStep||"writing"===e.generatingStep)}),[ye,yt]);ri&&console.log("FormulaInput",{currentValue:De,cursorEditorInfo:lt,infoHelper:ct,errorMessagesWithRange:at,errorRanges:st,astWithTypes:qe});const _t=(0,g().IS)((()=>({container:{display:"flex",flexDirection:"column",alignItems:"flex-start",isolation:"isolate",height:"100%",background:F().Tj.popoverBackground,boxShadow:F().Tj.shadowMD,borderRadius:12,position:"relative"},topSection:{display:"flex",flexDirection:"column",alignItems:"flex-start",width:"100%",padding:12,gap:12},headerWrapper:{display:"flex",flexDirection:"row",alignItems:"center",padding:0,gap:8,height:28,flex:"none",alignSelf:"stretch",flexGrow:0},inputText:{width:"100%",position:"relative",direction:"ltr"},bottomSection:{display:"flex",flexDirection:"row",height:l().A.isMobile?"100%":240,maxHeight:l().A.isMobile?void 0:"calc(90vh - 38px - 31px - 38px - 30px)",borderTop:`1px solid ${F().Tj.border.primary}`,width:"100%"},leftColumn:{position:"relative",borderInlineEnd:`1px solid ${F().Tj.border.primary}`,width:l().A.isMobile?"100%":void 0},rightColumn:{display:"flex",flexDirection:"column",flexGrow:1},infoHelper:{padding:"12px 14px"}})),[]);return(0,o.useEffect)((()=>{const e=e=>{(0,u().A)(ve,e,"command+enter")&&(e.preventDefault(),Et())};return document.addEventListener("keydown",e),()=>{document.removeEventListener("keydown",e)}}),[Et,ve]),(0,Ge.jsx)(s().N,{debugName:"FormulaInput",capture:!l().A.isMobile,onPaste:_().D_,children:(0,Ge.jsxs)("div",{style:_t.container,children:[(0,Ge.jsxs)("div",{style:_t.topSection,children:[(0,Ge.jsx)("div",{style:_t.headerWrapper,children:(0,Ge.jsx)(ko,{setIsLoading:he,disabled:M,onClickCancel:G,onClickClose:Et,onClickRevert:Ne&&!bt?ft:void 0,onClickUndo:ht&&!bt?xt:void 0,autosave:te,isEdited:Ne})}),(0,Ge.jsx)(W().y,{experimentId:"formula_assistant",groups:{on:!M&&kt&&Ct?(0,Ge.jsx)(Bt,{setFormulaValue:_e,formulaAssistantStore:gt,onStop:Pt,onSubmit:jt,spaceId:n,isLoading:ye,currentFormulaTextValue:De,sessionId:ke}):null,control:null}}),(0,Ge.jsx)("div",{style:_t.inputText,children:(0,Ge.jsx)(ti,{setIsLoading:he,store:Fe,disabled:M||bt,parentSpaceId:n,valueTypes:H.valueTypes,errorRanges:st,handleClose:Et,analyticsContext:{restrict_unaccessible_properties:H.restrictUnaccessibleProperties},onToggleAssistant:kt?wt:void 0,isAssistantVisible:Ct,parentCollectionStore:Q},"input")})]}),(0,Ge.jsx)(oo,{isLoading:Ft,hasErrors:it,hasWarnings:rt,debouncedErrorMessagesWithRange:at,formulaResult:Ke,returnType:Ce,formulaSchema:ne,collectionStore:ie,selectedBlockStore:fe,setSelectedBlockStore:ge,showFixWithAiButton:kt&&St&&Mt,isAiGenerating:bt,onFixWithAi:kt&&St&&Mt?()=>jt("Fix this"):void 0}),M?void 0:(0,Ge.jsxs)("div",{style:_t.bottomSection,children:[(0,Ge.jsx)("div",{style:_t.leftColumn,children:(0,Ge.jsx)(An,{store:Fe,context:H,selection:Re,cursorEditorInfo:lt,cursorEditorInfoRef:dt,onChange:Be,getRecordModel:e.getRecordModel,setInfoHelper:pt,isLoading:ye,isAssistantGenerating:bt})}),l().A.isMobile?void 0:(0,Ge.jsx)("div",{style:_t.rightColumn,children:(0,Ge.jsx)(yn,{infoHelper:ct,getRecordModel:e.getRecordModel,style:_t.infoHelper,typecheckContextValues:H.valueTypes,isLoading:ye})})]})]})})}function di(e){switch(e.type){case M().IA.CalledFunctionOnEmptyValue:return"https://www.notion.com/help/common-formula-errors#undefined-value";case M().IA.DisallowedReturnType:return"https://www.notion.com/help/common-formula-errors#wrong-return-type";default:return}}},133518:(e,t,n)=>{n.d(t,{F:()=>s,i:()=>l});n(517642),n(658004),n(733853),n(845876),n(432475),n(515024),n(731698);var o=n(296540),i=()=>n(310109),r=()=>n(534177),a=()=>n(546461);function s(e){const{actionId:t}=e??{},n=(0,a().K4)();return(0,o.useMemo)((()=>{if(!n)return[];return(0,r().O9)(t)?(0,i().getContextValuesForAction)(n.typecheckResult,t):(0,i().getAllContextValues)(n.typecheckResult)}),[n,t])}function l(){const e=(0,a().K4)();return e?(0,i().getAllGuaranteedPropertyIds)(e.typecheckResult):new Set}},141768:(e,t,n)=>{n.d(t,{YH:()=>l,bi:()=>a});n(944114),n(517642),n(658004),n(733853),n(845876),n(432475),n(515024),n(731698),n(898992),n(803949),n(581454),n(908872);var o=()=>n(338381),i=()=>n(201980),r=()=>n(496603);function a(e){let t="";const n=document.createElement("div");n.innerHTML=e;const i=o().zn(n);for(const o of i){const e=r().ih(o.data);if(null!==o.parentElement&&o.parentElement!==n){t+=`<span class="${s({parent:o.parentElement,root:n}).join(" ")}">${e}</span>`}else t+=e}return t}function s(e){const{parent:t,root:n}=e,o=new Set;let i=t;for(;i&&i!==n;)i.classList.forEach((e=>{o.add(e)})),i=i.parentElement??void 0;return Array.from(o)}function l(e,t){const n={text:u(e),syntax:u(t)},o=function(e){let t=0;return e.reduce(((e,n)=>(e.push([t,n]),t+=n,e)),[])}(function(e,t){const n=e.slice(),o=t.slice(),i=[];let r=0,a=0;for(;r<n.length&&a<o.length;){const e=n[r],t=o[a];e===t?(i.push(e),r+=1,a+=1):e<t?(i.push(e),r+=1,o[a]-=e):(i.push(t),n[r]-=t,a+=1)}return i}(n.text,n.syntax)),r={text:0,syntax:0},a={text:0,syntax:0},s=[],l=e.map(i().N8A).join("");for(const[i,u]of o){const e=i+u,o=t[r.syntax],c={value:l.substring(i,e),textTokenIndex:r.text,classNames:(d=o,d&&d[1])};s.push(c);const p=n.text[r.text],m=n.syntax[r.syntax];e>=a.text+p&&(r.text+=1,a.text+=p),e>=a.syntax+m&&(r.syntax+=1,a.syntax+=m)}var d;return s}function u(e){return e.map((e=>e[0].length))}},164891:(e,t,n)=>{n.d(t,{y:()=>r});var o=()=>n(242422),i=()=>n(590526);function r(e){const{experimentId:t,groups:n,disableExposureLogging:r}=e,a=function(e){const{experimentId:t,disableExposureLogging:n,defaultGroup:r}=e;return(0,i().K8)((()=>o().default.getEligibleGroup({experimentId:t,defaultGroup:r??"control",disableExposureLogging:n})),[t,n,r])}({experimentId:t,disableExposureLogging:r});return n[a]}},246474:(e,t,n)=>{n.d(t,{_:()=>x});n(581454);var o=n(296540),i=()=>n(242422),r=()=>n(726637),a=()=>n(338381),s=()=>n(365917),l=()=>n(675133),u=()=>n(416504),d=()=>n(379632),c=()=>n(201980),p=()=>n(924703),m=()=>n(496603),f=()=>n(267419),g=()=>n(141768),y=()=>n(562800),h=n(474848);function x(e){const{currentUserId:t,errorRanges:n,getPublicBaseUrlForPage:a,isAndroid:x,isMobileNative:v,isSafariOrIOS:k,isFirefox:T,isWindows:I,parentSpaceId:S,Prism:M,store:C,theme:w,valueTypes:A,textValue:j}=e,P=c().q4_(j),E="notion",F=M.languages[E],_=document.createElement("div"),B=M.highlight(P,F,E);_.innerHTML=g().bi(B);const R=m().oE(Array.from(_.childNodes).map(b));let D=j;for(const o of n)D=c().Mwp({annotation:[c().Ifu.FormulaError],selection:o,textValue:D});const N=function({syntaxTokens:e,textValue:t,store:n,parentSpaceId:o,valueTypes:a,theme:d,isAndroid:m,isSafariOrIOS:x,isFirefox:b,isWindows:v,isMobileNative:k,currentUserId:T,getPublicBaseUrlForPage:I,errorRanges:S}){const M=g().YH(t,e),C=t.map(c().uPN).map(((e,t)=>(0,p().sT)({annotations:e,theme:d,getRecordModel:n.getRecordModel,spaceId:o,isSafariOrIOS:x})));let w=0;return M.map(((e,g)=>{const I=t[e.textTokenIndex],M=C[e.textTokenIndex],A=e.value.length,j=w,P=w+A;let E;if(w=P,S)for(const t of S){const{startIndex:e,endIndex:n,severity:o}=t;if(void 0!==e&&void 0!==n&&j<n&&P>e){E="warning"===o?"formula-warning-underline":"formula-error-underline";break}}if(c().qXl(I)){const e=[...M.classNames||[],...E?[E]:[]];return(0,p().Au)({args:{textValue:{value:t,spaceId:o},getRecordModel:n.getRecordModel,getRecordRole:n.getRecordRole,disableHover:!1,disableStyleAnnotations:!1,disableInsertedDeletedAnnotations:!1,disableDateStyleAnnotations:!1,disableSuggestionAnnotations:!1,disableLinks:!1,userTimeZone:(0,u().P)(),disabled:!1,isAndroid:m,isSafariOrIOS:x,isFirefox:b,isWindows:v,emojiType:"raw",highlightDiscussionId:void 0,theme:d,intl:l().A.getIntl(),renderedPageBlockId:void 0,parentBlockId:void 0,katex:void 0,isClient:!0,baseUrl:r().A.domainBaseUrl,publicDomainName:r().A.publicDomainName,currentUserId:T,getPublicBaseUrlForPageOrCollection:y().d6,externalIntegrations:s().A.integrations.state,formulaValueTypes:a,emojiData:f().A.state,isMobileNative:k,isMobileNativeExternalLinkFixEnabled:i().default.checkGate({gateName:"mobile_native_external_link_fix"}),displayInUserTimezone:!0},style:M.style,classNames:e,index:g,token:I,tokenValue:c().N8A(I),tokenAnnotations:c().uPN(I)})}{const t=[e.classNames||"",...M.classNames||[],...E?[E]:[]];return(0,h.jsx)("span",{className:t.join(" ").trim(),style:M.style,"data-token-index":e.textTokenIndex,children:e.value},g)}}))}({store:C,parentSpaceId:S,valueTypes:A,syntaxTokens:m().oE(R),textValue:j,theme:w,isAndroid:x,isSafariOrIOS:k,isFirefox:T,isWindows:I,isMobileNative:v,getPublicBaseUrlForPage:a,currentUserId:t,errorRanges:n}),L=(0,h.jsxs)(o.Fragment,{children:[N,(0,h.jsx)("span",{children:"\n"})]});return d().A.renderToStaticMarkup(L)}function b(e){return a().KH(e)?[e.data]:a().vq(e)?[e.textContent||"",e.className]:void 0}},255043:(e,t,n)=>{n.d(t,{O:()=>k,r:()=>T});n(898992),n(672577),n(581454);var o=n(296540),i=()=>n(401497),r=()=>n(249046),a=()=>n(250910),s=()=>n(807449),l=()=>n(546926),u=()=>n(631524),d=()=>n(302501),c=()=>n(890492),p=()=>n(81068),m=()=>n(663639),f=()=>n(736847),g=()=>n(324254),y=()=>n(676510),h=()=>n(534177),x=()=>n(608346),b=()=>n(419357),v=n(474848);function k(e){return(0,v.jsxs)(r().Ye,{alignItems:"center",style:{gap:4},children:[e.icon,(0,v.jsx)(d().A,{isSmall:e.isSmall,children:e.name})]})}function T(e){const{onSelectOption:t,options:n,currentOption:r,placeHolder:c,initialFocus:m,menuProps:f,iconOnly:x,inputProps:T,searchThreshold:S,selectorButtonStyle:M}=e,[C,w]=(0,o.useState)(""),A=n.find((({key:e})=>e===r)),j=(0,i().IS)((()=>({workspaceSelectorButton:{paddingTop:8,paddingBottom:8,paddingInlineStart:8,paddingInlineEnd:8,opacity:1,width:376,border:`1px solid ${y().$.light.gray[100]}`,justifyContent:"space-between",marginTop:8,marginBottom:8},teamspacePickerButton:{maxWidth:300},menuChevronDownIcon:{marginInlineStart:4}})),[]),P={..."workspace"===M?j.workspaceSelectorButton:{},..."teamspace"===M?j.teamspacePickerButton:{}};return(0,v.jsx)(a().A,{popupType:a().z.Popup,placementToOrigin:"bottom",alignmentToOrigin:e.alignmentToOrigin,originGap:4,renderOrigin:e=>(0,v.jsxs)(u().p,{...e,style:{color:r?void 0:y().$.light.gray[300],...P},children:[(0,v.jsx)(d().A,{style:{textOverflow:"ellipsis",fontSize:"14px",font:"SF Pro Text",color:r?void 0:"#ACABA9",lineHeight:"19.6px"},children:(x?null==A?void 0:A.icon:A&&(0,v.jsx)(k,{...A}))??c}),(0,v.jsx)(s().I,{icon:g().arrowChevronSingleDownSmallIcon,size:"xs",colorVariant:"secondary",style:j.menuChevronDownIcon})]}),render:e=>{const o=(0,v.jsx)(b().Ay,{style:{width:"100%",paddingTop:8,paddingBottom:2},onChange:e=>w(e.target.value),value:C,...T}),i={menuType:l().gu.Popup,width:376,left:50,header:(0,h().O9)(S)&&n.length>S?o:null,...f},a=n.map((({key:n,name:o,icon:i,searchTerm:a})=>({key:n,keywords:a??[],action:()=>{t(n),e.close()},render:e=>(0,v.jsx)(p().A,{...e,title:(0,v.jsx)(k,{name:o,icon:i}),shouldWrapCaption:!0,isChecked:r===n})})));return(0,v.jsx)(I,{menuOptions:i,menuItems:a,filterQuery:C,initialFocus:m})}})}function I({menuOptions:e,menuItems:t,filterQuery:n,initialFocus:o}){const i=(0,x().m)({sections:[{key:"dropdown.menuList",render:e=>(0,v.jsx)(f().A,{...e}),items:t}],filterQuery:n||void 0});return(0,v.jsx)(c().A,{...e,children:(0,v.jsx)(m().A,{type:m().O.Vertical,sections:i,initialFocus:o,style:{position:"relative",alignItems:"flex-end"}})})}},310109:(e,t,n)=>{n.r(t),n.d(t,{getAllContextValues:()=>h,getAllGuaranteedPropertyIds:()=>v,getContextValueForActionById:()=>b,getContextValuesForAction:()=>x,typecheckAutomation:()=>g,typecheckAutomationAsync:()=>y});n(944114),n(517642),n(658004),n(733853),n(845876),n(432475),n(515024),n(731698),n(898992),n(803949),n(581454),n(737550);var o=()=>n(496603),i=()=>n(973647),r=()=>n(534177),a=()=>n(999515),s=()=>n(239381),l=()=>n(368609),u=()=>n(638458),d=()=>n(322867),c=()=>n(281994),p=()=>n(648651),m=()=>n(103966);function*f(e){const{actionModels:t,automationModel:n,contextType:f,formulasModule:g,runtimeStats:y}=e,h={valueTypes:e.valueTypes,actionInputValueTypes:{},guaranteedPropertyIds:new Set,actionValidationFailures:{},actionValidationWarnings:{}},x=performance.now();let b,v,k;if("button_block"===f||"button_property"===f){if(!n.isButtonType())return{error:new(d().N9)(`Automation trigger (${n.getTriggerType()}) does not match context type (${f}).`)};const t=n.getTrigger();k=(0,m().Z)(n.getTriggerType()).typecheck(e,t)}else if("event"===f){if(!n.isEventType())return{error:new(d().N9)(`Automation trigger (${n.getTriggerType()}) does not match context type (${f}).`)};const t=n.getTrigger();k=(0,m().Z)(n.getTriggerType()).typecheck(e,t)}else if("recurrence"===f){if(!n.isRecurrenceType())return{error:new(d().N9)(`Automation trigger (${n.getTriggerType()}) does not match context type (${f}).`)};const t=n.getTrigger();k=(0,m().Z)(n.getTriggerType()).typecheck(e,t)}else(0,r().HB)(e);if(i().Q.isFail(k))return k;h.valueTypes.push(...o().o8(k.value.valueTypes));for(const r of t){b=void 0,y&&(b=p().hs.getOrCreateAction(y,r.pointer,r.getType()));const t=(0,l().getActionRegistryItem)(r.getType());if(!t){v={error:new(d().oM)({actionId:r.id,message:`Unsupported action type: ${r.getType()}`})};break}const m=performance.now(),f=(0,u().Q)({automationModel:n,formulasModule:g,formulaValueTypes:h.valueTypes,checkExperimentGate:e.checkExperimentGate}),x=(0,c().HI)(yield*t.resolveExecutionDependencies(f,r));yield*a().q.fetchRecords(x.map((e=>e.pointer))),b&&(b.totalDependencies=x.length,b.getDependenciesDurationMs=Math.trunc(performance.now()-m));const k=t.typecheck(e,r),I=o().o8(h.valueTypes);if(h.actionInputValueTypes[r.id]=I,i().Q.isFail(k)){v=k;break}var T;for(const e of k.value.valueTypes??[]){h.valueTypes.some((t=>(0,s().oH)(e,t)))||h.valueTypes.push(e)}null===(T=k.value.guaranteedPropertyIds)||void 0===T||T.forEach((e=>{h.guaranteedPropertyIds.add(e)})),k.value.validationFailures&&k.value.validationFailures.length>0&&(h.actionValidationFailures[r.id]=k.value.validationFailures),k.value.validationWarnings&&k.value.validationWarnings.length>0&&(h.actionValidationWarnings[r.id]=k.value.validationWarnings)}const I=Math.trunc(performance.now()-x);return y&&(y.typecheckStartTime=x,y.typecheckDurationMs=I,y.typecheckSuccess=!(0,r().O9)(v)),v??{value:h}}function g(e){return a().q.runSync(e.getRecordModel,f(e))}async function y(e){return await a().q.runAsync(e.loadRecordModel,f(e))}function h(e){return i().Q.isFail(e)?[]:e.value.valueTypes.slice(0)}function x(e,t){return i().Q.isFail(e)?[]:e.value.actionInputValueTypes[t]??[]}function b(e,t,n){const o=x(e,t);return(0,s().IV)(o,n)}function v(e){return i().Q.isFail(e)?new Set:e.value.guaranteedPropertyIds}},348869:(e,t,n)=>{n.d(t,{g:()=>s});n(944114);var o=()=>n(792057),i=()=>n(785728),r=()=>n(532659),a=()=>n(769864);async function s(e){const{environment:t,onResponse:n,data:s,userId:l,tracking:u,abortSignal:d}=e,c=await a().callStreamApi({eventName:"runInferenceTranscript",environment:t,data:s,userId:l,tracking:u,abortSignal:d,headers:(0,i().WS)({spaceId:s.spaceId})});if("success"!==c.type)return null!=d&&d.aborted?{error:{message:"Aborted",code:0}}:(o().Qg(c),{error:{message:c.error.message,code:c.status}});const p=[];if(r().hS.is(c.data))for await(const o of c.data){if("error"===o.type)return{error:{message:o.message,code:o.errorCode}};null==n||n(o),p.push(o)}return{value:p}}},608346:(e,t,n)=>{n.d(t,{m:()=>a});n(898992),n(354520),n(672577),n(581454);var o=n.n(n(844751)),i=n(296540),r=()=>n(534177);function a({sections:e,filterQuery:t}){return(0,i.useMemo)((()=>e.map((e=>function(e,t){const{items:n,...i}=e;if(!t)return e;const r=n.filter((e=>e.keywords.find((e=>o().match(t,e)))));return r.length>0?{...i,items:r}:void 0}(e,t))).filter(r().O9)),[t,e])}},613016:(e,t,n)=>{n.d(t,{a:()=>i});var o=()=>n(907258);function i(){const{sidebarSpaceStore:e}=o().default.getState();return e?e.id:void 0}},687681:(e,t,n)=>{n.d(t,{u:()=>o});const o=(0,n(340498).xh)("pencilLine",{default:{loader:()=>n.e(92668).then(n.bind(n,105819))},small:{loader:()=>n.e(92668).then(n.bind(n,523389))},fill:{loader:()=>n.e(92668).then(n.bind(n,71287))},fillSmall:{loader:()=>n.e(92668).then(n.bind(n,396654))}},["compose","edit","write","create"])},704658:(e,t,n)=>{n.r(t),n.d(t,{UpgradeButton:()=>y});n(296540);var o=()=>n(593531),i=()=>n(406094),r=()=>n(69708),a=()=>n(86269),s=()=>n(839897),l=()=>n(674482),u=()=>n(24796),d=n(474848);function c(e){var t;const{upgradeStatus:n,handleClick:o,size:c="default",width:p="fill",hoverRef:m,onMouseDown:f,upsell:g,featureName:y}=e,h=(0,r().tz)(),x=(0,s().e)(n),b=x.label.button({intl:h,upsell:g,featureName:y}),v=Boolean(x.disabledTooltip),k=(0,a().Lo)({width:p}),{animationState:T,animationTriggers:I}=(0,a().lP)(m);return(0,d.jsx)(u().T,{tooltipMessage:v&&!m?null===(t=x.disabledTooltip)||void 0===t?void 0:t.call(x,{intl:h,upsell:g,featureName:y}):void 0,children:(0,d.jsx)(i().A,{...m?{}:I,disabled:v,hoveredStyle:m?{background:"unset"}:void 0,size:l().lR[c],iconLeading:{...(0,a().e4)({icon:x.icon({upsell:g}),animationState:T}),size:l().Ud[c]},style:k,onClick:o,onMouseDown:f,children:b})})}var p=()=>n(160432);function m(e){var t;const{upsell:n,upgradeStatus:o,handleClick:i,onMouseDown:a,featureName:c}=e,m=(0,r().tz)(),f=(0,s().e)(o),g=f.label.button({intl:m,upsell:n,featureName:c}),y=Boolean(f.disabledTooltip);return(0,d.jsx)(u().T,{tooltipMessage:y?null===(t=f.disabledTooltip)||void 0===t?void 0:t.call(f,{intl:m,upsell:n,featureName:c}):void 0,children:(0,d.jsx)(p().A,{colorPalette:"blue",disabled:y,size:l().lR.default,onClick:i,onMouseDown:a,children:g})})}var f=()=>n(986321),g=()=>n(408543);function y({source:e,upsell:t,featureName:n,hoverRef:i,onMouseDown:r,postUpgradeCallback:a,onClickBeforeUpgradeAction:s,spaceStore:l,...u}){const{upgradeEligibility:p,handleClick:y}=(0,g().C)({upsell:t,source:e,buttonDisplayType:u.display,onClickBeforeUpgradeAction:s,postUpgradeCallback:a,spaceStore:l});if(!p||"not_eligible"===p.status&&"feature_not_upsellable"===p.reason)return null;switch(u.display){case"button":return(0,d.jsx)(c,{upgradeStatus:p.status,handleClick:y,upsell:t,featureName:n,hoverRef:i,onMouseDown:r,...u});case"icon":return(0,d.jsx)(o().c,{upgradeStatus:p.status,handleClick:y,upsell:t,featureName:n,hoverRef:i,onMouseDown:r,...u});case"text":return(0,d.jsx)(f().c,{upgradeStatus:p.status,handleClick:y,upsell:t,featureName:n,hoverRef:i,onMouseDown:r,...u});case"primary":return(0,d.jsx)(m,{upgradeStatus:p.status,handleClick:y,upsell:t,featureName:n,onMouseDown:r,...u})}}},736767:(e,t,n)=>{n.d(t,{A:()=>a});var o=n(296540),i=n(474848);function r(e,t){return(0,i.jsx)(n(424400).Ay,{...e,ref:t,style:{background:"none",borderBottom:"none",boxShadow:"",marginTop:2,marginBottom:6,paddingTop:4,paddingBottom:4,minHeight:"none",...e.style}})}const a=(0,o.forwardRef)(r)},824160:(e,t,n)=>{n.d(t,{A:()=>u});n(296540);var o=()=>n(726637),i=()=>n(484714),r=()=>n(401497),a=()=>n(718827),s=()=>n(100622),l=n(474848);function u(e){const t=(0,i().Y0)(),n=(0,r().IS)((()=>({sharedStyle:{display:"flex",alignItems:"center",borderRadius:4},innerStyle:{padding:"2px 6px",borderRadius:4,color:s().Tj.text.secondary,background:s().Tj.defaultBadgeBackground,fontSize:o().A.isMobile?11:9,lineHeight:t.isAndroid?1.5:1,textTransform:"uppercase",letterSpacing:"0.04em",whiteSpace:"nowrap"}})),[t.isAndroid]);return o().A.isMobile?(0,l.jsx)(a().Ay,{style:{...n.sharedStyle,...e.mobileStyle},disabled:void 0===e.onClick,children:(0,l.jsx)("div",{style:{...n.innerStyle,...e.innerStyle},children:e.children})}):(0,l.jsx)(a().Ay,{style:{...n.sharedStyle,...e.desktopStyle},disabled:void 0===e.onClick,...e,children:(0,l.jsx)("div",{style:{...n.innerStyle,...e.innerStyle},children:e.children})})}},838364:(e,t,n)=>{n.d(t,{H:()=>o});const o=52},871114:(e,t,n)=>{n.d(t,{o:()=>i});n(296540);const o={viewBox:"0 0 20 20",fittedViewBox:"2.12 4.12 15.76 12.16",directional:!0,svg:(0,n(474848).jsx)("path",{d:"M16.625 8A2.625 2.625 0 0 0 14 5.375h-1.42a.625.625 0 1 1 0-1.25H14a3.875 3.875 0 0 1 0 7.75H4.259l3.333 3.333a.625.625 0 0 1-.884.884l-4.4-4.4a.625.625 0 0 1 0-.884l4.4-4.4a.625.625 0 0 1 .884.884l-3.333 3.333H14A2.625 2.625 0 0 0 16.625 8"})},i=(0,n(340498).wt)("arrowUTurnDownLeft",o,"default")},876776:(e,t,n)=>{n.d(t,{Y:()=>L});n(898992),n(354520),n(581454);var o=n(296540),i=()=>n(726637),r=()=>n(484714),a=()=>n(590526),s=()=>n(401497),l=()=>n(295633),u=()=>n(699143),d=()=>n(245720),c=()=>n(127833),p=()=>n(250910),m=()=>n(807449),f=()=>n(546926),g=()=>n(631524),y=()=>n(302501),h=()=>n(890492),x=()=>n(81068),b=()=>n(663639),v=()=>n(736847),k=()=>n(187174),T=()=>n(324254),I=()=>n(179034),S=()=>n(69708),M=()=>n(100622),C=()=>n(284371),w=()=>n(255043),A=()=>n(619133),j=()=>n(419357),P=()=>n(187820),E=()=>n(29554),F=()=>n(915019),_=()=>n(106628),B=n(474848);const R=(0,S().YK)({pickPageToPreview:{id:"formulas.editor.pickPageToPreview",defaultMessage:"Preview a page’s formula result"},searchPlaceholder:{id:"formulas.editor.searchPlaceholder",defaultMessage:"Search"},noResults:{id:"formulas.editor.noResults",defaultMessage:"No results"},newPage:{id:"formulas.editor.newPage",defaultMessage:"New page"},selectPagePlaceholder:{id:"formulas.editor.selectPagePlaceholder",defaultMessage:"Select a page"}});function D(e,t){const n=e.getModel(),o=!n||n.isEmptyPage(),i=n?e.getProperties():void 0,r=i?(0,E().r4)(i.title,e):"",a=r||t.formatMessage(R.newPage);return{menuTitle:a,icon:(0,B.jsx)(P().B6,{disabled:!0,icon:e.getIcon(),iconRecordCategory:"pageBlock",isEmptyPage:o,size:16,title:a,defaultIcon:(0,B.jsx)(A().A,{size:16,isEmptyPage:o,role:"reader"})})}}function N({intl:e,events:t,currentOptionFull:n}){const o=(0,s().IS)((()=>({selectorButton:{padding:4,opacity:1,backgroundColor:"transparent",justifyContent:"flex-start",alignItems:"center",gap:2,fontSize:C().J.UISmall.desktop,color:M().Tj.text.secondary,fontWeight:500,height:24,maxWidth:200,...C().RC},selectorButtonText:{textOverflow:"ellipsis",color:M().Tj.text.primary}})),[]);return(0,B.jsxs)(g().p,{...t,style:o.selectorButton,children:[(0,B.jsx)(y().A,{style:o.selectorButtonText,children:n?(0,B.jsx)(w().O,{name:n.menuTitle,icon:n.icon,isSmall:!0}):(0,B.jsx)(w().O,{name:e.formatMessage(R.selectPagePlaceholder),isSmall:!0})}),(0,B.jsx)(m().I,{icon:T().arrowChevronSingleDownSmallIcon,size:"xs"})]})}function L(e){const{setSelectedBlockStore:t,selectedBlockStore:n,menuProps:s,inputProps:m,collectionStore:g}=e,T=(0,r().v3)(),[M,C]=(0,o.useState)(""),A=(0,a().K8)((()=>g.id),[g]),P=(0,a().K8)((()=>g.getSpaceId()),[g]),E=(0,S().tz)(),[{value:L}]=(0,k().Yb)((async()=>{if(!A)return{results:[]};const e=await _().T.searchActions.load();return await e.searchPagesInCollection({environment:T,query:M,collectionId:A,spaceId:P,excludeTemplates:!0,source:"formula_editor_page_picker",limit:20,includePublicPagesWithoutExplicitAccess:!1,boostRecentlyViewedPages:!0})}),[T,M,A,P],{debounce:300,debugName:"FormulaResultDropdownMenu_searchPages"}),V=(0,a().K8)((()=>L&&g?L.results.map((e=>l().B.createChildStore(g,{table:I().ev,id:e}))).filter((e=>null!==e)).map((e=>e)):[]),[L,g]),U=(0,a().K8)((()=>V.map((e=>function(e,t,n,o){const{menuTitle:i,icon:r}=D(t,e);return{key:t.id,keywords:[i],action:()=>{o(t)},render:e=>(0,B.jsx)(F().A,{store:t,render:o=>(0,B.jsx)("div",{...o,children:(0,B.jsx)(x().A,{...e,title:(0,B.jsx)(w().O,{name:i,icon:r,isSmall:!0}),shouldWrapCaption:!0,isChecked:(null==n?void 0:n.id)===t.id})}),delayThreshold:0,placement:"right"})}}(E,e,n,t)))),[V,n,t,E]),H=V.length>0,Y=(0,a().K8)((()=>n?D(n,E):void 0),[n,E]);return(0,B.jsx)(p().A,{popupType:i().A.isMobile?c().nl.BottomSheet:c().nl.Popup,bottomSheetInitialState:i().A.isMobile?"half":void 0,placementToOrigin:"bottom",renderOrigin:e=>(0,B.jsx)(N,{intl:E,events:e,currentOptionFull:Y}),render:e=>{const t=(0,B.jsx)(j().Ay,{style:{width:"100%",paddingTop:8,paddingBottom:2,marginBottom:8},placeholder:E.formatMessage(R.searchPlaceholder),onChange:e=>C(e.target.value),value:M,...m});let n;return n=i().A.isMobile?{menuType:f().gu.Modal,title:E.formatMessage(R.pickPageToPreview),right:(0,B.jsx)(S().sA,{...d().W.done}),onClickRight:()=>e.close(),minWidth:260,header:(0,B.jsx)(v().A,{children:t}),...s}:{menuType:f().gu.Popup,width:260,maxHeight:240,header:t,...s},(0,B.jsx)(h().A,{...n,children:H?(0,B.jsx)(b().A,{type:b().O.Vertical,sections:[{key:"dropdown.menuList",render:e=>(0,B.jsx)(v().A,{...e}),items:U}],initialFocus:0,onAccept:(t,n)=>{t.action(n),e.close()},style:{fontSize:i().A.isMobile?16:void 0,marginBottom:i().A.isMobile?16:void 0}}):(0,B.jsx)(u().Y1,{padding:8,children:(0,B.jsx)(y().A,{isSmall:!0,children:E.formatMessage(R.noResults)})})})}})}},915019:(e,t,n)=>{n.d(t,{A:()=>a});var o=n(296540),i=n(474848);function r({store:e,...t}){const r=(0,o.useCallback)((t=>(0,i.jsx)(n(877349).y,{store:e,events:t})),[e]);return(0,i.jsx)(n(26697).m,{noStyle:!0,delayThreshold:400,placement:"bottom",alignment:"start",renderTooltip:r,...t})}const a=o.memo(r)},931077:(e,t,n)=>{n.d(t,{Q:()=>s});n(296540);var o=()=>n(726637),i=()=>n(401497),r=()=>n(494379),a=n(474848);function s(e){const t=(0,i().DP)();return(0,a.jsx)(r().Q,{...e,theme:t,isMobile:o().A.isMobile})}},962753:(e,t,n)=>{n.d(t,{EH:()=>x,FO:()=>y,P$:()=>h,VA:()=>f,h0:()=>d,lM:()=>c,mq:()=>g});n(898992),n(581454),n(737550);var o=()=>n(907258),i=()=>n(242422),r=()=>n(763765),a=()=>n(613848),s=()=>n(496603),l=()=>n(534177),u=()=>n(822789);function d(e){const{currentUserRootStore:t}=o().default.state;if(!t)return!1;const n=t.getSpaceViewStores();return(0,s().oE)(null==n?void 0:n.map((e=>e.getSpaceId()))).map((t=>a().A.getData(e,{spaceId:t,userId:e.currentUser.id}))).some((e=>p(e)))}function c(e,t){return p(a().A.getData(e,{spaceId:t,userId:e.currentUser.id}))}function p(e){switch(null==e?void 0:e.membershipType){case void 0:case"none":case"page_guest":return!1;case"restricted_member":case"member":case"membership_admin":case"owner":return!0===e.is_sales_assisted;default:(0,l().HB)(e)}}function m(e,t){if(!t)return"control";if(c(e,t))return"control";const n=i().default.getEligibleGroup({experimentId:"ai_product_retention_simplified_input",defaultGroup:"control"});return"input"===n||"input_and_ask_mode"===n?n:"control"}function f(){switch(i().default.getEligibleGroup({experimentId:"ai_product_retention_agent_follow_ups",defaultGroup:"control"})){case"button_nudge":return["button","nudge"];case"button_control":return["button","default"];case"nudge":return["nudge"];default:return}}function g(e,t){const n=i().default.checkGate({gateName:"agent_deep_find"}),o=void 0!==t&&c(e,t),a=e.currentUser.id,s=!t||!a||r().t.USEWITHCAUTION_isFetchedForSpaceAndUserId({spaceId:t,userId:a}),l=n||!o&&s&&"on"===i().default.getEligibleGroup({experimentId:"ai_product_retention_deepfind",defaultGroup:"control"}),u=h(e,t);return{agentDeepFindEnabled:l,useReadOnlyMode:l&&u}}function y(e,t){if(t?(0,u().vp)(t):(0,u().hw)())return!0;return"control"!==m(e,t)}function h(e,t){return"input_and_ask_mode"===m(e,t)}function x(){return"on"===i().default.getEligibleGroup({experimentId:"ai_product_retention_agent_speculative_search",defaultGroup:"control"})}}}]);