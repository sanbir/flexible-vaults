"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[3651,8836],{101926:(e,t,o)=>{o.d(t,{ai:()=>oe,xN:()=>ae,e_:()=>ne,Ix:()=>ie,Z5:()=>le});o(898992),o(672577);var n=()=>o(569797),r=()=>o(197636),i=()=>o(663077),a=()=>o(792071),l=()=>o(869558),c=()=>o(144081),s=()=>o(496603),p=()=>o(534177),d=()=>o(79650),u=()=>o(414360),m=()=>o(586481),v=()=>o(547149),f=(o(354520),()=>o(913454)),g=()=>o(204067);function S({environment:e,collectionStore:t,collectionViewValue:o,dependencyMap:n,logger:r}){var a;if((0,f().remapPropertyIds)({collectionStore:t,object:o,dependencyMap:n}),function({environment:e,spaceId:t,collectionViewValue:o,logger:n}){for(const a of(null===(r=o.format)||void 0===r?void 0:r.collection_groups)??[]){var r,i;const{value:o}=a;if(("created_by"===o.type||"last_edited_by"===o.type)&&"notion_user"===(null===(i=o.value)||void 0===i?void 0:i.table)){const r=e.currentUser.id;if(!r){n.warn("No current user ID, unable to remap collection group user to current user!");continue}n.log(`Remapping user ID ${o.value.id} to ${r} in collection view group.`),o.value.id=r,o.value.spaceId=t}}}({environment:e,spaceId:t.getSpaceId(),collectionViewValue:o,logger:r}),o.query2&&function({collectionStore:e,query2:t,dependencyMap:o}){for(const n of i().Nf){const r=t[n];r&&(t[n]=(0,g().CB)({collectionStore:e,sourceTemplateType:"property",dependencyMap:o,sourcePrimitiveId:r}))}}({collectionStore:t,query2:o.query2,dependencyMap:n}),"object"==typeof(null===(a=o.format)||void 0===a?void 0:a.collection_view_default_template)){const e=(0,g().fI)({collectionStore:t,sourceTemplateType:"block",dependencyMap:n,sourcePrimitiveId:o.format.collection_view_default_template.template_page_id});e?o.format.collection_view_default_template={template_page_id:e}:(r.warn("Unable to resolve collection_view default template, omitting it."),delete o.format.collection_view_default_template)}}function h({collectionViewFormat:e}){const t=null==e?void 0:e.table_properties;t&&(e.table_properties=t.filter((e=>!(0,g().TE)(e.property))))}var y=()=>o(731638),w=(o(581454),o.n(o(794148))),_=()=>o(726637),I=()=>o(675133),C=()=>o(192845),T=()=>o(239381),b=()=>o(206267),k=()=>o(884173),P=()=>o(696706),V=()=>o(912720),M=()=>o(199378),x=()=>o(179034),B=()=>o(519831),A=()=>o(798880),R=()=>o(324587),F=()=>o(594794);function E({collectionStore:e,environment:t,logger:o,template:n,transaction:r}){const i=function({environment:e,logger:t,parentStore:o,template:n,transaction:r}){const i=(0,F().zP)({environment:e,spaceId:o.getSpaceId(),table:V().yB}),l=e.currentUser.id,c=a().Bj6.fromAutomation({alive:!0,created_by_id:l??"",created_by_table:A().oo,created_time:Date.now(),id:i.id,parent_id:o.pointer.id,parent_table:o.pointer.table,space_id:o.getSpaceId(),trigger:{...n.value.trigger,id:b().JW()},version:0,last_edited_by_id:l??"",last_edited_by_table:A().oo,last_edited_time:Date.now(),status:"active"}),s=O({actionPlaceholderIdToActionId:new Map,collectionStore:o,dependencyMap:n.dependencyMap,logger:t}),{value:p}=(0,C().n)({automationModel:c,visitors:s}),d=p.getTrigger(),u=R().createAutomation({actionIds:[],environment:e,automationId:i.id,automationName:n.value.name,parentPointer:o.getSpaceShardedPointer(),transaction:r,trigger:d});return u}({environment:t,logger:o,parentStore:e,template:n,transaction:r}),l=new Map;return n.value.actions.map((a=>function({actionPlaceholderIdToActionId:e,actionTemplate:t,collectionStore:o,environment:n,logger:r,parentStore:i,parentTemplate:a,transaction:l}){const c=(0,F().zP)({environment:n,spaceId:i.getSpaceId(),table:M().SC}),{config:s,placeholderId:p,type:d}=t,{model:u}=k().RU.create({alive:!0,config:s,id:c.id,parent_id:i.pointer.id,parent_table:i.pointer.table,space_id:o.getSpaceId(),type:d,version:0}),m=O({actionPlaceholderIdToActionId:e,collectionStore:o,dependencyMap:a.dependencyMap,logger:r}),{value:v}=(0,C().G)({automationActionModel:u,baseUrl:_().A.domainBaseUrl,preventClearingConfig:!0,publicDomainName:_().A.publicDomainName,sourceSpaceId:o.getSpaceId(),visitors:m}),f=v.getConfig(),g=R().addAutomationAction({actionId:c.id,actionType:t.type,automationStore:i,config:f,createDuplicateBlocksContainer:!0,environment:n,intl:I().A.getIntl(),transaction:l});return w()(g,"Failed to create automation action"),e.set(p,g.id),g}({actionPlaceholderIdToActionId:l,actionTemplate:a,collectionStore:e,environment:t,logger:o,parentStore:i,parentTemplate:n,transaction:r}))),i.isTriggerType("event")&&v().applyOperation({store:e,operation:{pointer:e.pointer,path:["format","automation_ids"],command:"listAfter",args:{id:i.id}},transaction:r}),{id:i.id,spaceId:e.getSpaceId(),type:"automation"}}function O(e){const{actionPlaceholderIdToActionId:t,collectionStore:o,dependencyMap:n,logger:r}=e;function i(e){const o=(0,T().y5)(e);if("action"===o.source){const e=t.get(o.action_id)??o.action_id;return(0,T().$y)({...o,action_id:e})}if("global"===o.source)return e;(0,p().HB)(o)}function a(e){if(!n)return;if("title"===e)return e;const t=(0,g().fI)({collectionStore:o,sourceTemplateType:"property",sourcePrimitiveId:e,dependencyMap:n});return t||r.warn(`Failed to remap property ID ${e} in automation template`),t}return{visitCollectionProperty:e=>n?{type:"replace",value:a(e)}:{type:"keep"},visitCollectionPropertyPointer:e=>{if(!n)return{type:"keep"};const t=a(e.propertyId);if(!t)return{type:"replace",value:void 0};const i=(0,g().fI)({collectionStore:o,sourceTemplateType:"collection",sourcePrimitiveId:e.id,dependencyMap:n});return i?{type:"replace",value:{id:i,propertyId:t,spaceId:o.getSpaceId(),table:B().Vl}}:(r.warn(`Failed to remap collection ID ${e.id} in automation template`),{type:"replace",value:void 0})},visitFormulaContextValue:e=>({type:"replace",value:i(e)}),visitFormulaPageProperty:e=>{if(!n)return{type:"keep"};const t=(0,s().mg)(e),l=a(e.property);if(!l)return{type:"replace",value:void 0};if(t.property=l,"collection"in t&&t.collection){const e=(0,g().fI)({collectionStore:o,sourceTemplateType:B().Vl,sourcePrimitiveId:t.collection.id,dependencyMap:n});if(!e)return r.warn(`Failed to remap collection ID ${t.collection.id} in automation template`),{type:"replace",value:void 0};t.collection=P().L3.fromSpaceShardRecordId({id:e,spaceId:o.getSpaceId()},B().Vl)}else"contextValueId"in t&&t.contextValueId&&(t.contextValueId=i(t.contextValueId));return{type:"replace",value:t}},visitRecordPointer:e=>{if(!n)return{type:"keep"};if(e.table===x().ev||e.table===B().Vl||e.table===V().yB||e.table===l().Gy){const t=(0,g().fI)({collectionStore:o,sourceTemplateType:e.table,sourcePrimitiveId:e.id,dependencyMap:n});return t?{type:"replace",value:P().L3.fromSpaceShardRecordId({id:t,spaceId:o.getSpaceId()},e.table)}:(r.warn(`Failed to remap record pointer ${P().L3.toKey(e)} in automation template`),{type:"replace",value:void 0})}return{type:"keep"}}}}o(16280);var N=()=>o(388821),$=()=>o(722101),G=()=>o(44729),L=()=>o(949653);var D=()=>o(253141),z=(o(944114),o(803949),()=>o(384944));function U({environment:e,transaction:t,collectionStore:o,template:r,logger:i,preserveCollectionFeatureOrdering:a}){const c=o.getParentBlockStore();if(!c)throw new Error("Collection view block store not found");const{value:s,dependencyMap:p}=r;if(!p)throw new Error("Dependency map not defined on view template");S({environment:e,collectionStore:o,collectionViewValue:s,dependencyMap:p,logger:i}),function({collectionStore:e,collectionViewValue:t}){var o;const n=null===(o=t.format)||void 0===o?void 0:o.table_properties;if(!n)return;const r=n.map((e=>e.property)),i=Object.keys(e.getSchema()).filter((e=>!r.includes(e)));for(const a of i)n.push({property:a,visible:!1})}({collectionStore:o,collectionViewValue:s});const d=z().eC({environment:e,table:l().Gy,inMemoryRecordCache:c.inMemoryRecordCache,value:{...s,parent_id:c.id,parent_table:c.table,space_id:c.getSpaceId(),format:{...s.format,collection_pointer:o.pointer},alive:!0},transaction:t}),u=n().p.createChildStore(c,d.pointer),m=c.getCollectionViewsStore();if(a){const e=function({collectionTemplate:e,collectionViewStores:t,collectionViewTemplate:o}){let n,r=-1;const i=e.value.templateItems.findIndex((e=>e.pointer===o.templateId));return t.forEach((t=>{var o;const a=null===(o=t.getFormat().workflow_template_instance)||void 0===o?void 0:o.template_id;if(!a)return;const l=e.value.templateItems.findIndex((e=>e.pointer===a));l>i||l>r&&(r=l,n=t.id)})),n}({collectionTemplate:a,collectionViewStores:c.getCollectionViewStores(),collectionViewTemplate:r});e?$().BC({parentStore:m,appendStore:u,transaction:t,after:e}):$().Hs({parentStore:m,prependStore:u,transaction:t})}else $().BC({parentStore:m,appendStore:u,transaction:t});return{type:"collection_view",id:u.id}}var W=()=>o(498212);var q=()=>o(220719),Q=()=>o(447934);var Z=()=>o(536095),H=()=>o(443881),j=()=>o(931075),K=()=>o(183558),X=()=>o(312296);function Y(e){const{environment:t,logger:o,transaction:n,collectionStore:r,template:a}=e,l=function(e){if("title"===e.value.type)return"title";if(e.templateId===Z().RE||e.templateId===Z().K4)return j()._e.Verification;if(e.templateId===Z().dr)return j()._e.Owner;return(0,K().Ay)()}(a);if((0,i().PC)(a,"formula"))J({...e,template:a});else if((0,i().Ox)(a)){const t=f().globalWorkflowTemplates.featureFromId(a.buttonAutomationId);o.log(`Instantiating dependency "${t.templateId}" of button property template "${a.templateId}".`);const n=ne({...e,template:t});if(!n)throw new Error(`Failed to create instance of automation template "${t.templateId}"`);if("automation"!==n.type)throw new Error(`Unexpected instance pointer. Expected "automation" but got "${n.type}"`);a.value.automation_id=n.id}const c=(0,s().mg)(a.value);return c.workflow_template_instance={template_id:a.templateId},(0,X().F)({environment:t,collectionStore:r,update:{[l]:c},transaction:n}),{type:"property",id:l,collectionId:r.id}}function J({template:e,collectionStore:t}){const{value:o,dependencyMap:n}=e;if(!n)return;if(!o.formula2)return;const{value:r}=(0,H().RI)({baseUrl:_().A.domainBaseUrl,formula:o.formula2.code,publicDomainName:_().A.publicDomainName,spaceId:t.getSpaceId(),visitors:{visitFormulaContextValue:void 0,visitFormulaPageProperty:e=>{const o={...e};return o.property=(0,g().CB)({dependencyMap:n,collectionStore:t,sourcePrimitiveId:e.property,sourceTemplateType:"property"}),"collection"in o&&o.collection&&(o.collection=t.pointer),{type:"replace",value:o}},visitRecordPointer:void 0}});o.formula2.code=r}var ee=()=>o(290966),te=()=>o(839754);function oe({environment:e,transaction:t,collectionStore:o,template:n,logger:r,origin:i,examplePageStores:a,preserveCollectionFeatureOrdering:l}){const c=ne({transaction:t,environment:e,collectionStore:o,template:n,logger:r,origin:i,preserveCollectionFeatureOrdering:l}),s=(0,f().getPropertyTemplates)([n]);return(0,te().My)({transaction:t,collectionStore:o,propertyTemplates:s}),(0,te().Bi)({transaction:t,collectionStore:o,propertyTemplates:s}),ie({environment:e,transaction:t,collectionStore:o,template:n,logger:r,examplePageStores:a}),c}function ne(e){const{collectionStore:t,template:o,transaction:n}=e;!function(e){const{template:t,logger:o}=e,n=(0,i().Z6)({template:t,logger:o}),{environment:r,collectionStore:a}=e;for(const i of n){(0,g().Zp)({environment:r,scopeStore:a,templateId:i.templateId})||(o.log(`Template "${t.templateId}" has implicit dependency "${i.templateId}" (source: ${i.debugSource}), instantiating it.`),ne({...e,template:f().globalWorkflowTemplates.featureFromId(i.templateId)}))}}(e);const r=function(e){const{logger:t}=e,o=s().mg(e.template),{type:n}=o;switch(t.log(`Instantiating ${n} template "${o.templateId}".`),n){case"property":return Y({...e,template:o});case"collection_view":return U({...e,template:o});case"layout":return function({environment:e,transaction:t,collectionStore:o,template:n}){if(!n.dependencyMap)throw new Error("Dependency map not defined on layout template");const r=(0,y().f)({collectionStore:o,modules:{page_layout_schema:void 0,page_info_layout_schema:void 0,form_layout_schema:void 0,person_profile_page_main:void 0,person_profile_page_details:void 0,...n.value},dependencyMap:n.dependencyMap}),{model:i}=(0,Q().$L)({environment:e,transaction:t,collectionStore:o,userId:(0,q().o9)(e.currentUser.id),modules:r});return{type:"layout",id:i.id,spaceId:o.getSpaceId()}}({...e,template:o});case"compound":return function(e){const{environment:t,template:o,collectionStore:n,logger:r}=e,a=[],l=e=>{if(!(0,g().DM)(e)||"compound"===e.type)throw new Error(`Template in compound template generated a non-feature instance pointer of an illegal type: ${e.type}`);a.push(e)};for(const c of o.value.templateItems){const{optionality:a,pointer:s}=c;if("optionalDefaultOff"===a)continue;const p=(0,g().Zp)({environment:t,scopeStore:n,templateId:c.pointer});if(p){l(p);continue}const d=f().globalWorkflowTemplates.fromId(s);if(!(0,i().$K)(d))throw new Error(`${d.templateId} in compound template is of an illegal type: ${d.type}`);r.log(`Instantiating dependency "${d.templateId}" of compound template "${o.templateId}".`);const u=oe({...e,template:d});u&&l(u)}return{type:"compound",id:(0,W().Ay)(),instancePointers:a,collectionId:n.id}}({...e,template:o});case"block":return function({environment:e,transaction:t,collectionStore:o,template:n}){const r=(0,F().zP)({environment:e,spaceId:o.getSpaceId(),table:x().ev});if("block"!==n.type)throw new Error(`Expected block template, got ${n.type} template: ${n.templateId}`);if(!n.dependencyMap)throw new Error(`Dependency map not defined on block template: ${n.templateId}`);const{dependencyMap:i}=n,a=N().RecordMap.create(n.value.recordMap),l=a.getModel(n.value.blockPointer);if(l){const e=l.getProperties();for(const[t,n]of Object.entries(e)){const r=(0,g().CB)({collectionStore:o,sourceTemplateType:"property",sourcePrimitiveId:t,dependencyMap:i});r&&(delete e[t],e[r]=n)}}const{targetBlockStore:c}=(0,L().localDuplicate)({environment:e,sourceBlockId:n.value.blockPointer.id,targetBlockPointer:r,sourceBlockSubtree:a,transaction:t,targetInMemoryRecordCache:o.inMemoryRecordCache,from:"create_block_template",options:{allowRedundancy:!0,deepCopyTransclusionContainers:!1,resolveTemplateVariables:!1}});return G().X$({childStore:c,parentStore:o,transaction:t}),c.isTemplate()&&$().BC({parentStore:o.getTemplatePagesStore(),appendStore:c,transaction:t}),{type:"block",id:c.id,spaceId:o.getSpaceId()}}({...e,template:o});case"automation":return E({...e,template:o});default:(0,p().HB)(n)}}(e);return r&&(0,ee().ZQ)({transaction:n,collectionStore:t,templateId:o.templateId,instance:r,logger:e.logger}),r}function re({environment:e,transaction:t,collectionStore:o,template:n,instancePointer:r,examplePageStores:i}){if(i&&"property"===r.type)for(const a of i){const r=(0,D().gv)({collectionStore:o,dependencyMap:n.dependencyMap??{},exampleRow:{properties:a.getProperties()}});(0,m().C)({environment:e,store:a,properties:r.properties,transaction:t})}}function ie({environment:e,transaction:t,collectionStore:o,template:i,logger:s,examplePageStores:p}){const d=(0,g().Sl)({environment:e,collectionStore:o});for(const{instancePointer:u,templateId:m}of d){if("collection"===u.type)continue;const d=f().globalWorkflowTemplates.fromId(m),g=d.dependencyMap&&Object.values(d.dependencyMap).includes(i.templateId);if(!("dependencyMap"in d)||!d.dependencyMap||!g){re({environment:e,transaction:t,collectionStore:o,template:i,examplePageStores:p,instancePointer:u});continue}s.log(`Remapping dependency "${i.templateId}" in "${m}".`);const h={};if("layout"===u.type){const e=r().K.createChildStore(o,{table:c().zx,id:u.id,spaceId:u.spaceId}),n=e.getRawModules();if(n){const r=(0,y().f)({collectionStore:o,modules:n,dependencyMap:h});v().applyOperation({transaction:t,store:e,operation:a().N4X.updateModules(e.pointer,r)})}}else if("collection_view"===u.type){const t=n().p.createChildStore(o,{table:l().Gy,id:u.id}),r=t.getType();if(!r)continue;S({environment:e,collectionStore:o,collectionViewValue:{type:r,name:t.getName(),format:t.getFormat(),query2:t.getRawQuery()},dependencyMap:h,logger:s})}else s.warn(`Don't know how to remap instance type "${u.type}"!`)}}function ae({environment:e,collectionStore:t}){const o=(0,g().Sl)({environment:e,collectionStore:t});for(const{instancePointer:r}of o)if("collection_view"===r.type){const e=n().p.createChildStore(t,{table:l().Gy,id:r.id});if(!e.getType())continue;h({collectionViewFormat:e.getFormat()})}}function le({environment:e,transaction:t,collectionViewBlockStore:o,collectionStore:n,instancePointer:r}){const i=r.type;switch(i){case"property":(0,d().B)({environment:e,collectionStore:n,schema:n.getSchema(),property:r.id,transaction:t,permanentlyDelete:!1});break;case"collection_view":if(!o)return;const a=o.getCollectionViewStores().find((e=>e.id===r.id));a&&(0,u().T)({collectionViewBlockStore:o,collectionViewStore:a,transaction:t});break;case"layout":case"block":case"automation":break;default:(0,p().HB)(i)}}},154152:(e,t,o)=>{o.d(t,{z:()=>i});var n=()=>o(239924),r=()=>o(458097);async function i({setupGenerator:e,isPhone:t}){(0,n().moveToNextOnboardingStep)(t);const o=r().default.state.open?r().default.state.flowId:void 0,i=await e.submitPrompt({from:"initial-input"}),a=r().default.state.open?r().default.state.flowId:void 0;i&&!(o!==a)&&(0,n().moveToNextOnboardingStep)(t)}},239924:(e,t,o)=>{o.r(t),o.d(t,{createCollectionTemplateFromModalState:()=>ae,createMinimalCollectionTemplateWithoutModal:()=>re,createPlaceholderWorkflowTemplateBlock:()=>de,getSetupGeneratorForTemplate:()=>ee,getTemplateOnboardingVersion:()=>Y,handleSelectTemplateFromOnboardingModal:()=>oe,maybeAddAppTemplateMetadataForTasks:()=>se,moveToNextOnboardingStep:()=>ge,moveToPreviousOnboardingStep:()=>fe,onNavigateToPlaceholderWorkflowTemplateBlock:()=>ue,openSelectedTemplateOnboardingModalForInAppFlows:()=>te,openTemplateOnboardingModal:()=>X,retryAiSetup:()=>me,setFollowUpInputFocused:()=>ve,switchModalToTemplate:()=>ne,toggleFeatureSelectionInPreview:()=>pe});o(16280),o(898992),o(354520),o(672577),o(581454);var n=()=>o(726637),r=()=>o(675133),i=()=>o(128933),a=()=>o(295633),l=()=>o(584262),c=()=>o(433337),s=()=>o(536095),p=()=>o(663077),d=()=>o(700500),u=()=>o(206267),m=()=>o(201980),v=()=>o(496603),f=()=>o(498212),g=()=>o(973647),S=()=>o(534177),h=()=>o(896628),y=()=>o(496414),w=()=>o(384944),_=()=>o(857783),I=()=>o(680074),C=()=>o(547149),T=()=>o(680977);var b=()=>o(766854),k=()=>o(512039),P=()=>o(586481),V=()=>o(211716),M=()=>o(154152),x=(o(18107),o(410838),o(813451),o(967357),o(737550),()=>o(564884)),B=()=>o(155792),A=()=>o(449412),R=()=>o(962753),F=()=>o(594794),E=()=>o(349379);o(944114);class O{constructor(){this.root=new N}append(e){if(this.root.isEmpty())this.root.addChild(e);else{const t=this.toNodes().at(-1);if(!t)throw new Error("Last node not found");t.addChild(e)}}toNodes(){return this.root.getSelectedPath()}toValues(){return this.toNodes().map((e=>e.value))}removeLast(){const e=this.toNodes().at(-1);if(!e)return;const t=e.value;return e.remove(),t}removeLastMatching(e){const t=this.toNodes().findLastIndex((t=>e(t.value)));if(-1===t)return[];const o=[];for(;this.toNodes().length>t;){const e=this.removeLast();void 0!==e&&o.push(e)}return o}}class N{constructor(){this.children=[],this.selectedChild=void 0}addChild(e){const t=new $(e,this);return this.children.push(t),this.selectedChild=t,t}getSelectedPath(){var e;return(null===(e=this.selectedChild)||void 0===e?void 0:e.toSelectedPath())??[]}isEmpty(){return 0===this.children.length}getChildren(){return this.children}setSelectedChild(e){if(!this.children.includes(e))throw new Error("Cannot select a node that is not a child");this.selectedChild=e}removeChild(e){const t=this.children.indexOf(e);-1!==t&&(this.children.splice(t,1),this.selectedChild===e&&(this.selectedChild=void 0))}}class ${constructor(e,t){this.value=void 0,this.children=[],this.selectedChild=void 0,this.parent=void 0,this.isRemoved=!1,this.value=e,this.parent=t}addChild(e){const t=new $(e,this);return this.children.push(t),this.selectedChild=t,t}toSelectedPath(){const e=[this];return this.selectedChild&&e.push(...this.selectedChild.toSelectedPath()),e}retry(e){if(this.isRemoved)throw new Error("Cannot retry on a removed node");this.parent.addChild(e)}select(e){if(this.isRemoved)throw new Error("Cannot select on a removed node");const t=this.parent.getChildren(),o=e(t.map((e=>e.value)),this.value);if(void 0===o)return!1;const n=t.find((e=>e.value===o));return n?this.parent.setSelectedChild(n):this.parent.addChild(o),!0}selectOrRetry(e){if(!this.select(e)){const t=e([],void 0);void 0!==t&&this.retry(t)}}remove(){if(this.children.length>0)throw new Error("Cannot remove a node that has children");if(this.isRemoved)throw new Error("Node is already removed");this.parent.removeChild(this),this.isRemoved=!0}getChildren(){return this.children}setSelectedChild(e){if(!this.children.includes(e))throw new Error("Cannot select a node that is not a child");this.selectedChild=e}removeChild(e){const t=this.children.indexOf(e);-1!==t&&(this.children.splice(t,1),this.selectedChild===e&&(this.selectedChild=void 0),e.isRemoved=!0)}}class G extends(()=>o(757695))().Store{constructor(...e){super(...e),this.derivedUiStore=new(o(140934).ComputedStore)((()=>{var e;const t=(null===(e=this.state.transcriptTree)||void 0===e||null===(e=e.toNodes())||void 0===e?void 0:e.filter((e=>"setup"===e.value.type)))??[];return{canFollowUp:t.length<5,canRetry:t.length>=2}}),{debugName:"derivedUiStore",useDeepEqual:!0})}getInitialState(){return{isBusy:!1,transcriptTree:new O}}setPrompt(e){this.setState({...this.state,prompt:e})}}class L{constructor(e){this.environment=void 0,this.generatedSetupCount=0,this.store=void 0,this.error=void 0,this.spaceId=void 0,this.eventBase=void 0,this.abortController=void 0,this.onSetupReady=void 0,this.setPrompt=e=>{this.store.setState({...this.store.state,prompt:e})},this.submitPrompt=async e=>{var t;const{from:n}=e,r="follow-up"===n,{isBusy:a,prompt:l}=this.store.state;if(a||!l)return!1;if(!this.spaceId)return!1;this.store.setState({...this.store.state,isBusy:!0}),null===(t=this.store.state.transcriptTree.toNodes().find((e=>"config"===e.value.type)))||void 0===t||t.selectOrRetry((e=>{const t=e.find((e=>"config"===e.type&&"setup-generator"===e.value.type));return t||{id:(0,F().Z1)({environment:this.environment,table:B().mS,spaceId:this.spaceId}),type:"config",value:{type:"setup-generator"}}}));try{var c;const e=this.store.state.transcriptTree.toNodes().find((e=>"user"===e.value.type));if(e&&!r)e.selectOrRetry((e=>{const t=e.find((e=>"user"===e.type&&(0,m().MTk)(l,e.value)));if(t)return t;{const e=this.environment.currentUser.id;if(!e)throw new Error("Current user not found");return{id:(0,F().Z1)({environment:this.environment,table:B().mS,spaceId:this.spaceId}),type:"user",value:l,userId:e}}}));else{const e=this.environment.currentUser.id;if(!e)throw new Error("Current user not found");this.store.state.transcriptTree.append({id:(0,F().Z1)({environment:this.environment,table:B().mS,spaceId:this.spaceId}),type:"user",value:l,userId:e})}const t=this.store.state.transcriptTree.toValues();if(!t.slice(t.findLastIndex((e=>"user"===e.type))+1).some((e=>"setup"===e.type))){const e=(0,f().Ay)(),n=new AbortController;this.abortController=n;let r=!1;try{const a=await(0,o(348869).g)({environment:this.environment,abortSignal:n.signal,data:{traceId:e,generateTitle:!1,transcript:t,spaceId:this.spaceId,isUserInAnySalesAssistedSpace:(0,R().h0)(this.environment),isSpaceSalesAssisted:(0,R().lM)(this.environment,this.spaceId)},onResponse:e=>{"setup-operations"===e.type&&this.store.setState({...this.store.state,progress:e.progress}),"retry"!==e.type||r||(r=!0,i().D6({label:"This is taking a little longer than usual"}))}});if(this.abortController=void 0,this.store.setState({...this.store.state,progress:void 0,feedbackArgs:this.computeFeedbackArgs()}),!g().Q.isSuccess(a))return A().O8(a.error,{from:"fullPageTranslationActions.generateAndApplyTranslationMapToPage",type:"error"}),this.onSetupReady({error:a.error}),!1;const l=function(e){const t=new Map;for(const o of e){const e="string"==typeof o.id?o.id:String(o.id),n=t.get(e);n&&"setup-operations"===n.type&&"setup-operations"===o.type?t.set(e,{...n,operations:[...n.operations,...o.operations]}):t.set(e,o)}return Array.from(t.values())}(a.value.filter(o(592933).Vf));for(const e of l)this.store.state.transcriptTree.append(e)}finally{this.abortController=void 0}}const n=null===(c=this.store.state.transcriptTree.toValues().findLast((e=>"setup"===e.type)))||void 0===c?void 0:c.setup;if(!n)throw new Error("Missing setup step");return this.generatedSetupCount++,this.store.setState({...this.store.state,setup:n,prompt:void 0}),this.trackGeneratedSetup(n),this.onSetupReady({value:n}),!0}catch(s){return s instanceof Error&&"AbortError"===s.name||(A().O8(s,{from:"setupGenerator.submitPrompt",type:"error"}),this.onSetupReady({error:{code:500,message:"Unknown error"}})),!1}finally{this.store.setState({...this.store.state,isBusy:!1,feedbackArgs:this.computeFeedbackArgs()})}},this.stopGenerating=()=>{var e;null===(e=this.abortController)||void 0===e||e.abort()},this.discardLatestSetup=()=>{var e,t;const o=null===(e=this.store.state.transcriptTree.toValues().findLast((e=>"user"===e.type)))||void 0===e?void 0:e.value;if(!o)return;this.store.state.transcriptTree.removeLastMatching((e=>"user"===e.type));const n=null===(t=this.store.state.transcriptTree.toValues().findLast((e=>"setup"===e.type)))||void 0===t?void 0:t.setup;this.store.setState({...this.store.state,prompt:o,setup:n,feedbackArgs:this.computeFeedbackArgs()}),n&&this.onSetupReady({value:n}),(0,x().u)({environment:this.environment,event:{eventName:"setup_generator_try_again_clicked",eventProperties:this.eventBase}})};const{environment:t,spaceId:n,onSetupReady:r,initialPrompt:a,analyticsArgs:l}=e;if(this.environment=t,this.spaceId=n,this.eventBase={flow_id:l.workflowTemplatesFlowId??(0,f().Ay)(),origin:l.origin,has_selection_modal_search_query:l.hadSelectionModalSearchEntered,data_source_session_id:l.dataSourceSessionId,data_source_from:l.dataSourceFrom},this.store=new G,this.store.state.transcriptTree.append({id:(0,F().Z1)({environment:t,table:B().mS,spaceId:n}),type:"config",value:{type:"setup-generator"}}),a){this.store.setState({...this.store.state,prompt:a});const e=this.environment.currentUser.id;e&&this.store.state.transcriptTree.append({id:(0,F().Z1)({environment:t,table:B().mS,spaceId:n}),type:"user",value:a,userId:e})}this.onSetupReady=r}computeFeedbackArgs(){const{setup:e}=this.store.state,t=null==e?void 0:e.metadata.setupId;if(t&&this.store.state.transcriptTree)return{spaceId:this.spaceId,traceId:t,transcript:this.store.state.transcriptTree.toValues()}}discardAllSetups(){var e;if(!this.store.state.transcriptTree)return;const t=this.store.state.transcriptTree.toNodes().findIndex((e=>"user"===e.value.type));if(-1===t)return;const o=this.store.state.transcriptTree.toValues().at(t);if(!o||"user"!==o.type)return;for(;this.store.state.transcriptTree.toNodes().length>t;)this.store.state.transcriptTree.removeLast();const n=null===(e=this.store.state.transcriptTree.toValues().findLast((e=>"setup"===e.type)))||void 0===e?void 0:e.setup;this.store.setState({...this.store.state,prompt:o.value,setup:n,feedbackArgs:this.computeFeedbackArgs()}),n&&this.onSetupReady({value:n})}trackSessionStarted(){(0,E().Vd)({environment:this.environment,eventProperties:this.eventBase})}trackSessionEnded(e){const{reason:t}=e;(0,x().u)({environment:this.environment,event:{eventName:"setup_generator_session_ended",eventProperties:{...this.eventBase,generated_setup_count:this.generatedSetupCount,reason:t}}})}trackGeneratedSetup(e){const{metadata:t}=e,{setupId:o,promptInfo:n}=t,r=e.allTemplates.filter((e=>(0,p().Xq)(e,"collection"))).length,i=e.allTemplates.filter((e=>(0,p().Xq)(e,"collection_view"))).length,a=e.allTemplates.filter((e=>(0,p().Xq)(e,"property"))).length;(0,E().If)({environment:this.environment,eventProperties:{...this.eventBase,setup_id:o,prompt_type:"custom",collection_count:r,collection_view_count:i,property_count:a,total_duration_ms:e.metadata.timing.total,warning_count:e.metadata.warnings.length,error_count:e.metadata.errors.length,use_case:null==n?void 0:n.useCase,prompt_specificity:null==n?void 0:n.specificity,prompt_language:null==n?void 0:n.language}})}}var D=()=>o(973891),z=()=>o(253141),U=()=>o(101926),W=()=>o(922952),q=()=>o(913454);function Q({environment:e,parentStore:t,collectionTemplate:o}){if(!t.getSpaceId())throw new Error(`Space ID not found for ${t}`);const n=(0,p().bQ)(o).map((e=>q().globalWorkflowTemplates.fromId(e))).filter((e=>(0,p().Sz)(e))),r=[];for(const i of n){const{relatedCollectionTemplateId:o}=i,n=(0,q().getChildCollectionStoreByTemplateId)({environment:e,parentStore:t,collectionTemplateId:o});n&&r.push({type:"target",collectionStore:n,relationPropertyTemplate:i})}return r}var Z=()=>o(204067),H=()=>o(605315),j=()=>o(466934),K=()=>o(458097);function X({template:e,parentStore:t,origin:o,version:n,existingCollectionInfo:r,relationInfos:i,navigateToOnFinish:a="created_collection",setupGenerator:l,flowId:c,dataSourceAnalytics:s,onClose:p}){const d=e?(0,j().C8)({collectionTemplate:e,origin:o,flowId:c,parentStore:t,dataSourceAnalytics:s,existingCollectionInfo:r}):(0,j().XM)({origin:o,flowId:c,parentStore:t,dataSourceAnalytics:s});D().T_(),K().default.setState({open:!0,isSaving:!1,currentStepIndex:0,version:n,existingCollectionInfo:r,relationInfos:i??[],navigateToOnFinish:a,setupGenerator:l,onClose:p,...d,parentStore:t})}function Y(e){if(!e.template)return"select_and_customize_template";const{includeTemplateSelectionStep:t,hasSetupGenerator:o}=e;return o?t?"select_and_build_with_ai":"build_with_ai":t?"select_and_customize_template":"customize_template"}const J=(0,o(69708).YK)({setupGenerationError:{id:"setupGenerator.error.failedToGenerateSetup",defaultMessage:"Sorry, something went wrong while completing this request. Please try again."},setupGenerationRateLimitError:{id:"setupGenerator.error.rateLimited",defaultMessage:"Too many requests. Please try again later."}});function ee({environment:e,parentStore:t,template:o,initialAiPrompt:n,analyticsArgs:a}){const l=null==t?void 0:t.getSpaceId(),c=(0,p().cB)(o.templateId)?new L({environment:e,analyticsArgs:a,spaceId:l,initialPrompt:n,onSetupReady:e=>{const t=K().default.state;if(!t.open)return;if(g().Q.isFail(e))return void(429===e.error.code?i().D6({label:r().A.formatMessage(J.setupGenerationRateLimitError)}):i().D6({label:r().A.formatMessage(J.setupGenerationError)}));const o=e.value;if(t.setupGenerator!==c)return;H().Z.append(o.allTemplates.filter((e=>e.isAiGenerated)));const n=o.allTemplates.find((e=>(0,p().Xq)(e,"collection")));if(!n)throw new Error("No collection template found");ne(n)}}):void 0;return c}function te({template:e,environment:t,aiPrompt:o,autoSubmit:n=!1,version:r,...i}){var a;const{parentStore:l,relationInfos:c,origin:s,flowId:p=(0,f().Ay)(),dataSourceAnalytics:d}=i,u=((null===(a=i.collectionTemplatesSearchQuery)||void 0===a?void 0:a.length)??0)>0,m=t.device.isPhone,g=Q({environment:t,parentStore:l,collectionTemplate:e}),S=ee({environment:t,template:e,parentStore:l,initialAiPrompt:o,analyticsArgs:{origin:s,hadSelectionModalSearchEntered:u,workflowTemplatesFlowId:p,...d}});X({...i,template:e,flowId:p,version:r??Y({template:e,includeTemplateSelectionStep:!1,hasSetupGenerator:Boolean(S)}),relationInfos:v().hS([...c??[],...g],(e=>e.collectionStore.id)),setupGenerator:S}),S&&n&&(0,M().z)({setupGenerator:S,isPhone:m})}function oe({template:e,environment:t,analyticsArgs:o}){var n,r;const i=K().default.state;if(!i.open||!i.parentStore)return;const{parentStore:a,relationInfos:l,origin:c,flowId:p,dataSourceAnalytics:d}=i,u=t.device.isPhone,f=i.collectionTemplatesSearchQuery?(0,m().x9d)(i.collectionTemplatesSearchQuery):void 0,g=Q({environment:t,parentStore:a,collectionTemplate:e}),S=v().hS([...l??[],...g],(e=>e.collectionStore.id)),h=ee({environment:t,template:e,parentStore:a,analyticsArgs:{origin:c,hadSelectionModalSearchEntered:((null===(n=i.collectionTemplatesSearchQuery)||void 0===n?void 0:n.length)??0)>0,workflowTemplatesFlowId:p,...d},initialAiPrompt:f}),y=Y({template:e,includeTemplateSelectionStep:!0,hasSetupGenerator:Boolean(h)}),w={...i,open:!0,isSaving:!1,currentStepIndex:(0,j().aO)(i,u),version:y,relationInfos:S??[],setupGenerator:i.setupGenerator??ee({environment:t,template:q().globalWorkflowTemplates.fromIdOfType({templateId:s().MH,type:"collection"}),parentStore:i.parentStore,initialAiPrompt:[[""]],analyticsArgs:{origin:i.origin,workflowTemplatesFlowId:i.flowId,hadSelectionModalSearchEntered:!1,...i.dataSourceAnalytics}}),isFollowUpInputFocused:!1,...(0,j().C8)({collectionTemplate:e,origin:c,flowId:p,parentStore:a,dataSourceAnalytics:d,existingCollectionInfo:i.existingCollectionInfo}),parentStore:i.parentStore};null!==(r=e.value.onboarding)&&void 0!==r&&r.isMinimal?ae({environment:t,modalState:w}):("suggested_template"===o.type&&(0,E().os)({environment:t,eventProperties:{from_modal_template_picker:!0,selected_index:o.allOrderedTemplateIds.indexOf(e.templateId),collection_template_ids_shown:o.allOrderedTemplateIds,...(0,j().gM)({origin:c,parentStore:a,collectionTemplatesSearchQuery:i.collectionTemplatesSearchQuery,flowId:p,collectionTemplate:e,dataSourceAnalytics:i.dataSourceAnalytics})}}),K().default.setState(w))}function ne(e){const t=K().default.state;if(!t.open||!t.collectionTemplate||!t.parentStore)return;let o={...t,...(0,j().C8)({collectionTemplate:e,origin:t.origin,flowId:t.flowId,parentStore:t.parentStore,dataSourceAnalytics:t.dataSourceAnalytics,existingCollectionInfo:t.existingCollectionInfo}),parentStore:t.parentStore,isSaving:!1};if(t.collectionTemplate.templateId===e.templateId){var n;const e=o.userCustomizations.featureTemplateSelections,r=t.userCustomizations.featureTemplateSelections,i=e.map((e=>{const t=r.find((t=>t.template.templateId===e.template.templateId));return"required"!==e.optionality&&t?{...e,selected:t.selected}:e}));o={...o,userCustomizations:{...o.userCustomizations,featureTemplateSelections:i,prevFeatureTemplateSelections:e},previewCollectionInfo:{collectionViewBlockStore:void 0,collectionContextStore:void 0,examplePageStores:void 0,focusViewTemplateId:null===(n=t.previewCollectionInfo)||void 0===n||null===(n=n.collectionContextStore)||void 0===n||null===(n=n.collectionViewStore())||void 0===n||null===(n=n.getFormat().workflow_template_instance)||void 0===n?void 0:n.template_id}}}K().default.setState(o)}function re({environment:e,template:t,parentStore:o,existingCollectionInfo:n,relationInfos:r}){C().createAndCommit({userAction:"workflowTemplates.createMinimalCollectionTemplate",environment:e,canUndo:!0,perform:i=>{(0,z().mm)({environment:e,transaction:i,template:t,parentStore:o,existingCollectionInfo:n,inMemoryRecordCache:o.inMemoryRecordCache,relationInfos:r,logger:new(q().WorkflowTemplateLogger)})}})}function ie({environment:e,modalState:t,collectionViewBlockStore:o,collectionStore:n,examplePageStores:r}){var i;if(!n)return;(0,U().xN)({environment:e,collectionStore:n});const{existingCollectionInfo:a,userCustomizations:c,navigateToOnFinish:s}=t,p=(0,j().gM)(t);!function({environment:e,eventProperties:t,collectionViewBlockStore:o,examplePageStores:n,navigateTo:r,result:i}){if("created_collection"===r)_().uK({environment:e,store:o,visitType:V().ig.Link,pageVisitSource:l().y8.WorkflowTemplateOnboarding,redirect:!0,callback:()=>{D().yQ({examplePageStores:n,collectionViewBlockStore:o,eventProperties:t})}});else if("skip"===r){var a;null!==(a=o.getModel())&&void 0!==a&&a.isFullPageCollectionView()&&D().yQ({examplePageStores:n,collectionViewBlockStore:o,eventProperties:t})}else(0,S().HB)(r);const c=o.getSpaceId();c&&function(e,t,o){var n;const r=(0,I().R$)(e);if(!r)return;const i=(null==r||null===(n=r.getSettings())||void 0===n?void 0:n.onboarding_workflow_template_blocks)||{},a=null==i?void 0:i[t];if(!a)return;const l=a.filter((e=>e!==o));if(l.length===a.length)return;const c={...i};0===l.length?delete c[t]:c[t]=l,C().createAndCommit({environment:e,userAction:"userSettingsActions.removeOnboardingWorkflowTemplateForSpace",canUndo:!0,cellTarget:"main",perform:e=>{(0,T().m)({userSettingsStore:r,transaction:e,data:{onboarding_workflow_template_blocks:c}})}})}(e,c,o.id);const s=K().default.getState();!s.open&&s.isShowingLoadingState&&y().V();K().default.close(i)}({environment:e,eventProperties:p,collectionViewBlockStore:o,examplePageStores:r,navigateTo:s,result:{type:"accepted_template",blockId:o.id,collectionId:n.id}}),(0,E().g2)({environment:e,modalState:t,eventProperties:{record_titles_is_empty:c.recordTitles.map((e=>0===e.length)),selected_feature_template_ids:c.featureTemplateSelections.filter((e=>"required"!==e.optionality&&e.selected)).map((e=>e.template.templateId)),step:(0,j().hq)(t),target_page_ids:[o.id],collection_ids:[n.id],example_page_ids:r.map((e=>e.id)),existing_block_id:null==a||null===(i=a.collectionViewBlockStore)||void 0===i?void 0:i.id,...p}})}function ae({environment:e,modalState:t}){if(!t.collectionTemplate||t.isSaving||!t.parentStore)return;const{collectionTemplate:o,parentStore:n,existingCollectionInfo:r,relationInfos:i,userCustomizations:a}=t;K().default.setState({...t,isSaving:!0});const{performResult:l}=C().createAndCommit({userAction:"WorkflowTemplatesOnboardingModal.getStarted",environment:e,canUndo:!0,perform:t=>{const{collectionStore:l,collectionViewStore:c,collectionViewBlockStore:s,examplePageStores:p}=(0,z().mm)({environment:e,transaction:t,template:o,parentStore:n,existingCollectionInfo:r,inMemoryRecordCache:n.inMemoryRecordCache,selectedFeatureTemplateIds:(0,q().getSelectedFeatureTemplateIds)(a),relationInfos:i,logger:new(q().WorkflowTemplateLogger)});return function({environment:e,transaction:t,collectionStore:o,collectionViewStore:n,collectionViewBlockStore:r,recordTitles:i}){const a=new(k().B)(e);a.setContext({type:"collectionView",collectionViewBlockStore:r,collectionStore:o,collectionViewStore:n,pageVisitSourceOverride:void 0});const l=i.filter((e=>e.length>0));for(const c of l)le({environment:e,transaction:t,collectionContextStore:a,title:c})}({environment:e,transaction:t,collectionStore:l,collectionViewStore:c,collectionViewBlockStore:s,recordTitles:a.recordTitles}),{collectionViewBlockStore:s,collectionStore:l,examplePageStores:p}}});return ie({environment:e,modalState:t,collectionViewBlockStore:l.collectionViewBlockStore,collectionStore:l.collectionStore,examplePageStores:l.examplePageStores}),l}function le({environment:e,transaction:t,collectionContextStore:o,title:n}){const{newStore:r}=(0,b().Q)({environment:e,collectionContextStore:o,groupsPointer:[],insertAtIndex:0,shouldCoerce:!0,templateStore:o.defaultPageTemplateStore.state,transaction:t,from:{createBlock:"workflow_template"},inMemoryRecordCache:e.defaultRecordCache.inMemoryRecordCache});return(0,P().C)({environment:e,store:r,properties:{title:(0,m().x9d)(n)},transaction:t}),r}const ce={assigneeProperty:"notion://tasks/assign_property",statusProperty:"notion://tasks/status_property",dueDateProperty:"notion://tasks/due_date_property"};function se({environment:e,transaction:t,collectionStore:o,collectionViewBlockStore:n}){const r=c().dC,i=c().d0,a=(0,Z().Sl)({environment:e,collectionStore:o}),l={};for(const[c,s]of Object.entries(ce)){const e=a.find((e=>e.templateId.includes(c)));if(!e)return;l[s]=e.instancePointer.id}h().zA({stores:[o],update:{app_config_uri:r,app_uri_map:l},transaction:t}),h().zA({stores:[n],update:{app_id:u().JW(),app_config_uri:i,app_uri_map:{[r]:o.id,[i]:n.id}},transaction:t})}function pe({template:e}){const t=K().default.state;t.open&&t.collectionTemplate&&K().default.setState({...t,userCustomizations:(0,j().Ll)({userCustomizations:t.userCustomizations,templateId:e.templateId})})}function de({environment:e,transaction:t,parentStore:o,collectionTemplate:n,spaceViewStore:r}){const i=w().Wv({environment:e,type:d().xd.collectionViewPage,spaceId:o.getSpaceId(),format:{collection_view_sub_type:"workflow_template_placeholder",placeholder_workflow_template_id:n.templateId,page_icon:n.value.targetCollection.icon},properties:{title:(0,m().x9d)(n.value.targetCollection.name)},inMemoryRecordCache:o.inMemoryRecordCache,transaction:t});w().zv({store:i,data:{parent_id:o.id,parent_table:o.table,alive:!0,view_ids:[]},transaction:t});const l=a().B.createChildStore(o,i.pointer);(0,z().Ls)({environment:e,parentStore:o,collectionViewBlockStore:l,transaction:t,appendOrPrepend:"append",spaceViewStore:r});const c=o.getSpaceId();return c&&((0,E().HD)({environment:e,eventProperties:{placeholder_workflow_template_id:n.templateId,collection_view_block_id:l.id}}),function(e,t,o,n){var r;const i=(0,I().R$)(e);if(!i)return;const a=(null==i||null===(r=i.getSettings())||void 0===r?void 0:r.onboarding_workflow_template_blocks)||{},l=(null==a?void 0:a[o])||[];(0,T().m)({userSettingsStore:i,transaction:t,data:{onboarding_workflow_template_blocks:{...a,[o]:[...l,n]}}})}(e,t,c,l.id)),l}function ue({environment:e,collectionTemplate:t,collectionViewBlockStore:o}){const r=o.getParentStore(),i=r&&(0,W().u)(r)?r:o;if(n().A.isMobile)return re({environment:e,template:t,parentStore:i,existingCollectionInfo:{collectionViewBlockStore:o,collectionStore:void 0,collectionViewStore:void 0},relationInfos:[]}),_().uK({environment:e,store:o,visitType:V().ig.Link,pageVisitSource:l().y8.WorkflowTemplateOnboarding}),{didOpenOnboardingModal:!1};const a="placeholder_block",c={collectionViewBlockStore:o,collectionStore:void 0,collectionViewStore:void 0},s=(0,j().gM)((0,j().C8)({collectionTemplate:t,origin:a,flowId:void 0,parentStore:i,dataSourceAnalytics:void 0,existingCollectionInfo:c}));return(0,E().os)({environment:e,eventProperties:{...s,from_modal_template_picker:!1,selected_index:0,collection_template_ids_shown:[t.templateId]}}),te({environment:e,template:t,origin:a,parentStore:i,aiPrompt:void 0,flowId:s.flow_id,existingCollectionInfo:c}),{didOpenOnboardingModal:!0}}function me(e){const t=K().default.state;if(!t.open)return;const o=t.setupGenerator;o&&(o.discardLatestSetup(),void 0===o.store.state.setup&&fe(e))}function ve(e){const t=K().default.state;t.open&&K().default.setState({...t,isFollowUpInputFocused:e})}function fe(e){const t=K().default.state;if(!t.open)return;const o=(0,j().Wm)(t),n=(0,j().gP)(t,e),r=o[n];if(n>=0){var i,a;if("setupGeneratorInput"===r||"templateSelection"===r)null==t||null===(i=t.setupGenerator)||void 0===i||i.discardAllSetups(),null==t||null===(a=t.setupGenerator)||void 0===a||a.stopGenerating();const e={...t,isFollowUpInputFocused:!1,currentStepIndex:n};"templateSelection"===r&&(e.collectionTemplate=s().XK,"land_on_app_from_new_user_onboarding"===t.origin&&(e.version="new_user_template_onboarding")),K().default.setState(e)}}function ge(e){const t=K().default.state;if(!t.open)return;const o=(0,j().aO)(t,e);o>=0&&K().default.setState({...t,isFollowUpInputFocused:!1,currentStepIndex:o})}},253141:(e,t,o)=>{o.d(t,{Ls:()=>j,mm:()=>q,my:()=>Q,gv:()=>Z});o(16280),o(944114),o(517642),o(658004),o(733853),o(845876),o(432475),o(515024),o(731698),o(581454);var n=()=>o(907258),r=()=>o(135168),i=()=>o(242422),a=()=>o(726637),l=()=>o(675133),c=()=>o(569797),s=()=>o(663077),p=()=>o(651124),d=()=>o(179034),u=()=>o(869558),m=()=>o(96689),v=()=>o(854150),f=()=>o(201980),g=()=>o(534177),S=()=>o(896628),h=()=>o(722101),y=()=>o(44729),w=()=>o(384944),_=()=>o(185544),I=()=>o(955930),C=()=>o(37450),T=()=>o(766854),b=()=>o(649813),k=()=>o(512039),P=()=>o(58415),V=()=>o(414360),M=()=>o(496592),x=()=>o(306499),B=()=>o(586481),A=()=>o(59110),R=()=>o(949653),F=()=>o(389658),E=()=>o(547149),O=()=>o(239924),N=()=>o(922952),$=()=>o(913454),G=()=>o(204067),L=()=>o(101926),D=(o(898992),o(354520),()=>o(838038)),z=()=>o(290966);function U(e){const{environment:t,transaction:o,collectionStore:n,template:r,targetCollectionStore:i,logger:a}=e,{value:c}=r,p=(0,L().ai)(e);if(!p)throw new Error(`relationPropertyPointer not created for ${r.templateId}`);if("property"!==p.type)throw new Error(`Instance pointer returned is not of property type: ${p.type}`);const d=new(k().B)(t);d.setContext({type:"collectionPage",collectionStore:n});const{inverseRelationPropertyId:u}=D().cT({environment:t,transaction:o,intl:l().A.getIntl(),collectionContextStore:d,collectionStore:n,property:p.id,targetCollectionStore:i,hasInverseRelation:!0,inverseName:void 0,propertyName:c.name,autoRelate:c.autoRelate,propertyLimit:1===c.limit?"1":"no_limit"});if(u){const e=function({environment:e,sourceCollectionStore:t,targetCollectionStore:o}){const n=(0,G().tY)({environment:e,collectionStore:t}),r=(0,G().tY)({environment:e,collectionStore:o});if(!n||!r)return;const i=(0,s().bQ)(r).map((e=>$().globalWorkflowTemplates.fromId(e))).filter((e=>(0,s().Sz)(e)));for(const a of i)if(a.relatedCollectionTemplateId===n.templateId)return a}({environment:t,sourceCollectionStore:n,targetCollectionStore:i});e&&(a.log(`Instantiating relation property template "${e.templateId}" because it is the inverse of "${r.templateId}".`),(0,z().ZQ)({transaction:o,collectionStore:i,templateId:e.templateId,instance:{type:"property",id:u,collectionId:i.id},logger:a}))}return p}var W=()=>o(839754);function q({environment:e,transaction:t,template:o,parentStore:n,existingCollectionInfo:a,inMemoryRecordCache:p,selectedFeatureTemplateIds:d,collectionViewBlockType:m="collection_view_page",relationInfos:v,logger:g}){var h;g.log(`Instantiating collection template "${o.templateId}".`);const{collectionStore:y,collectionViewBlockStore:_}=function({environment:e,transaction:t,template:o,parentStore:n,existingCollectionInfo:i,collectionViewBlockType:a="collection_view_page",inMemoryRecordCache:c,logger:s}){var p;if(!(0,N().u)(n))throw new Error(`Parent store is not a valid  collection template parent store ${n}`);let d;if(i){const{collectionStore:e,collectionViewStore:o}=i;d=i.collectionViewBlockStore,o&&(0,V().T)({collectionViewBlockStore:d,collectionViewStore:o,transaction:t}),e&&(0,M().removeCollectionFromCollectionViewBlock)({collectionViewBlockStore:d,collectionStore:e,transaction:t})}else d=H({environment:e,transaction:t,parentStore:n,collectionViewBlockType:a,inMemoryRecordCache:c});const{name:u,icon:m,description:v}=o.value.targetCollection,g=(0,P().E)({environment:e,collectionViewBlockStore:d,transaction:t,collectionValue:{name:(0,f().x9d)(u),icon:m,description:v,format:{item_name_config:o.value.targetCollection.itemName,item_name_config_v2:null===(p=o.value.targetCollection.format)||void 0===p?void 0:p.item_name_config_v2},schema:{title:{name:l().A.formatMessage(F().n4.namePropertyTitle),type:"title"}}}}),S=(0,r().f)(g);if(!S)throw new Error("No current space store");return{collectionStore:g,collectionViewBlockStore:d}}({environment:e,transaction:t,template:o,parentStore:n,existingCollectionInfo:a,collectionViewBlockType:m,inMemoryRecordCache:p,logger:g});(0,z().ZQ)({transaction:t,collectionStore:y,templateId:o.templateId,instance:{type:"collection",id:y.id},logger:g});const{allFeatureTemplates:I,nonRelationPropertyTemplates:x}=function({template:e,selectedFeatureTemplateIds:t}){if(t){const o=new Set((0,s().bQ)(e));for(const n of t)if(!o.has(n))throw new Error(`Feature template ID ${n} is not part of collection template ${e.templateId}`)}const{templateItems:o}=e.value,n=(0,s().b2)(o,"required"),r=(0,s().b2)(o,"optionalDefaultOn"),i=new Set([...n,...t??r]),a=Array.from(i).map($().globalWorkflowTemplates.featureFromId),l=[],c=[];for(const p of a)(0,s().Sz)(p)?l.push(p):c.push(p);return{allFeatureTemplates:a,relationPropertyTemplates:l,nonRelationPropertyTemplates:c}}({template:o,selectedFeatureTemplateIds:d}),E=[];for(const r of x){const o=(0,L().e_)({environment:e,transaction:t,collectionStore:y,template:r,logger:g,origin:"collection_creation"});"collection_view"===(null==o?void 0:o.type)&&E.push(o),(0,L().Ix)({environment:e,transaction:t,collectionStore:y,template:r,logger:g})}if(0===E.length)throw new Error("No collection view templates to create");const D=c().p.createChildStore(_,{table:u().Gy,id:E[0].id});v&&function({environment:e,transaction:t,currentCollectionStore:o,relationInfos:n,logger:r}){for(const i of n){const{sourceCollectionStore:n,targetCollectionStore:a}=K({currentCollectionStore:o,relationInfo:i});U({environment:e,transaction:t,origin:"collection_creation",collectionStore:n,targetCollectionStore:a,template:i.relationPropertyTemplate,logger:r})}}({environment:e,transaction:t,currentCollectionStore:y,relationInfos:v,logger:g});const q=(0,$().getPropertyTemplates)(I);(0,W().My)({transaction:t,collectionStore:y,propertyTemplates:q}),(0,W().Bi)({transaction:t,collectionStore:y,propertyTemplates:q}),function(e){const{transaction:t,collectionStore:o,template:n,logger:r}=e,{format:i}=n.value.targetCollection;if("object"!=typeof(null==i?void 0:i.collection_default_template))return;const a=(0,G().fI)({collectionStore:o,sourceTemplateType:"block",dependencyMap:n.dependencyMap??{},sourcePrimitiveId:i.collection_default_template.template_page_id});a?S().zA({stores:[o],update:{collection_default_template:{template_page_id:a}},transaction:t}):r.warn("Unable to resolve collection default template, omitting it.")}({transaction:t,template:o,collectionStore:y,logger:g}),"tasks"===o.category&&(0,O().maybeAddAppTemplateMetadataForTasks)({environment:e,collectionStore:y,collectionViewBlockStore:_,transaction:t}),function({transaction:e,collectionViewBlockStore:t}){const o=t.getFormat();("workflow_template_placeholder"===o.collection_view_sub_type||o.placeholder_workflow_template_id)&&S().zA({stores:[t],update:{placeholder_workflow_template_id:void 0,collection_view_sub_type:void 0},transaction:e});"app_container"===o.collection_view_sub_type&&o.app_config_uri&&!o.app_initialized&&S().zA({stores:[t],update:{app_config_uri:void 0,app_template_preset:void 0,app_template_features:void 0,app_initialized:void 0,collection_view_sub_type:void 0},transaction:e})}({transaction:t,collectionViewBlockStore:_});let Q=[];return null!==(h=o.value.exampleRows)&&void 0!==h&&h.length&&(Q=function({environment:e,transaction:t,collectionStore:o,collectionViewStore:n,collectionViewBlockStore:r,exampleRows:a,dependencyMap:l,logger:c}){const s=new(k().B)(e);s.setContext({type:"collectionView",collectionViewBlockStore:r,collectionStore:o,collectionViewStore:n,pageVisitSourceOverride:void 0});const p=[],d=s.defaultPageTemplateStore.state,u=i().default.checkGate({gateName:"duplicate_subtree_collection_flows"}),m=d&&u?(0,A().loadLocalSubtree)({environment:e,blockId:d.id,inMemoryRecordCache:d.inMemoryRecordCache,options:{allowCopyCollections:!1,requireFullSubtree:!0,skipTransclusionContainerChildren:!0,allowCopyExternalObjectInstances:!0,includeLegacyTransclusionBlockValues:!0}}).recordMap:void 0;d&&u&&!m&&c.warn(`Unable to hydrate local duplication subtree for template "${d.id}".`);const{inMemoryRecordCache:v}=r;for(const i of a){const{newStore:n}=(0,T().Q)({environment:e,collectionContextStore:s,groupsPointer:[],insertAtIndex:0,shouldCoerce:!0,transaction:t,from:{createBlock:"workflow_template"},inMemoryRecordCache:v});p.push(n);const r=Z({collectionStore:o,dependencyMap:l,exampleRow:i});(0,B().C)({environment:e,store:n,properties:r.properties,transaction:t}),d&&(u&&m?(0,R().localDuplicate)({environment:e,sourceBlockId:d.id,targetBlockPointer:n.pointer,sourceBlockSubtree:m,targetInMemoryRecordCache:n.inMemoryRecordCache,transaction:t,from:"collection_template_actions",options:{deepCopyTransclusionContainers:!1,resolveTemplateVariables:!0,isTemplateInstantiation:!0,sourceBlockUpdateStrategy:"append_only",convertExternalObjectInstancesToPlaceholders:!1},skipUserFacingMessages:!0}):b().n5({title:"template",environment:e,store:n,templateStore:d,isKeyboard:!1,isCreateIn:!1,transaction:t,from:"collection_template_actions"}));const a=n.getIconStore();i.icon&&a&&w().KY({store:a,value:i.icon,transaction:t})}return p}({environment:e,transaction:t,collectionStore:y,collectionViewStore:D,collectionViewBlockStore:_,exampleRows:o.value.exampleRows,dependencyMap:o.dependencyMap??{},logger:g})),t.postSubmitCallbacks.push((t=>{t||p.isTemporaryData||C().vH(e,{from:"workflow_template",type:_.getType()??"collection_view_page",creating_block_id:_.id,collection_view_block_id:_.id,collection_view_id:D.id,collection_id:y.id,view_type:D.getType()})})),{collectionStore:y,collectionViewStore:D,collectionViewBlockStore:_,examplePageStores:Q}}function Q(e){const{environment:t,parentStore:o,title:n,onFinish:r,skipCreateViewSourceMenu:i}=e,{performResult:{collectionViewBlockStore:s,collectionViewStore:d,collectionStore:m}}=E().createAndCommit({userAction:"workflowTemplatesOnboardingModal.addEmptyDatabase",environment:t,canUndo:!0,perform:r=>{let s=e.collectionViewBlockStore;void 0===s&&(s=H({environment:t,transaction:r,parentStore:o,collectionViewBlockType:"collection_view_page",inMemoryRecordCache:o.inMemoryRecordCache}));const d=(0,P().E)({environment:t,collectionViewBlockStore:s,transaction:r,collectionValue:{name:n?(0,f().x9d)(n):void 0,schema:{title:{name:l().A.formatMessage(F().n4.namePropertyTitle),type:"title"}}}});void 0===e.collectionViewBlockStore&&C().vH(t,{from:"workflow_template",type:"collection_view_page",new_page_id:s.id,creating_block_id:s.id,collection_id:d.id});const m=w().eC({environment:t,table:u().Gy,inMemoryRecordCache:s.inMemoryRecordCache,value:{type:"table",parent_id:s.id,parent_table:s.table,space_id:s.getSpaceId(),format:{collection_pointer:d.pointer,table_properties:[{property:"title",visible:!0,width:a().A.isMobile?p().PI:p().Xv}]},alive:!0},transaction:r}),v=c().p.createChildStore(s,m.pointer);return(0,x().F)(v.id,{viewType:"table",isPlaceholderCollection:!0,...i?{viewSettingsStack:{type:"skip"}}:void 0}),h().BC({parentStore:s.getCollectionViewsStore(),appendStore:v,transaction:r}),{collectionViewBlockStore:s,collectionViewStore:v,collectionStore:d}}});return r&&r(s),{collectionViewBlockStore:s,collectionViewStore:d,collectionStore:m}}function Z({exampleRow:e,dependencyMap:t,collectionStore:o}){const n={properties:{}};for(const[r,i]of Object.entries(e.properties))n.properties[(0,G().CB)({collectionStore:o,sourceTemplateType:"property",dependencyMap:t,sourcePrimitiveId:r})]=i;return n}function H({environment:e,transaction:t,parentStore:o,collectionViewBlockType:r,inMemoryRecordCache:i}){var a;const l=w().Wv({environment:e,type:r,inMemoryRecordCache:i,transaction:t});return w().zv({store:l,transaction:t,data:{parent_id:o.id,parent_table:o.table,alive:!0}}),j({environment:e,spaceViewStore:null===(a=n().default.state.sidebarSpaceViewStore)||void 0===a?void 0:a.clone(i),parentStore:o,collectionViewBlockStore:l,transaction:t,appendOrPrepend:"append"}),l}function j({environment:e,parentStore:t,collectionViewBlockStore:o,transaction:n,appendOrPrepend:r,spaceViewStore:i}){if(t.table===d().ev)y().NI({parentStore:t,childStore:o,transaction:n});else if(t.table===m().NX){if((null==i?void 0:i.getSpaceId())!==t.id)throw new Error(`spaceViewStore doesn't match parent with ID ${t.id}`);_().yM({environment:e,spaceStore:t,spaceViewStore:i,pageStore:o,isPrivate:!0,transaction:n})}else t.table===v().yK?I().sP({teamStore:t,store:o,transaction:n,location:{type:r}}):(0,g().HB)(t)}function K({currentCollectionStore:e,relationInfo:t}){const{type:o,collectionStore:n}=t;return"source"===o?{sourceCollectionStore:n,targetCollectionStore:e}:"target"===o?{sourceCollectionStore:e,targetCollectionStore:n}:void(0,g().HB)(o)}},349379:(e,t,o)=>{o.d(t,{DF:()=>p,HD:()=>a,If:()=>s,Vd:()=>c,g2:()=>l,os:()=>i});var n=()=>o(564884),r=()=>o(955104);function i({environment:e,eventProperties:t}){(0,n().u)({environment:e,event:{eventName:"suggested_collection_template_clicked",eventProperties:t}})}function a({environment:e,eventProperties:t}){(0,n().u)({environment:e,event:{eventName:"workflow_template_onboarding_placeholder_created",eventProperties:t}})}function l({environment:e,eventProperties:t,modalState:o}){var i;((0,n().u)({environment:e,event:{eventName:"workflow_template_onboarding_done",eventProperties:t}}),r().u4({name:"collection_created_from_workflow_template",args:{template_id:t.collection_template_id??"",origin:t.origin,experiment_group:"personalized"}}),o.collectionTemplate.isAiGenerated)&&(null===(i=o.setupGenerator)||void 0===i||i.trackSessionEnded({reason:"instantiated"}))}function c({environment:e,eventProperties:t}){(0,n().u)({environment:e,event:{eventName:"setup_generator_session_started",eventProperties:t}})}function s({environment:e,eventProperties:t}){(0,n().u)({environment:e,event:{eventName:"setup_generator_generated_setup",eventProperties:t}})}function p({environment:e,eventProperties:t}){(0,n().u)({environment:e,event:{eventName:"template_picker_opened",eventProperties:t}})}},362750:(e,t,o)=>{o.d(t,{Zl:()=>r,lH:()=>i,oV:()=>n});o(16280),o(410838),o(944114),o(581454);const n=12e3;function r(e){const t=[];for(const o of e){const e=t[t.length-1];e?"text"===o.type&&"text"===e.type?t[t.length-1]={type:"text",content:e.content+o.content}:"thinking"!==o.type||"thinking"!==e.type||o.encryptedContent||e.encryptedContent||o.signature&&e.signature||o.modelProvider!==e.modelProvider||o.notionModelName!==e.notionModelName?"tool_use"===o.type&&"tool_use"===e.type&&o.id===e.id?t[t.length-1]={type:"tool_use",id:o.id,name:o.name,content:e.content+o.content,signature:o.signature||e.signature}:t.push({...o}):t[t.length-1]={type:"thinking",content:e.content+o.content,id:o.id||e.id,signature:o.signature||e.signature,encryptedContent:o.encryptedContent||e.encryptedContent,modelProvider:o.modelProvider||e.modelProvider,notionModelName:o.notionModelName||e.notionModelName}:t.push({...o})}return t}function i(e){return"string"==typeof e?[{type:"text",content:e}]:e??[]}},458097:(e,t,o)=>{o.r(t),o.d(t,{default:()=>i});class n extends(()=>o(757695))().Store{getInitialState(){return{open:!1,isShowingLoadingState:!1}}updateUserCustomizations(e,t){this.state.open&&this.state.collectionTemplate&&this.setState({...this.state,userCustomizations:{...this.state.userCustomizations,[e]:t}})}updateCollectionTemplate(e){this.state.open&&this.state.collectionTemplate&&this.setState({...this.state,collectionTemplate:e})}updatePreviewFocusViewTemplateId(e){this.state.open&&this.state.collectionTemplate&&this.state.previewCollectionInfo&&this.state.previewCollectionInfo.focusViewTemplateId!==e&&this.setState({...this.state,previewCollectionInfo:{...this.state.previewCollectionInfo,focusViewTemplateId:e}})}updatePreviewCollectionContextStore(e){this.state.open&&this.state.collectionTemplate&&this.state.previewCollectionInfo&&this.state.previewCollectionInfo.collectionContextStore!==e&&this.setState({...this.state,previewCollectionInfo:{...this.state.previewCollectionInfo,collectionContextStore:e}})}getPreviewCollectionContextStore(){if(this.state.open&&this.state.collectionTemplate&&this.state.previewCollectionInfo)return this.state.previewCollectionInfo.collectionContextStore}getParentStore(){return this.state.open?this.state.parentStore:void 0}getShouldShowExpandedTemplateList(){return this.state.open&&this.state.shouldShowExpandedTemplateList}setShouldShowExpandedTemplateList(e){this.state.open&&this.setState({...this.state,shouldShowExpandedTemplateList:e})}close(e){var t,o;this.state.open&&(null===(t=(o=this.state).onClose)||void 0===t||t.call(o,e),this.setState({open:!1,isShowingLoadingState:!1}))}reset(){this.setState(this.getInitialState())}}const r=new n;(0,o(852832).exposeDebugValue)("InitializeWorkflowTemplateModalStore",r);const i=r},592933:(e,t,o)=>{o.d(t,{G1:()=>i,Pn:()=>a,Vf:()=>n,yD:()=>r});o(410838),o(813451),o(944114),o(898992),o(354520),o(672577),o(803949),o(581454),o(737550);function n(e){return"inference"!==e.type&&"queue-handoff"!==e.type&&"reenqueue-with-delay"!==e.type&&"record-map"!==e.type&&"patch-start"!==e.type&&"patch"!==e.type&&"agent-search-extracted-results"!==e.type}function r(e){return"patch"===e.type||"patch-start"===e.type}function i(e){return function(e){const t=e.find((e=>"context"===e.type));return"daily_brief_reminder"===(null==t?void 0:t.value.surface)}(e)&&function(e){return e.filter((e=>"user"===e.type||"user-injected"===e.type)).length}(e)<=1}function a(e){let t=0;const o=e.findLastIndex((e=>"user"===e.type));-1!==o&&(t=o+1);return e.slice(t)}}}]);